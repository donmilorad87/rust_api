class r{constructor(){this.form=null,this.approveBtn=null,this.denyBtn=null,this.isSubmitting=!1,this.loginModal=null,this.isLoggedIn=!1}init(){if(this.form=document.getElementById("consentForm"),this.approveBtn=document.getElementById("approveBtn"),this.denyBtn=document.getElementById("denyBtn"),this.isLoggedIn=window.IS_LOGGED_IN===!0,!this.form){console.error("Consent form not found");return}this.isLoggedIn||this.initLoginModal(),this.setupEventListeners()}initLoginModal(){const t=()=>{var e;(e=window.Blazing_Sun)!=null&&e.LoginModal?(this.loginModal=new window.Blazing_Sun.LoginModal({baseUrl:window.BASE_URL||"",redirectAfterLogin:!1,onSuccess:()=>{window.location.reload()},showToast:(n,o)=>{console.log(`[${o}] ${n}`)}}),this.loginModal.show()):setTimeout(t,100)};document.readyState==="complete"?t():window.addEventListener("load",t)}setupEventListeners(){var t,e;(t=this.approveBtn)==null||t.addEventListener("click",n=>{n.preventDefault(),this.submitConsent(!0)}),(e=this.denyBtn)==null||e.addEventListener("click",n=>{n.preventDefault(),this.submitConsent(!1)}),this.form.addEventListener("submit",n=>{n.preventDefault()})}getFormData(){const t=new FormData(this.form),e={};for(const[n,o]of t.entries())e[n]=o;return e}getCsrfHeaders(){var o,i;if((i=(o=window.Blazing_Sun)==null?void 0:o.csrf)!=null&&i.getCsrfHeaders)return window.Blazing_Sun.csrf.getCsrfHeaders();const t=document.querySelector('meta[name="csrf-token"]'),e=t==null?void 0:t.getAttribute("content"),n={"Content-Type":"application/json"};return e&&(n["X-CSRF-TOKEN"]=e),n}async submitConsent(t){if(this.isSubmitting)return;if(!this.isLoggedIn){this.loginModal?this.loginModal.show():this.initLoginModal();return}this.isSubmitting=!0,this.setButtonsLoading(!0);const e=this.getFormData(),n={client_id:e.client_id,redirect_uri:e.redirect_uri,scope:e.scope,state:e.state||null,code_challenge:e.code_challenge||null,code_challenge_method:e.code_challenge_method||null,approved:t};try{const o=await fetch("/oauth/authorize",{method:"POST",headers:this.getCsrfHeaders(),body:JSON.stringify(n)});if(o.redirected){window.location.href=o.url;return}const i=await o.json();i.redirect_uri?window.location.href=i.redirect_uri:i.error&&this.showError(i.error_description||i.error)}catch(o){console.error("Consent submission error:",o),this.showError("An error occurred. Please try again.")}finally{this.isSubmitting=!1,this.setButtonsLoading(!1)}}setButtonsLoading(t){this.approveBtn&&(this.approveBtn.disabled=t,this.approveBtn.textContent=t?"Processing...":"Authorize"),this.denyBtn&&(this.denyBtn.disabled=t)}showError(t){let e=document.querySelector(".oauth-consent__error");e||(e=document.createElement("div"),e.className="oauth-consent__error",this.form.insertBefore(e,this.form.firstChild)),e.textContent=t,e.style.display="block",setTimeout(()=>{e.style.display="none"},5e3)}}document.addEventListener("DOMContentLoaded",()=>{new r().init()});
