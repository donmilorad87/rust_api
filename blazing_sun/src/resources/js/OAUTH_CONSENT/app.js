class s{constructor(){this.form=null,this.approveBtn=null,this.denyBtn=null,this.isSubmitting=!1,this.loginModal=null,this.isLoggedIn=!1}init(){if(this.form=document.getElementById("consentForm"),this.approveBtn=document.getElementById("approveBtn"),this.denyBtn=document.getElementById("denyBtn"),this.isLoggedIn=window.IS_LOGGED_IN===!0,!this.form){console.error("Consent form not found");return}this.isLoggedIn||this.initLoginModal(),this.setupEventListeners()}initLoginModal(){const e=()=>{window.Blazing_Sun?.LoginModal?(this.loginModal=new window.Blazing_Sun.LoginModal({baseUrl:window.BASE_URL||"",redirectAfterLogin:!1,onSuccess:()=>{window.location.reload()},showToast:(t,r)=>{console.log(`[${r}] ${t}`)}}),this.loginModal.show()):setTimeout(e,100)};document.readyState==="complete"?e():window.addEventListener("load",e)}setupEventListeners(){this.approveBtn?.addEventListener("click",e=>{e.preventDefault(),this.submitConsent(!0)}),this.denyBtn?.addEventListener("click",e=>{e.preventDefault(),this.submitConsent(!1)}),this.form.addEventListener("submit",e=>{e.preventDefault()})}getFormData(){const e=new FormData(this.form),t={};for(const[r,o]of e.entries())t[r]=o;return t}getCsrfHeaders(){if(window.Blazing_Sun?.csrf?.getCsrfHeaders)return window.Blazing_Sun.csrf.getCsrfHeaders();const t=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),r={"Content-Type":"application/json"};return t&&(r["X-CSRF-TOKEN"]=t),r}async submitConsent(e){if(this.isSubmitting)return;if(!this.isLoggedIn){this.loginModal?this.loginModal.show():this.initLoginModal();return}this.isSubmitting=!0,this.setButtonsLoading(!0);const t=this.getFormData(),r={client_id:t.client_id,redirect_uri:t.redirect_uri,scope:t.scope,state:t.state||null,code_challenge:t.code_challenge||null,code_challenge_method:t.code_challenge_method||null,approved:e};try{const o=await fetch("/oauth/authorize",{method:"POST",headers:this.getCsrfHeaders(),body:JSON.stringify(r)});if(o.redirected){if(!this.isValidRedirectUri(o.url)){this.showError("Invalid redirect URI. Please contact the application owner.");return}window.location.href=o.url;return}const i=await o.json();if(i.redirect_uri){if(!this.isValidRedirectUri(i.redirect_uri)){this.showError("Invalid redirect URI. Please contact the application owner.");return}window.location.href=i.redirect_uri}else i.error&&this.showError(this.buildErrorMessage(i))}catch(o){console.error("Consent submission error:",o),this.showError("An error occurred. Please try again.")}finally{this.isSubmitting=!1,this.setButtonsLoading(!1)}}setButtonsLoading(e){this.approveBtn&&(this.approveBtn.disabled=e,this.approveBtn.textContent=e?"Processing...":"Authorize"),this.denyBtn&&(this.denyBtn.disabled=e)}showError(e){this.showToast(e,"error");let t=document.querySelector(".oauth-consent__error");t||(t=document.createElement("div"),t.className="oauth-consent__error",this.form.insertBefore(t,this.form.firstChild)),t.textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},5e3)}buildErrorMessage(e){return e?.error&&e?.error_description?`${e.error}: ${e.error_description}`:e?.error_description?e.error_description:e?.error?e.error:"Authorization failed. Please try again."}showToast(e,t="info"){const r={success:"linear-gradient(to right, #00b09b, #96c93d)",error:"linear-gradient(to right, #ff5f6d, #ffc371)",info:"linear-gradient(to right, #667eea, #764ba2)"};typeof Toastify<"u"?Toastify({text:e,duration:5e3,gravity:"top",position:"right",style:{background:r[t]||r.info}}).showToast():console.log(`[${t.toUpperCase()}] ${e}`)}isValidRedirectUri(e){try{const t=new URL(e),r=t.protocol.toLowerCase(),o=t.hostname.toLowerCase();if(r==="https:")return!0;if(r==="http:")return o==="localhost"||o==="127.0.0.1"||o==="::1"}catch{return!1}return!1}}document.addEventListener("DOMContentLoaded",()=>{new s().init()});
