(function(){"use strict";function T(){const n=document.querySelector('meta[name="csrf-token"]');return n?n.getAttribute("content"):(console.warn('CSRF token not found. Ensure <meta name="csrf-token"> exists in page head.'),null)}function f(n={}){const t=T(),s={"Content-Type":"application/json",...n};return t&&(s["X-CSRF-TOKEN"]=t),s}class _{constructor({baseUrl:t,form:s,amountInput:a,submitBtn:e,statusEl:i,summaryEl:c,walletTab:l,transactionsTab:u,walletPanel:r,transactionsPanel:h,transactionsList:o,transactionsLoading:d,transactionsEmpty:m,transactionsError:b}){const g=(t||"").replace(/\/$/,"");this.baseUrl=g,this.checkoutBaseUrl=g?`${g}/checkout`:"/checkout",this.form=s,this.amountInput=a,this.submitBtn=e,this.statusEl=i,this.summaryEl=c,this.walletTab=l,this.transactionsTab=u,this.walletPanel=r,this.transactionsPanel=h,this.transactionsList=o,this.transactionsLoading=d,this.transactionsEmpty=m,this.transactionsError=b,this.isSubmitting=!1,this.transactionsLoaded=!1,this.isLoadingTransactions=!1,this.init()}init(){this.form.addEventListener("submit",t=>this.handleSubmit(t)),this.amountInput.addEventListener("input",()=>this.updateSummary()),this.updateSummary(),this.showStatusFromQuery(),this.initTabs()}showStatusFromQuery(){const s=new URLSearchParams(window.location.search).get("status");s==="success"?this.showStatus("Payment completed. Coins will appear shortly.","success"):s==="cancel"&&this.showStatus("Payment canceled. You can try again.","warning")}initTabs(){!this.walletTab||!this.transactionsTab||!this.walletPanel||!this.transactionsPanel||(this.walletTab.addEventListener("click",()=>this.activateTab("wallet")),this.transactionsTab.addEventListener("click",()=>this.activateTab("transactions")))}activateTab(t){const s=t==="wallet";this.walletTab&&this.transactionsTab&&(this.walletTab.classList.toggle("balance__tab--active",s),this.transactionsTab.classList.toggle("balance__tab--active",!s),this.walletTab.setAttribute("aria-selected",s?"true":"false"),this.transactionsTab.setAttribute("aria-selected",s?"false":"true")),this.walletPanel&&this.transactionsPanel&&(this.walletPanel.hidden=!s,this.transactionsPanel.hidden=s,this.walletPanel.classList.toggle("balance__panel--active",s),this.transactionsPanel.classList.toggle("balance__panel--active",!s)),!s&&!this.transactionsLoaded&&this.loadTransactions()}updateSummary(){if(!this.summaryEl)return;const t=this.getAmount();if(!t){this.summaryEl.textContent="",this.amountInput.classList.remove("balance__input--error");return}const s=t*100;this.summaryEl.textContent=`You are adding ${t} coins (${s} balance).`,this.amountInput.classList.remove("balance__input--error")}getAmount(){const t=Number.parseInt(this.amountInput.value,10);return!Number.isInteger(t)||t<1?null:t}async handleSubmit(t){if(t.preventDefault(),this.isSubmitting)return;const s=this.getAmount();if(!s){this.amountInput.classList.add("balance__input--error"),this.showToast("Enter a whole number of coins (minimum 1).","error");return}this.setLoading(!0,"Creating checkout..."),this.isSubmitting=!0;const a=await this.createCheckoutSession(s);if(!a.ok){this.setLoading(!1,"Continue to Stripe"),this.isSubmitting=!1,this.showToast(a.message||"Checkout failed. Please try again.","error");return}const e=a.data?.url;if(e){window.location.href=e;return}this.setLoading(!1,"Continue to Stripe"),this.isSubmitting=!1,this.showToast("Stripe checkout could not start.","error")}async createCheckoutSession(t){try{const s=f(),a=this.getAuthToken();a&&(s.Authorization=`Bearer ${a}`);const e=await fetch(`${this.checkoutBaseUrl}/sessions`,{method:"POST",headers:s,credentials:"same-origin",body:JSON.stringify({amount:t})}),i=await e.json().catch(()=>({}));return{ok:e.ok,data:i,message:i?.message}}catch(s){return console.error("Checkout request failed:",s),{ok:!1,message:"Network error. Please try again."}}}getAuthToken(){const t=document.cookie.split(";");for(const s of t){const[a,e]=s.trim().split("=");if(a==="auth_token")return decodeURIComponent(e)}return null}setTransactionsState(t,s){this.transactionsLoading&&this.transactionsLoading.classList.toggle("balance__transactions-state--hidden",t!=="loading"),this.transactionsEmpty&&this.transactionsEmpty.classList.toggle("balance__transactions-state--hidden",t!=="empty"),this.transactionsError&&(s&&(this.transactionsError.textContent=s),this.transactionsError.classList.toggle("balance__transactions-state--hidden",t!=="error")),this.transactionsList&&this.transactionsList.classList.toggle("balance__transactions-list--hidden",t!=="list")}async loadTransactions(){if(this.isLoadingTransactions||!this.transactionsList)return;this.isLoadingTransactions=!0,this.setTransactionsState("loading");const t=await this.fetchTransactions();if(!t.ok){this.setTransactionsState("error",t.message||"Unable to load transactions."),this.isLoadingTransactions=!1;return}const s=Array.isArray(t.data?.transactions)?t.data.transactions:[];s.length===0?this.setTransactionsState("empty"):(this.renderTransactions(s),this.setTransactionsState("list"),this.transactionsLoaded=!0),this.isLoadingTransactions=!1}async fetchTransactions(){try{const t=f({Accept:"application/json"}),s=this.getAuthToken();s&&(t.Authorization=`Bearer ${s}`);const a=await fetch(`${this.checkoutBaseUrl}/transactions?limit=50`,{method:"GET",headers:t,credentials:"same-origin"}),e=await a.json().catch(()=>({}));return{ok:a.ok,data:e,message:e?.message}}catch(t){return console.error("Transactions request failed:",t),{ok:!1,message:"Network error. Please try again."}}}renderTransactions(t){this.transactionsList&&(this.transactionsList.innerHTML="",t.forEach(s=>{const a=Number(s.amount_cents||0),e=a/100,i=Number.isInteger(e)?e.toString():e.toFixed(2),c=this.formatPurpose(s.purpose),{label:l,className:u}=this.formatStatus(s.status),r=this.formatCheckoutId(s.checkout_id),h=this.formatDate(s.completed_at||s.created_at),o=document.createElement("div");o.className="balance__transactions-row",o.innerHTML=`
        <div class="balance__transactions-main">
          <div class="balance__transactions-amount">+${i} coins</div>
          <div class="balance__transactions-meta">${c} Â· ${a} balance</div>
          ${r?`<div class="balance__transactions-id">Checkout ${r}</div>`:""}
        </div>
        <div class="balance__transactions-side">
          <span class="balance__transactions-status balance__transactions-status--${u}">
            ${l}
          </span>
          <span class="balance__transactions-date">${h}</span>
        </div>
      `,this.transactionsList.appendChild(o)}))}formatPurpose(t){if(!t)return"Top up";const s=t.replace(/_/g," ");return s.charAt(0).toUpperCase()+s.slice(1)}formatCheckoutId(t){return t?t.length<=8?t:t.slice(-8):null}formatStatus(t){switch(t){case"payment_succeeded":return{label:"Paid",className:"success"};case"payment_failed":case"session_failed":return{label:"Failed",className:"failed"};case"session_created":return{label:"Pending",className:"pending"};default:return{label:"Unknown",className:"pending"}}}formatDate(t){if(!t)return"-";const s=new Date(t);return Number.isNaN(s.getTime())?"-":s.toLocaleString()}setLoading(t,s){this.submitBtn&&(this.submitBtn.disabled=t,this.submitBtn.textContent=s,this.submitBtn.classList.toggle("balance__submit--loading",t))}showStatus(t,s){this.statusEl&&(this.statusEl.textContent=t,this.statusEl.classList.remove("balance__status--success","balance__status--warning","balance__status--error"),this.statusEl.classList.add(`balance__status--${s}`))}showToast(t,s){if(typeof window.showToast=="function"){window.showToast(t,s);return}console.log(`[${s}] ${t}`)}}function p(){const n=document.getElementById("balanceForm"),t=document.getElementById("amount"),s=document.getElementById("balanceSubmit"),a=document.getElementById("balanceStatus"),e=document.getElementById("amountSummary"),i=document.getElementById("balanceWalletTab"),c=document.getElementById("balanceTransactionsTab"),l=document.getElementById("balanceWalletPanel"),u=document.getElementById("balanceTransactionsPanel"),r=document.getElementById("balanceTransactionsList"),h=document.getElementById("balanceTransactionsLoading"),o=document.getElementById("balanceTransactionsEmpty"),d=document.getElementById("balanceTransactionsError");if(!n||!t||!s){console.error("Balance page: Required DOM elements not found");return}const m=window.BASE_URL||"",b=new _({baseUrl:m,form:n,amountInput:t,submitBtn:s,statusEl:a,summaryEl:e,walletTab:i,transactionsTab:c,walletPanel:l,transactionsPanel:u,transactionsList:r,transactionsLoading:h,transactionsEmpty:o,transactionsError:d});typeof window<"u"&&(window.balancePage=b)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",p):p()})();
