(function(){"use strict";var f=document.createElement("style");f.textContent=`.profile{min-height:calc(100vh - 60px);padding:2rem;background:var(--bg-primary)}.profile__container{max-width:900px;margin:0 auto}.profile__header{margin-bottom:2rem}.profile__title{font-size:1.5rem;font-weight:700;color:var(--text-primary);margin:0}.profile__grid{display:grid;gap:2rem}@media(min-width:768px){.profile__grid{grid-template-columns:300px 1fr}}.profile-card{background:var(--card-bg);border-radius:8px;padding:2rem;box-shadow:0 4px 20px var(--card-shadow);transition:box-shadow .25s ease}.profile-card:hover{box-shadow:0 6px 24px var(--card-shadow)}.profile-card__title{font-size:1.125rem;font-weight:600;color:var(--text-primary);margin:0 0 1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border-color)}.avatar-section{display:flex;flex-direction:column;align-items:center}.avatar{position:relative;width:120px;height:120px;margin-bottom:1.5rem}.avatar__image{width:100%;height:100%;border-radius:9999px;object-fit:cover;border:4px solid var(--border-color);transition:border-color .25s ease}.avatar__placeholder{width:100%;height:100%;border-radius:9999px;background:var(--input-disabled-bg, #f3f4f6);display:flex;align-items:center;justify-content:center;color:var(--text-disabled, #9ca3af);border:4px solid var(--border-color)}.avatar__placeholder svg{width:60%;height:60%}.avatar__overlay{position:absolute;inset:0;border-radius:9999px;background:color-mix(in srgb,var(--text-primary) 50%,transparent);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .25s ease;cursor:pointer}.avatar__overlay:hover{opacity:1}.avatar__overlay-icon{width:32px;height:32px;color:var(--text-on-dark, #ffffff)}.avatar__input{display:none}.avatar__name{font-size:1.125rem;font-weight:600;color:var(--text-primary);margin-bottom:.25rem}.avatar__email{font-size:.875rem;color:var(--text-muted)}.avatar-preview{position:fixed;inset:0;background:color-mix(in srgb,var(--text-primary) 80%,transparent);display:flex;align-items:center;justify-content:center;z-index:500;padding:2rem}.avatar-preview.hidden{display:none}.avatar-preview__container{background:var(--card-bg);border-radius:8px;padding:2rem;max-width:400px;width:100%}.avatar-preview__image{width:200px;height:200px;border-radius:9999px;object-fit:cover;margin:0 auto 1.5rem;display:block;border:4px solid var(--border-color)}.avatar-preview__actions{display:flex;gap:1rem;justify-content:center}.form-section{margin-bottom:2rem}.form-section:last-child{margin-bottom:0}.form-section__title{font-size:1rem;font-weight:600;color:var(--text-secondary);margin:0 0 1rem;text-transform:uppercase;letter-spacing:.5px}.form-group{margin-bottom:1rem}.form-group:last-child{margin-bottom:0}.form-group__label{display:block;font-size:.875rem;font-weight:500;color:var(--text-secondary);margin-bottom:.25rem}.form-group__input{width:100%;padding:.75rem 1rem;border:2px solid var(--input-border);border-radius:6px;background:var(--input-bg);color:var(--text-primary);font-size:1rem;font-family:inherit;transition:border-color .25s ease,box-shadow .25s ease}.form-group__input:focus{outline:none;border-color:var(--color-accent);box-shadow:0 0 0 3px color-mix(in srgb,var(--color-accent) 20%,transparent)}.form-group__input:disabled{opacity:.6;cursor:not-allowed}.form-group__input::placeholder{color:var(--text-muted)}.form-group__hint{font-size:.875rem;color:var(--text-muted);margin-top:.25rem}.form-group__error{font-size:.875rem;color:#ef4444;margin-top:.25rem}.form-row{display:grid;gap:1rem}@media(min-width:480px){.form-row{grid-template-columns:repeat(2,1fr)}}.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem 1.5rem;border:none;border-radius:6px;font-size:1rem;font-weight:600;font-family:inherit;cursor:pointer;transition:all .25s ease;text-decoration:none}.btn:disabled{opacity:.6;cursor:not-allowed}.btn--primary{background:linear-gradient(135deg,#3498db,#764ba2);color:var(--text-on-primary, #ffffff)}.btn--primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 4px 12px color-mix(in srgb,var(--color-accent) 40%,transparent)}.btn--secondary{background:var(--btn-secondary-bg);color:var(--text-primary);border:2px solid var(--border-color)}.btn--secondary:hover:not(:disabled){border-color:var(--color-accent);color:var(--color-accent)}.btn--danger{background:#ef4444;color:var(--text-on-primary, #ffffff)}.btn--danger:hover:not(:disabled){background:var(--color-error-dark, #dc2626)}.btn--sm{padding:.5rem 1rem;font-size:.875rem}.btn--loading{pointer-events:none;opacity:.8}.btn--full{width:100%}.password-strength{margin-top:.5rem}.password-strength__track{height:4px;background:var(--border-color);border-radius:2px;overflow:hidden}.password-strength__bar{height:100%;width:0;transition:width .25s ease,background .25s ease}.password-strength__bar--weak{width:25%;background:#ef4444}.password-strength__bar--fair{width:50%;background:#f59e0b}.password-strength__bar--good{width:75%;background:var(--color-success, #10b981)}.password-strength__bar--strong{width:100%;background:#10b981}.password-strength-text{font-size:.875rem;margin-top:.25rem;color:var(--text-muted)}.email-steps{display:flex;align-items:center;justify-content:center;gap:.5rem;margin-bottom:2rem}.email-step{display:flex;align-items:center;gap:.5rem}.email-step__number{width:28px;height:28px;border-radius:9999px;background:var(--border-color);color:var(--text-muted);font-size:.875rem;font-weight:600;display:flex;align-items:center;justify-content:center;transition:all .25s ease}.email-step__label{font-size:.875rem;color:var(--text-muted);transition:color .25s ease}@media(max-width:480px){.email-step__label{display:none}}.email-step--active .email-step__number{background:linear-gradient(135deg,#3498db,#764ba2);color:var(--text-on-primary, #ffffff)}.email-step--active .email-step__label{color:var(--text-primary);font-weight:500}.email-step--completed .email-step__number{background:#10b981;color:var(--text-on-primary, #ffffff)}.email-step__connector{width:30px;height:2px;background:var(--border-color)}@media(max-width:480px){.email-step__connector{width:20px}}.section-divider{height:1px;background:var(--border-color);margin:2rem 0}.message-box{padding:1rem;border-radius:6px;margin-bottom:1.5rem}.message-box--info{background:color-mix(in srgb,var(--color-accent) 10%,transparent);border:1px solid color-mix(in srgb,var(--color-accent) 30%,transparent);color:var(--text-primary)}.message-box--success{background:color-mix(in srgb,var(--color-success) 10%,transparent);border:1px solid color-mix(in srgb,var(--color-success) 30%,transparent);color:#10b981}.message-box--warning{background:color-mix(in srgb,var(--color-warning) 10%,transparent);border:1px solid color-mix(in srgb,var(--color-warning) 30%,transparent);color:var(--text-primary)}.message-box--error{background:color-mix(in srgb,var(--color-error) 10%,transparent);border:1px solid color-mix(in srgb,var(--color-error) 30%,transparent);color:#ef4444}@media(max-width:768px){.profile{padding:1rem}.profile__grid{grid-template-columns:1fr}.profile-card{padding:1.5rem}}@media(max-width:480px){.profile{padding:.5rem}.avatar{width:80px;height:80px}.avatar__placeholder{font-size:1.25rem}}
/*$vite$:1*/`,document.head.appendChild(f);function g(){const n=document.querySelector('meta[name="csrf-token"]');return n?n.getAttribute("content"):(console.warn('CSRF token not found. Ensure <meta name="csrf-token"> exists in page head.'),null)}function m(n={}){const e=g(),t={"Content-Type":"application/json",...n};return e&&(t["X-CSRF-TOKEN"]=e),t}class c{constructor(e={}){this.options={showIcons:!0,validateOnInput:!0,...e},this.validationRules={email:[{test:t=>t.length>0,message:"Email is required",key:"required"},{test:t=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t),message:"Must be a valid email format",key:"format"}],password:[{test:t=>t.length>0,message:"Password is required",key:"required"},{test:t=>t.length>=8,message:"Minimum 8 characters",key:"minLength"},{test:t=>/[A-Z]/.test(t),message:"At least one uppercase letter",key:"uppercase"},{test:t=>/[a-z]/.test(t),message:"At least one lowercase letter",key:"lowercase"},{test:t=>/[0-9]/.test(t),message:"At least one number",key:"number"},{test:t=>/[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\\/`~]/.test(t),message:"At least one special character",key:"special"}],first_name:[{test:t=>t.length>0,message:"First name is required",key:"required"},{test:t=>t.length>=2,message:"Minimum 2 characters",key:"minLength"},{test:t=>/^[a-zA-Z\s'-]+$/.test(t)||t.length===0,message:"Letters only (no special characters)",key:"letters"}],last_name:[{test:t=>t.length>0,message:"Last name is required",key:"required"},{test:t=>t.length>=2,message:"Minimum 2 characters",key:"minLength"},{test:t=>/^[a-zA-Z\s'-]+$/.test(t)||t.length===0,message:"Letters only (no special characters)",key:"letters"}],current_password:[{test:t=>t.length>0,message:"Current password is required",key:"required"}],new_password:[{test:t=>t.length>0,message:"New password is required",key:"required"},{test:t=>t.length>=8,message:"Minimum 8 characters",key:"minLength"},{test:t=>/[A-Z]/.test(t),message:"At least one uppercase letter",key:"uppercase"},{test:t=>/[a-z]/.test(t),message:"At least one lowercase letter",key:"lowercase"},{test:t=>/[0-9]/.test(t),message:"At least one number",key:"number"},{test:t=>/[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\\/`~]/.test(t),message:"At least one special character",key:"special"}]},this.boundInputs=new Map,this.passwordConfirmPairs=new Map}bindPasswordConfirm(e,t,i){if(!e||!t)return;const a={input:e,type:"password_confirm",feedbackContainer:i,isValid:!1,touched:!1,passwordInput:t};if(this.boundInputs.set(e,a),this.passwordConfirmPairs.set(e,t),i){i.innerHTML="",i.className="validation-feedback";const s=document.createElement("div");s.className="validation-item",s.dataset.rule="match",s.innerHTML=`
                <span class="validation-icon"></span>
                <span class="validation-text">Passwords must match</span>
            `,i.appendChild(s)}this.options.validateOnInput&&(e.addEventListener("input",()=>this.validatePasswordConfirm(a)),e.addEventListener("blur",()=>{a.touched=!0,this.validatePasswordConfirm(a)}),t.addEventListener("input",()=>{e.value.length>0&&this.validatePasswordConfirm(a)}))}validatePasswordConfirm(e){const{input:t,feedbackContainer:i,touched:a,passwordInput:s}=e,r=t.value,o=s.value,l=r.length>0&&r===o;if(e.isValid=l,i){const d=i.querySelector('[data-rule="match"]');d&&(d.classList.remove("valid","invalid"),(r.length>0||a)&&d.classList.add(l?"valid":"invalid"))}return t.classList.remove("input--valid","input--invalid"),(r.length>0||a)&&t.classList.add(l?"input--valid":"input--invalid"),l}bindInput(e,t,i){if(!e||!this.validationRules[t])return;const a={input:e,type:t,feedbackContainer:i,isValid:!1,touched:!1};this.boundInputs.set(e,a),this.createFeedbackElements(a),this.options.validateOnInput&&(e.addEventListener("input",()=>this.validateInput(a)),e.addEventListener("blur",()=>{a.touched=!0,this.validateInput(a)})),this.validateInput(a,!1)}createFeedbackElements(e){const{feedbackContainer:t,type:i}=e;if(!t)return;t.innerHTML="",t.className="validation-feedback",this.validationRules[i].forEach(s=>{const r=document.createElement("div");r.className="validation-item",r.dataset.rule=s.key,r.innerHTML=`
                <span class="validation-icon"></span>
                <span class="validation-text">${s.message}</span>
            `,t.appendChild(r)})}validateInput(e,t=!0){const{input:i,type:a,feedbackContainer:s,touched:r}=e,o=i.value,l=this.validationRules[a];let d=!0;return l.forEach(w=>{const b=w.test(o);if(b||(d=!1),s&&(t||r)){const p=s.querySelector(`[data-rule="${w.key}"]`);p&&(p.classList.remove("valid","invalid"),(o.length>0||r)&&p.classList.add(b?"valid":"invalid"))}}),e.isValid=d,i.classList.remove("input--valid","input--invalid"),(o.length>0||r)&&t&&i.classList.add(d?"input--valid":"input--invalid"),d}validateAll(){let e=!0;return this.boundInputs.forEach(t=>{t.touched=!0,t.type==="password_confirm"?this.validatePasswordConfirm(t)||(e=!1):this.validateInput(t,!0)||(e=!1)}),e}isValid(){let e=!0;return this.boundInputs.forEach(t=>{t.isValid||(e=!1)}),e}reset(){this.boundInputs.forEach(e=>{e.touched=!1,e.isValid=!1,e.input.classList.remove("input--valid","input--invalid"),e.feedbackContainer&&e.feedbackContainer.querySelectorAll(".validation-item").forEach(i=>i.classList.remove("valid","invalid"))})}getErrors(){const e={};return this.boundInputs.forEach((t,i)=>{const a=i.value,s=this.validationRules[t.type],r=[];s.forEach(o=>{o.test(a)||r.push(o.message)}),r.length>0&&(e[i.name||i.id||t.type]=r)}),e}}class u{constructor(e,t){this.input=e,this.toggleBtn=t,this.isVisible=!1,this.input&&this.toggleBtn&&this.init()}init(){this.toggleBtn.addEventListener("click",e=>{e.preventDefault(),this.toggle()}),this.updateIcon()}toggle(){this.isVisible=!this.isVisible,this.input.type=this.isVisible?"text":"password",this.updateIcon()}updateIcon(){const e='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>',t='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>';this.toggleBtn.innerHTML=this.isVisible?t:e,this.toggleBtn.setAttribute("aria-label",this.isVisible?"Hide password":"Show password")}}class y{constructor(e){this.baseUrl=e.baseUrl||"",this.profileForm=e.profileForm,this.firstNameInput=e.firstNameInput,this.lastNameInput=e.lastNameInput,this.displayName=e.displayName,this.displayEmail=e.displayEmail,this.saveBtn=e.saveBtn,this.showToast=e.showToast||this.defaultToast.bind(this),this.isSubmitting=!1,this.userData=e.userData||null,this.originalFirstName=this.firstNameInput?.value||"",this.originalLastName=this.lastNameInput?.value||"",this.authToken=null,this.validator=null,this.init()}init(){if(this.authToken=this.getTokenFromCookie(),!this.authToken&&!this.userData){this.showToast("Please sign in to view your profile","error"),setTimeout(()=>{window.location.href="/sign_in"},1500);return}this.initValidator(),this.profileForm&&this.profileForm.addEventListener("submit",e=>this.handleSubmit(e)),this.firstNameInput&&this.firstNameInput.addEventListener("input",()=>this.checkForChanges()),this.lastNameInput&&this.lastNameInput.addEventListener("input",()=>this.checkForChanges()),this.saveBtn&&(this.saveBtn.disabled=!0)}initValidator(){const e=document.getElementById("firstNameFeedback"),t=document.getElementById("lastNameFeedback");this.validator=new c({validateOnInput:!0}),this.firstNameInput&&e&&this.validator.bindInput(this.firstNameInput,"first_name",e),this.lastNameInput&&t&&this.validator.bindInput(this.lastNameInput,"last_name",t)}getTokenFromCookie(){const e=document.cookie.split(";");for(const t of e){const[i,a]=t.trim().split("=");if(i==="auth_token")return decodeURIComponent(a)}return null}getAuthToken(){return this.authToken}checkForChanges(){if(!this.saveBtn)return;const e=this.firstNameInput?.value||"",t=this.lastNameInput?.value||"",i=e!==this.originalFirstName||t!==this.originalLastName;this.saveBtn.disabled=!i}async handleSubmit(e){if(e.preventDefault(),this.isSubmitting||this.validator&&!this.validator.validateAll())return;const t=this.firstNameInput?.value.trim()||"",i=this.lastNameInput?.value.trim()||"";this.isSubmitting=!0,this.setButtonLoading(!0);try{const a=m();this.authToken&&(a.Authorization=`Bearer ${this.authToken}`);const s=await fetch(`${this.baseUrl}/api/v1/user`,{method:"PATCH",headers:a,credentials:"same-origin",body:JSON.stringify({first_name:t,last_name:i})}),r=await s.json();s.ok?(this.originalFirstName=t,this.originalLastName=i,this.userData&&(this.userData.first_name=t,this.userData.last_name=i),this.displayName&&(this.displayName.textContent=`${t} ${i}`),this.showToast("Profile updated successfully!","success"),this.saveBtn.disabled=!0):this.handleApiError(r)}catch(a){console.error("Profile update failed:",a),this.showToast("Network error. Please try again.","error")}finally{this.isSubmitting=!1,this.setButtonLoading(!1)}}updateEmail(e){this.userData&&(this.userData.email=e),this.displayEmail&&(this.displayEmail.textContent=e)}getUserInitials(){if(!this.userData)return"?";const e=this.userData.first_name?.[0]||"",t=this.userData.last_name?.[0]||"";return(e+t).toUpperCase()||"?"}getUserData(){return this.userData}setButtonLoading(e){this.saveBtn&&(this.saveBtn.disabled=e,this.saveBtn.textContent=e?"Saving...":"Save Changes",e?this.saveBtn.classList.add("btn--loading"):this.saveBtn.classList.remove("btn--loading"))}handleApiError(e){const t=e.message||"An error occurred. Please try again.";if(this.showToast(t,"error"),e.errors)for(const[i,a]of Object.entries(e.errors))Array.isArray(a)&&a.forEach(s=>this.showToast(`${i}: ${s}`,"error"))}defaultToast(e,t="info"){console.log(`[${t.toUpperCase()}] ${e}`),alert(e)}}class E{constructor(e){this.baseUrl=e.baseUrl||"",this.avatarContainer=e.avatarContainer,this.avatarImage=e.avatarImage,this.avatarPlaceholder=e.avatarPlaceholder,this.fileInput=e.fileInput,this.previewModal=e.previewModal,this.previewImage=e.previewImage,this.confirmBtn=e.confirmBtn,this.cancelBtn=e.cancelBtn,this.showToast=e.showToast||this.defaultToast.bind(this),this.getAuthToken=e.getAuthToken||(()=>null),this.onUploadSuccess=e.onUploadSuccess||(()=>{}),this.selectedFile=null,this.isUploading=!1,this.maxFileSize=5*1024*1024,this.allowedTypes=["image/jpeg","image/png","image/gif","image/webp"],this.init()}init(){if(!this.fileInput||!this.avatarContainer){console.error("AvatarUpload: Required elements not found");return}const e=this.avatarContainer.querySelector(".avatar__overlay");e&&e.addEventListener("click",()=>this.fileInput.click()),this.fileInput.addEventListener("change",t=>this.handleFileSelect(t)),this.confirmBtn&&this.confirmBtn.addEventListener("click",()=>this.uploadAvatar()),this.cancelBtn&&this.cancelBtn.addEventListener("click",()=>this.closePreview()),this.previewModal&&this.previewModal.addEventListener("click",t=>{t.target===this.previewModal&&this.closePreview()})}handleFileSelect(e){const t=e.target.files[0];if(t){if(!this.allowedTypes.includes(t.type)){this.showToast("Please select a valid image file (JPEG, PNG, GIF, or WebP)","error"),this.fileInput.value="";return}if(t.size>this.maxFileSize){this.showToast("Image must be smaller than 5MB","error"),this.fileInput.value="";return}this.selectedFile=t,this.showPreview(t)}}showPreview(e){if(!this.previewModal||!this.previewImage)return;const t=new FileReader;t.onload=i=>{this.previewImage.src=i.target.result,this.previewModal.classList.remove("hidden")},t.readAsDataURL(e)}closePreview(){this.previewModal&&this.previewModal.classList.add("hidden"),this.selectedFile=null,this.fileInput.value=""}async uploadAvatar(){if(!this.selectedFile||this.isUploading)return;this.isUploading=!0,this.setButtonLoading(!0);const e=new FormData;e.append("file",this.selectedFile);try{const t={},i=g();i&&(t["X-CSRF-TOKEN"]=i);const a=await fetch(`${this.baseUrl}/api/v1/upload/avatar`,{method:"POST",headers:t,credentials:"same-origin",body:e}),s=await a.json();if(a.ok&&s.status==="success"){const r=s.upload,o=`${r.url}?variant=small`;this.updateAvatarDisplay(o),this.showToast("Profile picture updated!","success"),this.closePreview(),this.onUploadSuccess(r)}else this.showToast(s.message||"Failed to upload profile picture","error")}catch(t){console.error("Avatar upload failed:",t),this.showToast("Network error. Please try again.","error")}finally{this.isUploading=!1,this.setButtonLoading(!1)}}updateAvatarDisplay(e){this.avatarImage&&(this.avatarImage.src=e,this.avatarImage.classList.remove("hidden")),this.avatarPlaceholder&&this.avatarPlaceholder.classList.add("hidden")}setAvatar(e){if(e){const t=e.includes("?")?`${e}&variant=small`:`${e}?variant=small`;this.updateAvatarDisplay(t)}else this.avatarImage&&this.avatarImage.classList.add("hidden"),this.avatarPlaceholder&&this.avatarPlaceholder.classList.remove("hidden")}setButtonLoading(e){this.confirmBtn&&(this.confirmBtn.disabled=e,this.confirmBtn.textContent=e?"Uploading...":"Save",e?this.confirmBtn.classList.add("btn--loading"):this.confirmBtn.classList.remove("btn--loading"))}defaultToast(e,t="info"){console.log(`[${t.toUpperCase()}] ${e}`),alert(e)}}class I{constructor(e){this.baseUrl=e.baseUrl||"",this.form=e.form,this.currentPasswordInput=e.currentPasswordInput,this.newPasswordInput=e.newPasswordInput,this.confirmPasswordInput=e.confirmPasswordInput,this.submitBtn=e.submitBtn,this.showToast=e.showToast||this.defaultToast.bind(this),this.getAuthToken=e.getAuthToken||(()=>null),this.isSubmitting=!1,this.validator=null,this.currentPasswordToggle=null,this.newPasswordToggle=null,this.confirmPasswordToggle=null,this.init()}init(){if(!this.form){console.error("PasswordChange: Form element not found");return}this.initValidator(),this.initPasswordToggles(),this.form.addEventListener("submit",e=>this.handleSubmit(e))}initValidator(){const e=document.getElementById("currentPasswordFeedback"),t=document.getElementById("newPasswordFeedback"),i=document.getElementById("confirmPasswordFeedback");this.validator=new c({validateOnInput:!0}),this.currentPasswordInput&&e&&this.validator.bindInput(this.currentPasswordInput,"current_password",e),this.newPasswordInput&&t&&this.validator.bindInput(this.newPasswordInput,"new_password",t),this.confirmPasswordInput&&this.newPasswordInput&&i&&this.validator.bindPasswordConfirm(this.confirmPasswordInput,this.newPasswordInput,i)}initPasswordToggles(){const e=document.getElementById("currentPasswordToggle"),t=document.getElementById("newPasswordToggle"),i=document.getElementById("confirmPasswordToggle");this.currentPasswordInput&&e&&(this.currentPasswordToggle=new u(this.currentPasswordInput,e)),this.newPasswordInput&&t&&(this.newPasswordToggle=new u(this.newPasswordInput,t)),this.confirmPasswordInput&&i&&(this.confirmPasswordToggle=new u(this.confirmPasswordInput,i))}async handleSubmit(e){if(e.preventDefault(),this.isSubmitting||this.validator&&!this.validator.validateAll())return;const t=this.currentPasswordInput?.value||"",i=this.newPasswordInput?.value||"",a=this.confirmPasswordInput?.value||"";if(t===i){this.showToast("New password must be different from current password","error");return}this.isSubmitting=!0,this.setButtonLoading(!0);try{const s=m(),r=this.getAuthToken();r&&(s.Authorization=`Bearer ${r}`);const o=await fetch(`${this.baseUrl}/api/v1/password/change-password`,{method:"POST",headers:s,credentials:"same-origin",body:JSON.stringify({current_password:t,new_password:i,confirm_password:a})}),l=await o.json();o.ok?(this.showToast("Password changed successfully! Redirecting to sign in...","success"),this.form.reset(),setTimeout(()=>{window.location.href="/sign_in"},1500)):this.handleApiError(l)}catch(s){console.error("Password change failed:",s),this.showToast("Network error. Please try again.","error")}finally{this.isSubmitting=!1,this.setButtonLoading(!1)}}setButtonLoading(e){this.submitBtn&&(this.submitBtn.disabled=e,this.submitBtn.textContent=e?"Changing...":"Change Password",e?this.submitBtn.classList.add("btn--loading"):this.submitBtn.classList.remove("btn--loading"))}handleApiError(e){const t=e.message||"An error occurred. Please try again.";if(this.showToast(t,"error"),e.errors)for(const[i,a]of Object.entries(e.errors))Array.isArray(a)&&a.forEach(s=>this.showToast(`${i}: ${s}`,"error"))}defaultToast(e,t="info"){console.log(`[${t.toUpperCase()}] ${e}`),alert(e)}}class x{constructor(e){this.baseUrl=e.baseUrl||"",this.step1Card=e.step1Card,this.step2Card=e.step2Card,this.step3Card=e.step3Card,this.step4Card=e.step4Card,this.newEmailForm=e.newEmailForm,this.verifyOldEmailForm=e.verifyOldEmailForm,this.verifyNewEmailForm=e.verifyNewEmailForm,this.newEmailInput=e.newEmailInput,this.oldEmailCodeInput=e.oldEmailCodeInput,this.newEmailCodeInput=e.newEmailCodeInput,this.sendEmailCodeBtn=e.sendEmailCodeBtn,this.verifyOldEmailBtn=e.verifyOldEmailBtn,this.verifyNewEmailBtn=e.verifyNewEmailBtn,this.stepIndicators=e.stepIndicators||[],this.currentEmailDisplay=e.currentEmailDisplay,this.newEmailDisplay=e.newEmailDisplay,this.showToast=e.showToast||this.defaultToast.bind(this),this.getAuthToken=e.getAuthToken||(()=>null),this.currentEmail=e.currentEmail||"",this.currentStep=1,this.isSubmitting=!1,this.newEmail="",this.validator=null,this.init()}init(){this.initValidator(),this.newEmailForm&&this.newEmailForm.addEventListener("submit",e=>this.handleNewEmailSubmit(e)),this.verifyOldEmailForm&&this.verifyOldEmailForm.addEventListener("submit",e=>this.handleVerifyOldEmailSubmit(e)),this.verifyNewEmailForm&&this.verifyNewEmailForm.addEventListener("submit",e=>this.handleVerifyNewEmailSubmit(e)),this.oldEmailCodeInput&&this.oldEmailCodeInput.addEventListener("input",e=>this.formatCodeInput(e)),this.newEmailCodeInput&&this.newEmailCodeInput.addEventListener("input",e=>this.formatCodeInput(e)),document.querySelectorAll('[data-action="cancel"]').forEach(e=>{e.addEventListener("click",()=>this.goToStep(1))})}initValidator(){const e=document.getElementById("newEmailFeedback");this.validator=new c({validateOnInput:!0}),this.newEmailInput&&e&&this.validator.bindInput(this.newEmailInput,"email",e)}async handleNewEmailSubmit(e){if(e.preventDefault(),this.isSubmitting||this.validator&&!this.validator.validateAll())return;const t=this.newEmailInput?.value.trim()||"";if(t.toLowerCase()===this.currentEmail.toLowerCase()){this.showToast("New email cannot be the same as your current email","error");return}this.isSubmitting=!0,this.setButtonLoading(this.sendEmailCodeBtn,!0,"Sending...");const i=m(),a=this.getAuthToken();a&&(i.Authorization=`Bearer ${a}`);try{const s=await fetch(`${this.baseUrl}/api/v1/email/request-change`,{method:"POST",headers:i,credentials:"same-origin",body:JSON.stringify({new_email:t})}),r=await s.json();s.ok?(this.newEmail=t,this.showToast("Verification code sent to your current email!","success"),this.currentEmailDisplay&&(this.currentEmailDisplay.textContent=this.currentEmail),this.goToStep(2)):(this.showToast(r.message||"Failed to send verification code","error"),this.setButtonLoading(this.sendEmailCodeBtn,!1,"Request Email Change"))}catch(s){console.error("Email change request failed:",s),this.showToast("Network error. Please try again.","error"),this.setButtonLoading(this.sendEmailCodeBtn,!1,"Request Email Change")}finally{this.isSubmitting=!1}}async handleVerifyOldEmailSubmit(e){if(e.preventDefault(),this.isSubmitting)return;const t=this.oldEmailCodeInput?.value.trim()||"";if(!t||t.length<32){this.showToast("Please enter the verification code from your current email","error");return}this.isSubmitting=!0,this.setButtonLoading(this.verifyOldEmailBtn,!0,"Verifying...");const i=m(),a=this.getAuthToken();a&&(i.Authorization=`Bearer ${a}`);try{const s=await fetch(`${this.baseUrl}/api/v1/email/verify-old-email`,{method:"POST",headers:i,credentials:"same-origin",body:JSON.stringify({code:t})}),r=await s.json();s.ok?(this.showToast("Old email verified! Check your new email for the next code.","success"),this.newEmailDisplay&&(this.newEmailDisplay.textContent=this.newEmail),this.goToStep(3)):(this.showToast(r.message||"Invalid or expired verification code","error"),this.setButtonLoading(this.verifyOldEmailBtn,!1,"Verify Old Email"))}catch(s){console.error("Old email verification failed:",s),this.showToast("Network error. Please try again.","error"),this.setButtonLoading(this.verifyOldEmailBtn,!1,"Verify Old Email")}finally{this.isSubmitting=!1}}async handleVerifyNewEmailSubmit(e){if(e.preventDefault(),this.isSubmitting)return;const t=this.newEmailCodeInput?.value.trim()||"";if(!t||t.length<32){this.showToast("Please enter the verification code from your new email","error");return}this.isSubmitting=!0,this.setButtonLoading(this.verifyNewEmailBtn,!0,"Completing...");const i=m(),a=this.getAuthToken();a&&(i.Authorization=`Bearer ${a}`);try{const s=await fetch(`${this.baseUrl}/api/v1/email/verify-new-email`,{method:"POST",headers:i,credentials:"same-origin",body:JSON.stringify({code:t})}),r=await s.json();s.ok?(this.showToast("Email changed successfully!","success"),this.goToStep(4),this.startRedirectCountdown()):(this.showToast(r.message||"Invalid or expired verification code","error"),this.setButtonLoading(this.verifyNewEmailBtn,!1,"Complete Email Change"))}catch(s){console.error("New email verification failed:",s),this.showToast("Network error. Please try again.","error"),this.setButtonLoading(this.verifyNewEmailBtn,!1,"Complete Email Change")}finally{this.isSubmitting=!1}}startRedirectCountdown(){let e=5;const t=document.getElementById("redirectCountdown"),i=setInterval(()=>{e--,t&&(t.textContent=e),e<=0&&(clearInterval(i),window.location.href="/sign_in")},1e3)}goToStep(e){this.currentStep=e,this.step1Card?.classList.add("hidden"),this.step2Card?.classList.add("hidden"),this.step3Card?.classList.add("hidden"),this.step4Card?.classList.add("hidden");const t=this.getCardForStep(e);if(t&&(t.classList.remove("hidden"),e<4)){const i=t.querySelector('input:not([type="hidden"])');i&&setTimeout(()=>i.focus(),100)}this.updateStepIndicators(e),this.setButtonLoading(this.sendEmailCodeBtn,!1,"Request Email Change"),this.setButtonLoading(this.verifyOldEmailBtn,!1,"Verify Old Email"),this.setButtonLoading(this.verifyNewEmailBtn,!1,"Complete Email Change"),e===1&&(this.newEmailForm?.reset(),this.verifyOldEmailForm?.reset(),this.verifyNewEmailForm?.reset(),this.newEmail="")}getCardForStep(e){switch(e){case 1:return this.step1Card;case 2:return this.step2Card;case 3:return this.step3Card;case 4:return this.step4Card;default:return null}}updateStepIndicators(e){this.stepIndicators.forEach((t,i)=>{const a=i+1;t.classList.remove("email-step--active","email-step--completed"),a<e?t.classList.add("email-step--completed"):a===e&&t.classList.add("email-step--active")})}formatCodeInput(e){const t=e.target;t.value=t.value.replace(/[^a-zA-Z0-9]/g,"").slice(0,32)}setButtonLoading(e,t,i){e&&(e.disabled=t,e.textContent=i,t?e.classList.add("btn--loading"):e.classList.remove("btn--loading"))}defaultToast(e,t="info"){console.log(`[${t.toUpperCase()}] ${e}`),alert(e)}}function h(n,e="info"){const t={success:"linear-gradient(135deg, #10b981 0%, #059669 100%)",error:"linear-gradient(135deg, #ef4444 0%, #dc2626 100%)",warning:"linear-gradient(135deg, #f59e0b 0%, #d97706 100%)",info:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"};typeof Toastify=="function"?Toastify({text:n,duration:4e3,gravity:"top",position:"right",stopOnFocus:!0,style:{background:t[e]||t.info,borderRadius:"8px",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)"}}).showToast():console.log(`[${e.toUpperCase()}] ${n}`)}function v(){const n=window.BASE_URL||"",e=window.USER_DATA||null,t=new y({baseUrl:n,userData:e,profileForm:document.getElementById("profileForm"),firstNameInput:document.getElementById("first_name"),lastNameInput:document.getElementById("last_name"),displayName:document.getElementById("displayName"),displayEmail:document.getElementById("displayEmail"),saveBtn:document.getElementById("saveProfileBtn"),showToast:h}),i=new E({baseUrl:n,avatarContainer:document.getElementById("avatarContainer"),avatarImage:document.getElementById("avatarImage"),avatarPlaceholder:document.getElementById("avatarPlaceholder"),fileInput:document.getElementById("avatarInput"),previewModal:document.getElementById("avatarPreviewModal"),previewImage:document.getElementById("previewImage"),confirmBtn:document.getElementById("confirmAvatarBtn"),cancelBtn:document.getElementById("cancelAvatarBtn"),showToast:h,getAuthToken:()=>t.getAuthToken(),onUploadSuccess:r=>{console.log("Avatar uploaded:",r)}}),a=new I({baseUrl:n,form:document.getElementById("passwordForm"),currentPasswordInput:document.getElementById("current_password"),newPasswordInput:document.getElementById("new_password"),confirmPasswordInput:document.getElementById("confirm_password"),strengthBar:document.querySelector(".password-strength__bar"),strengthText:document.querySelector(".password-strength-text"),submitBtn:document.getElementById("changePasswordBtn"),showToast:h,getAuthToken:()=>t.getAuthToken()}),s=new x({baseUrl:n,step1Card:document.getElementById("emailStep1"),step2Card:document.getElementById("emailStep2"),step3Card:document.getElementById("emailStep3"),step4Card:document.getElementById("emailStep4"),newEmailForm:document.getElementById("newEmailForm"),verifyOldEmailForm:document.getElementById("verifyOldEmailForm"),verifyNewEmailForm:document.getElementById("verifyNewEmailForm"),newEmailInput:document.getElementById("new_email"),oldEmailCodeInput:document.getElementById("old_email_code"),newEmailCodeInput:document.getElementById("new_email_code"),sendEmailCodeBtn:document.getElementById("sendEmailCodeBtn"),verifyOldEmailBtn:document.getElementById("verifyOldEmailBtn"),verifyNewEmailBtn:document.getElementById("verifyNewEmailBtn"),stepIndicators:Array.from(document.querySelectorAll(".email-step")),currentEmailDisplay:document.getElementById("currentEmailDisplay"),newEmailDisplay:document.getElementById("newEmailDisplay"),currentEmail:e?.email||"",showToast:h,getAuthToken:()=>t.getAuthToken()});window.profilePage=t,window.avatarUpload=i,window.passwordChange=a,window.emailChange=s}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",v):v()})();
