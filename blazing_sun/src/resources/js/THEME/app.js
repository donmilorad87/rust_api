(function(){"use strict";function _(){const m=document.querySelector('meta[name="csrf-token"]');return m?m.getAttribute("content"):(console.warn('CSRF token not found. Ensure <meta name="csrf-token"> exists in page head.'),null)}function h(m={}){const e=_(),t={"Content-Type":"application/json",...m};return e&&(t["X-CSRF-TOKEN"]=e),t}const L=2,v="inline",b="reference",P=new Set(["Action","BioChemEntity","CreativeWork","Event","Intangible","MedicalEntity","Organization","Person","Place","Product","Taxon"]);class x{constructor(e){this.baseUrl=e.baseUrl||"",this.showToast=e.showToast||console.log,this.getAuthToken=e.getAuthToken||(()=>null),this.tabButtons=e.tabButtons,this.tabPanels=e.tabPanels,this.logoSelector=e.logoSelector,this.logoPreview=e.logoPreview,this.logoPlaceholder=e.logoPlaceholder,this.faviconSelector=e.faviconSelector,this.faviconPreview=e.faviconPreview,this.faviconPlaceholder=e.faviconPlaceholder,this.lightColorsContainer=e.lightColorsContainer,this.darkColorsContainer=e.darkColorsContainer,this.typographyContainer=e.typographyContainer,this.spacingContainer=e.spacingContainer,this.borderRadiusContainer=e.borderRadiusContainer,this.themeModeToggle=e.themeModeToggle,this.lightColorsSection=document.getElementById("lightColors"),this.darkColorsSection=document.getElementById("darkColors"),this.buildBtn=e.buildBtn,this.buildOverlay=e.buildOverlay,this.buildStatus=e.buildStatus,this.buildProgress=e.buildProgress,this.imageModal=e.imageModal,this.imageModalTitle=e.imageModalTitle,this.imageGrid=e.imageGrid,this.imageFileInput=e.imageFileInput,this.removeImageBtn=e.removeImageBtn,this.schemaModal=e.schemaModal,this.schemaModalTitle=e.schemaModalTitle,this.schemaModalTabs=e.schemaModalTabs,this.schemaCreatePanel=e.schemaCreatePanel,this.schemaAssignPanel=e.schemaAssignPanel,this.schemaAssignmentContainer=e.schemaAssignmentContainer,this.schemaSelectorContainer=e.schemaSelectorContainer,this.schemaFormContainer=e.schemaFormContainer,this.schemaFormBuilderContainer=e.schemaFormBuilderContainer,this.schemaPreview=e.schemaPreview,this.schemaPreviewCode=e.schemaPreviewCode,this.saveSchemaBtn=e.saveSchemaBtn,this.togglePreviewBtn=e.togglePreviewBtn,this.addSchemaBtn=e.addSchemaBtn,this.schemasList=e.schemasList,this.schemasEmpty=e.schemasEmpty,this.assignedSchemasList=e.assignedSchemasList,this.assignedSchemasEmpty=e.assignedSchemasEmpty,this.languageForm=e.languageForm,this.languageResetBtn=e.languageResetBtn,this.languageIconFile=e.languageIconFile,this.languageIconPreview=e.languageIconPreview,this.languageIconClear=e.languageIconClear,this.languagesTableBody=e.languagesTableBody,this.localeForm=e.localeForm,this.localeResetBtn=e.localeResetBtn,this.localeLanguageSelect=e.localeLanguageSelect,this.localesTableBody=e.localesTableBody,this.localizationForm=e.localizationForm,this.localizationResetBtn=e.localizationResetBtn,this.localizationNewBtn=e.localizationNewBtn,this.localizationKeysTableBody=e.localizationKeysTableBody,this.translationInputs=e.translationInputs,this.localizationModal=e.localizationModal,this.localizationModalTitle=e.localizationModalTitle,this.localizationLocaleTabs=e.localizationLocaleTabs,this.localizationCancelBtn=e.localizationCancelBtn,this.seoLanguageTabs=e.seoLanguageTabs,this.seoAddPageBtn=e.seoAddPageBtn,this.seoPageModal=e.seoPageModal,this.seoPageModalTitle=e.seoPageModalTitle,this.seoPageForm=e.seoPageForm,this.seoPageRouteName=e.seoPageRouteName,this.seoPageLabel=e.seoPageLabel,this.seoPageSaveBtn=e.seoPageSaveBtn,this.seoPageCancelBtn=e.seoPageCancelBtn,this.hreflangForm=e.hreflangForm,this.hreflangIdInput=e.hreflangIdInput,this.hreflangCodeInput=e.hreflangCodeInput,this.hreflangUrlInput=e.hreflangUrlInput,this.hreflangDefaultInput=e.hreflangDefaultInput,this.hreflangCancelBtn=e.hreflangCancelBtn,this.hreflangTableBody=e.hreflangTableBody,this.ColorPicker=e.ColorPicker,this.SizePicker=e.SizePicker,this.SchemaSelector=e.SchemaSelector,this.SchemaFormBuilder=e.SchemaFormBuilder,this.PageSchemaAssignment=e.PageSchemaAssignment,this.SchemaDefinitions=e.SchemaDefinitions,this.originalConfig=null,this.currentConfig=null,this.colorPickers=[],this.sizePickers=[],this.hasUnsavedChanges=!1,this.isBuilding=!1,this.currentImageTarget=null,this.logoUuid=null,this.faviconUuid=null,this.logoStorageType="public",this.faviconStorageType="public",this.seoPages=[],this.currentSeoPage=null,this.seoFormElements=null,this.currentSchemaType=null,this.currentSchemaPath=[],this.editingSchemaId=null,this.editingSchemaEntityId=null,this.pageSchemas=[],this.availableSchemas=[],this.schemaSelectorInstance=null,this.schemaFormBuilderInstance=null,this.pageSchemaAssignmentInstance=null,this.schemaModalMode="create",this.schemaDefinitionCache=new Map,this.languages=[],this.locales=[],this.localizationKeys=[],this.editingLanguageId=null,this.editingLocaleId=null,this.editingLocalizationKeyId=null,this.localizationTranslations={},this.activeLocalizationLocale=null,this.seoLanguages=[],this.activeSeoLanguage="en",this.seoTranslations={},this.currentSeoTranslation=null,this.hreflangEntries=[],this.siteName="Blazing Sun",this.showSiteName=!0,this.identityColorStart="#3498db",this.identityColorEnd="#764ba2",this.identitySize="1.375rem",this.domColorPickers=[],this.domAnglePickers=[],this.scssVariables={typography:[{name:"font-size-base",label:"Base Font Size",unit:"rem",min:.75,max:1.5,step:.0625},{name:"font-size-sm",label:"Small Font Size",unit:"rem",min:.5,max:1.25,step:.0625},{name:"font-size-lg",label:"Large Font Size",unit:"rem",min:1,max:2,step:.0625},{name:"font-size-xl",label:"Extra Large Font Size",unit:"rem",min:1.25,max:3,step:.125},{name:"font-size-2xl",label:"2X Large Font Size",unit:"rem",min:1.5,max:4,step:.125},{name:"font-size-3xl",label:"3X Large Font Size",unit:"rem",min:2,max:5,step:.25}],spacing:[{name:"spacing-xs",label:"Extra Small",unit:"rem",min:.125,max:.5,step:.0625},{name:"spacing-sm",label:"Small",unit:"rem",min:.25,max:1,step:.125},{name:"spacing-md",label:"Medium",unit:"rem",min:.5,max:1.5,step:.125},{name:"spacing-lg",label:"Large",unit:"rem",min:1,max:2.5,step:.25},{name:"spacing-xl",label:"Extra Large",unit:"rem",min:1.5,max:4,step:.25},{name:"spacing-2xl",label:"2X Large",unit:"rem",min:2,max:6,step:.5}],borderRadius:[{name:"radius-sm",label:"Small Radius",unit:"rem",min:0,max:1,step:.0625},{name:"radius-md",label:"Medium Radius",unit:"rem",min:0,max:1.5,step:.125},{name:"radius-lg",label:"Large Radius",unit:"rem",min:0,max:2,step:.125},{name:"radius-xl",label:"Extra Large Radius",unit:"rem",min:0,max:3,step:.25}],colors:[{name:"color-primary",label:"Primary Color",type:"color"},{name:"color-primary-dark",label:"Primary Dark",type:"color"},{name:"color-secondary",label:"Secondary Color",type:"color"}]},this.init()}async init(){console.log("ThemeConfig.init() starting..."),this.setupTabs(),this.setupThemeModeToggle(),this.setupActionButtons(),this.setupImageModal(),this.setupSchemaModal(),this.setupImageSelectors(),this.setupIdentity(),this.setupBeforeUnload(),this.setupSEO(),this.setupLocalization(),this.initializeDomColorPickers(),this.initializeDomAnglePickers(),this.initializeDomSizePickers(),console.log("Loading config..."),await this.loadConfig(),await this.loadLocalizationData(),console.log("ThemeConfig.init() completed")}setupTabs(){this.tabButtons&&this.tabButtons.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tab;this.switchTab(t)})})}setupThemeModeToggle(){if(!this.themeModeToggle)return;this.themeModeToggle.querySelectorAll(".theme-mode-toggle__btn").forEach(t=>{t.addEventListener("click",()=>{const a=t.dataset.mode;this.switchThemeMode(a)})})}switchThemeMode(e){if(!this.themeModeToggle)return;this.themeModeToggle.querySelectorAll(".theme-mode-toggle__btn").forEach(a=>{const s=a.dataset.mode===e;a.classList.toggle("theme-mode-toggle__btn--active",s)}),this.lightColorsSection&&this.darkColorsSection&&(e==="light"?(this.lightColorsSection.removeAttribute("hidden"),this.darkColorsSection.setAttribute("hidden","")):(this.lightColorsSection.setAttribute("hidden",""),this.darkColorsSection.removeAttribute("hidden")))}switchTab(e){this.tabButtons.forEach(t=>{const a=t.dataset.tab===e;t.classList.toggle("theme-tabs__tab--active",a),t.setAttribute("aria-selected",a)}),this.tabPanels.forEach(t=>{const a=t.id===`panel-${e}`;t.classList.toggle("theme-panel--active",a),a?t.removeAttribute("hidden"):t.setAttribute("hidden","")})}setupActionButtons(){this.buildBtn&&this.buildBtn.addEventListener("click",()=>this.triggerBuild());const e=document.getElementById("brandingSaveBtn");e&&e.addEventListener("click",()=>this.saveBranding(e));const t=document.getElementById("colorsSaveBtn");t&&t.addEventListener("click",()=>this.saveColors(t));const a=document.getElementById("typographySaveBtn");a&&a.addEventListener("click",()=>this.saveTypography(a));const s=document.getElementById("spacingSaveBtn");s&&s.addEventListener("click",()=>this.saveSpacing(s))}setupImageModal(){this.imageModal&&(this.imageModal.addEventListener("click",e=>{(e.target===this.imageModal||e.target.closest('[data-action="close"]'))&&this.closeImageModal()}),this.imageFileInput&&this.imageFileInput.addEventListener("change",e=>this.handleImageUpload(e)),this.removeImageBtn&&this.removeImageBtn.addEventListener("click",()=>{this.removeCurrentImage(),this.closeImageModal()}))}setupSchemaModal(){this.schemaModal&&(this.schemaModal.addEventListener("click",e=>{(e.target===this.schemaModal||e.target.closest('[data-action="close"]'))&&this.closeSchemaModal()}),this.schemaSelectorContainer&&this.SchemaSelector&&(this.schemaSelectorInstance=new this.SchemaSelector({container:this.schemaSelectorContainer,baseUrl:this.baseUrl,csrfHeaders:{},onSelect:(e,t,a)=>{this.currentSchemaType=e,this.currentSchemaPath=t.map(s=>s.type||s),e?this.onSchemaTypeSelected(e,a):this.hideSchemaForm()},onPathChange:e=>{this.currentSchemaPath=e.map(t=>t.type||t)}})),this.schemaFormBuilderContainer&&this.SchemaFormBuilder&&(this.schemaFormBuilderInstance=new this.SchemaFormBuilder({container:this.schemaFormBuilderContainer,baseUrl:this.baseUrl,csrfHeaders:{},maxDepth:2,onChange:()=>{this.updateSchemaPreview(),this.saveSchemaBtn&&(this.saveSchemaBtn.disabled=!1)}})),this.saveSchemaBtn&&this.saveSchemaBtn.addEventListener("click",()=>this.saveCurrentSchema()),this.togglePreviewBtn&&this.togglePreviewBtn.addEventListener("click",()=>this.toggleSchemaPreview()),this.addSchemaBtn&&this.addSchemaBtn.addEventListener("click",()=>{this.openSchemaModal()}),this.setupSchemaModalTabs())}async onSchemaTypeSelected(e,t=!1){if(!e){this.hideSchemaForm();return}this.schemaFormBuilderInstance&&await this.schemaFormBuilderInstance.loadSchema(e),this.showSchemaForm(),this.updateSchemaPreview(),this.saveSchemaBtn&&(this.saveSchemaBtn.disabled=!1)}showSchemaForm(){this.schemaFormContainer&&this.schemaFormContainer.classList.remove("hidden"),this.schemaPreview&&this.schemaPreview.classList.remove("hidden")}hideSchemaForm(){this.schemaFormContainer&&this.schemaFormContainer.classList.add("hidden"),this.schemaPreview&&this.schemaPreview.classList.add("hidden"),this.saveSchemaBtn&&(this.saveSchemaBtn.disabled=!0)}setupLocalizationModal(){this.localizationModal&&(this.localizationModal.addEventListener("click",e=>{(e.target===this.localizationModal||e.target.closest('[data-action="close"]'))&&this.closeLocalizationModal()}),this.localizationCancelBtn&&this.localizationCancelBtn.addEventListener("click",()=>this.closeLocalizationModal()))}openLocalizationModal(e=null){this.localizationModal&&(e?(this.populateLocalizationForm(e),this.localizationModalTitle&&(this.localizationModalTitle.textContent="Edit Localization Key")):(this.resetLocalizationForm(),this.localizationModalTitle&&(this.localizationModalTitle.textContent="New Localization Key")),this.localizationModal.classList.remove("hidden"))}closeLocalizationModal(){this.localizationModal&&(this.localizationModal.classList.add("hidden"),this.resetLocalizationForm())}async loadSchemaCategories(){if(!this.schemaCategorySelect||this.schemaCategoryPopulated)return;let e=!1;try{const t=await fetch(`${this.baseUrl}/api/v1/schemas/categories`,{credentials:"include"});if(!t.ok)throw new Error("Failed to load schema categories");const a=await t.json();this.schemaCategories=a.categories||[],e=Array.isArray(this.schemaCategories)&&this.schemaCategories.length>0}catch(t){console.error("Failed to load schema categories",t)}if(!e&&this.applySchemaCategoryFallback()&&this.showToast("Using offline schema catalog for categories","warning"),!this.schemaCategories.length){this.showToast("Failed to load schema categories","error");return}this.renderSchemaCategorySelect(),this.schemaCategoryPopulated=!0}applySchemaCategoryFallback(){if(!this.SchemaDefinitions||!this.SchemaDefinitions.SCHEMA_CATEGORIES)return!1;const e=Object.keys(this.SchemaDefinitions.SCHEMA_CATEGORIES).filter(t=>P.has(t)).map(t=>{const a=this.SchemaDefinitions.SCHEMA_CATEGORIES[t]||{},s=typeof this.SchemaDefinitions.hasSchemaChildren=="function"?this.SchemaDefinitions.hasSchemaChildren(t):!1;return{type:t,label:a.label||t,description:a.description||"",has_children:s}}).filter(t=>t.label);return e.length?(this.schemaCategories=e,!0):!1}renderSchemaCategorySelect(){if(!this.schemaCategorySelect)return;for(;this.schemaCategorySelect.options.length>1;)this.schemaCategorySelect.remove(1);const e=document.createDocumentFragment();this.schemaCategories.forEach(t=>{const a=document.createElement("option");a.value=t.type,a.textContent=t.label||t.type,e.appendChild(a)}),this.schemaCategorySelect.appendChild(e)}async loadSchemaChildren(e){if(!e)return[];if(this.schemaChildrenCache.has(e))return this.schemaChildrenCache.get(e);try{const t=await fetch(`${this.baseUrl}/api/v1/schemas/children/${encodeURIComponent(e)}`,{credentials:"include"});if(!t.ok)throw new Error(`Failed to load schema children for ${e}`);const s=(await t.json()).children||[];return this.schemaChildrenCache.set(e,s),s}catch(t){console.error(`Failed to load schema children for ${e}`,t);const a=this.getSchemaChildrenFallback(e);if(a.length)return this.schemaChildrenCache.set(e,a),a;throw t}}getSchemaChildrenFallback(e){return!e||!this.SchemaDefinitions||typeof this.SchemaDefinitions.getSchemaChildren!="function"?[]:this.SchemaDefinitions.getSchemaChildren(e)}clearSchemaHierarchy(){this.schemaHierarchyContainer&&(this.schemaHierarchyContainer.innerHTML="")}async renderSchemaLevel(e,t,a=""){if(!this.schemaHierarchyContainer)return;let s=[];try{s=await this.loadSchemaChildren(e)}catch(n){this.showToast("Failed to load schema children","error"),console.error(n);return}if(!s.length){await this.onSchemaTypeChange(e);return}const i=document.createElement("select");i.className="form-select schema-hierarchy__select",i.dataset.depth=String(t),i.dataset.parent=e,i.innerHTML='<option value="">-- Select a schema type --</option>',s.forEach(n=>{const o=document.createElement("option");o.value=n.type,o.textContent=n.label||n.type,i.appendChild(o)}),i.addEventListener("change",n=>{const o=n.target.value;this.trimSchemaHierarchy(t),o?this.renderSchemaLevel(o,t+1):this.onSchemaTypeChange("")}),this.schemaHierarchyContainer.appendChild(i),a&&(i.value=a,a&&this.renderSchemaLevel(a,t+1))}trimSchemaHierarchy(e){if(!this.schemaHierarchyContainer)return;Array.from(this.schemaHierarchyContainer.querySelectorAll(".schema-hierarchy__select")).forEach(a=>{parseInt(a.dataset.depth||"0",10)>e&&a.remove()})}async onSchemaTypeChange(e){if(!e){this.currentSchemaType=null,this.schemaFields&&this.schemaFields.classList.add("hidden"),this.schemaPreview&&this.schemaPreview.classList.add("hidden"),this.saveSchemaBtn&&(this.saveSchemaBtn.disabled=!0),this.schemaTypeDescription&&(this.schemaTypeDescription.textContent="Select a schema type to configure structured data");return}let t;try{t=await this.fetchSchemaDefinition(e)}catch(s){this.showToast("Schema type not found","error"),console.error(s);return}this.currentSchemaType=e,this.schemaTypeDescription&&(this.schemaTypeDescription.textContent=t.description||"Schema definition loaded.");const a=this.buildFieldsFromSchemaDefinition(t);this.generateSchemaFields({type:e,fields:a}),this.schemaFields&&this.schemaFields.classList.remove("hidden"),this.schemaPreview&&this.schemaPreview.classList.remove("hidden"),this.updateSchemaPreview(),this.saveSchemaBtn&&(this.saveSchemaBtn.disabled=!1)}buildSchemaIdDefault(e){const t=(this.activeSeoLanguage||"en").toLowerCase(),a=(e||"entity").toLowerCase(),s=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():Date.now().toString(36);return`urn:${t}:entity:${a}:${s}`}generateSchemaFields(e){if(!this.schemaFields)return;this.schemaFields.innerHTML="";const t={name:"@id",type:"text",label:"@id",help:"Defaults to urn:language:entity:type:uuid (editable).",value:this.buildSchemaIdDefault(e.type)};(e.fields.some(s=>s.name==="@id")?e.fields:[t,...e.fields]).forEach(s=>{if(s.type==="hidden")return;const i=this.generateFieldHtml(s,"",0);this.schemaFields.insertAdjacentHTML("beforeend",i)}),this.setupSchemaFieldListeners()}generateFieldHtml(e,t="",a=0){const s=t?`${t}_${e.name}`:`schema_${e.name}`,i=e.required?"form-group--required":"",n=e.placeholder||"",o=e.help||"",l=e.value===void 0||e.value===null?"":String(e.value),r=this.escapeHtml(l),c=r?` value="${r}"`:"";let d="";switch(e.type){case"text":case"url":case"email":case"tel":d=`<input type="${e.type}" id="${s}" class="form-input schema-field"
          data-field="${e.name}" placeholder="${n}"${c}>`;break;case"number":d=`<input type="number" id="${s}" class="form-input schema-field"
          data-field="${e.name}" placeholder="${n}" step="any"${c}>`;break;case"date":d=`<input type="date" id="${s}" class="form-input schema-field"
          data-field="${e.name}"${c}>`;break;case"datetime":d=`<input type="datetime-local" id="${s}" class="form-input schema-field"
          data-field="${e.name}"${c}>`;break;case"textarea":d=`<textarea id="${s}" class="form-textarea schema-field"
          data-field="${e.name}" rows="3" placeholder="${n}">${r}</textarea>`;break;case"select":const u=(e.options||[]).map(p=>`<option value="${p.value}">${p.label}</option>`).join("");d=`<select id="${s}" class="form-select schema-field" data-field="${e.name}">
          <option value="">-- Select --</option>
          ${u}
        </select>`;break;case"boolean":d=`
          <label class="checkbox-label">
            <input type="checkbox" id="${s}" class="form-checkbox schema-field"
              data-field="${e.name}">
            <span>${e.label}</span>
          </label>`;break;case"array":d=this.generateArrayFieldHtml(e,s);break;case"nested":d=this.generateNestedFieldHtml(e,s,a);break;case"entity":d=this.generateEntityFieldHtml(e,s,a);break;case"mixed":d=this.generateMixedFieldHtml(e,s,a);break;default:d=`<input type="text" id="${s}" class="form-input schema-field"
          data-field="${e.name}" placeholder="${n}">`}return e.type==="boolean"?`<div class="form-group ${i}">${d}</div>`:`
      <div class="form-group ${i}">
        <label for="${s}" class="form-label">${e.label}</label>
        ${d}
        ${o?`<p class="form-help">${o}</p>`:""}
      </div>
    `}generateArrayFieldHtml(e,t){return`
      <div class="schema-array" data-field="${e.name}" data-item-type="${e.itemType||"text"}">
        <div class="schema-array__header">
          <span class="schema-array__title">${e.label}</span>
        </div>
        <div class="schema-array__items" id="${t}_items">
          <!-- Items added dynamically -->
        </div>
        <button type="button" class="schema-array__add" data-array="${t}">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add Item
        </button>
      </div>
    `}generateNestedFieldHtml(e,t,a=0){const i=(e.fields||[]).filter(n=>n.type!=="hidden").map(n=>this.generateFieldHtml(n,t,a+1)).join("");return`
      <div class="schema-nested" data-field="${e.name}" data-schema="${e.schema||""}">
        <div class="schema-nested__header">
          <span class="schema-nested__title">${e.label}</span>
        </div>
        <div class="schema-nested__fields">
          ${i}
        </div>
      </div>
    `}getDataInputType(e,t){const a=new Set(e||[]);return a.has("Boolean")?"boolean":a.has("DateTime")?"datetime":a.has("Date")?"date":a.has("Number")||a.has("Float")||a.has("Integer")?"number":a.has("URL")?"url":t.toLowerCase().includes("description")?"textarea":"text"}mapDataTypeToFieldType(e,t){const a=this.getDataInputType([e],t);return a==="textarea"?"textarea":a==="datetime"?"datetime":a==="date"?"date":a==="number"?"number":a==="boolean"?"boolean":a==="url"?"url":"text"}async fetchSchemaDefinition(e){if(!e)throw new Error("Schema type is required");if(this.schemaDefinitionCache.has(e))return this.schemaDefinitionCache.get(e);const t=await fetch(`${this.baseUrl}/api/v1/schemas/${encodeURIComponent(e)}`,{credentials:"include"});if(!t.ok)throw new Error(`Schema type ${e} not found`);const a=await t.json(),s=a.schema||a;return this.schemaDefinitionCache.set(e,s),s}buildFieldsFromSchemaDefinition(e){return(e?.properties||[]).map(a=>{const s=a.expected_types||[],i=s.filter(l=>l.kind==="data_type").map(l=>l.type),n=s.filter(l=>l.kind!=="data_type").map(l=>l.type),o={name:a.name,label:a.label||a.name,help:a.description||"",dataTypes:i,entityTypes:n};return n.length&&i.length?{...o,type:"mixed"}:n.length?{...o,type:"entity"}:i.length>1?{...o,type:"mixed"}:i.length===1?{...o,type:this.mapDataTypeToFieldType(i[0],a.name)}:{...o,type:"text"}})}buildInlineEntityFields(e,t,a){const s=this.schemaDefinitionCache.get(e);if(!s)return'<p class="form-help">Schema type not available yet.</p>';const i={name:"@id",type:"text",label:"@id",help:"Defaults to urn:language:entity:type:uuid (editable).",value:this.buildSchemaIdDefault(e)},n=this.buildFieldsFromSchemaDefinition(s);return(n.some(l=>l.name==="@id")?n:[i,...n]).filter(l=>l.type!=="hidden").map(l=>this.generateFieldHtml(l,t,a)).join("")}generateEntityFieldHtml(e,t,a=0){const s=e.entityTypes||[],i=s[0]||"Thing",n=a<L,o=b,l=s.length?s.join(" or "):"entity",r=n?this.buildInlineEntityFields(i,t,a+1):'<p class="form-help">Inline editing is disabled at this depth. Use @id reference.</p>',c=s.map((d,u)=>`
        <label class="schema-radio">
          <input type="radio" class="schema-entity__type-radio" name="${t}_type"
            value="${d}"${u===0?" checked":""}>
          <span>${d}</span>
        </label>
      `).join("");return`
      <div class="schema-entity" data-field="${e.name}" data-mode="${o}" data-prefix="${t}" data-depth="${a}">
        <div class="schema-entity__header">
          <span class="schema-entity__title">${e.label}</span>
          ${n?`
            <label class="schema-entity__toggle">
              <input type="checkbox" class="schema-entity__toggle-input" data-action="inline-toggle">
              Enter manually
            </label>
          `:""}
        </div>
        ${s.length>1?`
          <div class="schema-entity__types">
            ${c}
          </div>
        `:s.length===1?`
          <div class="schema-entity__types">
            ${c}
          </div>
        `:""}
        <div class="schema-entity__reference">
          <input type="text" class="form-input schema-entity__ref" placeholder="urn:language:entity:type:uuid">
          <p class="form-help">Use @id to reference existing ${l}, or enable manual entry.</p>
        </div>
        <div class="schema-entity__inline hidden">
          <div class="schema-entity__inline-fields">
            ${r}
          </div>
        </div>
      </div>
    `}generateMixedFieldHtml(e,t,a=0){const s=e.dataTypes||[],i=e.entityTypes||[];s[0];const n=i[0]||"Thing",o=a<L,l=this.getDataInputType(s,e.name),r=o?this.buildInlineEntityFields(n,t,a+1):'<p class="form-help">Inline editing is disabled at this depth. Use reference.</p>',c=s.map((p,g)=>`
        <label class="schema-radio">
          <input type="radio" class="schema-mixed__type-radio" name="${t}_expected_type"
            data-kind="data" value="${p}"${g===0&&!i.length?" checked":""}>
          <span>${p}</span>
        </label>
      `).join(""),d=i.map((p,g)=>`
        <label class="schema-radio">
          <input type="radio" class="schema-mixed__type-radio" name="${t}_expected_type"
            data-kind="entity" value="${p}"${g===0&&!s.length?" checked":""}>
          <span>${p}</span>
        </label>
      `).join(""),u=s.length&&i.length;return`
      <div class="schema-mixed" data-field="${e.name}" data-prefix="${t}" data-depth="${a}">
        <div class="schema-mixed__header">
          <span class="schema-mixed__title">${e.label}</span>
        </div>
        <div class="schema-mixed__types">
          ${c}
          ${d}
        </div>
        <div class="schema-mixed__data${i.length&&!s.length?" hidden":""}${u?" hidden":""}">
          ${l==="textarea"?'<textarea class="form-textarea schema-mixed__data-input" rows="3" placeholder="Enter value..."></textarea>':`<input type="${l}" class="form-input schema-mixed__data-input" placeholder="Enter value...">`}
        </div>
        <div class="schema-mixed__entity schema-entity${s.length?" hidden":""}${u?" hidden":""}" data-mode="${b}" data-prefix="${t}" data-depth="${a}">
          <div class="schema-entity__header">
            <span class="schema-entity__title">Entity</span>
            ${o?`
              <label class="schema-entity__toggle">
                <input type="checkbox" class="schema-entity__toggle-input" data-action="inline-toggle">
                Enter manually
              </label>
            `:""}
          </div>
          <div class="schema-entity__reference">
            <input type="text" class="form-input schema-entity__ref" placeholder="urn:language:entity:type:uuid">
            <p class="form-help">Use @id to reference an entity, or enable manual entry.</p>
          </div>
          <div class="schema-entity__inline hidden">
            <div class="schema-entity__inline-fields">
              ${r}
            </div>
          </div>
        </div>
      </div>
    `}setupSchemaFieldListeners(){this.schemaFields&&(this.schemaFieldListenersBound||(this.schemaFieldListenersBound=!0,this.schemaFields.addEventListener("input",()=>{this.updateSchemaPreview()}),this.schemaFields.addEventListener("change",()=>{this.updateSchemaPreview()}),this.schemaFields.addEventListener("click",e=>{const t=e.target.closest(".schema-array__add");if(t){const s=t.dataset.array;this.addArrayItem(s);return}const a=e.target.closest(".schema-entity__toggle-input");if(a){const s=a.closest(".schema-entity");if(!s)return;const i=a.checked?v:b;this.setEntityMode(s,i)}}),this.schemaFields.addEventListener("change",e=>{const t=e.target.closest(".schema-entity__type-radio");if(t){const s=t.closest(".schema-entity");if(!s)return;this.updateEntityInlineFields(s);return}const a=e.target.closest(".schema-mixed__type-radio");if(a){const s=a.closest(".schema-mixed");if(!s)return;this.updateMixedField(s)}})))}setEntityMode(e,t){e.dataset.mode=t;const a=e.querySelector(".schema-entity__inline"),s=e.querySelector(".schema-entity__reference"),i=e.querySelector(".schema-entity__toggle-input");a&&a.classList.toggle("hidden",t!==v),s&&s.classList.toggle("hidden",t!==b),i&&(i.checked=t===v),t===v&&this.updateEntityInlineFields(e),this.updateSchemaPreview()}async updateEntityInlineFields(e){const t=e.querySelector(".schema-entity__inline-fields");if(!t||e.dataset.mode!==v)return;let s=e.querySelector(".schema-entity__type-radio:checked")?.value;s||(s=e.closest(".schema-mixed")?.querySelector('.schema-mixed__type-radio[data-kind="entity"]:checked')?.value),s||(s="Thing");const i=e.dataset.prefix||`${e.dataset.field}_entity`,n=parseInt(e.dataset.depth||"0",10)+1;try{await this.fetchSchemaDefinition(s),t.innerHTML=this.buildInlineEntityFields(s,i,n)}catch(o){t.innerHTML='<p class="form-help">Failed to load schema type.</p>',console.error(o)}this.updateSchemaPreview()}updateMixedField(e){const t=e.querySelector(".schema-mixed__type-radio:checked");if(!t)return;const a=t.value||"",s=t.dataset.kind||"data",i=e.querySelector(".schema-mixed__data"),n=e.querySelector(".schema-mixed__entity");if(s==="entity"){i&&i.classList.add("hidden"),n&&n.classList.remove("hidden"),n&&(n.dataset.selectedType=a,this.setEntityMode(n,b));return}if(i&&i.classList.remove("hidden"),n&&n.classList.add("hidden"),i){const o=a,l=e.dataset.field||"",r=this.getDataInputType([o],l),c=i.querySelector(".schema-mixed__data-input");c&&(r==="textarea"?c.tagName.toLowerCase()!=="textarea"&&(i.innerHTML='<textarea class="form-textarea schema-mixed__data-input" rows="3" placeholder="Enter value..."></textarea>'):(c.tagName.toLowerCase()!=="input"||c.type!==r)&&(i.innerHTML=`<input type="${r}" class="form-input schema-mixed__data-input" placeholder="Enter value...">`))}this.updateSchemaPreview()}addArrayItem(e){const t=document.getElementById(`${e}_items`),a=t?.closest(".schema-array");if(!t||!a)return;a.dataset.itemType;const s=t.children.length,i=`${e}_item_${s}`,n=`
      <div class="schema-array__item" data-index="${s}">
        <input type="text" id="${i}" class="form-input schema-array-item" placeholder="Enter value...">
        <button type="button" class="schema-array__remove" data-remove="${i}">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    `;t.insertAdjacentHTML("beforeend",n);const o=t.querySelector(`[data-remove="${i}"]`);o&&o.addEventListener("click",()=>{o.closest(".schema-array__item")?.remove(),this.updateSchemaPreview()}),document.getElementById(i)?.focus(),this.updateSchemaPreview()}collectSchemaData(){return this.currentSchemaType?this.schemaFormBuilderInstance?this.schemaFormBuilderInstance.getData():this.editingSchemaEntityId&&this.schemaFields?this.collectEntityEditFormData():null:null}collectEntityEditFormData(){if(!this.schemaFields)return{};const e={};return this.schemaFields.querySelectorAll(".schema-form__field-group").forEach(t=>{const a=t.dataset.fieldName;if(!a)return;const s=t.querySelector("input, textarea");if(!s)return;let i=s.value;if(s.dataset.type==="object")try{i=JSON.parse(i)}catch{}else s.type==="number"?i=i?parseFloat(i):null:i=i.trim();i!==null&&i!==""&&i!==void 0&&(e[a]=i)}),e}collectSchemaDataFromContainer(e){if(!e)return{};const t={};return e.querySelectorAll(".schema-field").forEach(a=>{const s=a.dataset.field;if(!s||a.closest(".schema-nested, .schema-entity, .schema-mixed")&&a.closest(".schema-nested, .schema-entity, .schema-mixed")!==e)return;let i;a.type==="checkbox"?i=a.checked:a.type==="number"?i=a.value?parseFloat(a.value):null:i=a.value.trim(),i!==null&&i!==""&&i!==!1&&(t[s]=i)}),e.querySelectorAll(".schema-array").forEach(a=>{if(a.closest(".schema-nested, .schema-entity, .schema-mixed")&&a.closest(".schema-nested, .schema-entity, .schema-mixed")!==e)return;const s=a.dataset.field;if(!s)return;const i=[];a.querySelectorAll(".schema-array-item").forEach(n=>{const o=n.value.trim();o&&i.push(o)}),i.length>0&&(t[s]=i)}),e.querySelectorAll(".schema-nested").forEach(a=>{if(a.closest(".schema-entity, .schema-mixed")&&a.closest(".schema-entity, .schema-mixed")!==e)return;const s=a.dataset.field,i=a.dataset.schema;if(!s)return;const n=this.collectSchemaDataFromContainer(a);i&&(n["@type"]=i),Object.keys(n).length>1&&(t[s]=n)}),e.querySelectorAll(".schema-entity").forEach(a=>{if(a.closest(".schema-entity, .schema-mixed")&&a.closest(".schema-entity, .schema-mixed")!==e)return;const s=a.dataset.field;if(!s)return;if((a.dataset.mode||v)===b){const d=a.querySelector(".schema-entity__ref")?.value.trim();d&&(t[s]={"@id":d});return}const o=a.querySelector(".schema-entity__type-radio:checked")?.value,l=a.querySelector(".schema-entity__inline"),r=this.collectSchemaDataFromContainer(l);o&&(r["@type"]=o),Object.keys(r).length>1&&(t[s]=r)}),e.querySelectorAll(".schema-mixed").forEach(a=>{if(a.closest(".schema-mixed")&&a.closest(".schema-mixed")!==e)return;const s=a.dataset.field;if(!s)return;const i=a.querySelector(".schema-mixed__type-radio:checked"),n=i?.value||"";if((i?.dataset.kind||"data")==="entity"){const c=a.querySelector(".schema-mixed__entity");if(!c)return;if((c.dataset.mode||v)===b){const E=c.querySelector(".schema-entity__ref")?.value.trim();E&&(t[s]={"@id":E});return}const u=n||c.dataset.selectedType,p=c.querySelector(".schema-entity__inline"),g=this.collectSchemaDataFromContainer(p);u&&(g["@type"]=u),Object.keys(g).length>1&&(t[s]=g);return}const l=a.querySelector(".schema-mixed__data-input");if(!l)return;let r;l.type==="checkbox"?r=l.checked:l.type==="number"?r=l.value?parseFloat(l.value):null:r=l.value.trim(),r!==null&&r!==""&&r!==!1&&(t[s]=r)}),t}buildJsonLd(e,t){const a={"@context":"https://schema.org","@type":e,...t};return Object.keys(a).forEach(s=>{(a[s]===""||a[s]===null||a[s]===void 0)&&delete a[s],Array.isArray(a[s])&&a[s].length===0&&delete a[s]}),a}updateSchemaPreview(){if(!this.schemaPreviewCode||!this.currentSchemaType)return;const e=this.collectSchemaData(),t=this.buildJsonLd(this.currentSchemaType,e||{});this.schemaPreviewCode.textContent=JSON.stringify(t,null,2)}toggleSchemaPreview(){if(!this.schemaPreview)return;const e=this.schemaPreview.querySelector(".schema-preview__code");if(e&&e.classList.toggle("hidden"),this.togglePreviewBtn){const t=this.togglePreviewBtn.querySelector("svg");t&&(t.style.transform=e?.classList.contains("hidden")?"rotate(-90deg)":"")}}closeSchemaModal(){this.schemaModal&&this.schemaModal.classList.add("hidden"),this.resetSchemaModal()}resetSchemaModal(){this.currentSchemaType=null,this.currentSchemaPath=[],this.editingSchemaId=null,this.editingSchemaEntityId=null,this.schemaModalMode="create",this.schemaModalTabs&&this.schemaModalTabs.classList.remove("hidden"),this.switchSchemaModalTab("create"),this.schemaSelectorInstance&&this.schemaSelectorInstance.reset(),this.schemaFormBuilderInstance&&this.schemaFormBuilderInstance.reset(),this.hideSchemaForm(),this.schemaPreviewCode&&(this.schemaPreviewCode.textContent="{}"),this.schemaModalTitle&&(this.schemaModalTitle.textContent="Add Schema")}switchSchemaModalTab(e){this.schemaModalMode=e,this.schemaModalTabs&&this.schemaModalTabs.querySelectorAll(".schema-modal-tabs__tab").forEach(t=>{t.dataset.tab===e?t.classList.add("schema-modal-tabs__tab--active"):t.classList.remove("schema-modal-tabs__tab--active")}),this.schemaCreatePanel&&this.schemaCreatePanel.classList.toggle("hidden",e!=="create"),this.schemaAssignPanel&&this.schemaAssignPanel.classList.toggle("hidden",e!=="assign"),this.saveSchemaBtn&&this.saveSchemaBtn.classList.toggle("hidden",e==="assign"),e==="assign"&&this.schemaAssignmentContainer&&this.initPageSchemaAssignment()}initPageSchemaAssignment(){!this.pageSchemaAssignmentInstance&&this.PageSchemaAssignment?(this.pageSchemaAssignmentInstance=new this.PageSchemaAssignment({container:this.schemaAssignmentContainer,baseUrl:this.baseUrl,showToast:this.showToast,csrfHeaders:h(),langCode:this.activeSeoLanguage,onAssign:e=>this.handleEntityAssignment(e)}),this.pageSchemaAssignmentInstance.init()):this.pageSchemaAssignmentInstance&&this.pageSchemaAssignmentInstance.setLangCode(this.activeSeoLanguage)}async handleEntityAssignment(e){if(!this.currentSeoPage){this.showToast("Please select a page first","error");return}try{const t=await fetch(`${this.baseUrl}/api/v1/admin/seo/page/${this.currentSeoPage.id}/schemas`,{method:"POST",headers:h(),credentials:"include",body:JSON.stringify({lang_code:this.activeSeoLanguage,schema_type:e.schema_type,schema_data:e.schema_data,is_active:!0})});if(!t.ok)throw new Error("Failed to assign schema");const a=await t.json();if(a.status==="success")this.showToast("Schema assigned to page","success"),this.closeSchemaModal(),this.loadPageSchemas(this.currentSeoPage.id);else throw new Error(a.message||"Unknown error")}catch(t){console.error("Assign schema error:",t),this.showToast(`Failed to assign schema: ${t.message}`,"error")}}setupSchemaModalTabs(){this.schemaModalTabs&&this.schemaModalTabs.querySelectorAll(".schema-modal-tabs__tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tab;t&&this.switchSchemaModalTab(t)})})}async saveCurrentSchema(){if(!this.currentSchemaType){this.showToast("Please select a schema type first","error");return}if(!this.editingSchemaEntityId&&!this.currentSeoPage){this.showToast("Please select an SEO page first","error");return}const e=this.collectSchemaData();if(!e||Object.keys(e).length===0){this.showToast("Please fill in at least one field","error");return}const t=this.buildJsonLd(this.currentSchemaType,e);try{if(this.editingSchemaEntityId){const a=await fetch(`${this.baseUrl}/api/v1/admin/seo/entities`,{method:"POST",headers:{"Content-Type":"application/json",...h()},credentials:"include",body:JSON.stringify({lang_code:this.activeSeoLanguage,schema_id:this.editingSchemaEntityId,schema_type:this.currentSchemaType,schema_data:t})});if(!a.ok)throw new Error("Failed to update schema entity");const s=await a.json();if(s.status==="success")this.showToast("Schema entity updated","success"),this.closeSchemaModal(),await this.loadAvailableSchemas();else throw new Error(s.message||"Unknown error")}else{const a=this.editingSchemaId?`${this.baseUrl}/api/v1/admin/seo/schema/${this.editingSchemaId}`:`${this.baseUrl}/api/v1/admin/seo/page/${this.currentSeoPage.id}/schemas`,s=this.editingSchemaId?"PUT":"POST",i=await fetch(a,{method:s,headers:{"Content-Type":"application/json",...h()},credentials:"include",body:JSON.stringify({lang_code:this.activeSeoLanguage,schema_type:this.currentSchemaType,schema_data:t,is_active:!0})});if(!i.ok)throw new Error("Failed to save schema");const n=await i.json();if(n.status==="success")this.showToast(this.editingSchemaId?"Schema updated":"Schema added","success"),this.closeSchemaModal(),this.loadPageSchemas(this.currentSeoPage.id);else throw new Error(n.message||"Unknown error")}}catch(a){console.error("Save schema error:",a),this.showToast(`Failed to save schema: ${a.message}`,"error")}}async loadPageSchemas(e){console.log("[loadPageSchemas] Loading schemas for page:",e,"lang:",this.activeSeoLanguage);try{const t=`${this.baseUrl}/api/v1/admin/seo/page/${e}/schemas?lang_code=${encodeURIComponent(this.activeSeoLanguage)}`;console.log("[loadPageSchemas] Fetching:",t);const a=await fetch(t,{headers:h(),credentials:"include"});if(console.log("[loadPageSchemas] Response status:",a.status),!a.ok){const i=await a.text();throw console.error("[loadPageSchemas] Error response:",i),new Error("Failed to load schemas")}const s=await a.json();console.log("[loadPageSchemas] Result:",s),s.status==="success"&&(this.pageSchemas=s.schemas||[],console.log("[loadPageSchemas] Loaded schemas:",this.pageSchemas.length,this.pageSchemas),this.renderAssignedSchemasList())}catch(t){console.error("[loadPageSchemas] Load schemas error:",t),this.pageSchemas=[],this.renderAssignedSchemasList()}await this.loadAvailableSchemas()}async loadAvailableSchemas(){try{const e=await fetch(`${this.baseUrl}/api/v1/admin/seo/entities?lang_code=${encodeURIComponent(this.activeSeoLanguage)}&limit=200`,{headers:h(),credentials:"include"});if(!e.ok)throw new Error("Failed to load available schemas");const t=await e.json();t.status==="success"&&(this.availableSchemas=t.entities||[],this.renderAvailableSchemasList())}catch(e){console.error("Load available schemas error:",e),this.availableSchemas=[],this.renderAvailableSchemasList()}}renderAvailableSchemasList(){if(this.schemasList){if(this.schemasList.querySelectorAll(".schema-card").forEach(e=>e.remove()),this.availableSchemas.length===0){this.schemasEmpty&&this.schemasEmpty.classList.remove("hidden");return}this.schemasEmpty&&this.schemasEmpty.classList.add("hidden"),this.availableSchemas.forEach(e=>{const t=this.pageSchemas.some(o=>{const l=o.schema_data?.["@id"];return l&&l===e.schema_id}),a=e.schema_type||"Unknown",s=e.schema_data||{},i=s.name||s.title||s["@id"]||e.schema_id||"",n=`
        <div class="schema-card ${t?"schema-card--assigned":""}" data-schema-id="${this.escapeHtml(e.schema_id)}" data-entity-id="${e.id}">
          <div class="schema-card__icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="16 18 22 12 16 6"></polyline>
              <polyline points="8 6 2 12 8 18"></polyline>
            </svg>
          </div>
          <div class="schema-card__content">
            <div class="schema-card__type">${this.escapeHtml(a)}</div>
            <div class="schema-card__description">${this.escapeHtml(i)}</div>
          </div>
          <div class="schema-card__actions">
            <button type="button" class="schema-card__btn schema-card__btn--assign ${t?"hidden":""}" data-action="assign" title="Add to this page">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
            <span class="schema-card__assigned-badge ${t?"":"hidden"}">Assigned</span>
            <button type="button" class="schema-card__btn schema-card__btn--delete" data-action="delete" title="Delete schema">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
              </svg>
            </button>
          </div>
        </div>
      `;this.schemasList.insertAdjacentHTML("beforeend",n)}),this.schemasList.querySelectorAll(".schema-card").forEach(e=>{const t=e.dataset.schemaId;e.addEventListener("click",a=>{a.target.closest(".schema-card__actions")||this.openSchemaEntityForEdit(t)}),e.style.cursor="pointer",e.querySelector('[data-action="assign"]')?.addEventListener("click",a=>{a.stopPropagation(),this.assignSchemaToCurrentPage(t)}),e.querySelector('[data-action="delete"]')?.addEventListener("click",a=>{a.stopPropagation(),this.deleteSchemaEntity(t)})})}}async deleteSchemaEntity(e){const a=this.availableSchemas.find(s=>s.schema_id===e)?.schema_type||"this schema";if(confirm(`Delete "${a}"?

This will also remove it from all pages where it is assigned.`))try{const s=await fetch(`${this.baseUrl}/api/v1/admin/seo/entities/${encodeURIComponent(e)}?lang_code=${encodeURIComponent(this.activeSeoLanguage)}`,{method:"DELETE",headers:h(),credentials:"include"});if(!s.ok){const n=await s.json().catch(()=>({}));throw new Error(n.message||"Failed to delete schema")}const i=await s.json();if(i.status==="success")this.showToast("Schema deleted","success"),await this.loadAvailableSchemas(),this.currentSeoPage&&await this.loadPageSchemas(this.currentSeoPage.id);else throw new Error(i.message||"Unknown error")}catch(s){console.error("Delete schema error:",s),this.showToast(`Failed to delete schema: ${s.message}`,"error")}}async assignSchemaToCurrentPage(e){if(!this.currentSeoPage){this.showToast("Please select a page first","error");return}try{const t=this.availableSchemas.find(i=>i.schema_id===e);if(!t)throw new Error("Schema entity not found");const a=await fetch(`${this.baseUrl}/api/v1/admin/seo/page/${this.currentSeoPage.id}/schemas`,{method:"POST",headers:{"Content-Type":"application/json",...h()},credentials:"include",body:JSON.stringify({lang_code:this.activeSeoLanguage,schema_type:t.schema_type,schema_data:t.schema_data,is_active:!0})});if(!a.ok){const i=await a.json().catch(()=>({}));throw new Error(i.message||"Failed to assign schema")}const s=await a.json();if(s.status==="success")this.showToast("Schema assigned to page","success"),await this.loadPageSchemas(this.currentSeoPage.id),this.renderAvailableSchemasList();else throw new Error(s.message||"Unknown error")}catch(t){console.error("Assign schema error:",t),this.showToast(`Failed to assign schema: ${t.message}`,"error")}}async openSchemaEntityForEdit(e){const t=this.availableSchemas.find(a=>a.schema_id===e);if(!t){this.showToast("Schema entity not found","error");return}this.editingSchemaEntityId=e,this.editingSchemaId=null,await this.openSchemaEntityEditModal(t)}async openSchemaEntityEditModal(e){if(!this.schemaModal){this.showToast("Schema modal not available","error");return}this.currentSchemaType=e.schema_type,this.schemaModalMode="edit",this.schemaModalTitle&&(this.schemaModalTitle.textContent=`Edit Schema: ${e.schema_type}`),this.schemaModalTabs&&this.schemaModalTabs.classList.add("hidden"),this.schemaCreatePanel&&this.schemaCreatePanel.classList.remove("hidden"),this.schemaAssignPanel&&this.schemaAssignPanel.classList.add("hidden"),this.buildSchemaEntityEditForm(e),this.schemaModal.classList.remove("hidden")}buildSchemaEntityEditForm(e){if(!this.schemaFormBuilderContainer)return;const t=e.schema_data||{},a=e.schema_type||"Thing";this.schemaFormBuilderContainer.innerHTML="";const s=`
      <div class="schema-form schema-form--entity-edit">
        <div class="schema-form__header">
          <div class="schema-form__type-badge">${this.escapeHtml(a)}</div>
          <p class="schema-form__hint">Edit the JSON-LD properties below</p>
        </div>
        <div class="schema-form__fields" id="schemaEntityFields"></div>
      </div>
    `;this.schemaFormBuilderContainer.innerHTML=s;const i=document.getElementById("schemaEntityFields");i&&(this.buildFieldsFromJsonLd(i,t,a),this.schemaFields=i,this.schemaPreview&&this.schemaPreview.classList.remove("hidden"),this.saveSchemaBtn&&(this.saveSchemaBtn.disabled=!1),this.updateSchemaPreview())}buildFieldsFromJsonLd(e,t,a){if(!e||!t)return;const s=new Set(["@context","@type"]);Object.entries(t).forEach(([n,o])=>{if(s.has(n))return;const l=this.createFieldFromValue(n,o);e.insertAdjacentHTML("beforeend",l)}),e.insertAdjacentHTML("beforeend",`
      <div class="schema-form__add-field">
        <button type="button" class="schema-form__add-field-btn" id="addSchemaFieldBtn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add Field
        </button>
      </div>
    `),document.getElementById("addSchemaFieldBtn")?.addEventListener("click",()=>{this.addNewSchemaField(e)}),e.querySelectorAll(".schema-form__remove-field-btn").forEach(n=>{n.addEventListener("click",o=>{const l=o.target.closest(".schema-form__field-group");l&&(l.remove(),this.updateSchemaPreview())})}),e.querySelectorAll("input, textarea").forEach(n=>{n.addEventListener("input",()=>this.updateSchemaPreview())})}createFieldFromValue(e,t){const a=typeof t=="string"&&(t.startsWith("http://")||t.startsWith("https://")),s=typeof t=="string"&&t.length>100,i=a?"url":typeof t=="number"?"number":"text";let n;return typeof t=="object"&&t!==null?n=`<textarea class="schema-form__input schema-form__textarea" data-field="${this.escapeHtml(e)}" data-type="object" rows="4">${this.escapeHtml(JSON.stringify(t,null,2))}</textarea>`:s?n=`<textarea class="schema-form__input schema-form__textarea" data-field="${this.escapeHtml(e)}" rows="3">${this.escapeHtml(String(t||""))}</textarea>`:n=`<input type="${i}" class="schema-form__input" data-field="${this.escapeHtml(e)}" value="${this.escapeHtml(String(t||""))}">`,`
      <div class="schema-form__field-group" data-field-name="${this.escapeHtml(e)}">
        <div class="schema-form__field-header">
          <label class="schema-form__label">${this.escapeHtml(e)}</label>
          <button type="button" class="schema-form__remove-field-btn" title="Remove field">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        ${n}
      </div>
    `}addNewSchemaField(e){const t=prompt('Enter field name (e.g., "name", "description", "url"):');if(!t||!t.trim())return;const a=t.trim();if(e.querySelector(`[data-field-name="${a}"]`)){this.showToast("Field already exists","warning");return}const s=this.createFieldFromValue(a,""),i=e.querySelector(".schema-form__add-field");i?i.insertAdjacentHTML("beforebegin",s):e.insertAdjacentHTML("beforeend",s);const n=e.querySelector(`[data-field-name="${a}"]`);n&&(n.querySelector(".schema-form__remove-field-btn")?.addEventListener("click",()=>{n.remove(),this.updateSchemaPreview()}),n.querySelector("input, textarea")?.addEventListener("input",()=>this.updateSchemaPreview())),this.updateSchemaPreview()}async unassignSchemaFromPage(e){try{if(!(await fetch(`${this.baseUrl}/api/v1/admin/seo/schema/${e}`,{method:"DELETE",headers:h(),credentials:"include"})).ok)throw new Error("Failed to remove schema");this.showToast("Schema removed from page","success"),await this.loadPageSchemas(this.currentSeoPage.id),this.renderAvailableSchemasList()}catch(t){console.error("Unassign schema error:",t),this.showToast(`Failed to remove schema: ${t.message}`,"error")}}renderAssignedSchemasList(){if(console.log("[renderAssignedSchemasList] Called, element exists:",!!this.assignedSchemasList),console.log("[renderAssignedSchemasList] pageSchemas:",this.pageSchemas),!this.assignedSchemasList){console.warn("[renderAssignedSchemasList] assignedSchemasList element not found");return}if(this.assignedSchemasList.querySelectorAll(".schema-card").forEach(e=>e.remove()),!this.pageSchemas||this.pageSchemas.length===0){console.log("[renderAssignedSchemasList] No schemas, showing empty state"),this.assignedSchemasEmpty&&this.assignedSchemasEmpty.classList.remove("hidden");return}console.log("[renderAssignedSchemasList] Rendering",this.pageSchemas.length,"schemas"),this.assignedSchemasEmpty&&this.assignedSchemasEmpty.classList.add("hidden"),this.pageSchemas.forEach(e=>{const a=this.schemaDefinitionCache?.get(e.schema_type)?.label||e.schema_type||"Unknown",s=e.schema_data?.["@id"]||e.entity_schema_id||"",i=e.schema_data?.name||e.schema_data?.title||s||"",n=`
        <div class="schema-card" data-page-schema-id="${e.id}" data-schema-id="${this.escapeHtml(s)}">
          <div class="schema-card__icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="16 18 22 12 16 6"></polyline>
              <polyline points="8 6 2 12 8 18"></polyline>
            </svg>
          </div>
          <div class="schema-card__content">
            <div class="schema-card__type">${this.escapeHtml(a)}</div>
            <div class="schema-card__description">${this.escapeHtml(i)}</div>
          </div>
          <div class="schema-card__actions">
            <button type="button" class="schema-card__btn schema-card__btn--danger" data-action="remove" title="Remove from this page">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
        </div>
      `;this.assignedSchemasList.insertAdjacentHTML("beforeend",n)}),this.assignedSchemasList.querySelectorAll(".schema-card").forEach(e=>{const t=e.dataset.pageSchemaId;e.querySelector('[data-action="remove"]')?.addEventListener("click",a=>{a.stopPropagation(),this.unassignSchemaFromPage(t)})})}editSchema(e){const t=this.pageSchemas.find(a=>String(a.id)===String(e));if(!t){this.showToast("Schema not found","error");return}this.editingSchemaId=e,this.openSchemaModal(t)}async deleteSchema(e){if(confirm("Are you sure you want to delete this schema?"))try{if(!(await fetch(`${this.baseUrl}/api/v1/admin/seo/schema/${e}`,{method:"DELETE",headers:h(),credentials:"include"})).ok)throw new Error("Failed to delete schema");this.showToast("Schema deleted","success"),this.loadPageSchemas(this.currentSeoPage.id)}catch(t){console.error("Delete schema error:",t),this.showToast(`Failed to delete schema: ${t.message}`,"error")}}setupImageSelectors(){this.logoSelector&&(this.logoSelector.addEventListener("click",()=>this.openImageModal("logo")),this.logoSelector.addEventListener("keydown",e=>{(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),this.openImageModal("logo"))})),this.faviconSelector&&(this.faviconSelector.addEventListener("click",()=>this.openImageModal("favicon")),this.faviconSelector.addEventListener("keydown",e=>{(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),this.openImageModal("favicon"))}))}setupIdentity(){this.identityElements={siteName:document.getElementById("siteName"),showSiteName:document.getElementById("showSiteName"),colorStart:document.getElementById("identityColorStart"),colorStartHex:document.getElementById("identityColorStartHex"),colorEnd:document.getElementById("identityColorEnd"),colorEndHex:document.getElementById("identityColorEndHex"),sizeRange:document.getElementById("identitySizeRange"),sizeValue:document.getElementById("identitySizeValue"),previewText:document.getElementById("identityPreviewText")};const e=this.identityElements;e.siteName&&e.siteName.addEventListener("input",()=>{this.siteName=e.siteName.value||"Blazing Sun",this.updateIdentityPreview(),this.markUnsaved()}),e.showSiteName&&e.showSiteName.addEventListener("change",()=>{this.showSiteName=e.showSiteName.checked,this.updateIdentityPreview(),this.markUnsaved()}),e.colorStart&&e.colorStartHex&&(e.colorStart.addEventListener("input",()=>{this.identityColorStart=e.colorStart.value,e.colorStartHex.value=e.colorStart.value,this.updateIdentityPreview(),this.markUnsaved()}),e.colorStartHex.addEventListener("input",()=>{const t=e.colorStartHex.value;/^#[0-9A-Fa-f]{6}$/.test(t)&&(this.identityColorStart=t,e.colorStart.value=t,this.updateIdentityPreview(),this.markUnsaved())})),e.colorEnd&&e.colorEndHex&&(e.colorEnd.addEventListener("input",()=>{this.identityColorEnd=e.colorEnd.value,e.colorEndHex.value=e.colorEnd.value,this.updateIdentityPreview(),this.markUnsaved()}),e.colorEndHex.addEventListener("input",()=>{const t=e.colorEndHex.value;/^#[0-9A-Fa-f]{6}$/.test(t)&&(this.identityColorEnd=t,e.colorEnd.value=t,this.updateIdentityPreview(),this.markUnsaved())})),e.sizeRange&&e.sizeValue&&(e.sizeRange.addEventListener("input",()=>{const t=e.sizeRange.value;this.identitySize=`${t}rem`,e.sizeValue.value=t,this.updateIdentityPreview(),this.markUnsaved()}),e.sizeValue.addEventListener("input",()=>{const t=parseFloat(e.sizeValue.value);t>=.875&&t<=2&&(this.identitySize=`${t}rem`,e.sizeRange.value=t,this.updateIdentityPreview(),this.markUnsaved())}))}updateIdentityPreview(){const e=this.identityElements;!e||!e.previewText||(e.previewText.textContent=this.siteName||"Blazing Sun",e.previewText.style.fontSize=this.identitySize,e.previewText.style.background=`linear-gradient(135deg, ${this.identityColorStart} 0%, ${this.identityColorEnd} 100%)`,e.previewText.style.webkitBackgroundClip="text",e.previewText.style.webkitTextFillColor="transparent",e.previewText.style.backgroundClip="text")}setupBeforeUnload(){window.addEventListener("beforeunload",e=>{this.hasUnsavedChanges&&(e.preventDefault(),e.returnValue="")})}initializeDomColorPickers(){document.querySelectorAll(".color-picker[data-var][data-type]").forEach(t=>{const a=t.dataset.var,s=t.dataset.type,i=t.querySelector(".color-picker__color"),n=t.querySelector(".color-picker__hex");!i||!n||(this.domColorPickers.push({element:t,varName:a,themeType:s,colorInput:i,hexInput:n}),i.addEventListener("input",()=>{n.value=i.value,this.handleDomColorChange(s,a,i.value)}),n.addEventListener("input",()=>{const o=n.value;/^#[0-9A-Fa-f]{6}$/.test(o)&&(i.value=o,this.handleDomColorChange(s,a,o))}))}),console.log(`Initialized ${this.domColorPickers.length} DOM color pickers`)}initializeDomAnglePickers(){document.querySelectorAll(".angle-picker[data-var][data-type]").forEach(t=>{const a=t.dataset.var,s=t.dataset.type,i=t.querySelector(".angle-picker__range"),n=t.querySelector(".angle-picker__number");!i||!n||(this.domAnglePickers.push({element:t,varName:a,themeType:s,rangeInput:i,numberInput:n}),i.addEventListener("input",()=>{n.value=i.value,this.handleDomAngleChange(s,a,i.value)}),n.addEventListener("input",()=>{const o=parseInt(n.value,10);o>=0&&o<=360&&(i.value=o,this.handleDomAngleChange(s,a,o))}))}),console.log(`Initialized ${this.domAnglePickers.length} DOM angle pickers`)}initializeDomSizePickers(){document.querySelectorAll(".size-picker[data-var][data-type]").forEach(t=>{const a=t.dataset.var,s=t.dataset.type,i=t.querySelector(".size-picker__number"),n=t.querySelector(".size-picker__unit"),o=t.querySelector(".size-picker__preview, .radius-preview");if(!i)return;const l={element:t,varName:a,themeType:s,numberInput:i,unitSelect:n,preview:o};this.sizePickers.push(l),i.addEventListener("input",()=>{const r=parseFloat(i.value),c=n?n.value:"rem";this.handleDomSizeChange(a,r,c),o&&(a.includes("font")?o.style.fontSize=`${r}${c}`:a.includes("radius")&&(o.style.borderRadius=`${r}${c}`))}),n&&n.addEventListener("change",()=>{const r=parseFloat(i.value),c=n.value;this.handleDomSizeChange(a,r,c)})}),console.log(`Initialized ${this.sizePickers.length} DOM size pickers`)}handleDomColorChange(e,t,a){this.currentConfig&&(console.log(`handleDomColorChange: ${e}, ${t} = ${a}`),e==="light"?(this.currentConfig.theme_light||(this.currentConfig.theme_light={}),this.currentConfig.theme_light[t]=a):e==="dark"?(this.currentConfig.theme_dark||(this.currentConfig.theme_dark={}),this.currentConfig.theme_dark[t]=a):e==="scss"&&(this.currentConfig.scss_variables||(this.currentConfig.scss_variables={}),this.currentConfig.scss_variables[t]=a),this.markUnsaved())}handleDomAngleChange(e,t,a){this.currentConfig&&(console.log(`handleDomAngleChange: ${e}, ${t} = ${a}`),e==="light"?(this.currentConfig.theme_light||(this.currentConfig.theme_light={}),this.currentConfig.theme_light[t]=parseInt(a,10)):e==="dark"&&(this.currentConfig.theme_dark||(this.currentConfig.theme_dark={}),this.currentConfig.theme_dark[t]=parseInt(a,10)),this.markUnsaved())}handleDomSizeChange(e,t,a){this.currentConfig&&(this.currentConfig.scss_variables||(this.currentConfig.scss_variables={}),this.currentConfig.scss_variables[e]=`${t}${a}`,this.markUnsaved())}async loadConfig(){console.log("loadConfig() called, fetching from:",`${this.baseUrl}/api/v1/admin/theme`);try{const e=await fetch(`${this.baseUrl}/api/v1/admin/theme`,{headers:h(),credentials:"include"});if(console.log("loadConfig response status:",e.status),!e.ok)throw new Error("Failed to load theme configuration");const t=await e.json();if(console.log("loadConfig result:",t),t.status==="success")this.originalConfig=JSON.parse(JSON.stringify(t.config)),this.currentConfig=t.config,console.log("currentConfig.theme_light:",this.currentConfig.theme_light),console.log("currentConfig.theme_dark:",this.currentConfig.theme_dark),this.populateForm();else throw new Error(t.message||"Unknown error")}catch(e){console.error("Failed to load config:",e),this.showToast("Failed to load theme configuration","error")}}populateForm(){if(this.currentConfig){if(this.logoUuid=this.currentConfig.logo_uuid,this.logoStorageType=this.currentConfig.logo_storage_type||"public",this.faviconUuid=this.currentConfig.favicon_uuid,this.faviconStorageType=this.currentConfig.favicon_storage_type||"public",this.updateImagePreview("logo",this.logoUuid,this.logoStorageType),this.updateImagePreview("favicon",this.faviconUuid,this.faviconStorageType),this.siteName=this.currentConfig.site_name||"Blazing Sun",this.showSiteName=this.currentConfig.show_site_name!==!1,this.identityColorStart=this.currentConfig.identity_color_start||"#3498db",this.identityColorEnd=this.currentConfig.identity_color_end||"#764ba2",this.identitySize=this.currentConfig.identity_size||"1.375rem",this.identityElements){const e=this.identityElements;e.siteName&&(e.siteName.value=this.siteName),e.showSiteName&&(e.showSiteName.checked=this.showSiteName),e.colorStart&&(e.colorStart.value=this.identityColorStart),e.colorStartHex&&(e.colorStartHex.value=this.identityColorStart),e.colorEnd&&(e.colorEnd.value=this.identityColorEnd),e.colorEndHex&&(e.colorEndHex.value=this.identityColorEnd);const t=parseFloat(this.identitySize);e.sizeRange&&(e.sizeRange.value=t),e.sizeValue&&(e.sizeValue.value=t)}this.updateIdentityPreview(),this.populateDomColorPickers(),this.populateDomAnglePickers(),this.populateDomSizePickers()}}populateDomColorPickers(){const e=this.currentConfig.theme_light||{},t=this.currentConfig.theme_dark||{},a=this.currentConfig.scss_variables||{};this.domColorPickers.forEach(({varName:s,themeType:i,colorInput:n,hexInput:o})=>{let l="#000000";i==="light"?l=e[s]||"#000000":i==="dark"?l=t[s]||"#000000":i==="scss"&&(l=a[s]||"#667eea"),n.value=l,o.value=l}),console.log("Populated DOM color pickers with API values")}populateDomAnglePickers(){const e=this.currentConfig.theme_light||{},t=this.currentConfig.theme_dark||{};this.domAnglePickers.forEach(({varName:a,themeType:s,rangeInput:i,numberInput:n})=>{let o=135;s==="light"?o=e[a]??135:s==="dark"&&(o=t[a]??135),i.value=o,n.value=o}),console.log("Populated DOM angle pickers with API values")}populateDomSizePickers(){const e=this.currentConfig.scss_variables||{};this.sizePickers.forEach(({varName:t,numberInput:a,unitSelect:s,preview:i})=>{const n=e[t];if(!n)return;const o=parseFloat(n),l=n.replace(/[\d.-]/g,"")||"rem";if(a.value=o,s){for(let r=0;r<s.options.length;r++)if(s.options[r].value===l){s.selectedIndex=r;break}}i&&(t.includes("font")?i.style.fontSize=n:t.includes("radius")&&(i.style.borderRadius=n))}),console.log("Populated DOM size pickers with API values")}updatePreview(){}markUnsaved(){this.hasUnsavedChanges=!0}markSaved(){this.hasUnsavedChanges=!1}async openImageModal(e){if(this.currentImageTarget=e,this.imageModalTitle){const a={logo:"Select Logo",favicon:"Select Favicon",og_image:"Select OG Image",twitter_image:"Select Twitter Image"};this.imageModalTitle.textContent=a[e]||"Select Image"}let t=null;e==="logo"?t=this.logoUuid:e==="favicon"?t=this.faviconUuid:e==="og_image"?t=this.currentSeoTranslation?.og_image_uuid:e==="twitter_image"&&(t=this.currentSeoTranslation?.twitter_image_uuid),this.removeImageBtn&&(t?this.removeImageBtn.classList.remove("hidden"):this.removeImageBtn.classList.add("hidden")),await this.loadUserUploads(),this.imageModal&&this.imageModal.classList.remove("hidden")}closeImageModal(){this.imageModal&&this.imageModal.classList.add("hidden"),this.currentImageTarget=null}async loadUserUploads(){if(this.imageGrid){this.imageGrid.innerHTML='<div class="loading">Loading images...</div>';try{const e=await fetch(`${this.baseUrl}/api/v1/upload/user`,{headers:h(),credentials:"include"});if(!e.ok)throw new Error("Failed to load uploads");const s=((await e.json()).uploads||[]).filter(i=>i.mime_type&&i.mime_type.startsWith("image/"));if(s.length===0){this.imageGrid.innerHTML='<div class="image-grid__empty">No images found. Upload one above!</div>';return}this.imageGrid.innerHTML="",s.forEach(i=>{const n=document.createElement("div");n.className="image-grid__item";const o=i.storage_type==="public"?`/api/v1/upload/download/public/${i.uuid}?variant=thumb`:`/api/v1/upload/private/${i.uuid}?variant=thumb`,l=i.storage_type==="private"?'<span class="image-grid__private-badge" title="Private - will be copied to public">Private</span>':"";n.innerHTML=`
          <img src="${o}" alt="${i.original_name}">
          ${l}
          <span class="image-grid__name">${i.original_name}</span>
        `,n.addEventListener("click",()=>this.selectImage(i.uuid,i.storage_type)),this.imageGrid.appendChild(n)})}catch(e){console.error("Failed to load uploads:",e),this.imageGrid.innerHTML='<div class="image-grid__error">Failed to load images</div>'}}}async selectImage(e,t="public"){this.currentImageTarget==="logo"?(this.logoUuid=e,this.logoStorageType=t,this.updateImagePreview("logo",e,t),this.markUnsaved()):this.currentImageTarget==="favicon"?(this.faviconUuid=e,this.faviconStorageType=t,this.updateImagePreview("favicon",e,t),this.markUnsaved()):this.currentImageTarget==="og_image"?this.currentSeoTranslation&&(this.currentSeoTranslation.og_image_uuid=e,this.currentSeoTranslation.og_image_storage_type=t,this.updateSeoImagePreview("og_image",e,t)):this.currentImageTarget==="twitter_image"&&this.currentSeoTranslation&&(this.currentSeoTranslation.twitter_image_uuid=e,this.currentSeoTranslation.twitter_image_storage_type=t,this.updateSeoImagePreview("twitter_image",e,t)),this.closeImageModal()}async duplicateToPublic(e){try{this.showToast("Copying image to public...","info");const t=await fetch(`${this.baseUrl}/api/v1/upload/private/${e}`,{headers:h(),credentials:"include"});if(!t.ok)throw new Error("Failed to download private image");const a=await t.blob(),s=t.headers.get("content-disposition")?.match(/filename="(.+)"/)?.[1]||"image.jpg",i=new FormData;i.append("file",a,s);const n={},o=_();o&&(n["X-CSRF-TOKEN"]=o);const l=await fetch(`${this.baseUrl}/api/v1/upload/public`,{method:"POST",headers:n,body:i,credentials:"include"}),r=await l.json();if(l.ok&&r.status==="success"&&r.upload?.uuid)return this.showToast("Image copied to public","success"),r.upload.uuid;throw new Error(r.message||"Failed to upload")}catch(t){return console.error("Failed to duplicate to public:",t),null}}removeCurrentImage(){this.currentImageTarget==="logo"?(this.logoUuid=null,this.updateImagePreview("logo",null),this.markUnsaved()):this.currentImageTarget==="favicon"?(this.faviconUuid=null,this.updateImagePreview("favicon",null),this.markUnsaved()):this.currentImageTarget==="og_image"?this.currentSeoTranslation&&(this.currentSeoTranslation.og_image_uuid=null,this.updateSeoImagePreview("og_image",null)):this.currentImageTarget==="twitter_image"&&this.currentSeoTranslation&&(this.currentSeoTranslation.twitter_image_uuid=null,this.updateSeoImagePreview("twitter_image",null))}updateImagePreview(e,t,a="public"){let s,i;if(e==="logo"?(s=this.logoPreview,i=this.logoPlaceholder):(s=this.faviconPreview,i=this.faviconPlaceholder),t&&s){const n=a==="public"?`/api/v1/upload/download/public/${t}?variant=medium`:`/api/v1/upload/private/${t}?variant=medium`;s.src=n,s.classList.remove("hidden"),i&&i.classList.add("hidden")}else s&&s.classList.add("hidden"),i&&i.classList.remove("hidden")}async handleImageUpload(e){const t=e.target.files[0];if(!t)return;if(!t.type.startsWith("image/")){this.showToast("Please select an image file","error"),e.target.value="";return}const a=new FormData;a.append("file",t);try{this.showToast("Uploading image...","info");const s={},i=_();i&&(s["X-CSRF-TOKEN"]=i);const n=await fetch(`${this.baseUrl}/api/v1/upload/public`,{method:"POST",headers:s,body:a,credentials:"include"}),o=await n.json();n.ok&&o.status==="success"&&o.upload?.uuid?(this.showToast("Image uploaded successfully","success"),await this.selectImage(o.upload.uuid,"public")):this.showToast(o.message||"Upload failed","error")}catch(s){console.error("Upload failed:",s),this.showToast("Network error during upload","error")}e.target.value=""}async saveChanges(e=null){if(!this.currentConfig)return{saved:!1};const t={logo_uuid:this.logoUuid,favicon_uuid:this.faviconUuid,scss_variables:this.currentConfig.scss_variables,theme_light:this.currentConfig.theme_light,theme_dark:this.currentConfig.theme_dark};try{e&&this.setButtonLoading(e,!0),this.showBuildOverlay("Saving and building theme...");const a=await fetch(`${this.baseUrl}/api/v1/admin/theme`,{method:"PUT",headers:h(),body:JSON.stringify(t),credentials:"include"}),s=await a.json();return a.ok&&s.status==="success"?(this.originalConfig=JSON.parse(JSON.stringify(this.currentConfig)),this.markSaved(),s.success&&s.new_version?(this.updateBuildStatus("Build successful!"),this.updateGlobalAssetsVersion(s.new_version),setTimeout(()=>{this.hideBuildOverlay(),this.showToast(`Theme saved and built! Version: ${s.new_version}`,"success")},1e3)):s.success===!1?(this.updateBuildStatus(`Build failed: ${s.error||"Unknown error"}`),setTimeout(()=>{this.hideBuildOverlay(),this.showToast(s.error||"Build failed","error")},2e3)):(this.hideBuildOverlay(),this.showToast("Theme configuration saved!","success")),{saved:!0,buildSuccess:s.success,version:s.new_version}):(this.hideBuildOverlay(),this.showToast(s.message||"Failed to save","error"),{saved:!1})}catch(a){return console.error("Save failed:",a),this.hideBuildOverlay(),this.showToast("Network error while saving","error"),{saved:!1}}finally{e&&this.setButtonLoading(e,!1)}}async saveBranding(e=null){const t={logo_uuid:this.logoUuid||"",favicon_uuid:this.faviconUuid||"",site_name:this.siteName||"Blazing Sun",show_site_name:this.showSiteName,identity_color_start:this.identityColorStart||"#3498db",identity_color_end:this.identityColorEnd||"#764ba2",identity_size:this.identitySize||"1.375rem"},a=this.currentConfig&&(t.identity_color_start!==this.currentConfig.identity_color_start||t.identity_color_end!==this.currentConfig.identity_color_end||t.identity_size!==this.currentConfig.identity_size);try{e&&this.setButtonLoading(e,!0),a&&this.showBuildOverlay("Saving branding and rebuilding theme...");const s=await fetch(`${this.baseUrl}/api/v1/admin/theme/branding`,{method:"PUT",headers:h(),body:JSON.stringify(t),credentials:"include"}),i=await s.json();return s.ok&&i.status==="success"?(this.currentConfig&&(this.currentConfig.site_name=t.site_name,this.currentConfig.show_site_name=t.show_site_name,this.currentConfig.identity_color_start=t.identity_color_start,this.currentConfig.identity_color_end=t.identity_color_end,this.currentConfig.identity_size=t.identity_size,this.currentConfig.logo_uuid=t.logo_uuid,this.currentConfig.favicon_uuid=t.favicon_uuid),this.markSaved(),this.updateNavbarBranding(t),i.success&&i.new_version?(this.updateBuildStatus("Build successful!"),this.updateGlobalAssetsVersion(i.new_version),setTimeout(()=>{this.hideBuildOverlay(),this.showToast(`Branding saved and theme rebuilt! Version: ${i.new_version}`,"success")},1e3),{saved:!0,buildSuccess:!0,version:i.new_version}):i.success===!1&&i.error?(this.updateBuildStatus(`Build failed: ${i.error}`),setTimeout(()=>{this.hideBuildOverlay(),this.showToast(i.error||"Build failed","error")},2e3),{saved:!0,buildSuccess:!1}):(this.hideBuildOverlay(),this.showToast("Branding saved successfully!","success"),{saved:!0})):(this.hideBuildOverlay(),this.showToast(i.message||"Failed to save branding","error"),{saved:!1})}catch(s){return console.error("Save branding failed:",s),this.hideBuildOverlay(),this.showToast("Network error while saving branding","error"),{saved:!1}}finally{e&&this.setButtonLoading(e,!1)}}updateNavbarBranding(e){const t=document.querySelector(".navbar__logo-text");t&&(t.textContent=e.site_name||"Blazing Sun",t.style.display=e.show_site_name?"":"none",t.style.background=`linear-gradient(135deg, ${e.identity_color_start} 0%, ${e.identity_color_end} 100%)`,t.style.webkitBackgroundClip="text",t.style.webkitTextFillColor="transparent",t.style.backgroundClip="text",t.style.fontSize=e.identity_size)}async saveColors(e=null){if(!this.currentConfig)return this.showToast("No configuration loaded","error"),{saved:!1};const t={theme_light:this.currentConfig.theme_light||{},theme_dark:this.currentConfig.theme_dark||{}};console.log("saveColors called"),console.log("theme_light:",JSON.stringify(t.theme_light,null,2)),console.log("theme_dark:",JSON.stringify(t.theme_dark,null,2));try{e&&this.setButtonLoading(e,!0,"Building..."),this.showBuildOverlay("Saving colors and rebuilding theme...");const a=await fetch(`${this.baseUrl}/api/v1/admin/theme`,{method:"PUT",headers:h(),body:JSON.stringify(t),credentials:"include"}),s=await a.json();return a.ok&&s.status==="success"?(this.markSaved(),s.success&&s.new_version?(this.updateBuildStatus("Build successful!"),this.updateGlobalAssetsVersion(s.new_version),setTimeout(()=>{this.hideBuildOverlay(),this.showToast(`Colors saved and theme built! Version: ${s.new_version}`,"success")},1e3)):s.success===!1?(this.updateBuildStatus(`Build failed: ${s.error||"Unknown error"}`),setTimeout(()=>{this.hideBuildOverlay(),this.showToast(s.error||"Build failed","error")},2e3)):(this.hideBuildOverlay(),this.showToast("Colors saved successfully!","success")),{saved:!0,buildSuccess:s.success,version:s.new_version}):(this.hideBuildOverlay(),this.showToast(s.message||"Failed to save colors","error"),{saved:!1})}catch(a){return console.error("Save colors failed:",a),this.hideBuildOverlay(),this.showToast("Network error while saving colors","error"),{saved:!1}}finally{e&&this.setButtonLoading(e,!1)}}async saveTypography(e=null){if(!this.currentConfig)return this.showToast("No configuration loaded","error"),{saved:!1};const t=this.currentConfig.scss_variables||{},a={},s=["font_size","font_weight","line_height","letter_spacing","font_family"];Object.keys(t).forEach(n=>{s.some(o=>n.startsWith(o))&&(a[n]=t[n])});const i={scss_variables:a};console.log("saveTypography called"),console.log("typography variables:",JSON.stringify(a,null,2));try{e&&this.setButtonLoading(e,!0,"Building..."),this.showBuildOverlay("Saving typography and rebuilding theme...");const n=await fetch(`${this.baseUrl}/api/v1/admin/theme`,{method:"PUT",headers:h(),body:JSON.stringify(i),credentials:"include"}),o=await n.json();return n.ok&&o.status==="success"?(this.markSaved(),o.success&&o.new_version?(this.updateBuildStatus("Build successful!"),this.updateGlobalAssetsVersion(o.new_version),setTimeout(()=>{this.hideBuildOverlay(),this.showToast(`Typography saved and theme built! Version: ${o.new_version}`,"success")},1e3)):o.success===!1?(this.updateBuildStatus(`Build failed: ${o.error||"Unknown error"}`),setTimeout(()=>{this.hideBuildOverlay(),this.showToast(o.error||"Build failed","error")},2e3)):(this.hideBuildOverlay(),this.showToast("Typography saved successfully!","success")),{saved:!0,buildSuccess:o.success,version:o.new_version}):(this.hideBuildOverlay(),this.showToast(o.message||"Failed to save typography","error"),{saved:!1})}catch(n){return console.error("Save typography failed:",n),this.hideBuildOverlay(),this.showToast("Network error while saving typography","error"),{saved:!1}}finally{e&&this.setButtonLoading(e,!1)}}async saveSpacing(e=null){if(!this.currentConfig)return this.showToast("No configuration loaded","error"),{saved:!1};const t=this.currentConfig.scss_variables||{},a={},s=["spacing","radius","padding","margin","gap"];Object.keys(t).forEach(n=>{s.some(o=>n.startsWith(o))&&(a[n]=t[n])});const i={scss_variables:a};console.log("saveSpacing called"),console.log("spacing variables:",JSON.stringify(a,null,2));try{e&&this.setButtonLoading(e,!0,"Building..."),this.showBuildOverlay("Saving spacing and rebuilding theme...");const n=await fetch(`${this.baseUrl}/api/v1/admin/theme`,{method:"PUT",headers:h(),body:JSON.stringify(i),credentials:"include"}),o=await n.json();return n.ok&&o.status==="success"?(this.markSaved(),o.success&&o.new_version?(this.updateBuildStatus("Build successful!"),this.updateGlobalAssetsVersion(o.new_version),setTimeout(()=>{this.hideBuildOverlay(),this.showToast(`Spacing saved and theme built! Version: ${o.new_version}`,"success")},1e3)):o.success===!1?(this.updateBuildStatus(`Build failed: ${o.error||"Unknown error"}`),setTimeout(()=>{this.hideBuildOverlay(),this.showToast(o.error||"Build failed","error")},2e3)):(this.hideBuildOverlay(),this.showToast("Spacing saved successfully!","success")),{saved:!0,buildSuccess:o.success,version:o.new_version}):(this.hideBuildOverlay(),this.showToast(o.message||"Failed to save spacing","error"),{saved:!1})}catch(n){return console.error("Save spacing failed:",n),this.hideBuildOverlay(),this.showToast("Network error while saving spacing","error"),{saved:!1}}finally{e&&this.setButtonLoading(e,!1)}}async triggerBuild(e=!1){if(!this.isBuilding){!e&&this.hasUnsavedChanges&&confirm("You have unsaved changes. Save before building?")&&await this.saveChanges(),this.isBuilding=!0,this.showBuildOverlay("Starting build...");try{const t=await fetch(`${this.baseUrl}/api/v1/admin/theme/build`,{method:"POST",headers:h(),credentials:"include"}),a=await t.json();t.ok&&a.status==="success"?(this.updateBuildStatus("Build successful!"),a.new_version&&this.updateGlobalAssetsVersion(a.new_version),setTimeout(()=>{this.hideBuildOverlay();const s=a.new_version?` Version: ${a.new_version}`:"";this.showToast(`Theme built successfully!${s}`,"success")},1500)):(this.updateBuildStatus(`Build failed: ${a.message||"Unknown error"}`),setTimeout(()=>{this.hideBuildOverlay(),this.showToast(a.message||"Build failed","error")},3e3))}catch(t){console.error("Build failed:",t),this.updateBuildStatus("Build failed: Network error"),setTimeout(()=>{this.hideBuildOverlay(),this.showToast("Network error during build","error")},2e3)}finally{this.isBuilding=!1}}}showBuildOverlay(e){this.buildOverlay&&this.buildOverlay.classList.remove("hidden"),this.updateBuildStatus(e)}hideBuildOverlay(){this.buildOverlay&&this.buildOverlay.classList.add("hidden")}updateBuildStatus(e){this.buildStatus&&(this.buildStatus.textContent=e)}setButtonLoading(e,t,a="Saving..."){e&&(e.disabled=t,t?(e.dataset.originalText=e.textContent,e.textContent=a,e.classList.add("btn--loading")):(e.textContent=e.dataset.originalText||"Save",e.classList.remove("btn--loading")))}updateGlobalAssetsVersion(e){if(!e)return;const t=document.querySelector('link[href*="/css/GLOBAL/"]');if(t){const s=t.getAttribute("href"),i=s.includes("?v=")?s.replace(/\?v=[^&]+/,`?v=${e}`):`${s}?v=${e}`;t.setAttribute("href",i),console.log("Updated GLOBAL CSS:",i)}const a=document.querySelector('script[src*="/js/GLOBAL/"]');if(a){const s=a.getAttribute("src"),i=s.includes("?v=")?s.replace(/\?v=[^&]+/,`?v=${e}`):`${s}?v=${e}`;a.setAttribute("src",i),console.log("Updated GLOBAL JS:",i)}}setupSEO(){this.seoFormElements={pageList:document.getElementById("seoPageItems"),placeholder:document.getElementById("seoFormPlaceholder"),content:document.getElementById("seoContent"),form:document.getElementById("seoForm"),pageName:document.getElementById("seoPageName"),pagePath:document.getElementById("seoPagePath"),routeName:document.getElementById("seoRouteName"),languageTabs:document.getElementById("seoLanguageTabs"),subtabs:document.querySelectorAll(".seo-subtab"),subpanels:{metatags:document.getElementById("seo-subpanel-metatags"),schemas:document.getElementById("seo-subpanel-schemas"),hreflang:document.getElementById("seo-subpanel-hreflang")},schemasList:document.getElementById("schemasList"),schemasEmpty:document.getElementById("schemasEmpty"),assignedSchemasList:document.getElementById("assignedSchemasList"),assignedSchemasEmpty:document.getElementById("assignedSchemasEmpty"),addSchemaBtn:document.getElementById("addSchemaBtn"),title:document.getElementById("seoTitle"),description:document.getElementById("seoDescription"),keywords:document.getElementById("seoKeywords"),robots:document.getElementById("seoRobots"),canonical:document.getElementById("seoCanonical"),ogTitle:document.getElementById("seoOgTitle"),ogDescription:document.getElementById("seoOgDescription"),ogType:document.getElementById("seoOgType"),ogImageSelector:document.getElementById("ogImageSelector"),ogImagePreview:document.getElementById("ogImagePreview"),ogImagePlaceholder:document.getElementById("ogImagePlaceholder"),ogImageUuid:document.getElementById("seoOgImageUuid"),twitterCard:document.getElementById("seoTwitterCard"),twitterTitle:document.getElementById("seoTwitterTitle"),twitterDescription:document.getElementById("seoTwitterDescription"),twitterImageSelector:document.getElementById("twitterImageSelector"),twitterImagePreview:document.getElementById("twitterImagePreview"),twitterImagePlaceholder:document.getElementById("twitterImagePlaceholder"),twitterImageUuid:document.getElementById("seoTwitterImageUuid"),isActive:document.getElementById("seoIsActive"),saveBtn:document.getElementById("seoSaveBtn")},this.seoFormElements.form&&this.seoFormElements.form.addEventListener("submit",e=>{e.preventDefault(),this.saveSeoPage()}),this.setupSeoSubtabs(),this.setupSeoCharacterCounts(),this.setupSeoImageSelectors(),this.setupSeoPageModal(),this.setupHreflangForm(),this.loadSeoLanguages(),this.loadSeoPages()}setupSeoSubtabs(){const e=this.seoFormElements;!e.subtabs||e.subtabs.length===0||(e.subtabs.forEach(t=>{t.addEventListener("click",()=>{const a=t.dataset.subtab;this.switchSeoSubtab(a)})}),e.addSchemaBtn&&e.addSchemaBtn.addEventListener("click",()=>{this.openSchemaModal()}))}async loadSeoLanguages(){try{const e=await fetch(`${this.baseUrl}/api/v1/admin/localizations/languages`,{headers:h(),credentials:"include"}),t=await e.json();e.ok&&t.status==="success"?this.seoLanguages=(t.languages||[]).map(a=>({code:(a.iso2||"").toLowerCase(),label:a.native_name||a.iso2})).filter(a=>a.code):this.seoLanguages=[]}catch(e){console.error("Failed to load SEO languages:",e),this.seoLanguages=[]}this.seoLanguages.find(e=>e.code==="en")||this.seoLanguages.unshift({code:"en",label:"English"}),this.seoLanguages.find(e=>e.code==="sr")||this.seoLanguages.push({code:"sr",label:"Srpski"}),this.renderSeoLanguageTabs()}renderSeoLanguageTabs(){const e=this.seoFormElements?.languageTabs||this.seoLanguageTabs;e&&(e.innerHTML="",this.seoLanguages.forEach(t=>{const a=document.createElement("button");a.type="button",a.className="seo-language-tab",t.code===this.activeSeoLanguage&&a.classList.add("is-active"),a.textContent=`${t.label} (${t.code.toUpperCase()})`,a.addEventListener("click",()=>{this.setActiveSeoLanguage(t.code)}),e.appendChild(a)}))}setActiveSeoLanguage(e){this.activeSeoLanguage=e,this.renderSeoLanguageTabs(),this.currentSeoPage&&(this.populateSeoForm(this.currentSeoPage),this.currentSeoPage.id&&this.loadPageSchemas(this.currentSeoPage.id))}normalizeSeoTranslations(e=[]){const t={};return e.forEach(a=>{a.lang_code&&(t[a.lang_code.toLowerCase()]={...a})}),t}getSeoTranslation(e){return this.seoTranslations?this.seoTranslations[e]||this.seoTranslations.en||{}:{}}switchSeoSubtab(e){const t=this.seoFormElements;t.subtabs.forEach(a=>{const s=a.dataset.subtab===e;a.classList.toggle("active",s),a.setAttribute("aria-selected",s?"true":"false")}),Object.entries(t.subpanels).forEach(([a,s])=>{s&&s.classList.toggle("hidden",a!==e)})}async openSchemaModal(e=null){if(!this.schemaModal){this.showToast("Schema modal not available","error");return}if(!(this.editingSchemaEntityId!==null)&&!this.currentSeoPage){this.showToast("Please select a page first","error");return}const a=this.editingSchemaEntityId;if(this.resetSchemaModal(),a&&(this.editingSchemaEntityId=a),await this.loadSchemaCategories(),e&&(e.id&&typeof e.id=="number"&&(this.editingSchemaId=e.id),this.schemaModalTitle&&(this.schemaModalTitle.textContent=this.editingSchemaEntityId?"Edit Schema Entity":"Edit Schema"),this.schemaModalTabs&&this.schemaModalTabs.classList.add("hidden"),e.schema_type))try{const i=(await this.fetchSchemaDefinition(e.schema_type)).path||[e.schema_type],n=i[0]==="Thing"?i.slice(1):i,o=n[0]||"";this.schemaCategorySelect&&(this.schemaCategorySelect.value=o),this.clearSchemaHierarchy(),o&&await this.renderSchemaLevel(o,0,n[1]||""),await this.onSchemaTypeChange(e.schema_type),setTimeout(()=>{this.populateSchemaFields(e.schema_data)},50)}catch(s){this.showToast("Failed to load schema definition","error"),console.error(s)}this.schemaModal.classList.remove("hidden")}populateSchemaFields(e){!e||!this.schemaFields||(this.populateFieldsFromData(this.schemaFields,e),this.updateSchemaPreview())}populateFieldsFromData(e,t){!e||!t||typeof t!="object"||Object.entries(t).forEach(([a,s])=>{if(a.startsWith("@"))return;if(Array.isArray(s)){const n=e.querySelector(`.schema-array[data-field="${a}"]`);if(n){const o=n.querySelector(".schema-array__add")?.dataset.array;o&&s.forEach(l=>{if(l&&typeof l=="object")return;this.addArrayItem(o);const c=document.getElementById(`${o}_items`)?.querySelector(".schema-array__item:last-child input");c&&(c.value=l)})}return}if(s&&typeof s=="object"){const n=e.querySelector(`.schema-entity[data-field="${a}"]`);if(n){this.populateEntityContainer(n,s);return}const o=e.querySelector(`.schema-mixed[data-field="${a}"]`);if(o){this.populateMixedContainer(o,s);return}const l=e.querySelector(`.schema-nested[data-field="${a}"]`);l&&this.populateFieldsFromData(l,s);return}const i=e.querySelector(`[data-field="${a}"]`);i&&(i.type==="checkbox"?i.checked=!!s:i.value=s)})}populateEntityContainer(e,t){if(!e||!t||typeof t!="object")return;if(Object.keys(t).length===1&&t["@id"]){this.setEntityMode(e,b);const r=e.querySelector(".schema-entity__ref");r&&(r.value=t["@id"]);return}this.setEntityMode(e,v);const i=e.querySelector(`.schema-entity__type-radio[value="${t["@type"]}"]`),n=e.querySelector(".schema-entity__type-radio");i&&t["@type"]?(i.checked=!0,this.updateEntityInlineFields(e)):n&&(n.checked=!0,this.updateEntityInlineFields(e));const o=e.querySelector(".schema-entity__inline");if(!o)return;const l={...t};delete l["@type"],this.populateFieldsFromData(o,l)}populateMixedContainer(e,t){if(!e)return;const a=e.querySelector(".schema-mixed__data"),s=e.querySelector(".schema-mixed__entity");if(t&&typeof t=="object"){const o=Object.keys(t).length===1&&t["@id"],l=e.querySelector(`.schema-mixed__type-radio[data-kind="entity"][value="${t["@type"]}"]`),r=e.querySelector('.schema-mixed__type-radio[data-kind="entity"]');if(l?l.checked=!0:r&&(r.checked=!0),this.updateMixedField(e),s&&this.populateEntityContainer(s,t),o&&s){const c=s.querySelector(".schema-entity__ref");c&&(c.value=t["@id"])}return}const i=e.querySelector('.schema-mixed__type-radio[data-kind="data"]');i&&(i.checked=!0),a&&a.classList.remove("hidden"),s&&s.classList.add("hidden");const n=e.querySelector(".schema-mixed__data-input");n&&(n.value=t??"")}setupSeoCharacterCounts(){[{id:"seoTitle",max:70},{id:"seoDescription",max:160},{id:"seoOgTitle",max:95},{id:"seoOgDescription",max:200},{id:"seoTwitterTitle",max:70},{id:"seoTwitterDescription",max:200}].forEach(({id:t,max:a})=>{const s=document.getElementById(t),i=document.querySelector(`.char-count[data-for="${t}"]`);if(s&&i){const n=()=>{const o=s.value.length;i.textContent=`${o}/${a}`,i.classList.toggle("char-count--warning",o>a*.9),i.classList.toggle("char-count--error",o>=a)};s.addEventListener("input",n),n()}})}setupSeoImageSelectors(){const{ogImageSelector:e,twitterImageSelector:t}=this.seoFormElements;e&&(e.addEventListener("click",()=>this.openImageModal("og_image")),e.addEventListener("keydown",a=>{(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),this.openImageModal("og_image"))})),t&&(t.addEventListener("click",()=>this.openImageModal("twitter_image")),t.addEventListener("keydown",a=>{(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),this.openImageModal("twitter_image"))}))}setupSeoPageModal(){this.seoAddPageBtn&&this.seoAddPageBtn.addEventListener("click",()=>this.openSeoPageModal()),this.seoPageModal&&this.seoPageModal.addEventListener("click",e=>{(e.target===this.seoPageModal||e.target.closest('[data-action="close"]'))&&this.closeSeoPageModal()}),this.seoPageForm&&this.seoPageForm.addEventListener("submit",e=>{e.preventDefault(),this.createSeoPage()}),this.seoPageCancelBtn&&this.seoPageCancelBtn.addEventListener("click",()=>this.closeSeoPageModal())}openSeoPageModal(){this.resetSeoPageModalForm(),this.seoPageModalTitle&&(this.seoPageModalTitle.textContent="Add SEO Page"),this.seoPageModal?.classList.remove("hidden"),this.seoPageRouteName?.focus()}closeSeoPageModal(){this.seoPageModal?.classList.add("hidden"),this.resetSeoPageModalForm()}resetSeoPageModalForm(){this.seoPageForm&&this.seoPageForm.reset()}async createSeoPage(){if(!this.seoPageRouteName)return;const e=this.seoPageRouteName.value.trim(),t=this.seoPageLabel?.value.trim();if(!e){this.showToast("Route name is required","error");return}try{this.setButtonLoading(this.seoPageSaveBtn,!0,"Saving...");const a=await fetch(`${this.baseUrl}/api/v1/admin/seo`,{method:"POST",headers:h(),body:JSON.stringify({route_name:e,page_label:t||null}),credentials:"include"}),s=await a.json();a.ok&&s.status==="success"?(this.showToast("SEO page created","success"),this.closeSeoPageModal(),await this.loadSeoPages(),this.selectSeoPage(e)):this.showToast(s.message||"Failed to create SEO page","error")}catch(a){console.error("Failed to create SEO page:",a),this.showToast("Network error while creating SEO page","error")}finally{this.setButtonLoading(this.seoPageSaveBtn,!1)}}setupHreflangForm(){this.hreflangForm&&this.hreflangForm.addEventListener("submit",e=>{e.preventDefault(),this.saveHreflangEntry()}),this.hreflangCancelBtn&&this.hreflangCancelBtn.addEventListener("click",()=>this.resetHreflangForm())}resetHreflangForm(){this.hreflangForm&&this.hreflangForm.reset(),this.hreflangIdInput&&(this.hreflangIdInput.value="")}async loadHreflangEntries(e){if(e)try{const t=await fetch(`${this.baseUrl}/api/v1/admin/seo/page/${e}/hreflang`,{headers:h(),credentials:"include"}),a=await t.json();t.ok&&a.status==="success"?(this.hreflangEntries=a.entries||[],this.renderHreflangTable()):(this.hreflangEntries=[],this.renderHreflangTable())}catch(t){console.error("Failed to load hreflang entries:",t),this.hreflangEntries=[],this.renderHreflangTable()}}renderHreflangTable(){if(this.hreflangTableBody){if(this.hreflangTableBody.innerHTML="",!this.hreflangEntries.length){const e=document.createElement("tr");e.innerHTML='<td colspan="4" class="hreflang-table__empty">No hreflang entries yet.</td>',this.hreflangTableBody.appendChild(e);return}this.hreflangEntries.forEach(e=>{const t=document.createElement("tr");t.className="hreflang-row",t.innerHTML=`
        <td>${this.escapeHtml(e.lang_code||"")}</td>
        <td>${this.escapeHtml(e.href||"")}</td>
        <td>${e.is_default?"Yes":"No"}</td>
        <td class="hreflang-actions">
          <button type="button" class="btn btn--secondary btn--xs" data-action="edit" data-id="${e.id}">Edit</button>
          <button type="button" class="btn btn--danger btn--xs" data-action="delete" data-id="${e.id}">Delete</button>
        </td>
      `,t.querySelectorAll("button").forEach(a=>{a.addEventListener("click",()=>{const s=a.dataset.action;s==="edit"?this.populateHreflangForm(e):s==="delete"&&this.deleteHreflangEntry(e.id)})}),this.hreflangTableBody.appendChild(t)})}}populateHreflangForm(e){e&&(this.hreflangIdInput&&(this.hreflangIdInput.value=e.id||""),this.hreflangCodeInput&&(this.hreflangCodeInput.value=e.lang_code||""),this.hreflangUrlInput&&(this.hreflangUrlInput.value=e.href||""),this.hreflangDefaultInput&&(this.hreflangDefaultInput.checked=!!e.is_default))}async saveHreflangEntry(){if(!this.currentSeoPage?.id){this.showToast("Select a page first","error");return}const e=this.hreflangCodeInput?.value.trim(),t=this.hreflangUrlInput?.value.trim(),a=this.hreflangIdInput?.value.trim(),s=!!this.hreflangDefaultInput?.checked;if(!e||!t){this.showToast("Language code and URL are required","error");return}try{const i=await fetch(`${this.baseUrl}/api/v1/admin/seo/page/${this.currentSeoPage.id}/hreflang`,{method:"POST",headers:h(),body:JSON.stringify({id:a||null,lang_code:e,href:t,is_default:s}),credentials:"include"}),n=await i.json();i.ok&&n.status==="success"?(this.showToast("Hreflang entry saved","success"),this.resetHreflangForm(),await this.loadHreflangEntries(this.currentSeoPage.id)):this.showToast(n.message||"Failed to save hreflang entry","error")}catch(i){console.error("Failed to save hreflang entry:",i),this.showToast("Network error while saving hreflang entry","error")}}async deleteHreflangEntry(e){if(e)try{const t=await fetch(`${this.baseUrl}/api/v1/admin/seo/hreflang/${e}`,{method:"DELETE",headers:h(),credentials:"include"}),a=await t.json();t.ok&&a.status==="success"?(this.showToast("Hreflang entry deleted","success"),this.currentSeoPage?.id&&await this.loadHreflangEntries(this.currentSeoPage.id)):this.showToast(a.message||"Failed to delete hreflang entry","error")}catch(t){console.error("Failed to delete hreflang entry:",t),this.showToast("Network error while deleting hreflang entry","error")}}async loadSeoPages(){try{const e=await fetch(`${this.baseUrl}/api/v1/admin/seo`,{headers:h(),credentials:"include"});if(!e.ok)throw new Error("Failed to load SEO pages");const t=await e.json();if(t.status==="success")this.seoPages=t.pages||[],this.renderSeoPageList();else throw new Error(t.message||"Unknown error")}catch(e){console.error("Failed to load SEO pages:",e),this.showToast("Failed to load SEO pages","error")}}renderSeoPageList(){const{pageList:e}=this.seoFormElements;e&&(e.innerHTML="",this.seoPages.forEach(t=>{const a=document.createElement("li");a.className="seo-page-list__item",a.dataset.routeName=t.route_name;const s=t.is_active?"seo-page-list__status--active":"seo-page-list__status--inactive",i=t.is_active?"Active":"Inactive";a.innerHTML=`
        <div class="seo-page-list__info">
          <span class="seo-page-list__label">${this.escapeHtml(t.page_label)}</span>
          <span class="seo-page-list__path">${this.escapeHtml(t.page_path)}</span>
        </div>
        <span class="seo-page-list__status ${s}">${i}</span>
      `,a.addEventListener("click",()=>this.selectSeoPage(t.route_name)),e.appendChild(a)}))}async selectSeoPage(e){this.seoFormElements.pageList?.querySelectorAll(".seo-page-list__item")?.forEach(a=>{a.classList.toggle("seo-page-list__item--active",a.dataset.routeName===e)});try{const a=await fetch(`${this.baseUrl}/api/v1/admin/seo/${encodeURIComponent(e)}`,{headers:h(),credentials:"include"});if(!a.ok)throw new Error("Failed to load SEO data");const s=await a.json();if(s.status==="success"&&s.seo)this.currentSeoPage=s.seo,this.seoTranslations=this.normalizeSeoTranslations(s.seo.translations||[]),this.seoTranslations[this.activeSeoLanguage]||(this.activeSeoLanguage=this.seoTranslations.en?"en":Object.keys(this.seoTranslations)[0]||"en"),this.renderSeoLanguageTabs(),this.populateSeoForm(s.seo),this.resetHreflangForm(),this.loadHreflangEntries(s.seo.id);else throw new Error(s.message||"Unknown error")}catch(a){console.error("Failed to load SEO page:",a),this.showToast("Failed to load SEO data","error")}}populateSeoForm(e){const t=this.seoFormElements;if(!t.form)return;t.placeholder?.classList.add("hidden"),t.content?.classList.remove("hidden"),this.switchSeoSubtab("metatags"),t.pageName&&(t.pageName.textContent=e.page_label||""),t.pagePath&&(t.pagePath.textContent=e.page_path||""),t.routeName&&(t.routeName.value=e.route_name||"");const a=this.getSeoTranslation(this.activeSeoLanguage);this.currentSeoTranslation={...a},t.title&&(t.title.value=a.title||""),t.description&&(t.description.value=a.description||""),t.keywords&&(t.keywords.value=a.keywords||""),t.robots&&(t.robots.value=a.robots||"index, follow"),t.canonical&&(t.canonical.value=a.canonical_url||""),t.ogTitle&&(t.ogTitle.value=a.og_title||""),t.ogDescription&&(t.ogDescription.value=a.og_description||""),t.ogType&&(t.ogType.value=a.og_type||"website"),this.currentSeoTranslation.og_image_uuid=a.og_image_uuid||null,this.updateSeoImagePreview("og_image",a.og_image_uuid||null),t.twitterCard&&(t.twitterCard.value=a.twitter_card||"summary"),t.twitterTitle&&(t.twitterTitle.value=a.twitter_title||""),t.twitterDescription&&(t.twitterDescription.value=a.twitter_description||""),this.currentSeoTranslation.twitter_image_uuid=a.twitter_image_uuid||null,this.updateSeoImagePreview("twitter_image",a.twitter_image_uuid||null),t.isActive&&(t.isActive.checked=e.is_active!==!1),this.updateAllSeoCharCounts(),this.currentSeoPage?.id&&this.loadPageSchemas(this.currentSeoPage.id)}updateAllSeoCharCounts(){["seoTitle","seoDescription","seoOgTitle","seoOgDescription","seoTwitterTitle","seoTwitterDescription"].forEach(t=>{const a=document.getElementById(t);a&&a.dispatchEvent(new Event("input"))})}updateSeoImagePreview(e,t,a="public"){let s,i,n;if(e==="og_image"?(s=this.seoFormElements.ogImagePreview,i=this.seoFormElements.ogImagePlaceholder,n=this.seoFormElements.ogImageUuid):(s=this.seoFormElements.twitterImagePreview,i=this.seoFormElements.twitterImagePlaceholder,n=this.seoFormElements.twitterImageUuid),t&&s){const o=a==="public"?`/api/v1/upload/download/public/${t}?variant=medium`:`/api/v1/upload/private/${t}?variant=medium`;s.src=o,s.classList.remove("hidden"),i&&i.classList.add("hidden")}else s&&s.classList.add("hidden"),i&&i.classList.remove("hidden");n&&(n.value=t||""),this.currentSeoTranslation&&(e==="og_image"?this.currentSeoTranslation.og_image_uuid=t||null:this.currentSeoTranslation.twitter_image_uuid=t||null,this.seoTranslations[this.activeSeoLanguage]={...this.currentSeoTranslation})}async saveSeoPage(){if(!this.currentSeoPage)return;const e=this.seoFormElements,t=e.routeName?.value;if(!t)return;const a={lang_code:this.activeSeoLanguage,title:e.title?.value||null,description:e.description?.value||null,keywords:e.keywords?.value||null,robots:e.robots?.value||null,canonical_url:e.canonical?.value||null,og_title:e.ogTitle?.value||null,og_description:e.ogDescription?.value||null,og_type:e.ogType?.value||null,og_image_uuid:this.currentSeoTranslation?.og_image_uuid||null,twitter_card:e.twitterCard?.value||null,twitter_title:e.twitterTitle?.value||null,twitter_description:e.twitterDescription?.value||null,twitter_image_uuid:this.currentSeoTranslation?.twitter_image_uuid||null,is_active:e.isActive?.checked??!0};try{this.setButtonLoading(e.saveBtn,!0);const s=await fetch(`${this.baseUrl}/api/v1/admin/seo/${encodeURIComponent(t)}`,{method:"PUT",headers:h(),body:JSON.stringify(a),credentials:"include"}),i=await s.json();if(s.ok&&i.status==="success"){this.showToast("SEO settings saved","success");const n=this.seoPages.findIndex(l=>l.route_name===t);n!==-1&&(this.seoPages[n].is_active=a.is_active,this.activeSeoLanguage==="en"&&(this.seoPages[n].title=a.title,this.seoPages[n].description=a.description)),this.renderSeoPageList(),this.seoTranslations[this.activeSeoLanguage]={...this.currentSeoTranslation,...a},this.seoFormElements.pageList?.querySelector(`[data-route-name="${t}"]`)?.classList.add("seo-page-list__item--active")}else this.showToast(i.message||"Failed to save SEO settings","error")}catch(s){console.error("Failed to save SEO:",s),this.showToast("Network error while saving","error")}finally{this.setButtonLoading(e.saveBtn,!1)}}setupLocalization(){this.setupLocalizationModal(),this.languageForm&&this.languageForm.addEventListener("submit",e=>{e.preventDefault(),this.saveLanguage()}),this.languageResetBtn&&this.languageResetBtn.addEventListener("click",()=>this.resetLanguageForm()),this.languageIconFile&&this.languageIconFile.addEventListener("change",e=>{this.uploadLanguageIcon(e.target.files?.[0]||null)}),this.languageIconClear&&this.languageIconClear.addEventListener("click",()=>{this.setLanguageIcon(null)}),this.localeForm&&this.localeForm.addEventListener("submit",e=>{e.preventDefault(),this.saveLocale()}),this.localeResetBtn&&this.localeResetBtn.addEventListener("click",()=>this.resetLocaleForm()),this.localizationForm&&this.localizationForm.addEventListener("submit",e=>{e.preventDefault(),this.saveLocalizationKey()}),this.localizationResetBtn&&this.localizationResetBtn.addEventListener("click",()=>this.openLocalizationModal()),this.localizationNewBtn&&this.localizationNewBtn.addEventListener("click",()=>this.openLocalizationModal())}async loadLocalizationData(){await Promise.all([this.loadLanguages(),this.loadLocales(),this.loadLocalizationKeys()])}async loadLanguages(){if(this.languagesTableBody)try{const e=await fetch(`${this.baseUrl}/api/v1/admin/localizations/languages`,{headers:h(),credentials:"include"}),t=await e.json();e.ok&&t.status==="success"?(this.languages=t.languages||[],this.renderLanguages()):this.showToast(t.message||"Failed to load languages","error")}catch(e){console.error("Failed to load languages:",e),this.showToast("Failed to load languages","error")}}async loadLocales(){if(this.localesTableBody)try{const e=await fetch(`${this.baseUrl}/api/v1/admin/localizations/locales`,{headers:h(),credentials:"include"}),t=await e.json();e.ok&&t.status==="success"?(this.locales=t.locales||[],this.renderLocales(),this.renderLocalizationTabs(),this.renderTranslationInputs()):this.showToast(t.message||"Failed to load locales","error")}catch(e){console.error("Failed to load locales:",e),this.showToast("Failed to load locales","error")}}async loadLocalizationKeys(){if(this.localizationKeysTableBody)try{const e=await fetch(`${this.baseUrl}/api/v1/admin/localizations/keys`,{headers:h(),credentials:"include"}),t=await e.json();e.ok&&t.status==="success"?(this.localizationKeys=t.keys||[],this.renderLocalizationKeys()):this.showToast(t.message||"Failed to load localization keys","error")}catch(e){console.error("Failed to load localization keys:",e),this.showToast("Failed to load localization keys","error")}}renderLanguages(){this.languagesTableBody&&(this.languagesTableBody.innerHTML="",this.languages.forEach(e=>{const t=document.createElement("tr"),a=e.icon_uuid?`<img src="/api/v1/upload/download/public/${this.escapeHtml(e.icon_uuid)}" alt="" class="language-icon__preview">`:"-";t.innerHTML=`
        <td>${a}</td>
        <td>${this.escapeHtml(e.native_name)}</td>
        <td>${this.escapeHtml(e.iso2)}</td>
        <td>${this.escapeHtml(e.iso3)}</td>
        <td>${(e.locales||[]).map(s=>this.escapeHtml(s)).join(", ")||"-"}</td>
        <td>
          <div class="localization-actions">
            <button type="button" class="btn btn--ghost btn--xs" data-action="edit">Edit</button>
            <button type="button" class="btn btn--ghost btn--xs btn--danger" data-action="delete">Delete</button>
          </div>
        </td>
      `,t.querySelector('[data-action="edit"]')?.addEventListener("click",()=>{this.editLanguage(e)}),t.querySelector('[data-action="delete"]')?.addEventListener("click",()=>{this.deleteLanguage(e.id)}),this.languagesTableBody.appendChild(t)}),this.populateLanguageSelect())}populateLanguageSelect(){this.localeLanguageSelect&&(this.localeLanguageSelect.innerHTML="",this.languages.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=`${e.native_name} (${e.iso2})`,this.localeLanguageSelect.appendChild(t)}))}renderLocales(){this.localesTableBody&&(this.localesTableBody.innerHTML="",this.locales.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`
        <td>${this.escapeHtml(e.locale_code)}</td>
        <td>${this.escapeHtml(e.language_iso2)}</td>
        <td>
          <div class="localization-actions">
            <button type="button" class="btn btn--ghost btn--xs" data-action="edit">Edit</button>
            <button type="button" class="btn btn--ghost btn--xs btn--danger" data-action="delete">Delete</button>
          </div>
        </td>
      `,t.querySelector('[data-action="edit"]')?.addEventListener("click",()=>{this.editLocale(e)}),t.querySelector('[data-action="delete"]')?.addEventListener("click",()=>{this.deleteLocale(e.id)}),this.localesTableBody.appendChild(t)}))}renderLocalizationKeys(){this.localizationKeysTableBody&&(this.localizationKeysTableBody.innerHTML="",this.localizationKeys.forEach(e=>{const t=e.translations?e.translations.length:0,a=document.createElement("tr");a.innerHTML=`
        <td>${this.escapeHtml(e.key)}</td>
        <td>${this.escapeHtml(e.context||"")}</td>
        <td>${t}</td>
        <td>
          <div class="localization-actions">
            <button type="button" class="btn btn--ghost btn--xs" data-action="edit">Edit</button>
            <button type="button" class="btn btn--ghost btn--xs btn--danger" data-action="delete">Delete</button>
          </div>
        </td>
      `,a.querySelector('[data-action="edit"]')?.addEventListener("click",()=>{this.openLocalizationModal(e)}),a.querySelector('[data-action="delete"]')?.addEventListener("click",()=>{this.deleteLocalizationKey(e.id)}),this.localizationKeysTableBody.appendChild(a)}))}initializeLocalizationTranslations(e=[]){this.localizationTranslations={},this.activeLocalizationLocale=this.locales[0]?.locale_code||null,this.locales.forEach(t=>{const a=e.find(s=>s.locale_code===t.locale_code);this.localizationTranslations[t.locale_code]={singular:a?.singular||"",plural:a?.plural||""}})}renderLocalizationTabs(){if(this.localizationLocaleTabs){if(this.localizationLocaleTabs.innerHTML="",!this.locales.length){this.localizationLocaleTabs.innerHTML='<p class="form-help">Add locales to start translating.</p>';return}this.locales.forEach(e=>{const t=document.createElement("button");t.type="button",t.className="localization-locale-tab",e.locale_code===this.activeLocalizationLocale&&t.classList.add("is-active"),t.textContent=e.locale_code,t.addEventListener("click",()=>{this.activeLocalizationLocale=e.locale_code,this.renderLocalizationTabs(),this.renderTranslationInputs()}),this.localizationLocaleTabs.appendChild(t)})}}renderTranslationInputs(){if(!this.translationInputs)return;if(this.translationInputs.innerHTML="",!this.locales.length){this.translationInputs.innerHTML='<p class="form-help">Add locales to start translating.</p>';return}this.activeLocalizationLocale||(this.activeLocalizationLocale=this.locales[0]?.locale_code||null);const e=this.activeLocalizationLocale,t=this.localizationTranslations[e]||{singular:"",plural:""};this.localizationTranslations[e]=t;const a=document.createElement("div");a.className="translation-row translation-row--single",a.innerHTML=`
      <div class="translation-row__header">${this.escapeHtml(e)}</div>
      <div class="translation-row__fields">
        <div class="form-group">
          <label class="form-label">Singular</label>
          <input type="text" class="form-input" data-field="singular" value="${this.escapeHtml(t.singular||"")}" required>
        </div>
        <div class="form-group">
          <label class="form-label">Plural</label>
          <input type="text" class="form-input" data-field="plural" value="${this.escapeHtml(t.plural||"")}" required>
        </div>
      </div>
    `,this.translationInputs.appendChild(a),a.querySelectorAll("input[data-field]").forEach(s=>{s.addEventListener("input",()=>{const i=s.dataset.field;this.localizationTranslations[e][i]=s.value})})}editLanguage(e){this.editingLanguageId=e.id;const t=document.getElementById("languageNativeName"),a=document.getElementById("languageIso2"),s=document.getElementById("languageIso3"),i=document.getElementById("languageId");t&&(t.value=e.native_name),a&&(a.value=e.iso2),s&&(s.value=e.iso3),i&&(i.value=e.id),this.setLanguageIcon(e.icon_uuid)}resetLanguageForm(){this.editingLanguageId=null,this.languageForm?.reset();const e=document.getElementById("languageId");e&&(e.value=""),this.setLanguageIcon(null)}setLanguageIcon(e){const t=document.getElementById("languageIconUuid");t&&(t.value=e||""),this.languageIconPreview&&(e?(this.languageIconPreview.src=`/api/v1/upload/download/public/${e}`,this.languageIconPreview.classList.remove("hidden")):this.languageIconPreview.classList.add("hidden"))}async uploadLanguageIcon(e){if(e)try{const t=new FormData;t.append("file",e);const a=_(),s=await fetch(`${this.baseUrl}/api/v1/upload/public`,{method:"POST",headers:a?{"X-CSRF-TOKEN":a}:{},body:t,credentials:"include"}),i=await s.json();s.ok&&i.status==="success"&&i.upload?.uuid?(this.setLanguageIcon(i.upload.uuid),this.showToast("Icon uploaded","success")):this.showToast(i.message||"Failed to upload icon","error")}catch(t){console.error("Failed to upload icon:",t),this.showToast("Failed to upload icon","error")}finally{this.languageIconFile&&(this.languageIconFile.value="")}}async saveLanguage(){const e=document.getElementById("languageNativeName"),t=document.getElementById("languageIso2"),a=document.getElementById("languageIso3"),s=document.getElementById("languageIconUuid");if(!e||!t||!a)return;const i={native_name:e.value.trim(),iso2:t.value.trim(),iso3:a.value.trim(),icon_uuid:s?.value||null};if(!i.native_name||!i.iso2||!i.iso3){this.showToast("Please fill in all required fields","error");return}const n=this.editingLanguageId?"PUT":"POST",o=this.editingLanguageId?`${this.baseUrl}/api/v1/admin/localizations/languages/${this.editingLanguageId}`:`${this.baseUrl}/api/v1/admin/localizations/languages`;try{const l=await fetch(o,{method:n,headers:h(),body:JSON.stringify(i),credentials:"include"}),r=await l.json();l.ok&&r.status==="success"?(this.showToast(r.message||"Language saved","success"),this.resetLanguageForm(),await this.loadLanguages()):this.showToast(r.message||"Failed to save language","error")}catch(l){console.error("Failed to save language:",l),this.showToast("Failed to save language","error")}}async deleteLanguage(e){try{const t=await fetch(`${this.baseUrl}/api/v1/admin/localizations/languages/${e}`,{method:"DELETE",headers:h(),credentials:"include"}),a=await t.json();t.ok&&a.status==="success"?(this.showToast("Language deleted","success"),await this.loadLanguages(),await this.loadLocales(),await this.loadLocalizationKeys()):this.showToast(a.message||"Failed to delete language","error")}catch(t){console.error("Failed to delete language:",t),this.showToast("Failed to delete language","error")}}editLocale(e){this.editingLocaleId=e.id;const t=document.getElementById("localeId"),a=document.getElementById("localeCode");t&&(t.value=e.id),a&&(a.value=e.locale_code),this.localeLanguageSelect&&(this.localeLanguageSelect.value=e.language_id)}resetLocaleForm(){this.editingLocaleId=null,this.localeForm?.reset();const e=document.getElementById("localeId");e&&(e.value="")}async saveLocale(){if(!this.localeLanguageSelect)return;const e=document.getElementById("localeCode");if(!e)return;const t={language_id:parseInt(this.localeLanguageSelect.value,10),locale_code:e.value.trim()};if(!t.language_id||!t.locale_code){this.showToast("Language and locale code are required","error");return}const a=this.editingLocaleId?"PUT":"POST",s=this.editingLocaleId?`${this.baseUrl}/api/v1/admin/localizations/locales/${this.editingLocaleId}`:`${this.baseUrl}/api/v1/admin/localizations/locales`;try{const i=await fetch(s,{method:a,headers:h(),body:JSON.stringify(t),credentials:"include"}),n=await i.json();i.ok&&n.status==="success"?(this.showToast(n.message||"Locale saved","success"),this.resetLocaleForm(),await this.loadLocales()):this.showToast(n.message||"Failed to save locale","error")}catch(i){console.error("Failed to save locale:",i),this.showToast("Failed to save locale","error")}}async deleteLocale(e){try{const t=await fetch(`${this.baseUrl}/api/v1/admin/localizations/locales/${e}`,{method:"DELETE",headers:h(),credentials:"include"}),a=await t.json();t.ok&&a.status==="success"?(this.showToast("Locale deleted","success"),await this.loadLocales(),await this.loadLocalizationKeys()):this.showToast(a.message||"Failed to delete locale","error")}catch(t){console.error("Failed to delete locale:",t),this.showToast("Failed to delete locale","error")}}populateLocalizationForm(e){this.editingLocalizationKeyId=e.id;const t=document.getElementById("localizationKeyName"),a=document.getElementById("localizationKeyContext"),s=document.getElementById("localizationKeyId");t&&(t.value=e.key),a&&(a.value=e.context||""),s&&(s.value=e.id),this.initializeLocalizationTranslations(e.translations||[]),this.renderLocalizationTabs(),this.renderTranslationInputs()}resetLocalizationForm(){this.editingLocalizationKeyId=null,this.localizationForm?.reset();const e=document.getElementById("localizationKeyId");e&&(e.value=""),this.initializeLocalizationTranslations(),this.renderLocalizationTabs(),this.renderTranslationInputs()}collectTranslations(){return this.locales.length?this.locales.map(e=>{const t=this.localizationTranslations[e.locale_code]||{singular:"",plural:""};return{locale_code:e.locale_code,singular:(t.singular||"").trim(),plural:(t.plural||"").trim()}}):[]}async saveLocalizationKey(){const e=document.getElementById("localizationKeyName");if(!e)return;const t=document.getElementById("localizationKeyContext");if(!this.locales.length){this.showToast("Add at least one locale before creating keys","error");return}const a=this.collectTranslations();if(a.find(l=>!l.singular||!l.plural)){this.showToast("Singular and plural values are required for all locales","error");return}const i={key:e.value.trim(),context:t?.value.trim()||null,translations:a};if(!i.key){this.showToast("Key is required","error");return}const n=this.editingLocalizationKeyId?"PUT":"POST",o=this.editingLocalizationKeyId?`${this.baseUrl}/api/v1/admin/localizations/keys/${this.editingLocalizationKeyId}`:`${this.baseUrl}/api/v1/admin/localizations/keys`;try{const l=await fetch(o,{method:n,headers:h(),body:JSON.stringify(i),credentials:"include"}),r=await l.json();l.ok&&r.status==="success"?(this.showToast(r.message||"Localization key saved","success"),this.resetLocalizationForm(),this.closeLocalizationModal(),await this.loadLocalizationKeys()):this.showToast(r.message||"Failed to save localization key","error")}catch(l){console.error("Failed to save localization key:",l),this.showToast("Failed to save localization key","error")}}async deleteLocalizationKey(e){try{const t=await fetch(`${this.baseUrl}/api/v1/admin/localizations/keys/${e}`,{method:"DELETE",headers:h(),credentials:"include"}),a=await t.json();t.ok&&a.status==="success"?(this.showToast("Localization key deleted","success"),await this.loadLocalizationKeys()):this.showToast(a.message||"Failed to delete localization key","error")}catch(t){console.error("Failed to delete localization key:",t),this.showToast("Failed to delete localization key","error")}}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}}class B{constructor(e){this.name=e.name,this.label=e.label,this.value=this.normalizeColor(e.value),this.themeType=e.themeType||"light",this.onChange=e.onChange||(()=>{}),this.debounceTimer=null,this.debounceDelay=100,this.element=this.createElement(),this.colorInput=this.element.querySelector(".color-picker__color"),this.textInput=this.element.querySelector(".color-picker__text"),this.init()}normalizeColor(e){if(!e)return"#000000";if(/^#[0-9A-Fa-f]{6}$/.test(e))return e.toLowerCase();if(/^#[0-9A-Fa-f]{3}$/.test(e)){const a=e[1],s=e[2],i=e[3];return`#${a}${a}${s}${s}${i}${i}`.toLowerCase()}const t=e.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);if(t){const a=parseInt(t[1]).toString(16).padStart(2,"0"),s=parseInt(t[2]).toString(16).padStart(2,"0"),i=parseInt(t[3]).toString(16).padStart(2,"0");return`#${a}${s}${i}`}return"#000000"}createElement(){const e=document.createElement("div");return e.className="color-picker",e.dataset.name=this.name,e.innerHTML=`
      <label class="color-picker__label">${this.label}</label>
      <div class="color-picker__inputs">
        <input type="color" class="color-picker__color" value="${this.value}">
        <input type="text" class="color-picker__text" value="${this.value}" maxlength="7" pattern="^#[0-9A-Fa-f]{6}$">
      </div>
      <span class="color-picker__preview" style="background-color: ${this.value}"></span>
    `,e}init(){this.colorInput.addEventListener("input",e=>{this.value=e.target.value,this.textInput.value=this.value,this.updatePreview(),this.emitChange()}),this.textInput.addEventListener("input",e=>{let t=e.target.value;t&&!t.startsWith("#")&&(t="#"+t,e.target.value=t),/^#[0-9A-Fa-f]{6}$/i.test(t)?(this.value=t.toLowerCase(),this.colorInput.value=this.value,this.updatePreview(),this.emitChange(),this.textInput.classList.remove("invalid")):this.textInput.classList.add("invalid")}),this.textInput.addEventListener("blur",()=>{this.textInput.classList.contains("invalid")&&(this.textInput.value=this.value,this.textInput.classList.remove("invalid"))})}updatePreview(){const e=this.element.querySelector(".color-picker__preview");e&&(e.style.backgroundColor=this.value)}emitChange(){clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.onChange(this.name,this.value)},this.debounceDelay)}getValue(){return this.value}setValue(e){this.value=this.normalizeColor(e),this.colorInput.value=this.value,this.textInput.value=this.value,this.updatePreview()}}class ${constructor(e){this.name=e.name,this.label=e.label,this.value=e.value||1,this.unit=e.unit||"rem",this.min=e.min||0,this.max=e.max||10,this.step=e.step||.125,this.onChange=e.onChange||(()=>{}),this.debounceTimer=null,this.debounceDelay=150,this.element=this.createElement(),this.numberInput=this.element.querySelector(".size-picker__number"),this.unitSelect=this.element.querySelector(".size-picker__unit"),this.previewBar=this.element.querySelector(".size-picker__preview-bar"),this.valueDisplay=this.element.querySelector(".size-picker__value-display"),this.init(),this.updatePreview()}createElement(){const e=document.createElement("div");e.className="size-picker",e.dataset.name=this.name;const t=this.calculatePercent();return e.innerHTML=`
      <label class="size-picker__label">${this.label}</label>
      <div class="size-picker__inputs">
        <input type="number"
               class="size-picker__number"
               value="${this.value}"
               min="${this.min}"
               max="${this.max}"
               step="${this.step}">
        <select class="size-picker__unit">
          <option value="rem" ${this.unit==="rem"?"selected":""}>rem</option>
          <option value="px" ${this.unit==="px"?"selected":""}>px</option>
          <option value="em" ${this.unit==="em"?"selected":""}>em</option>
        </select>
      </div>
      <div class="size-picker__preview">
        <div class="size-picker__preview-bar" style="width: ${t}%"></div>
      </div>
      <span class="size-picker__value-display">${this.value}${this.unit}</span>
    `,e}calculatePercent(){const e=this.max-this.min;return e===0?50:(this.value-this.min)/e*100}init(){this.numberInput.addEventListener("input",e=>{let t=parseFloat(e.target.value);isNaN(t)&&(t=this.min),t<this.min&&(t=this.min),t>this.max&&(t=this.max),this.value=t,this.updatePreview(),this.emitChange()}),this.unitSelect.addEventListener("change",e=>{this.unit=e.target.value,this.updatePreview(),this.emitChange()}),this.numberInput.addEventListener("keydown",e=>{(e.key==="ArrowUp"||e.key==="ArrowDown")&&setTimeout(()=>{this.value=parseFloat(this.numberInput.value),this.updatePreview(),this.emitChange()},0)})}updatePreview(){const e=this.calculatePercent();this.previewBar&&(this.previewBar.style.width=`${e}%`),this.valueDisplay&&(this.valueDisplay.textContent=`${this.value}${this.unit}`)}emitChange(){clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.onChange(this.name,this.value,this.unit)},this.debounceDelay)}getValue(){return`${this.value}${this.unit}`}getNumericValue(){return this.value}getUnit(){return this.unit}setValue(e,t){this.value=e,t&&(this.unit=t),this.numberInput.value=this.value,this.unitSelect.value=this.unit,this.updatePreview()}}class k{constructor(e){this.name=e.name,this.label=e.label,this.currentUuid=e.currentUuid||null,this.previewElement=e.previewElement,this.placeholderElement=e.placeholderElement,this.selectButton=e.selectButton,this.removeButton=e.removeButton,this.onSelect=e.onSelect||(()=>{}),this.onRemove=e.onRemove||(()=>{}),this.openModal=e.openModal||(()=>{}),this.init(),this.updateDisplay()}init(){this.selectButton&&this.selectButton.addEventListener("click",()=>{this.openModal(this.name)}),this.removeButton&&this.removeButton.addEventListener("click",()=>{this.remove()})}updateDisplay(){this.currentUuid?(this.previewElement&&(this.previewElement.src=`/api/v1/upload/public/${this.currentUuid}?variant=small`,this.previewElement.classList.remove("hidden")),this.placeholderElement&&this.placeholderElement.classList.add("hidden"),this.removeButton&&this.removeButton.classList.remove("hidden")):(this.previewElement&&this.previewElement.classList.add("hidden"),this.placeholderElement&&this.placeholderElement.classList.remove("hidden"),this.removeButton&&this.removeButton.classList.add("hidden"))}select(e){this.currentUuid=e,this.updateDisplay(),this.onSelect(e)}remove(){this.currentUuid=null,this.updateDisplay(),this.onRemove()}getUuid(){return this.currentUuid}setUuid(e){this.currentUuid=e,this.updateDisplay()}}class F{constructor(e){this.container=e.container,this.baseUrl=e.baseUrl||"",this.onSelect=e.onSelect||(()=>{}),this.onPathChange=e.onPathChange||(()=>{}),this.csrfHeaders=e.csrfHeaders||{},this.path=[],this.currentChildren=[],this.isLoading=!1,this.selectedType=null,this.childrenCache=new Map,this.render()}async fetchCategories(){try{this.isLoading=!0,this.renderLoading();const e=await fetch(`${this.baseUrl}/api/v1/schemas/categories`,{headers:{Accept:"application/json",...this.csrfHeaders}});if(!e.ok)throw new Error("Failed to fetch schema categories");const t=await e.json();t.status==="success"&&t.categories&&(this.currentChildren=t.categories.map(a=>({type:a.type,label:a.label,description:a.description,hasChildren:a.has_children})))}catch(e){console.error("Error fetching schema categories:",e),this.currentChildren=[]}finally{this.isLoading=!1,this.renderDropdown()}}async fetchChildren(e){if(this.childrenCache.has(e))return this.childrenCache.get(e);try{const t=await fetch(`${this.baseUrl}/api/v1/schemas/children/${encodeURIComponent(e)}`,{headers:{Accept:"application/json",...this.csrfHeaders}});if(!t.ok)throw new Error(`Failed to fetch children for ${e}`);const a=await t.json();if(a.status==="success"&&a.children){const s=a.children.map(i=>({type:i.type,label:i.label,description:i.description,hasChildren:i.has_children}));return this.childrenCache.set(e,s),s}}catch(t){console.error(`Error fetching children for ${e}:`,t)}return[]}async navigateTo(e){this.path.push({type:e.type,label:e.label,hasChildren:e.hasChildren}),this.selectedType=e.type,this.onPathChange(this.path),e.hasChildren?(this.isLoading=!0,this.renderLoading(),this.currentChildren=await this.fetchChildren(e.type),this.isLoading=!1,this.renderDropdown()):(this.currentChildren=[],this.renderDropdown()),this.onSelect(e.type,this.path)}async navigateToLevel(e){if(e<0){this.path=[],this.selectedType=null,this.onPathChange(this.path),this.onSelect(null,this.path),await this.fetchCategories();return}this.path=this.path.slice(0,e+1);const t=this.path[e];this.selectedType=t.type,this.onPathChange(this.path),this.onSelect(t.type,this.path),t.hasChildren?(this.isLoading=!0,this.renderLoading(),this.currentChildren=await this.fetchChildren(t.type),this.isLoading=!1,this.renderDropdown()):(this.currentChildren=[],this.renderDropdown())}async reset(){this.path=[],this.selectedType=null,this.currentChildren=[],this.onPathChange(this.path),this.onSelect(null,this.path),await this.fetchCategories()}async setSelection(e,t=[]){this.path=[];for(let s=0;s<t.length;s++){const i=t[s],o=(s===0?await this.fetchCategories().then(()=>this.currentChildren):await this.fetchChildren(t[s-1]))?.find(l=>l.type===i);o&&this.path.push({type:o.type,label:o.label,hasChildren:o.hasChildren})}this.selectedType=e;const a=this.path[this.path.length-1];a?.hasChildren?this.currentChildren=await this.fetchChildren(a.type):this.currentChildren=[],this.renderDropdown(),this.onPathChange(this.path)}render(){this.container.innerHTML=`
      <div class="schema-selector">
        <div class="schema-selector__breadcrumb"></div>
        <div class="schema-selector__dropdown-container">
          <select class="schema-selector__dropdown form-select" aria-label="Select schema type">
            <option value="">Select a category...</option>
          </select>
        </div>
        <div class="schema-selector__description"></div>
      </div>
    `,this.breadcrumbEl=this.container.querySelector(".schema-selector__breadcrumb"),this.dropdownEl=this.container.querySelector(".schema-selector__dropdown"),this.descriptionEl=this.container.querySelector(".schema-selector__description"),this.dropdownEl.addEventListener("change",e=>this.handleDropdownChange(e)),this.fetchCategories()}renderLoading(){this.dropdownEl.innerHTML='<option value="">Loading...</option>',this.dropdownEl.disabled=!0}renderBreadcrumb(){if(this.path.length===0){this.breadcrumbEl.innerHTML="";return}const e=this.path.map((t,a)=>{const s=a===this.path.length-1;return`
        <span class="schema-selector__breadcrumb-item ${s?"schema-selector__breadcrumb-item--active":""}"
              data-index="${a}"
              ${s?"":'role="button" tabindex="0"'}>
          ${t.label}
        </span>
      `}).join('<span class="schema-selector__breadcrumb-separator">/</span>');this.breadcrumbEl.innerHTML=`
      <span class="schema-selector__breadcrumb-item schema-selector__breadcrumb-item--root"
            role="button" tabindex="0" data-index="-1">
        Thing
      </span>
      <span class="schema-selector__breadcrumb-separator">/</span>
      ${e}
    `,this.breadcrumbEl.querySelectorAll('[role="button"]').forEach(t=>{t.addEventListener("click",()=>{const a=parseInt(t.dataset.index,10);this.navigateToLevel(a)}),t.addEventListener("keydown",a=>{if(a.key==="Enter"||a.key===" "){a.preventDefault();const s=parseInt(t.dataset.index,10);this.navigateToLevel(s)}})})}renderDropdown(){if(this.renderBreadcrumb(),this.dropdownEl.disabled=!1,this.currentChildren.length===0){if(this.path.length>0){this.dropdownEl.innerHTML='<option value="">No subtypes available</option>';const a=this.path[this.path.length-1];this.descriptionEl.innerHTML=`
          <div class="schema-selector__selected">
            <strong>Selected:</strong> ${a.label}
            <span class="schema-selector__use-btn" role="button" tabindex="0">Use this schema</span>
          </div>
        `;const s=this.descriptionEl.querySelector(".schema-selector__use-btn");s&&s.addEventListener("click",()=>{this.onSelect(a.type,this.path,!0)})}else this.dropdownEl.innerHTML='<option value="">Select a category...</option>',this.descriptionEl.innerHTML="";return}const e=this.path.length===0?"Select a category...":"Select a subtype...",t=this.currentChildren.map(a=>{const s=a.hasChildren?" >":"";return`<option value="${a.type}" data-description="${this.escapeHtml(a.description||"")}" data-has-children="${a.hasChildren}">${a.label}${s}</option>`});if(this.dropdownEl.innerHTML=`
      <option value="">${e}</option>
      ${t.join("")}
    `,this.path.length>0){const a=this.path[this.path.length-1];this.descriptionEl.innerHTML=`
        <div class="schema-selector__selected">
          <strong>Current:</strong> ${a.label}
          <span class="schema-selector__use-btn" role="button" tabindex="0">Use this schema</span>
        </div>
      `;const s=this.descriptionEl.querySelector(".schema-selector__use-btn");s&&s.addEventListener("click",()=>{this.onSelect(a.type,this.path,!0)})}else this.descriptionEl.innerHTML=""}handleDropdownChange(e){const t=e.target.value;if(!t)return;const a=e.target.querySelector(`option[value="${t}"]`);a?.dataset.description,a?.dataset.hasChildren;const s=this.currentChildren.find(i=>i.type===t);s&&this.navigateTo(s)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}getSelection(){return{type:this.selectedType,path:this.path.map(e=>e.type)}}}class w{constructor(e){this.container=e.container,this.baseUrl=e.baseUrl||"",this.onChange=e.onChange||(()=>{}),this.csrfHeaders=e.csrfHeaders||{},this.maxNestingDepth=e.maxNestingDepth!==void 0?e.maxNestingDepth:20,this.currentDepth=e.currentDepth||0,this.langCode=e.langCode||"en",this.schemaType=null,this.schemaDefinition=null,this.formData={},this.nestedForms=new Map,this.entitySelectorPopup=null,this.schemaCache=e.sharedCache||new Map,this.entityCache=e.entityCache||new Map}async fetchSchema(e){if(this.schemaCache.has(e))return this.schemaCache.get(e);try{const t=await fetch(`${this.baseUrl}/api/v1/schemas/${encodeURIComponent(e)}`,{headers:{Accept:"application/json",...this.csrfHeaders}});if(!t.ok)throw new Error(`Failed to fetch schema for ${e}`);const a=await t.json();if(a.status==="success"&&a.schema)return this.schemaCache.set(e,a.schema),a.schema}catch(t){console.error(`Error fetching schema ${e}:`,t)}return null}async fetchExistingEntities(e,t=""){const a=`${e}:${this.langCode}:${t}`;if(!t&&this.entityCache.has(a))return this.entityCache.get(a);try{const s=new URLSearchParams({lang_code:this.langCode,schema_type:e,limit:"50"});t&&s.append("q",t);const i=await fetch(`${this.baseUrl}/api/v1/admin/seo/entities?${s}`,{headers:{Accept:"application/json",...this.csrfHeaders}});if(!i.ok)throw new Error(`Failed to fetch entities for ${e}`);const n=await i.json();if(n.status==="success"&&Array.isArray(n.entities))return t||this.entityCache.set(a,n.entities),n.entities}catch(s){console.error(`Error fetching entities ${e}:`,s)}return[]}async loadSchema(e,t={}){this.container.innerHTML='<div class="schema-form__loading">Loading schema...</div>';const a=await this.fetchSchema(e);if(!a){this.container.innerHTML='<div class="schema-form__error">Failed to load schema definition.</div>';return}this.schemaType=e,this.schemaDefinition=a,this.formData={"@type":e,...t},this.nestedForms.clear(),this.render(this.currentDepth)}render(e=0){if(!this.schemaDefinition){this.container.innerHTML='<div class="schema-form__empty">No schema loaded.</div>';return}const{properties:t}=this.schemaDefinition,a=t.filter(n=>!n.is_inherited),s=t.filter(n=>n.is_inherited),i=this.formData["@id"]||"";this.container.innerHTML=`
      <div class="schema-form" data-depth="${e}">
        <div class="schema-form__header">
          <span class="schema-form__type-badge">${this.schemaType}</span>
          <span class="schema-form__path">${this.schemaDefinition.path?.join(" > ")||""}</span>
        </div>

        <!-- @id field - required for every entity -->
        <div class="schema-form__id-section">
          <div class="schema-form__field schema-form__field--id">
            <label class="schema-form__label" for="schema-id-${e}">
              <span class="schema-form__label-text">@id</span>
              <span class="schema-form__required-badge">Required</span>
            </label>
            <div class="schema-form__description">
              Unique identifier for this ${this.schemaType}. Use format: <code>urn:{lang}:${this.schemaType.toLowerCase()}:your-unique-id</code>
            </div>
            <input type="text"
                   id="schema-id-${e}"
                   name="@id"
                   value="${this.escapeHtml(i)}"
                   class="schema-form__input schema-form__input--id form-input"
                   placeholder="urn:en:${this.schemaType.toLowerCase()}:unique-identifier"
                   data-entity-id="true">
          </div>
        </div>

        ${a.length>0?`
          <fieldset class="schema-form__section">
            <legend class="schema-form__section-title">Properties of ${this.schemaType}</legend>
            <div class="schema-form__fields schema-form__fields--own">
              ${a.map(n=>this.renderPropertyField(n,e)).join("")}
            </div>
          </fieldset>
        `:""}

        ${s.length>0?`
          <fieldset class="schema-form__section schema-form__section--inherited">
            <legend class="schema-form__section-title">
              <button type="button" class="schema-form__toggle-inherited" aria-expanded="false">
                Inherited Properties (${s.length})
                <span class="schema-form__toggle-icon">+</span>
              </button>
            </legend>
            <div class="schema-form__fields schema-form__fields--inherited" style="display: none;">
              ${s.map(n=>this.renderPropertyField(n,e)).join("")}
            </div>
          </fieldset>
        `:""}
      </div>
    `,this.bindEventListeners(e)}renderPropertyField(e,t){const{name:a,label:s,description:i,expected_types:n,defined_on:o,is_inherited:l}=e,r=`schema-field-${a}-${t}`,c=this.formData[a]||"",d=n&&n.length>1;return n?.some(u=>u.kind==="entity"),n?.some(u=>u.kind==="data_type"),`
      <div class="schema-form__field" data-property="${a}">
        <label class="schema-form__label" for="${r}">
          <span class="schema-form__label-text">${s||a}</span>
          ${l?`<span class="schema-form__inherited-badge" title="Inherited from ${o}">${o}</span>`:""}
        </label>

        ${i?`<div class="schema-form__description">${this.formatDescription(i)}</div>`:""}

        ${d?this.renderMultiTypeSelector(e,r,t):this.renderSingleTypeInput(e,r,c,t)}
      </div>
    `}renderMultiTypeSelector(e,t,a){const{name:s,expected_types:i}=e,n=this.formData[`${s}__type`]||"";return`
      <div class="schema-form__type-selector">
        <div class="schema-form__type-options">
          ${[...i].sort((l,r)=>l.kind==="data_type"&&r.kind==="entity"?-1:l.kind==="entity"&&r.kind==="data_type"?1:l.type.localeCompare(r.type)).map((l,r)=>`
            <label class="schema-form__type-option">
              <input type="radio"
                     name="${s}__type"
                     value="${l.type}"
                     class="schema-form__type-radio"
                     data-kind="${l.kind}"
                     ${n===l.type?"checked":""}>
              <span class="schema-form__type-label">
                ${l.type}
                <span class="schema-form__type-kind schema-form__type-kind--${l.kind}">${l.kind==="data_type"?"text":"entity"}</span>
              </span>
            </label>
          `).join("")}
        </div>

        <div class="schema-form__type-input" data-property="${s}">
          ${n?this.renderTypeInput(e,n,i.find(l=>l.type===n),t,a):'<p class="schema-form__hint">Select a type above</p>'}
        </div>
      </div>
    `}renderTypeInput(e,t,a,s,i){if(!a)return"";const{name:n}=e,o=this.formData[n]||"";return a.kind==="data_type"?this.renderDataTypeInput(n,t,s,o):this.renderEntityTypeInput(n,t,s,o,i)}renderDataTypeInput(e,t,a,s){const i=this.getInputTypeForDataType(t),n=this.getPlaceholderForDataType(t);return`
      <input type="${i}"
             id="${a}"
             name="${e}"
             value="${this.escapeHtml(s)}"
             class="schema-form__input form-input"
             placeholder="${n}"
             data-data-type="${t}">
    `}renderEntityTypeInput(e,t,a,s,i){const n=typeof s=="object"&&s!==null&&!s["@id"],o=typeof s=="string"?s:s?.["@id"]||"",l=i<this.maxNestingDepth,r=i+1;return`
      <div class="schema-form__entity-input" data-entity-depth="${i}">
        <div class="schema-form__entity-options">
          <div class="schema-form__entity-option schema-form__entity-option--ref ${n?"":"schema-form__entity-option--active"}">
            <div class="schema-form__entity-option-header">
              <label class="schema-form__radio-label">
                <input type="radio"
                       name="${e}__mode"
                       value="reference"
                       class="schema-form__mode-radio"
                       data-property="${e}"
                       ${n?"":"checked"}>
                <span class="schema-form__option-title">Reference existing ${t}</span>
              </label>
            </div>
            <div class="schema-form__entity-ref-content" ${n?'style="display: none;"':""}>
              <div class="schema-form__entity-ref-input-row">
                <input type="text"
                       id="${a}-id"
                       name="${e}__id"
                       value="${this.escapeHtml(o)}"
                       class="schema-form__input form-input schema-form__entity-id-input"
                       placeholder="@id: urn:${this.langCode}:${t.toLowerCase()}:example-id"
                       ${n?"disabled":""}>
                <button type="button"
                        class="schema-form__browse-btn btn btn-secondary"
                        data-property="${e}"
                        data-entity-type="${t}"
                        title="Browse existing ${t} entities">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                  </svg>
                  Browse
                </button>
              </div>
              <small class="schema-form__hint">Enter @id manually or browse existing ${t} entities</small>
            </div>
          </div>

          ${l?`
            <div class="schema-form__entity-option schema-form__entity-option--inline ${n?"schema-form__entity-option--active":""}">
              <div class="schema-form__entity-option-header">
                <label class="schema-form__radio-label">
                  <input type="radio"
                         name="${e}__mode"
                         value="inline"
                         class="schema-form__mode-radio"
                         data-property="${e}"
                         data-entity-type="${t}"
                         ${n?"checked":""}>
                  <span class="schema-form__option-title">Create new ${t} inline</span>
                  <span class="schema-form__depth-badge" title="Nesting level ${r}">Level ${r}</span>
                </label>
              </div>
              <div class="schema-form__nested-form"
                   data-property="${e}"
                   data-entity-type="${t}"
                   style="${n?"":"display: none;"}">
                <!-- Nested form will be rendered here -->
              </div>
            </div>
          `:`
            <div class="schema-form__entity-option schema-form__entity-option--disabled">
              <p class="schema-form__depth-warning">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="12"></line>
                  <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                Maximum nesting depth (${this.maxNestingDepth}) reached. Use @id reference above.
              </p>
            </div>
          `}
        </div>
      </div>
    `}renderSingleTypeInput(e,t,a,s=0){const{name:i,expected_types:n}=e;if(!n||n.length===0)return`
        <input type="text"
               id="${t}"
               name="${i}"
               value="${this.escapeHtml(a)}"
               class="schema-form__input form-input"
               placeholder="Enter value...">
      `;const o=n[0];return o.kind==="data_type"?this.renderDataTypeInput(i,o.type,t,a):this.renderEntityTypeInput(i,o.type,t,a,s)}getInputTypeForDataType(e){return{Text:"text",URL:"url",Number:"number",Integer:"number",Float:"number",Date:"date",DateTime:"datetime-local",Time:"time",Boolean:"checkbox",Email:"email",Telephone:"tel"}[e]||"text"}getPlaceholderForDataType(e){return{Text:"Enter text...",URL:"https://example.com",Number:"0",Integer:"0",Float:"0.00",Date:"YYYY-MM-DD",DateTime:"YYYY-MM-DDTHH:MM",Time:"HH:MM",Boolean:"",Email:"email@example.com",Telephone:"+1-555-123-4567"}[e]||"Enter value..."}bindEventListeners(e){const t=this.container.querySelector(`.schema-form[data-depth="${e}"]`);if(!t){console.warn(`[SchemaFormBuilder] Could not find schema-form at depth ${e}`);return}const a=n=>{const o=n.closest(".schema-form__nested-form");return o&&o!==this.container},s=t.querySelector(":scope > .schema-form__section--inherited .schema-form__toggle-inherited");if(s){const n=s.cloneNode(!0);s.parentNode.replaceChild(n,s),n.addEventListener("click",o=>{o.stopPropagation();const l=n.getAttribute("aria-expanded")==="true";n.setAttribute("aria-expanded",!l),n.querySelector(".schema-form__toggle-icon").textContent=l?"+":"-";const r=n.closest(".schema-form__section--inherited")?.querySelector(".schema-form__fields--inherited");r&&(r.style.display=l?"none":"block")})}const i=t.querySelector(":scope > .schema-form__id-section .schema-form__input--id");i&&(i.addEventListener("input",n=>this.handleIdChange(n)),i.addEventListener("change",n=>this.handleIdChange(n))),t.querySelectorAll(":scope > .schema-form__section .schema-form__type-radio").forEach(n=>{a(n)||n.addEventListener("change",o=>this.handleTypeChange(o,e))}),t.querySelectorAll(":scope > .schema-form__section .schema-form__input").forEach(n=>{a(n)||(n.addEventListener("input",o=>this.handleInputChange(o)),n.addEventListener("change",o=>this.handleInputChange(o)))}),t.querySelectorAll(":scope > .schema-form__section .schema-form__mode-radio").forEach(n=>{a(n)||n.addEventListener("change",o=>this.handleModeChange(o,e))}),t.querySelectorAll(":scope > .schema-form__section .schema-form__browse-btn").forEach(n=>{a(n)||n.addEventListener("click",o=>this.handleBrowseEntities(o))}),t.querySelectorAll(":scope > .schema-form__section .schema-form__inline-checkbox").forEach(n=>{a(n)||n.addEventListener("change",o=>this.handleInlineToggle(o,e))})}async handleModeChange(e,t){const a=e.target,s=a.dataset.property,i=a.value,n=a.dataset.entityType;console.log(`[SchemaFormBuilder] handleModeChange: ${s} -> ${i} at depth ${t}`);const o=a.closest(".schema-form__entity-options");if(!o)return;o.querySelectorAll(".schema-form__entity-option").forEach(u=>{u.classList.remove("schema-form__entity-option--active")});const l=a.closest(".schema-form__entity-option");l&&l.classList.add("schema-form__entity-option--active");const r=o.querySelector(".schema-form__entity-ref-content"),c=o.querySelector(`.schema-form__nested-form[data-property="${s}"]`),d=o.querySelector(`input[name="${s}__id"]`);if(i==="reference")r&&(r.style.display=""),c&&(c.style.display="none"),d&&(d.disabled=!1);else if(i==="inline"&&c){r&&(r.style.display="none"),d&&(d.disabled=!0),c.style.display="block";const u=this.nestedForms.get(s);if(!u||u.schemaType!==n){c.innerHTML='<div class="schema-form__loading">Loading schema...</div>';const g=t+1;console.log(`[SchemaFormBuilder] Creating nested form for ${n} at depth ${g}`);const T=new w({container:c,baseUrl:this.baseUrl,csrfHeaders:this.csrfHeaders,maxNestingDepth:this.maxNestingDepth,currentDepth:g,sharedCache:this.schemaCache,entityCache:this.entityCache,langCode:this.langCode,onChange:()=>this.notifyChange()});try{await T.loadSchema(n,this.formData[s]||{}),this.nestedForms.set(s,T),console.log(`[SchemaFormBuilder] Successfully loaded nested schema for ${n}`)}catch(E){console.error(`[SchemaFormBuilder] Failed to load nested schema for ${n}:`,E),c.innerHTML=`<div class="schema-form__error">Failed to load ${n} schema.</div>`}}else console.log(`[SchemaFormBuilder] Reusing cached nested form for ${n}`),u.container=c,u.render(t+1)}this.notifyChange()}handleTypeChange(e,t){const a=e.target,s=a.name.replace("__type",""),i=a.value,n=a.dataset.kind;console.log(`[SchemaFormBuilder] handleTypeChange: ${s} -> ${i} (${n}) at depth ${t}`),this.formData[`${s}__type`]=i,this.nestedForms.has(s)&&(console.log(`[SchemaFormBuilder] Type changed for ${s}, clearing old nested form`),this.nestedForms.delete(s),delete this.formData[s]);const o=this.schemaDefinition.properties.find(d=>d.name===s),l=o?.expected_types?.find(d=>d.type===i);console.log("[SchemaFormBuilder] Found prop:",o?.name,"typeInfo:",l);let c=a.closest(".schema-form__type-selector")?.querySelector(`.schema-form__type-input[data-property="${s}"]`);c||(c=this.container.querySelector(`.schema-form__type-input[data-property="${s}"]`)),c&&l?(console.log(`[SchemaFormBuilder] Rendering type input for ${i}`),c.innerHTML=this.renderTypeInput(o,i,l,`schema-field-${s}-${t}`,t),c.querySelectorAll(".schema-form__input").forEach(d=>{d.addEventListener("input",u=>this.handleInputChange(u)),d.addEventListener("change",u=>this.handleInputChange(u))}),c.querySelectorAll(".schema-form__mode-radio").forEach(d=>{console.log(`[SchemaFormBuilder] Binding mode radio for ${d.dataset.property} (${d.dataset.entityType})`),d.addEventListener("change",u=>this.handleModeChange(u,t))}),c.querySelectorAll(".schema-form__browse-btn").forEach(d=>{console.log(`[SchemaFormBuilder] Binding browse button for ${d.dataset.property} (${d.dataset.entityType})`),d.addEventListener("click",u=>this.handleBrowseEntities(u))}),c.querySelectorAll(".schema-form__inline-checkbox").forEach(d=>{console.log(`[SchemaFormBuilder] Binding inline checkbox for ${d.dataset.property} (${d.dataset.entityType})`),d.addEventListener("change",u=>this.handleInlineToggle(u,t))})):console.warn(`[SchemaFormBuilder] Could not find inputContainer for ${s} or missing typeInfo`),this.notifyChange()}handleIdChange(e){const a=e.target.value.trim();a?this.formData["@id"]=a:delete this.formData["@id"],this.notifyChange()}handleInputChange(e){const t=e.target,a=t.name.replace("__id","");t.type==="checkbox"?this.formData[a]=t.checked:this.formData[a]=t.value,this.notifyChange()}async handleInlineToggle(e,t){const a=e.target,s=a.dataset.property,i=a.dataset.entityType;console.log(`[SchemaFormBuilder] handleInlineToggle called for ${s} (${i}) at depth ${t}`);const n=a.closest(".schema-form__entity-inline");let o=n?.querySelector(`.schema-form__nested-form[data-property="${s}"]`);if(o||(o=this.container.querySelector(`.schema-form__nested-form[data-property="${s}"][data-entity-type="${i}"]`)),!o){console.error(`[SchemaFormBuilder] Could not find nested container for property: ${s}, entityType: ${i}`),console.log("[SchemaFormBuilder] Container HTML:",this.container.innerHTML.substring(0,500));return}console.log(`[SchemaFormBuilder] Found nested container for ${s}`);const r=n?.closest(".schema-form__entity-input")?.querySelector(".schema-form__entity-ref")?.querySelector(`input[name="${s}__id"]`)||this.container.querySelector(`input[name="${s}__id"]`);if(r&&(r.disabled=a.checked,console.log(`[SchemaFormBuilder] ${a.checked?"Disabled":"Enabled"} @id input for ${s}`)),a.checked){o.style.display="block",o.innerHTML='<div class="schema-form__loading">Loading nested schema...</div>';const c=this.nestedForms.get(s);if(!c||c.schemaType!==i){c&&(console.log(`[SchemaFormBuilder] Entity type mismatch for ${s}: cached=${c.schemaType}, requested=${i}`),this.nestedForms.delete(s));const u=t+1;console.log(`[SchemaFormBuilder] Creating nested form for ${i} at depth ${u}`);const p=new w({container:o,baseUrl:this.baseUrl,csrfHeaders:this.csrfHeaders,maxNestingDepth:this.maxNestingDepth,currentDepth:u,sharedCache:this.schemaCache,entityCache:this.entityCache,langCode:this.langCode,onChange:()=>this.notifyChange()});try{console.log(`[SchemaFormBuilder] Loading nested schema ${i} into container:`,o),await p.loadSchema(i,this.formData[s]||{}),this.nestedForms.set(s,p),console.log(`[SchemaFormBuilder] Successfully loaded nested schema for ${i}`),console.log(`[SchemaFormBuilder] Nested builder container now has ${o.children.length} children`)}catch(g){console.error(`[SchemaFormBuilder] Failed to load nested schema for ${i}:`,g),o.innerHTML=`<div class="schema-form__error">Failed to load ${i} schema.</div>`}}else console.log(`[SchemaFormBuilder] Reusing cached nested form for ${i}`),c.container=o,c.render(t+1)}else o.style.display="none";this.notifyChange()}async handleBrowseEntities(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget,a=t.dataset.property,s=t.dataset.entityType;console.log(`[SchemaFormBuilder] Browse entities for ${a} (${s})`),this.closeEntitySelector(),t.classList.add("loading"),t.disabled=!0;try{const i=await this.fetchExistingEntities(s);this.showEntitySelector(t,a,s,i)}catch(i){console.error("[SchemaFormBuilder] Error fetching entities:",i)}finally{t.classList.remove("loading"),t.disabled=!1}}showEntitySelector(e,t,a,s){const i=document.createElement("div");i.className="schema-form__entity-selector",i.dataset.property=t;const n=s&&s.length>0;i.innerHTML=`
      <div class="schema-form__entity-selector-header">
        <span class="schema-form__entity-selector-title">Select ${a}</span>
        <button type="button" class="schema-form__entity-selector-close" title="Close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="schema-form__entity-selector-search">
        <input type="text"
               class="schema-form__entity-selector-input form-input"
               placeholder="Search by @id..."
               data-entity-type="${a}">
      </div>
      <div class="schema-form__entity-selector-list">
        ${n?this.renderEntityList(s):`
          <div class="schema-form__entity-selector-empty">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <p>No ${a} entities found.</p>
            <small>Create one using the schema form first.</small>
          </div>
        `}
      </div>
    `;const o=e.getBoundingClientRect(),l=this.container.getBoundingClientRect();i.style.position="absolute",i.style.top=`${o.bottom-l.top+5}px`,i.style.right=`${l.right-o.right}px`,i.style.left="auto",i.style.zIndex="1000",this.container.style.position="relative",this.container.appendChild(i),this.entitySelectorPopup=i,this.bindEntitySelectorEvents(i,t,a);const r=i.querySelector(".schema-form__entity-selector-input");r&&r.focus(),setTimeout(()=>{document.addEventListener("click",this.handleOutsideClick)},0)}renderEntityList(e){return e.map(t=>{const a=t.schema_id||"",s=t.schema_type||"",i=t.schema_data||{},n=i.name||i.addressLocality||i.streetAddress||i.givenName||i.familyName||i.title||a;return`
        <div class="schema-form__entity-selector-item"
             data-schema-id="${this.escapeHtml(a)}"
             data-schema-type="${this.escapeHtml(s)}"
             tabindex="0">
          <div class="schema-form__entity-selector-item-main">
            <span class="schema-form__entity-selector-item-id">${this.escapeHtml(a)}</span>
            ${n!==a?`<span class="schema-form__entity-selector-item-name">${this.escapeHtml(n)}</span>`:""}
          </div>
          <span class="schema-form__entity-selector-item-type">${this.escapeHtml(s)}</span>
        </div>
      `}).join("")}bindEntitySelectorEvents(e,t,a){const s=e.querySelector(".schema-form__entity-selector-close");s&&s.addEventListener("click",()=>this.closeEntitySelector());const i=e.querySelector(".schema-form__entity-selector-input");if(i){let n;i.addEventListener("input",async o=>{clearTimeout(n),n=setTimeout(async()=>{const l=o.target.value.trim(),r=await this.fetchExistingEntities(a,l),c=e.querySelector(".schema-form__entity-selector-list");c&&(r&&r.length>0?(c.innerHTML=this.renderEntityList(r),this.bindEntityItemEvents(e,t)):c.innerHTML=`
                <div class="schema-form__entity-selector-empty">
                  <p>No results for "${this.escapeHtml(l)}"</p>
                </div>
              `)},300)}),i.addEventListener("keydown",o=>{if(o.key==="Escape")this.closeEntitySelector();else if(o.key==="ArrowDown"){o.preventDefault();const l=e.querySelector(".schema-form__entity-selector-item");l&&l.focus()}})}this.bindEntityItemEvents(e,t)}bindEntityItemEvents(e,t){e.querySelectorAll(".schema-form__entity-selector-item").forEach(a=>{a.addEventListener("click",()=>{const s=a.dataset.schemaId;this.selectEntity(t,s)}),a.addEventListener("keydown",s=>{if(s.key==="Enter"||s.key===" "){s.preventDefault();const i=a.dataset.schemaId;this.selectEntity(t,i)}else if(s.key==="Escape")this.closeEntitySelector();else if(s.key==="ArrowDown"){s.preventDefault();const i=a.nextElementSibling;i&&i.classList.contains("schema-form__entity-selector-item")&&i.focus()}else if(s.key==="ArrowUp"){s.preventDefault();const i=a.previousElementSibling;if(i&&i.classList.contains("schema-form__entity-selector-item"))i.focus();else{const n=e.querySelector(".schema-form__entity-selector-input");n&&n.focus()}}})})}selectEntity(e,t){console.log(`[SchemaFormBuilder] Selected entity: ${t} for ${e}`);const a=this.container.querySelector(`input[name="${e}__id"]`);a&&(a.value=t,a.dispatchEvent(new Event("input",{bubbles:!0})),a.dispatchEvent(new Event("change",{bubbles:!0}))),this.formData[e]=t,this.closeEntitySelector(),this.notifyChange()}closeEntitySelector(){this.entitySelectorPopup&&(this.entitySelectorPopup.remove(),this.entitySelectorPopup=null),document.removeEventListener("click",this.handleOutsideClick)}handleOutsideClick=e=>{this.entitySelectorPopup&&!this.entitySelectorPopup.contains(e.target)&&(e.target.closest(".schema-form__browse-btn")||this.closeEntitySelector())};notifyChange(){this.onChange(this.getData())}getData(){const e={"@type":this.schemaType};return this.formData["@id"]&&(e["@id"]=this.formData["@id"]),this.container.querySelectorAll(".schema-form__input:not([disabled])").forEach(t=>{let a=t.name.replace("__id",""),s=t.type==="checkbox"?t.checked:t.value;t.dataset.entityId!=="true"&&s!==""&&s!==!1&&(t.name.endsWith("__id")?e[a]={"@id":s}:t.name.includes("__")||(e[a]=s))}),this.nestedForms.forEach((t,a)=>{const s=t.getData();Object.keys(s).length>1&&(e[a]=s)}),e}async setData(e){this.formData={...e},e["@type"]&&e["@type"]!==this.schemaType?await this.loadSchema(e["@type"],e):this.render(this.currentDepth)}clear(){this.schemaType=null,this.schemaDefinition=null,this.formData={},this.nestedForms.clear(),this.container.innerHTML='<div class="schema-form__empty">Select a schema type to begin.</div>'}reset(){this.clear()}escapeHtml(e){if(typeof e!="string")return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}formatDescription(e){if(typeof e!="string"||!e)return"";let t=this.escapeHtml(e);return t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer" class="schema-form__link">$1</a>'),t=t.replace(/\[\[([^\]]+)\]\]/g,'<a href="https://schema.org/$1" target="_blank" rel="noopener noreferrer" class="schema-form__schema-link">$1</a>'),t=t.replace(/\*([^*]+)\*/g,"<em>$1</em>"),t=t.replace(/\\n\\n/g,'</p><p class="schema-form__description-para">'),t=t.replace(/\n\n/g,'</p><p class="schema-form__description-para">'),t=t.replace(/\\n/g,"<br>"),t=t.replace(/\n/g,"<br>"),t.includes("</p><p")&&(t='<p class="schema-form__description-para">'+t+"</p>"),t}}class A{constructor(e){this.container=e.container,this.baseUrl=e.baseUrl||"",this.onAssign=e.onAssign||(()=>{}),this.showToast=e.showToast||console.log,this.csrfHeaders=e.csrfHeaders||{},this.langCode=e.langCode||"en",this.entityTypes=[],this.selectedType=null,this.entities=[],this.searchQuery="",this.isLoading=!1,this.elements={}}async init(){this.render(),await this.loadEntityTypes()}render(){this.container.innerHTML=`
      <div class="schema-assignment">
        <div class="schema-assignment__header">
          <h4 class="schema-assignment__title">Assign Existing Schema</h4>
          <p class="schema-assignment__desc">Select from previously created schema entities to add to this page.</p>
        </div>

        <div class="schema-assignment__filters">
          <div class="form-group">
            <label class="form-label" for="entityTypeSelect">Schema Type</label>
            <select class="form-select" id="entityTypeSelect">
              <option value="">Select a type...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="entitySearch">Search</label>
            <div class="input-group">
              <input type="text" class="form-input" id="entitySearch" placeholder="Search entities...">
              <button type="button" class="btn btn--secondary" id="entitySearchBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <div class="schema-assignment__content">
          <div class="schema-assignment__loading hidden" id="entityLoading">
            <div class="loading-spinner"></div>
            <span>Loading entities...</span>
          </div>
          <div class="schema-assignment__empty" id="entityEmpty">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            </svg>
            <p>Select a schema type to browse entities</p>
          </div>
          <div class="schema-assignment__list" id="entityList"></div>
        </div>
      </div>
    `,this.elements={typeSelect:this.container.querySelector("#entityTypeSelect"),searchInput:this.container.querySelector("#entitySearch"),searchBtn:this.container.querySelector("#entitySearchBtn"),loading:this.container.querySelector("#entityLoading"),empty:this.container.querySelector("#entityEmpty"),list:this.container.querySelector("#entityList")},this.setupEventListeners()}setupEventListeners(){this.elements.typeSelect.addEventListener("change",()=>{this.selectedType=this.elements.typeSelect.value||null,this.searchQuery="",this.elements.searchInput.value="",this.selectedType?this.loadEntities():this.showEmptyState("Select a schema type to browse entities")}),this.elements.searchBtn.addEventListener("click",()=>{this.searchQuery=this.elements.searchInput.value.trim(),this.selectedType&&this.loadEntities()}),this.elements.searchInput.addEventListener("keypress",e=>{e.key==="Enter"&&(e.preventDefault(),this.searchQuery=this.elements.searchInput.value.trim(),this.selectedType&&this.loadEntities())})}async loadEntityTypes(){try{const e=await fetch(`${this.baseUrl}/api/v1/admin/seo/entity-types?lang_code=${encodeURIComponent(this.langCode)}`,{headers:{Accept:"application/json",...this.csrfHeaders}});if(!e.ok)throw new Error("Failed to load entity types");const t=await e.json();t.status==="success"&&Array.isArray(t.types)&&(this.entityTypes=t.types,this.renderTypeOptions())}catch(e){console.error("Error loading entity types:",e),this.entityTypes=[],this.renderTypeOptions()}}renderTypeOptions(){const e=this.elements.typeSelect;if(e.innerHTML='<option value="">Select a type...</option>',this.entityTypes.length===0){e.innerHTML='<option value="">No entities available</option>';return}this.entityTypes.forEach(t=>{const a=document.createElement("option");a.value=t,a.textContent=t,e.appendChild(a)})}async loadEntities(){if(this.selectedType){this.showLoading();try{const e=new URLSearchParams({lang_code:this.langCode,schema_type:this.selectedType,limit:"100"});this.searchQuery&&e.append("q",this.searchQuery);const t=await fetch(`${this.baseUrl}/api/v1/admin/seo/entities?${e}`,{headers:{Accept:"application/json",...this.csrfHeaders}});if(!t.ok)throw new Error("Failed to load entities");const a=await t.json();a.status==="success"&&Array.isArray(a.entities)&&(this.entities=a.entities,this.renderEntities())}catch(e){console.error("Error loading entities:",e),this.showEmptyState("Failed to load entities")}}}renderEntities(){if(this.hideLoading(),this.entities.length===0){this.showEmptyState(this.searchQuery?"No entities found matching your search":`No ${this.selectedType} entities available`);return}this.elements.empty.classList.add("hidden"),this.elements.list.innerHTML="",this.entities.forEach(e=>{const t=this.createEntityCard(e);this.elements.list.appendChild(t)})}createEntityCard(e){const t=document.createElement("div");t.className="entity-card",t.dataset.schemaId=e.schema_id;const a=e.schema_data?.name||e.schema_data?.title||e.schema_data?.headline||e.schema_id,s=e.schema_data?.description||e.schema_data?.address?.streetAddress||"";return t.innerHTML=`
      <div class="entity-card__icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
        </svg>
      </div>
      <div class="entity-card__content">
        <div class="entity-card__name">${this.escapeHtml(a)}</div>
        <div class="entity-card__type">${e.schema_type}</div>
        ${s?`<div class="entity-card__desc">${this.escapeHtml(s.substring(0,100))}${s.length>100?"...":""}</div>`:""}
      </div>
      <div class="entity-card__actions">
        <button type="button" class="btn btn--sm btn--primary entity-card__assign" title="Assign to page">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Assign
        </button>
        <button type="button" class="btn btn--sm btn--ghost entity-card__preview" title="Preview schema">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </button>
      </div>
    `,t.querySelector(".entity-card__assign").addEventListener("click",()=>{this.assignEntity(e)}),t.querySelector(".entity-card__preview").addEventListener("click",()=>{this.previewEntity(e)}),t}assignEntity(e){this.onAssign({schema_type:e.schema_type,schema_data:e.schema_data,schema_id:e.schema_id})}previewEntity(e){const t=document.createElement("div");t.className="modal modal--preview",t.innerHTML=`
      <div class="modal__backdrop" data-action="close"></div>
      <div class="modal__content">
        <header class="modal__header">
          <h3 class="modal__title">Schema Preview: ${this.escapeHtml(e.schema_type)}</h3>
          <button type="button" class="modal__close" data-action="close" aria-label="Close">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </header>
        <div class="modal__body">
          <pre class="schema-preview__code">${this.escapeHtml(JSON.stringify(e.schema_data,null,2))}</pre>
        </div>
        <footer class="modal__footer">
          <button type="button" class="btn btn--secondary" data-action="close">Close</button>
          <button type="button" class="btn btn--primary" data-action="assign">Assign to Page</button>
        </footer>
      </div>
    `,document.body.appendChild(t);const a=()=>{t.remove()};t.querySelectorAll('[data-action="close"]').forEach(s=>{s.addEventListener("click",a)}),t.querySelector('[data-action="assign"]').addEventListener("click",()=>{this.assignEntity(e),a()}),requestAnimationFrame(()=>{t.classList.add("modal--visible")})}showLoading(){this.elements.loading.classList.remove("hidden"),this.elements.empty.classList.add("hidden"),this.elements.list.innerHTML=""}hideLoading(){this.elements.loading.classList.add("hidden")}showEmptyState(e){this.hideLoading(),this.elements.list.innerHTML="",this.elements.empty.classList.remove("hidden"),this.elements.empty.querySelector("p").textContent=e}setLangCode(e){this.langCode=e,this.loadEntityTypes(),this.selectedType&&this.loadEntities()}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}destroy(){this.container.innerHTML="",this.entityTypes=[],this.entities=[],this.elements={}}}const M={organization:{label:"Organizations",icon:"building",description:"Businesses, companies, NGOs, and other organizations"},person:{label:"People",icon:"user",description:"Individual people and profiles"},web:{label:"Web Pages",icon:"globe",description:"Websites, web pages, and navigation"},content:{label:"Content",icon:"file-text",description:"Articles, blog posts, and written content"},commerce:{label:"Commerce",icon:"shopping-cart",description:"Products, offers, and e-commerce"},event:{label:"Events",icon:"calendar",description:"Events, conferences, and gatherings"},service:{label:"Services",icon:"briefcase",description:"Professional and business services"},navigation:{label:"Navigation",icon:"menu",description:"Breadcrumbs, lists, and navigation elements"},howto:{label:"How-To & Recipes",icon:"list",description:"Instructions, guides, and recipes"},media:{label:"Media",icon:"video",description:"Videos, images, and audio content"},software:{label:"Software",icon:"code",description:"Applications and software products"},education:{label:"Education",icon:"book",description:"Courses, learning resources, and educational content"},jobs:{label:"Jobs",icon:"clipboard",description:"Job postings and occupations"},place:{label:"Places",icon:"map-pin",description:"Locations, addresses, and venues"},creative:{label:"Creative Works",icon:"film",description:"Books, movies, music, and other creative works"},faq:{label:"FAQ",icon:"help-circle",description:"Frequently asked questions"}},y=[{name:"@type",type:"hidden",value:"PostalAddress"},{name:"streetAddress",type:"text",label:"Street Address",placeholder:"123 Main Street"},{name:"addressLocality",type:"text",label:"City",placeholder:"San Francisco"},{name:"addressRegion",type:"text",label:"State/Region",placeholder:"CA"},{name:"postalCode",type:"text",label:"Postal Code",placeholder:"94102"},{name:"addressCountry",type:"text",label:"Country",placeholder:"US"}],C=[{name:"@type",type:"hidden",value:"GeoCoordinates"},{name:"latitude",type:"number",label:"Latitude",placeholder:"37.7749"},{name:"longitude",type:"number",label:"Longitude",placeholder:"-122.4194"}],D=[{name:"@type",type:"hidden",value:"OpeningHoursSpecification"},{name:"dayOfWeek",type:"select",label:"Day",options:[{value:"Monday",label:"Monday"},{value:"Tuesday",label:"Tuesday"},{value:"Wednesday",label:"Wednesday"},{value:"Thursday",label:"Thursday"},{value:"Friday",label:"Friday"},{value:"Saturday",label:"Saturday"},{value:"Sunday",label:"Sunday"}]},{name:"opens",type:"text",label:"Opens",placeholder:"09:00"},{name:"closes",type:"text",label:"Closes",placeholder:"17:00"}],z=[{name:"@type",type:"hidden",value:"MonetaryAmount"},{name:"currency",type:"text",label:"Currency",placeholder:"USD"},{name:"value",type:"number",label:"Value",placeholder:"99.99"}],f=[{name:"@type",type:"hidden",value:"AggregateRating"},{name:"ratingValue",type:"number",label:"Rating Value",placeholder:"4.5"},{name:"bestRating",type:"number",label:"Best Rating",placeholder:"5"},{name:"worstRating",type:"number",label:"Worst Rating",placeholder:"1"},{name:"ratingCount",type:"number",label:"Rating Count",placeholder:"100"}],S=[{type:"Organization",label:"Organization",description:"A general organization (company, NGO, club, etc.)",category:"organization",fields:[{name:"@type",type:"hidden",value:"Organization"},{name:"name",type:"text",label:"Organization Name",required:!0,placeholder:"Acme Corporation"},{name:"url",type:"url",label:"Website URL",placeholder:"https://example.com"},{name:"logo",type:"url",label:"Logo URL",placeholder:"https://example.com/logo.png"},{name:"description",type:"textarea",label:"Description",placeholder:"A brief description of the organization"},{name:"email",type:"email",label:"Email",placeholder:"contact@example.com"},{name:"telephone",type:"tel",label:"Phone",placeholder:"+1-555-123-4567"},{name:"address",type:"nested",label:"Address",schema:"PostalAddress",fields:y},{name:"sameAs",type:"array",label:"Social Profiles",itemType:"url",help:"URLs to social media profiles"}]},{type:"LocalBusiness",label:"Local Business",description:"A local business with physical location",category:"organization",fields:[{name:"@type",type:"hidden",value:"LocalBusiness"},{name:"name",type:"text",label:"Business Name",required:!0,placeholder:"Joe's Coffee Shop"},{name:"url",type:"url",label:"Website URL",placeholder:"https://joescoffee.com"},{name:"image",type:"url",label:"Image URL",placeholder:"https://example.com/storefront.jpg"},{name:"description",type:"textarea",label:"Description"},{name:"telephone",type:"tel",label:"Phone",placeholder:"+1-555-123-4567"},{name:"priceRange",type:"text",label:"Price Range",placeholder:"$$",help:"e.g., $, $$, $$$"},{name:"address",type:"nested",label:"Address",schema:"PostalAddress",fields:y},{name:"geo",type:"nested",label:"Coordinates",schema:"GeoCoordinates",fields:C},{name:"openingHoursSpecification",type:"array",label:"Opening Hours",itemType:"nested",schema:"OpeningHoursSpecification",fields:D}]},{type:"Restaurant",label:"Restaurant",description:"A restaurant or food establishment",category:"organization",fields:[{name:"@type",type:"hidden",value:"Restaurant"},{name:"name",type:"text",label:"Restaurant Name",required:!0},{name:"url",type:"url",label:"Website URL"},{name:"image",type:"url",label:"Image URL"},{name:"description",type:"textarea",label:"Description"},{name:"telephone",type:"tel",label:"Phone"},{name:"servesCuisine",type:"text",label:"Cuisine Type",placeholder:"Italian, Mexican, Chinese"},{name:"priceRange",type:"text",label:"Price Range",placeholder:"$$"},{name:"acceptsReservations",type:"boolean",label:"Accepts Reservations"},{name:"menu",type:"url",label:"Menu URL"},{name:"address",type:"nested",label:"Address",schema:"PostalAddress",fields:y},{name:"aggregateRating",type:"nested",label:"Rating",schema:"AggregateRating",fields:f}]},{type:"Corporation",label:"Corporation",description:"A business corporation",category:"organization",fields:[{name:"@type",type:"hidden",value:"Corporation"},{name:"name",type:"text",label:"Corporation Name",required:!0},{name:"legalName",type:"text",label:"Legal Name"},{name:"url",type:"url",label:"Website URL"},{name:"logo",type:"url",label:"Logo URL"},{name:"description",type:"textarea",label:"Description"},{name:"foundingDate",type:"date",label:"Founding Date"},{name:"tickerSymbol",type:"text",label:"Stock Ticker",placeholder:"NASDAQ: ACME"},{name:"address",type:"nested",label:"Headquarters",schema:"PostalAddress",fields:y},{name:"sameAs",type:"array",label:"Social Profiles",itemType:"url"}]},{type:"NGO",label:"NGO / Non-Profit",description:"A non-governmental organization",category:"organization",fields:[{name:"@type",type:"hidden",value:"NGO"},{name:"name",type:"text",label:"Organization Name",required:!0},{name:"url",type:"url",label:"Website URL"},{name:"logo",type:"url",label:"Logo URL"},{name:"description",type:"textarea",label:"Mission Statement"},{name:"foundingDate",type:"date",label:"Founded"},{name:"address",type:"nested",label:"Address",schema:"PostalAddress",fields:y}]},{type:"Person",label:"Person",description:"An individual person",category:"person",fields:[{name:"@type",type:"hidden",value:"Person"},{name:"name",type:"text",label:"Full Name",required:!0},{name:"givenName",type:"text",label:"First Name"},{name:"familyName",type:"text",label:"Last Name"},{name:"jobTitle",type:"text",label:"Job Title"},{name:"url",type:"url",label:"Website/Profile URL"},{name:"image",type:"url",label:"Photo URL"},{name:"email",type:"email",label:"Email"},{name:"telephone",type:"tel",label:"Phone"},{name:"description",type:"textarea",label:"Bio"},{name:"sameAs",type:"array",label:"Social Profiles",itemType:"url"}]},{type:"ProfilePage",label:"Profile Page",description:"A page representing a person's profile",category:"person",fields:[{name:"@type",type:"hidden",value:"ProfilePage"},{name:"name",type:"text",label:"Page Title",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"mainEntity",type:"nested",label:"Person",schema:"Person",fields:[{name:"@type",type:"hidden",value:"Person"},{name:"name",type:"text",label:"Name",required:!0},{name:"jobTitle",type:"text",label:"Job Title"},{name:"image",type:"url",label:"Photo URL"}]}]},{type:"WebSite",label:"Website",description:"A complete website",category:"web",fields:[{name:"@type",type:"hidden",value:"WebSite"},{name:"name",type:"text",label:"Site Name",required:!0},{name:"url",type:"url",label:"Site URL",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"inLanguage",type:"text",label:"Language",placeholder:"en-US"},{name:"potentialAction",type:"nested",label:"Search Action",schema:"SearchAction",fields:[{name:"@type",type:"hidden",value:"SearchAction"},{name:"target",type:"url",label:"Search URL Template",placeholder:"https://example.com/search?q={search_term_string}",help:"Use {search_term_string} as placeholder"},{name:"query-input",type:"text",label:"Query Input",value:"required name=search_term_string"}]}]},{type:"WebPage",label:"Web Page",description:"A single web page",category:"web",fields:[{name:"@type",type:"hidden",value:"WebPage"},{name:"name",type:"text",label:"Page Title",required:!0},{name:"url",type:"url",label:"Page URL"},{name:"description",type:"textarea",label:"Description"},{name:"datePublished",type:"date",label:"Date Published"},{name:"dateModified",type:"date",label:"Date Modified"},{name:"inLanguage",type:"text",label:"Language",placeholder:"en-US"}]},{type:"AboutPage",label:"About Page",description:"An about page",category:"web",fields:[{name:"@type",type:"hidden",value:"AboutPage"},{name:"name",type:"text",label:"Page Title",required:!0},{name:"url",type:"url",label:"Page URL"},{name:"description",type:"textarea",label:"Description"}]},{type:"ContactPage",label:"Contact Page",description:"A contact page",category:"web",fields:[{name:"@type",type:"hidden",value:"ContactPage"},{name:"name",type:"text",label:"Page Title",required:!0},{name:"url",type:"url",label:"Page URL"},{name:"description",type:"textarea",label:"Description"}]},{type:"Article",label:"Article",description:"A general article",category:"content",fields:[{name:"@type",type:"hidden",value:"Article"},{name:"headline",type:"text",label:"Headline",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"image",type:"url",label:"Featured Image URL"},{name:"datePublished",type:"datetime",label:"Date Published"},{name:"dateModified",type:"datetime",label:"Date Modified"},{name:"author",type:"nested",label:"Author",schema:"Person",fields:[{name:"@type",type:"hidden",value:"Person"},{name:"name",type:"text",label:"Author Name",required:!0},{name:"url",type:"url",label:"Author URL"}]},{name:"publisher",type:"nested",label:"Publisher",schema:"Organization",fields:[{name:"@type",type:"hidden",value:"Organization"},{name:"name",type:"text",label:"Publisher Name",required:!0},{name:"logo",type:"url",label:"Logo URL"}]}]},{type:"NewsArticle",label:"News Article",description:"A news article",category:"content",fields:[{name:"@type",type:"hidden",value:"NewsArticle"},{name:"headline",type:"text",label:"Headline",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"image",type:"url",label:"Featured Image URL"},{name:"datePublished",type:"datetime",label:"Date Published"},{name:"dateModified",type:"datetime",label:"Date Modified"},{name:"dateline",type:"text",label:"Dateline",placeholder:"NEW YORK"},{name:"author",type:"nested",label:"Author",schema:"Person",fields:[{name:"@type",type:"hidden",value:"Person"},{name:"name",type:"text",label:"Author Name",required:!0}]},{name:"publisher",type:"nested",label:"Publisher",schema:"Organization",fields:[{name:"@type",type:"hidden",value:"Organization"},{name:"name",type:"text",label:"Publisher Name",required:!0},{name:"logo",type:"url",label:"Logo URL"}]}]},{type:"BlogPosting",label:"Blog Post",description:"A blog post or blog article",category:"content",fields:[{name:"@type",type:"hidden",value:"BlogPosting"},{name:"headline",type:"text",label:"Title",required:!0},{name:"description",type:"textarea",label:"Excerpt"},{name:"image",type:"url",label:"Featured Image URL"},{name:"datePublished",type:"datetime",label:"Date Published"},{name:"dateModified",type:"datetime",label:"Date Modified"},{name:"wordCount",type:"number",label:"Word Count"},{name:"author",type:"nested",label:"Author",schema:"Person",fields:[{name:"@type",type:"hidden",value:"Person"},{name:"name",type:"text",label:"Author Name",required:!0},{name:"url",type:"url",label:"Author URL"}]}]},{type:"TechArticle",label:"Technical Article",description:"A technical or how-to article",category:"content",fields:[{name:"@type",type:"hidden",value:"TechArticle"},{name:"headline",type:"text",label:"Title",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"proficiencyLevel",type:"select",label:"Difficulty Level",options:[{value:"Beginner",label:"Beginner"},{value:"Intermediate",label:"Intermediate"},{value:"Expert",label:"Expert"}]},{name:"datePublished",type:"datetime",label:"Date Published"},{name:"author",type:"nested",label:"Author",schema:"Person",fields:[{name:"@type",type:"hidden",value:"Person"},{name:"name",type:"text",label:"Author Name",required:!0}]}]},{type:"Product",label:"Product",description:"A product for sale",category:"commerce",fields:[{name:"@type",type:"hidden",value:"Product"},{name:"name",type:"text",label:"Product Name",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"image",type:"url",label:"Product Image URL"},{name:"sku",type:"text",label:"SKU"},{name:"mpn",type:"text",label:"MPN (Manufacturer Part Number)"},{name:"gtin",type:"text",label:"GTIN/UPC/EAN"},{name:"brand",type:"nested",label:"Brand",schema:"Brand",fields:[{name:"@type",type:"hidden",value:"Brand"},{name:"name",type:"text",label:"Brand Name",required:!0}]},{name:"offers",type:"nested",label:"Offer",schema:"Offer",fields:[{name:"@type",type:"hidden",value:"Offer"},{name:"price",type:"number",label:"Price",required:!0},{name:"priceCurrency",type:"text",label:"Currency",placeholder:"USD"},{name:"availability",type:"select",label:"Availability",options:[{value:"https://schema.org/InStock",label:"In Stock"},{value:"https://schema.org/OutOfStock",label:"Out of Stock"},{value:"https://schema.org/PreOrder",label:"Pre-Order"},{value:"https://schema.org/LimitedAvailability",label:"Limited Availability"}]},{name:"url",type:"url",label:"Product URL"},{name:"priceValidUntil",type:"date",label:"Price Valid Until"}]},{name:"aggregateRating",type:"nested",label:"Rating",schema:"AggregateRating",fields:f}]},{type:"Review",label:"Review",description:"A review of an item",category:"commerce",fields:[{name:"@type",type:"hidden",value:"Review"},{name:"name",type:"text",label:"Review Title"},{name:"reviewBody",type:"textarea",label:"Review Text",required:!0},{name:"datePublished",type:"date",label:"Date Published"},{name:"author",type:"nested",label:"Reviewer",schema:"Person",fields:[{name:"@type",type:"hidden",value:"Person"},{name:"name",type:"text",label:"Reviewer Name",required:!0}]},{name:"reviewRating",type:"nested",label:"Rating",schema:"Rating",fields:[{name:"@type",type:"hidden",value:"Rating"},{name:"ratingValue",type:"number",label:"Rating",required:!0},{name:"bestRating",type:"number",label:"Best Rating",value:"5"},{name:"worstRating",type:"number",label:"Worst Rating",value:"1"}]}]},{type:"Event",label:"Event",description:"A general event",category:"event",fields:[{name:"@type",type:"hidden",value:"Event"},{name:"name",type:"text",label:"Event Name",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"image",type:"url",label:"Event Image URL"},{name:"startDate",type:"datetime",label:"Start Date/Time",required:!0},{name:"endDate",type:"datetime",label:"End Date/Time"},{name:"eventStatus",type:"select",label:"Status",options:[{value:"https://schema.org/EventScheduled",label:"Scheduled"},{value:"https://schema.org/EventCancelled",label:"Cancelled"},{value:"https://schema.org/EventPostponed",label:"Postponed"},{value:"https://schema.org/EventRescheduled",label:"Rescheduled"}]},{name:"eventAttendanceMode",type:"select",label:"Attendance Mode",options:[{value:"https://schema.org/OfflineEventAttendanceMode",label:"In-Person"},{value:"https://schema.org/OnlineEventAttendanceMode",label:"Online"},{value:"https://schema.org/MixedEventAttendanceMode",label:"Hybrid"}]},{name:"location",type:"nested",label:"Location",schema:"Place",fields:[{name:"@type",type:"hidden",value:"Place"},{name:"name",type:"text",label:"Venue Name"},{name:"address",type:"nested",label:"Address",schema:"PostalAddress",fields:y}]},{name:"organizer",type:"nested",label:"Organizer",schema:"Organization",fields:[{name:"@type",type:"hidden",value:"Organization"},{name:"name",type:"text",label:"Organizer Name"},{name:"url",type:"url",label:"Organizer URL"}]},{name:"offers",type:"nested",label:"Tickets",schema:"Offer",fields:[{name:"@type",type:"hidden",value:"Offer"},{name:"price",type:"number",label:"Price"},{name:"priceCurrency",type:"text",label:"Currency",placeholder:"USD"},{name:"url",type:"url",label:"Ticket URL"},{name:"availability",type:"select",label:"Availability",options:[{value:"https://schema.org/InStock",label:"Available"},{value:"https://schema.org/SoldOut",label:"Sold Out"},{value:"https://schema.org/PreOrder",label:"Pre-Sale"}]}]}]},{type:"BusinessEvent",label:"Business Event",description:"A business event like a conference",category:"event",fields:[{name:"@type",type:"hidden",value:"BusinessEvent"},{name:"name",type:"text",label:"Event Name",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"startDate",type:"datetime",label:"Start Date/Time",required:!0},{name:"endDate",type:"datetime",label:"End Date/Time"},{name:"location",type:"nested",label:"Location",schema:"Place",fields:[{name:"@type",type:"hidden",value:"Place"},{name:"name",type:"text",label:"Venue Name"},{name:"address",type:"nested",label:"Address",schema:"PostalAddress",fields:y}]}]},{type:"Service",label:"Service",description:"A service offered by a business",category:"service",fields:[{name:"@type",type:"hidden",value:"Service"},{name:"name",type:"text",label:"Service Name",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"serviceType",type:"text",label:"Service Type"},{name:"provider",type:"nested",label:"Provider",schema:"Organization",fields:[{name:"@type",type:"hidden",value:"Organization"},{name:"name",type:"text",label:"Provider Name",required:!0}]},{name:"areaServed",type:"text",label:"Area Served",placeholder:"San Francisco Bay Area"},{name:"offers",type:"nested",label:"Pricing",schema:"Offer",fields:[{name:"@type",type:"hidden",value:"Offer"},{name:"price",type:"number",label:"Starting Price"},{name:"priceCurrency",type:"text",label:"Currency",placeholder:"USD"}]}]},{type:"ProfessionalService",label:"Professional Service",description:"A professional service (lawyer, accountant, etc.)",category:"service",fields:[{name:"@type",type:"hidden",value:"ProfessionalService"},{name:"name",type:"text",label:"Business Name",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"url",type:"url",label:"Website URL"},{name:"telephone",type:"tel",label:"Phone"},{name:"priceRange",type:"text",label:"Price Range",placeholder:"$$$"},{name:"address",type:"nested",label:"Address",schema:"PostalAddress",fields:y}]},{type:"BreadcrumbList",label:"Breadcrumb",description:"Navigation breadcrumbs",category:"navigation",fields:[{name:"@type",type:"hidden",value:"BreadcrumbList"},{name:"itemListElement",type:"array",label:"Breadcrumb Items",itemType:"nested",schema:"ListItem",fields:[{name:"@type",type:"hidden",value:"ListItem"},{name:"position",type:"number",label:"Position",required:!0},{name:"name",type:"text",label:"Name",required:!0},{name:"item",type:"url",label:"URL"}]}]},{type:"ItemList",label:"Item List",description:"A list of items (e.g., top 10 list)",category:"navigation",fields:[{name:"@type",type:"hidden",value:"ItemList"},{name:"name",type:"text",label:"List Name"},{name:"description",type:"textarea",label:"Description"},{name:"numberOfItems",type:"number",label:"Number of Items"},{name:"itemListOrder",type:"select",label:"Order",options:[{value:"https://schema.org/ItemListOrderAscending",label:"Ascending"},{value:"https://schema.org/ItemListOrderDescending",label:"Descending"},{value:"https://schema.org/ItemListUnordered",label:"Unordered"}]}]},{type:"SiteNavigationElement",label:"Site Navigation",description:"Website navigation element",category:"navigation",fields:[{name:"@type",type:"hidden",value:"SiteNavigationElement"},{name:"name",type:"text",label:"Navigation Name",required:!0},{name:"url",type:"url",label:"URL"}]},{type:"HowTo",label:"How-To Guide",description:"Step-by-step instructions",category:"howto",fields:[{name:"@type",type:"hidden",value:"HowTo"},{name:"name",type:"text",label:"Title",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"image",type:"url",label:"Image URL"},{name:"totalTime",type:"text",label:"Total Time",placeholder:"PT30M (30 minutes)"},{name:"estimatedCost",type:"nested",label:"Estimated Cost",schema:"MonetaryAmount",fields:z},{name:"step",type:"array",label:"Steps",itemType:"nested",schema:"HowToStep",fields:[{name:"@type",type:"hidden",value:"HowToStep"},{name:"name",type:"text",label:"Step Title"},{name:"text",type:"textarea",label:"Instructions",required:!0},{name:"image",type:"url",label:"Step Image URL"}]}]},{type:"Recipe",label:"Recipe",description:"A cooking recipe",category:"howto",fields:[{name:"@type",type:"hidden",value:"Recipe"},{name:"name",type:"text",label:"Recipe Name",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"image",type:"url",label:"Recipe Image URL"},{name:"prepTime",type:"text",label:"Prep Time",placeholder:"PT15M"},{name:"cookTime",type:"text",label:"Cook Time",placeholder:"PT30M"},{name:"totalTime",type:"text",label:"Total Time",placeholder:"PT45M"},{name:"recipeYield",type:"text",label:"Yield",placeholder:"4 servings"},{name:"recipeCategory",type:"text",label:"Category",placeholder:"Dinner, Dessert"},{name:"recipeCuisine",type:"text",label:"Cuisine",placeholder:"Italian"},{name:"recipeIngredient",type:"array",label:"Ingredients",itemType:"text"},{name:"recipeInstructions",type:"array",label:"Instructions",itemType:"nested",schema:"HowToStep",fields:[{name:"@type",type:"hidden",value:"HowToStep"},{name:"text",type:"textarea",label:"Step",required:!0}]},{name:"nutrition",type:"nested",label:"Nutrition",schema:"NutritionInformation",fields:[{name:"@type",type:"hidden",value:"NutritionInformation"},{name:"calories",type:"text",label:"Calories",placeholder:"250 calories"},{name:"servingSize",type:"text",label:"Serving Size",placeholder:"1 cup"}]},{name:"aggregateRating",type:"nested",label:"Rating",schema:"AggregateRating",fields:f}]},{type:"VideoObject",label:"Video",description:"A video file",category:"media",fields:[{name:"@type",type:"hidden",value:"VideoObject"},{name:"name",type:"text",label:"Video Title",required:!0},{name:"description",type:"textarea",label:"Description",required:!0},{name:"thumbnailUrl",type:"url",label:"Thumbnail URL",required:!0},{name:"uploadDate",type:"date",label:"Upload Date",required:!0},{name:"duration",type:"text",label:"Duration",placeholder:"PT1H30M (1 hour 30 min)"},{name:"contentUrl",type:"url",label:"Video URL"},{name:"embedUrl",type:"url",label:"Embed URL"}]},{type:"ImageObject",label:"Image",description:"An image file",category:"media",fields:[{name:"@type",type:"hidden",value:"ImageObject"},{name:"name",type:"text",label:"Image Name"},{name:"contentUrl",type:"url",label:"Image URL",required:!0},{name:"caption",type:"text",label:"Caption"},{name:"width",type:"number",label:"Width (px)"},{name:"height",type:"number",label:"Height (px)"},{name:"author",type:"text",label:"Photographer/Author"}]},{type:"SoftwareApplication",label:"Software Application",description:"A software application",category:"software",fields:[{name:"@type",type:"hidden",value:"SoftwareApplication"},{name:"name",type:"text",label:"App Name",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"applicationCategory",type:"select",label:"Category",options:[{value:"BusinessApplication",label:"Business"},{value:"GameApplication",label:"Game"},{value:"LifestyleApplication",label:"Lifestyle"},{value:"MultimediaApplication",label:"Multimedia"},{value:"SocialNetworkingApplication",label:"Social"},{value:"UtilitiesApplication",label:"Utilities"}]},{name:"operatingSystem",type:"text",label:"Operating System",placeholder:"Windows, macOS, iOS"},{name:"softwareVersion",type:"text",label:"Version"},{name:"offers",type:"nested",label:"Pricing",schema:"Offer",fields:[{name:"@type",type:"hidden",value:"Offer"},{name:"price",type:"number",label:"Price"},{name:"priceCurrency",type:"text",label:"Currency",placeholder:"USD"}]},{name:"aggregateRating",type:"nested",label:"Rating",schema:"AggregateRating",fields:f}]},{type:"MobileApplication",label:"Mobile App",description:"A mobile application",category:"software",fields:[{name:"@type",type:"hidden",value:"MobileApplication"},{name:"name",type:"text",label:"App Name",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"operatingSystem",type:"text",label:"Platform",placeholder:"iOS, Android"},{name:"softwareVersion",type:"text",label:"Version"},{name:"downloadUrl",type:"url",label:"Download URL"},{name:"installUrl",type:"url",label:"Install URL (App Store)"},{name:"screenshot",type:"url",label:"Screenshot URL"},{name:"aggregateRating",type:"nested",label:"Rating",schema:"AggregateRating",fields:f}]},{type:"Course",label:"Course",description:"An educational course",category:"education",fields:[{name:"@type",type:"hidden",value:"Course"},{name:"name",type:"text",label:"Course Title",required:!0},{name:"description",type:"textarea",label:"Description",required:!0},{name:"provider",type:"nested",label:"Provider",schema:"Organization",fields:[{name:"@type",type:"hidden",value:"Organization"},{name:"name",type:"text",label:"Provider Name",required:!0},{name:"url",type:"url",label:"Provider URL"}]},{name:"hasCourseInstance",type:"nested",label:"Course Instance",schema:"CourseInstance",fields:[{name:"@type",type:"hidden",value:"CourseInstance"},{name:"courseMode",type:"select",label:"Mode",options:[{value:"online",label:"Online"},{value:"onsite",label:"On-site"},{value:"blended",label:"Blended"}]},{name:"startDate",type:"date",label:"Start Date"},{name:"endDate",type:"date",label:"End Date"}]},{name:"aggregateRating",type:"nested",label:"Rating",schema:"AggregateRating",fields:f}]},{type:"JobPosting",label:"Job Posting",description:"A job listing",category:"jobs",fields:[{name:"@type",type:"hidden",value:"JobPosting"},{name:"title",type:"text",label:"Job Title",required:!0},{name:"description",type:"textarea",label:"Job Description",required:!0},{name:"datePosted",type:"date",label:"Date Posted",required:!0},{name:"validThrough",type:"date",label:"Valid Through"},{name:"employmentType",type:"select",label:"Employment Type",options:[{value:"FULL_TIME",label:"Full-time"},{value:"PART_TIME",label:"Part-time"},{value:"CONTRACT",label:"Contract"},{value:"TEMPORARY",label:"Temporary"},{value:"INTERN",label:"Internship"}]},{name:"hiringOrganization",type:"nested",label:"Company",schema:"Organization",fields:[{name:"@type",type:"hidden",value:"Organization"},{name:"name",type:"text",label:"Company Name",required:!0},{name:"url",type:"url",label:"Company Website"},{name:"logo",type:"url",label:"Logo URL"}]},{name:"jobLocation",type:"nested",label:"Location",schema:"Place",fields:[{name:"@type",type:"hidden",value:"Place"},{name:"address",type:"nested",label:"Address",schema:"PostalAddress",fields:y}]},{name:"baseSalary",type:"nested",label:"Salary",schema:"MonetaryAmount",fields:[{name:"@type",type:"hidden",value:"MonetaryAmount"},{name:"currency",type:"text",label:"Currency",placeholder:"USD"},{name:"value",type:"nested",label:"Value",schema:"QuantitativeValue",fields:[{name:"@type",type:"hidden",value:"QuantitativeValue"},{name:"minValue",type:"number",label:"Min Salary"},{name:"maxValue",type:"number",label:"Max Salary"},{name:"unitText",type:"select",label:"Period",options:[{value:"YEAR",label:"Per Year"},{value:"MONTH",label:"Per Month"},{value:"HOUR",label:"Per Hour"}]}]}]}]},{type:"Place",label:"Place",description:"A physical location",category:"place",fields:[{name:"@type",type:"hidden",value:"Place"},{name:"name",type:"text",label:"Place Name",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"image",type:"url",label:"Image URL"},{name:"telephone",type:"tel",label:"Phone"},{name:"address",type:"nested",label:"Address",schema:"PostalAddress",fields:y},{name:"geo",type:"nested",label:"Coordinates",schema:"GeoCoordinates",fields:C}]},{type:"Hotel",label:"Hotel",description:"A hotel or accommodation",category:"place",fields:[{name:"@type",type:"hidden",value:"Hotel"},{name:"name",type:"text",label:"Hotel Name",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"image",type:"url",label:"Image URL"},{name:"starRating",type:"number",label:"Star Rating",placeholder:"1-5"},{name:"priceRange",type:"text",label:"Price Range",placeholder:"$$$"},{name:"telephone",type:"tel",label:"Phone"},{name:"address",type:"nested",label:"Address",schema:"PostalAddress",fields:y},{name:"aggregateRating",type:"nested",label:"Rating",schema:"AggregateRating",fields:f}]},{type:"Book",label:"Book",description:"A book publication",category:"creative",fields:[{name:"@type",type:"hidden",value:"Book"},{name:"name",type:"text",label:"Book Title",required:!0},{name:"author",type:"nested",label:"Author",schema:"Person",fields:[{name:"@type",type:"hidden",value:"Person"},{name:"name",type:"text",label:"Author Name",required:!0}]},{name:"isbn",type:"text",label:"ISBN"},{name:"datePublished",type:"date",label:"Publication Date"},{name:"numberOfPages",type:"number",label:"Number of Pages"},{name:"bookFormat",type:"select",label:"Format",options:[{value:"https://schema.org/Hardcover",label:"Hardcover"},{value:"https://schema.org/Paperback",label:"Paperback"},{value:"https://schema.org/EBook",label:"E-Book"},{value:"https://schema.org/AudiobookFormat",label:"Audiobook"}]},{name:"aggregateRating",type:"nested",label:"Rating",schema:"AggregateRating",fields:f}]},{type:"Movie",label:"Movie",description:"A movie or film",category:"creative",fields:[{name:"@type",type:"hidden",value:"Movie"},{name:"name",type:"text",label:"Movie Title",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"image",type:"url",label:"Poster URL"},{name:"datePublished",type:"date",label:"Release Date"},{name:"duration",type:"text",label:"Duration",placeholder:"PT2H30M"},{name:"director",type:"nested",label:"Director",schema:"Person",fields:[{name:"@type",type:"hidden",value:"Person"},{name:"name",type:"text",label:"Director Name",required:!0}]},{name:"aggregateRating",type:"nested",label:"Rating",schema:"AggregateRating",fields:f}]},{type:"Podcast",label:"Podcast",description:"A podcast series",category:"creative",fields:[{name:"@type",type:"hidden",value:"PodcastSeries"},{name:"name",type:"text",label:"Podcast Name",required:!0},{name:"description",type:"textarea",label:"Description"},{name:"image",type:"url",label:"Cover Art URL"},{name:"url",type:"url",label:"Podcast URL"},{name:"author",type:"nested",label:"Host",schema:"Person",fields:[{name:"@type",type:"hidden",value:"Person"},{name:"name",type:"text",label:"Host Name",required:!0}]}]},{type:"FAQPage",label:"FAQ Page",description:"A page of frequently asked questions",category:"faq",fields:[{name:"@type",type:"hidden",value:"FAQPage"},{name:"mainEntity",type:"array",label:"Questions",itemType:"nested",schema:"Question",fields:[{name:"@type",type:"hidden",value:"Question"},{name:"name",type:"text",label:"Question",required:!0},{name:"acceptedAnswer",type:"nested",label:"Answer",schema:"Answer",fields:[{name:"@type",type:"hidden",value:"Answer"},{name:"text",type:"textarea",label:"Answer Text",required:!0}]}]}]}];function U(){const m={};return S.forEach(e=>{m[e.category]||(m[e.category]=[]),m[e.category].push(e)}),m}function H(m){return S.find(e=>e.type===m)}function q(m){return S.filter(e=>e.category===m).map(e=>e.type)}function R(m){return m?S.filter(e=>e.category===m).map(e=>({type:e.type,label:e.label,description:e.description,has_children:!1})):[]}function O(m){return m?S.some(e=>e.category===m):!1}function N(m,e){const t={"@context":"https://schema.org","@type":m,...e};return Object.keys(t).forEach(a=>{(t[a]===""||t[a]===null||t[a]===void 0)&&delete t[a],Array.isArray(t[a])&&t[a].length===0&&delete t[a]}),t}const j={SCHEMA_CATEGORIES:M,SCHEMA_TYPES:S,getSchemasByCategory:U,getSchemaType:H,getSchemasForCategory:q,buildJsonLd:N,getSchemaChildren:R,hasSchemaChildren:O};function V(m,e="info"){const t={success:"linear-gradient(135deg, #10b981 0%, #059669 100%)",error:"linear-gradient(135deg, #ef4444 0%, #dc2626 100%)",warning:"linear-gradient(135deg, #f59e0b 0%, #d97706 100%)",info:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"};typeof Toastify=="function"?Toastify({text:m,duration:4e3,gravity:"top",position:"right",stopOnFocus:!0,style:{background:t[e]||t.info,borderRadius:"8px",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)"}}).showToast():console.log(`[${e.toUpperCase()}] ${m}`)}function J(){const m=document.cookie.match(/auth_token=([^;]+)/);return m?m[1]:null}async function I(){const m=window.BASE_URL||"",e=new x({baseUrl:m,showToast:V,getAuthToken:J,tabButtons:document.querySelectorAll(".theme-tabs__tab"),tabPanels:document.querySelectorAll(".theme-panel"),logoSelector:document.getElementById("logoSelector"),logoPreview:document.getElementById("logoPreview"),logoPlaceholder:document.getElementById("logoPlaceholder"),faviconSelector:document.getElementById("faviconSelector"),faviconPreview:document.getElementById("faviconPreview"),faviconPlaceholder:document.getElementById("faviconPlaceholder"),lightColorsContainer:document.getElementById("lightColors"),darkColorsContainer:document.getElementById("darkColors"),typographyContainer:document.getElementById("typographyPickers"),spacingContainer:document.getElementById("spacingPickers"),borderRadiusContainer:document.getElementById("borderRadiusPickers"),themeModeToggle:document.querySelector(".theme-mode-toggle"),buildBtn:null,buildOverlay:document.getElementById("buildOverlay"),buildStatus:document.getElementById("buildStatus"),buildProgress:document.getElementById("buildProgress"),imageModal:document.getElementById("imageModal"),imageModalTitle:document.getElementById("imageModalTitle"),imageGrid:document.getElementById("imageGrid"),imageFileInput:document.getElementById("imageFileInput"),removeImageBtn:document.getElementById("removeImageBtn"),schemaModal:document.getElementById("schemaModal"),schemaModalTitle:document.getElementById("schemaModalTitle"),schemaModalTabs:document.getElementById("schemaModalTabs"),schemaCreatePanel:document.getElementById("schemaCreatePanel"),schemaAssignPanel:document.getElementById("schemaAssignPanel"),schemaAssignmentContainer:document.getElementById("schemaAssignmentContainer"),schemaSelectorContainer:document.getElementById("schemaSelectorContainer"),schemaFormContainer:document.getElementById("schemaFormContainer"),schemaFormBuilderContainer:document.getElementById("schemaFormBuilderContainer"),schemaPreview:document.getElementById("schemaPreview"),schemaPreviewCode:document.getElementById("schemaPreviewCode"),saveSchemaBtn:document.getElementById("saveSchemaBtn"),togglePreviewBtn:document.getElementById("togglePreviewBtn"),addSchemaBtn:document.getElementById("addSchemaBtn"),schemasList:document.getElementById("schemasList"),schemasEmpty:document.getElementById("schemasEmpty"),assignedSchemasList:document.getElementById("assignedSchemasList"),assignedSchemasEmpty:document.getElementById("assignedSchemasEmpty"),languageForm:document.getElementById("languageForm"),languageResetBtn:document.getElementById("languageResetBtn"),languageIconFile:document.getElementById("languageIconFile"),languageIconPreview:document.getElementById("languageIconPreview"),languageIconClear:document.getElementById("languageIconClear"),languagesTableBody:document.getElementById("languagesTableBody"),localeForm:document.getElementById("localeForm"),localeResetBtn:document.getElementById("localeResetBtn"),localeLanguageSelect:document.getElementById("localeLanguageSelect"),localesTableBody:document.getElementById("localesTableBody"),localizationForm:document.getElementById("localizationForm"),localizationResetBtn:document.getElementById("localizationResetBtn"),localizationNewBtn:document.getElementById("localizationNewBtn"),localizationKeysTableBody:document.getElementById("localizationKeysTableBody"),translationInputs:document.getElementById("translationInputs"),localizationModal:document.getElementById("localizationModal"),localizationModalTitle:document.getElementById("localizationModalTitle"),localizationLocaleTabs:document.getElementById("localizationLocaleTabs"),localizationCancelBtn:document.getElementById("localizationCancelBtn"),seoLanguageTabs:document.getElementById("seoLanguageTabs"),seoAddPageBtn:document.getElementById("seoAddPageBtn"),seoPageModal:document.getElementById("seoPageModal"),seoPageModalTitle:document.getElementById("seoPageModalTitle"),seoPageForm:document.getElementById("seoPageForm"),seoPageRouteName:document.getElementById("seoPageRouteName"),seoPageLabel:document.getElementById("seoPageLabel"),seoPageSaveBtn:document.getElementById("seoPageSaveBtn"),seoPageCancelBtn:document.getElementById("seoPageCancelBtn"),hreflangForm:document.getElementById("hreflangForm"),hreflangIdInput:document.getElementById("hreflangId"),hreflangCodeInput:document.getElementById("hreflangCode"),hreflangUrlInput:document.getElementById("hreflangUrl"),hreflangDefaultInput:document.getElementById("hreflangDefault"),hreflangCancelBtn:document.getElementById("hreflangCancelBtn"),hreflangTableBody:document.getElementById("hreflangTableBody"),ColorPicker:B,SizePicker:$,ImageSelector:k,SchemaSelector:F,SchemaFormBuilder:w,PageSchemaAssignment:A,SchemaDefinitions:j});window.themeConfig=e}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{I()}):I()})();
