(function(){"use strict";function u(){const l=document.querySelector('meta[name="csrf-token"]');return l?l.getAttribute("content"):(console.warn('CSRF token not found. Ensure <meta name="csrf-token"> exists in page head.'),null)}function d(l={}){const t=u(),e={"Content-Type":"application/json",...l};return t&&(e["X-CSRF-TOKEN"]=t),e}class h{constructor({baseUrl:t,listEl:e,emptyState:i,createForm:o,isAdmin:s,isLogged:a,showToast:n}){this.baseUrl=t,this.listEl=e,this.emptyState=i,this.createForm=o,this.isAdmin=s,this.isLogged=a,this.showToast=n,this.competitions=[],this.geoGalleryIndex=new Map,this.userGalleries=null,this.init()}init(){this.setupCreateForm(),this.loadGeoGalleries(),this.loadCompetitions()}setupCreateForm(){this.createForm&&(this.setupCreateFormDatePickers(),this.createForm.addEventListener("submit",t=>{t.preventDefault(),this.handleCreateCompetition()}))}setupCreateFormDatePickers(){const t=this.createForm.querySelector('input[name="start_date"]'),e=this.createForm.querySelector('input[name="end_date"]');if(!t||!e)return;const i=()=>{const s=this.roundToMinute(new Date),a=this.formatDateTimeLocal(this.addHours(s,1));t.min=a,t.value&&this.isDateTimeBefore(t.value,a)&&(t.value=a)},o=()=>{if(!t.value){const n=this.roundToMinute(new Date),c=this.formatDateTimeLocal(this.addHours(n,24));e.min=c,e.value&&this.isDateTimeBefore(e.value,c)&&(e.value=c);return}const s=new Date(t.value);if(Number.isNaN(s.getTime()))return;const a=this.formatDateTimeLocal(this.addHours(s,1));e.min=a,e.value&&this.isDateTimeBefore(e.value,a)&&(e.value=a)};i(),o(),t.addEventListener("input",o),t.addEventListener("change",o),this.createForm.addEventListener("reset",()=>{requestAnimationFrame(()=>{i(),o()})})}async loadGeoGalleries(){try{const t=await fetch(`${this.baseUrl}/api/v1/geo-galleries`,{method:"GET",credentials:"include",headers:d({Accept:"application/json"})});if(!t.ok)throw new Error("Failed to load geo galleries");const i=(await t.json()).galleries||[];this.geoGalleryIndex=new Map(i.map(o=>[o.id,o]))}catch(t){console.error("Failed to load geo galleries",t)}}async loadCompetitions(){try{const t=await fetch(`${this.baseUrl}/api/v1/competitions`,{method:"GET",credentials:"include",headers:d({Accept:"application/json"})});if(!t.ok)throw new Error("Failed to load competitions");const e=await t.json();this.competitions=e.competitions||[],this.renderCompetitions()}catch(t){console.error("Failed to load competitions",t),this.showToast(t.message||"Failed to load competitions","error"),this.renderCompetitions()}}renderCompetitions(){if(this.listEl.innerHTML="",!this.competitions.length){this.emptyState.style.display="block";return}this.emptyState.style.display="none",this.competitions.forEach(t=>{const e=document.createElement("article");e.className="competition-card",e.dataset.competitionId=t.id,e.innerHTML=`
        <div class="competition-card__header">
          <div>
            <p class="competition-card__eyebrow">${this.formatStatus(t.status)}</p>
            <h2 class="competition-card__title">${this.escapeHtml(t.title)}</h2>
            <p class="competition-card__description">${this.escapeHtml(t.description)}</p>
          </div>
          <div class="competition-card__status competition-card__status--${t.status}">
            ${this.formatStatus(t.status)}
          </div>
        </div>
        <div class="competition-card__meta">
          <div>
            <span class="competition-card__label">Dates</span>
            <span>${this.formatDateRange(t.start_date,t.end_date)}</span>
          </div>
          <div>
            <span class="competition-card__label">Prize</span>
            <span>${this.formatPrize(t.prize_cents)}</span>
          </div>
        </div>
        <div class="competition-card__actions">
          <button type="button" class="competition-card__toggle" data-action="toggle">View entries</button>
          ${this.isLogged&&t.status==="active"?'<button type="button" class="competition-card__join" data-action="join">Join</button>':""}
        </div>
        <div class="competition-card__details" hidden></div>
      `;const i=e.querySelector('[data-action="toggle"]');i&&i.addEventListener("click",()=>this.toggleDetails(t,e));const o=e.querySelector('[data-action="join"]');o&&o.addEventListener("click",()=>this.openJoinPanel(t,e)),this.listEl.appendChild(e)})}async toggleDetails(t,e){const i=e.querySelector(".competition-card__details");i&&(i.dataset.loaded||(await this.loadCompetitionDetails(t,i),i.dataset.loaded="true"),i.hidden=!i.hidden)}async loadCompetitionDetails(t,e){try{this.geoGalleryIndex.size===0&&await this.loadGeoGalleries();const i=await fetch(`${this.baseUrl}/api/v1/competitions/${t.id}`,{method:"GET",credentials:"include",headers:d({Accept:"application/json"})});if(!i.ok)throw new Error("Failed to load competition details");const o=await i.json();this.renderCompetitionDetails(t,o,e)}catch(i){console.error("Failed to load competition details",i),this.showToast(i.message||"Failed to load competition details","error")}}renderCompetitionDetails(t,e,i){const o=e.competition,s=e.entries||[];i.innerHTML=`
      <div class="competition-detail">
        <div class="competition-detail__summary">
          <div>
            <span class="competition-detail__label">Rules</span>
            <p class="competition-detail__text">${this.escapeHtml(o.rules)}</p>
          </div>
          ${o.winner_gallery_id?`
            <div class="competition-detail__winner">
              Winner gallery ID: ${o.winner_gallery_id}
            </div>
          `:""}
        </div>
        <div class="competition-detail__entries">
          <h3>Entries</h3>
          <div class="competition-entries"></div>
        </div>
      </div>
    `;const a=i.querySelector(".competition-entries");if(a&&(a.innerHTML="",s.length===0?a.innerHTML='<p class="competition-empty">No entries submitted yet.</p>':s.forEach(n=>{const c=this.buildEntryCard(n,o);a.appendChild(c)})),this.isLogged&&o.status==="active"){const n=document.createElement("div");n.className="competition-detail__join",n.innerHTML=`
        <h4>Join this competition</h4>
        <form class="competition-join-form">
          <select name="gallery_id" required></select>
          <button type="submit">Submit gallery</button>
        </form>
      `;const c=n.querySelector(".competition-join-form"),r=n.querySelector("select");c.addEventListener("submit",m=>{m.preventDefault(),this.submitJoinCompetition(o.id,r.value)}),this.populateJoinOptions(r),i.appendChild(n)}if(this.isAdmin&&o.status==="ended"&&!o.awarded_at){const n=document.createElement("div");n.className="competition-detail__finalize",n.innerHTML=`
        <button type="button" class="competition-finalize-btn">Finalize competition</button>
      `,n.querySelector(".competition-finalize-btn").addEventListener("click",()=>this.finalizeCompetition(o.id)),i.appendChild(n)}}buildEntryCard(t,e){const i=this.geoGalleryIndex.get(t.gallery_id),o=i?i.title:`Gallery #${t.gallery_id}`,s=i?.description||"Geo gallery entry",a=i?.cover_image_url||"/assets/img/gallery-placeholder.svg",n=document.createElement("article");n.className="competition-entry",n.innerHTML=`
      <div class="competition-entry__media">
        <img src="${a}" alt="${this.escapeHtml(o)}">
      </div>
      <div class="competition-entry__info">
        <h4>${this.escapeHtml(o)}</h4>
        <p>${this.escapeHtml(s)}</p>
        <div class="competition-entry__stats">
          <span>Likes: <strong>${t.likes_count}</strong></span>
          <span>Admin votes: <strong>${t.admin_votes_count}</strong></span>
          <span>Score: <strong>${(t.score*100).toFixed(1)}%</strong></span>
        </div>
      </div>
      <div class="competition-entry__actions"></div>
    `;const c=n.querySelector(".competition-entry__actions");if(t._liked=!1,this.isLogged){const r=document.createElement("button");r.type="button",r.className="competition-entry__like",r.textContent="Like",r.addEventListener("click",()=>this.toggleLike(t,n,r)),c.appendChild(r)}if(this.isAdmin&&e.status==="active"){const r=document.createElement("button");r.type="button",r.className="competition-entry__vote",r.textContent="Admin vote",r.addEventListener("click",()=>this.submitAdminVote(e.id,t,r,n)),c.appendChild(r)}return n}async toggleLike(t,e,i){try{let o;if(t._liked?o=await fetch(`${this.baseUrl}/api/v1/galleries/${t.gallery_id}/likes`,{method:"DELETE",credentials:"include",headers:d({Accept:"application/json"})}):o=await fetch(`${this.baseUrl}/api/v1/galleries/${t.gallery_id}/likes`,{method:"POST",credentials:"include",headers:d({Accept:"application/json"})}),!o.ok){const a=await o.json();if(o.status===409){t._liked=!0,i.textContent="Unlike";return}if(o.status===404){t._liked=!1,i.textContent="Like";return}throw new Error(a.error||"Failed to update like")}const s=await o.json();t.likes_count=s.likes_count,t._liked=!t._liked,i.textContent=t._liked?"Unlike":"Like",this.updateEntryStats(e,t)}catch(o){console.error("Failed to update like",o),this.showToast(o.message||"Failed to update like","error")}}async submitAdminVote(t,e,i,o){try{const s=await fetch(`${this.baseUrl}/api/v1/competitions/${t}/admin-votes`,{method:"POST",credentials:"include",headers:d({Accept:"application/json"}),body:JSON.stringify({gallery_id:e.gallery_id})});if(!s.ok){const a=await s.json();if(s.status===409){i.disabled=!0,i.textContent="Voted";return}throw new Error(a.error||"Failed to submit vote")}e.admin_votes_count+=1,i.disabled=!0,i.textContent="Voted",this.updateEntryStats(o,e)}catch(s){console.error("Failed to submit admin vote",s),this.showToast(s.message||"Failed to submit admin vote","error")}}async submitJoinCompetition(t,e){if(!e){this.showToast("Select a gallery to submit","error");return}try{const i=await fetch(`${this.baseUrl}/api/v1/competitions/${t}/entries`,{method:"POST",credentials:"include",headers:d({Accept:"application/json"}),body:JSON.stringify({gallery_id:Number(e)})});if(!i.ok){const o=await i.json();throw new Error(o.error||"Failed to join competition")}this.showToast("Gallery submitted to competition","success"),this.loadCompetitions()}catch(i){console.error("Failed to join competition",i),this.showToast(i.message||"Failed to join competition","error")}}async populateJoinOptions(t){if(!t)return;if(this.userGalleries||await this.loadUserGalleries(),t.innerHTML="",!this.userGalleries||this.userGalleries.length===0){const i=document.createElement("option");i.textContent="No eligible galleries available",i.value="",t.appendChild(i),t.disabled=!0;return}const e=document.createElement("option");e.textContent="Select a gallery",e.value="",t.appendChild(e),this.userGalleries.forEach(i=>{const o=document.createElement("option");o.value=i.id,o.textContent=i.name,t.appendChild(o)})}async loadUserGalleries(){try{const t=await fetch(`${this.baseUrl}/api/v1/galleries`,{method:"GET",credentials:"include",headers:d({Accept:"application/json"})});if(!t.ok)throw new Error("Failed to load your galleries");const i=(await t.json()).galleries||[];this.userGalleries=i.filter(o=>o.is_public&&Number.isFinite(o.latitude)&&Number.isFinite(o.longitude))}catch(t){console.error("Failed to load user galleries",t),this.userGalleries=[]}}async handleCreateCompetition(){if(!this.createForm)return;const t=new FormData(this.createForm),e=t.get("title")?.toString().trim(),i=t.get("description")?.toString().trim(),o=t.get("start_date"),s=t.get("end_date"),a=t.get("rules")?.toString().trim();if(!e||!i||!o||!s||!a){this.showToast("Please fill in all fields","error");return}const n=new Date(o).toISOString(),c=new Date(s).toISOString();if(n>=c){this.showToast("End date must be after the start date","error");return}try{const r=await fetch(`${this.baseUrl}/api/v1/competitions`,{method:"POST",credentials:"include",headers:d({Accept:"application/json"}),body:JSON.stringify({title:e,description:i,start_date:n,end_date:c,rules:a})});if(!r.ok){const m=await this.parseErrorMessage(r);throw new Error(m||"Failed to create competition")}this.showToast("Competition created","success"),this.createForm.reset(),this.loadCompetitions()}catch(r){console.error("Failed to create competition",r),this.showToast(r.message||"Failed to create competition","error")}}async finalizeCompetition(t){try{const e=await fetch(`${this.baseUrl}/api/v1/competitions/${t}/finalize`,{method:"POST",credentials:"include",headers:d({Accept:"application/json"})});if(!e.ok){const i=await this.parseErrorMessage(e);throw new Error(i||"Failed to finalize competition")}this.showToast("Competition finalized","success"),this.loadCompetitions()}catch(e){console.error("Failed to finalize competition",e),this.showToast(e.message||"Failed to finalize competition","error")}}async parseErrorMessage(t){if((t.headers.get("content-type")||"").includes("application/json")){const s=await t.json().catch(()=>({}));return s.error||s.message||t.statusText}const o=(await t.text().catch(()=>"")).trim();return o.startsWith("<")?t.status===401?"Please sign in again.":t.status===403?"Admin permissions required.":"Unexpected server response. Please refresh and try again.":o||t.statusText}openJoinPanel(t,e){const i=e.querySelector(".competition-card__details");i&&i.hidden&&this.toggleDetails(t,e).then(()=>{const o=i.querySelector(".competition-join-form");o&&o.scrollIntoView({behavior:"smooth",block:"start"})})}updateEntryStats(t,e){const i=t.querySelector(".competition-entry__stats");i&&(i.innerHTML=`
      <span>Likes: <strong>${e.likes_count}</strong></span>
      <span>Admin votes: <strong>${e.admin_votes_count}</strong></span>
      <span>Score: <strong>${(e.score*100).toFixed(1)}%</strong></span>
    `)}formatDateTimeLocal(t){const e=i=>String(i).padStart(2,"0");return`${t.getFullYear()}-${e(t.getMonth()+1)}-${e(t.getDate())}T${e(t.getHours())}:${e(t.getMinutes())}`}roundToMinute(t){const e=new Date(t.getTime());return e.setSeconds(0,0),e}addHours(t,e){const i=new Date(t.getTime());return i.setHours(i.getHours()+e),i}isDateTimeBefore(t,e){const i=new Date(t),o=new Date(e);return Number.isNaN(i.getTime())||Number.isNaN(o.getTime())?!1:i.getTime()<o.getTime()}formatPrize(t){return`${((t||0)/100).toFixed(0)} EUR`}formatDateRange(t,e){const i=new Date(t),o=new Date(e);return`${i.toLocaleDateString()} - ${o.toLocaleDateString()}`}formatStatus(t){return{upcoming:"Upcoming",active:"Active",ended:"Ended"}[t]||"Unknown"}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}}function g(){const l={success:"linear-gradient(to right, #00b09b, #96c93d)",error:"linear-gradient(to right, #ff5f6d, #ffc371)",info:"linear-gradient(to right, #667eea, #764ba2)"};return function(e,i="success"){typeof Toastify<"u"?Toastify({text:e,duration:4e3,gravity:"top",position:"right",style:{background:l[i]||l.info}}).showToast():console.log(`[${i.toUpperCase()}] ${e}`)}}function p(){const l=document.getElementById("competitionsPage"),t=document.getElementById("competitionsList"),e=document.getElementById("competitionsEmptyState"),i=document.getElementById("competitionCreateForm");if(!t||!e){console.error("CompetitionsPage: Required DOM elements not found");return}const o=window.BASE_URL||"",s=l?.dataset?.isAdmin==="true",a=l?.dataset?.isLogged==="true",n=g(),c=new h({baseUrl:o,listEl:t,emptyState:e,createForm:i,isAdmin:s,isLogged:a,showToast:n});typeof window<"u"&&(window.competitionsPage=c)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",p):p()})();
