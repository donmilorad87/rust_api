(function(){"use strict";function E(p){return p&&p.__esModule&&Object.prototype.hasOwnProperty.call(p,"default")?p.default:p}var f={exports:{}};var v=f.exports,y;function _(){return y||(y=1,(function(p){(function(e,t){p.exports?p.exports=t():e.Toastify=t()})(v,function(e){var t=function(i){return new t.lib.init(i)},o="1.12.0";t.defaults={oldestFirst:!0,text:"Toastify is awesome!",node:void 0,duration:3e3,selector:void 0,callback:function(){},destination:void 0,newWindow:!1,close:!1,gravity:"toastify-top",positionLeft:!1,position:"",backgroundColor:"",avatar:"",className:"",stopOnFocus:!0,onClick:function(){},offset:{x:0,y:0},escapeMarkup:!0,ariaLive:"polite",style:{background:""}},t.lib=t.prototype={toastify:o,constructor:t,init:function(i){return i||(i={}),this.options={},this.toastElement=null,this.options.text=i.text||t.defaults.text,this.options.node=i.node||t.defaults.node,this.options.duration=i.duration===0?0:i.duration||t.defaults.duration,this.options.selector=i.selector||t.defaults.selector,this.options.callback=i.callback||t.defaults.callback,this.options.destination=i.destination||t.defaults.destination,this.options.newWindow=i.newWindow||t.defaults.newWindow,this.options.close=i.close||t.defaults.close,this.options.gravity=i.gravity==="bottom"?"toastify-bottom":t.defaults.gravity,this.options.positionLeft=i.positionLeft||t.defaults.positionLeft,this.options.position=i.position||t.defaults.position,this.options.backgroundColor=i.backgroundColor||t.defaults.backgroundColor,this.options.avatar=i.avatar||t.defaults.avatar,this.options.className=i.className||t.defaults.className,this.options.stopOnFocus=i.stopOnFocus===void 0?t.defaults.stopOnFocus:i.stopOnFocus,this.options.onClick=i.onClick||t.defaults.onClick,this.options.offset=i.offset||t.defaults.offset,this.options.escapeMarkup=i.escapeMarkup!==void 0?i.escapeMarkup:t.defaults.escapeMarkup,this.options.ariaLive=i.ariaLive||t.defaults.ariaLive,this.options.style=i.style||t.defaults.style,i.backgroundColor&&(this.options.style.background=i.backgroundColor),this},buildToast:function(){if(!this.options)throw"Toastify is not initialized";var i=document.createElement("div");i.className="toastify on "+this.options.className,this.options.position?i.className+=" toastify-"+this.options.position:this.options.positionLeft===!0?(i.className+=" toastify-left",console.warn("Property `positionLeft` will be depreciated in further versions. Please use `position` instead.")):i.className+=" toastify-right",i.className+=" "+this.options.gravity,this.options.backgroundColor&&console.warn('DEPRECATION NOTICE: "backgroundColor" is being deprecated. Please use the "style.background" property.');for(var a in this.options.style)i.style[a]=this.options.style[a];if(this.options.ariaLive&&i.setAttribute("aria-live",this.options.ariaLive),this.options.node&&this.options.node.nodeType===Node.ELEMENT_NODE)i.appendChild(this.options.node);else if(this.options.escapeMarkup?i.innerText=this.options.text:i.innerHTML=this.options.text,this.options.avatar!==""){var r=document.createElement("img");r.src=this.options.avatar,r.className="toastify-avatar",this.options.position=="left"||this.options.positionLeft===!0?i.appendChild(r):i.insertAdjacentElement("afterbegin",r)}if(this.options.close===!0){var l=document.createElement("button");l.type="button",l.setAttribute("aria-label","Close"),l.className="toast-close",l.innerHTML="&#10006;",l.addEventListener("click",(function(m){m.stopPropagation(),this.removeElement(this.toastElement),window.clearTimeout(this.toastElement.timeOutValue)}).bind(this));var d=window.innerWidth>0?window.innerWidth:screen.width;(this.options.position=="left"||this.options.positionLeft===!0)&&d>360?i.insertAdjacentElement("afterbegin",l):i.appendChild(l)}if(this.options.stopOnFocus&&this.options.duration>0){var c=this;i.addEventListener("mouseover",function(m){window.clearTimeout(i.timeOutValue)}),i.addEventListener("mouseleave",function(){i.timeOutValue=window.setTimeout(function(){c.removeElement(i)},c.options.duration)})}if(typeof this.options.destination<"u"&&i.addEventListener("click",(function(m){m.stopPropagation(),this.options.newWindow===!0?window.open(this.options.destination,"_blank"):window.location=this.options.destination}).bind(this)),typeof this.options.onClick=="function"&&typeof this.options.destination>"u"&&i.addEventListener("click",(function(m){m.stopPropagation(),this.options.onClick()}).bind(this)),typeof this.options.offset=="object"){var h=n("x",this.options),u=n("y",this.options),g=this.options.position=="left"?h:"-"+h,A=this.options.gravity=="toastify-top"?u:"-"+u;i.style.transform="translate("+g+","+A+")"}return i},showToast:function(){this.toastElement=this.buildToast();var i;if(typeof this.options.selector=="string"?i=document.getElementById(this.options.selector):this.options.selector instanceof HTMLElement||typeof ShadowRoot<"u"&&this.options.selector instanceof ShadowRoot?i=this.options.selector:i=document.body,!i)throw"Root element is not defined";var a=t.defaults.oldestFirst?i.firstChild:i.lastChild;return i.insertBefore(this.toastElement,a),t.reposition(),this.options.duration>0&&(this.toastElement.timeOutValue=window.setTimeout((function(){this.removeElement(this.toastElement)}).bind(this),this.options.duration)),this},hideToast:function(){this.toastElement.timeOutValue&&clearTimeout(this.toastElement.timeOutValue),this.removeElement(this.toastElement)},removeElement:function(i){i.className=i.className.replace(" on",""),window.setTimeout((function(){this.options.node&&this.options.node.parentNode&&this.options.node.parentNode.removeChild(this.options.node),i.parentNode&&i.parentNode.removeChild(i),this.options.callback.call(i),t.reposition()}).bind(this),400)}},t.reposition=function(){for(var i={top:15,bottom:15},a={top:15,bottom:15},r={top:15,bottom:15},l=document.getElementsByClassName("toastify"),d,c=0;c<l.length;c++){s(l[c],"toastify-top")===!0?d="toastify-top":d="toastify-bottom";var h=l[c].offsetHeight;d=d.substr(9,d.length-1);var u=15,g=window.innerWidth>0?window.innerWidth:screen.width;g<=360?(l[c].style[d]=r[d]+"px",r[d]+=h+u):s(l[c],"toastify-left")===!0?(l[c].style[d]=i[d]+"px",i[d]+=h+u):(l[c].style[d]=a[d]+"px",a[d]+=h+u)}return this};function n(i,a){return a.offset[i]?isNaN(a.offset[i])?a.offset[i]:a.offset[i]+"px":"0px"}function s(i,a){return!i||typeof a!="string"?!1:!!(i.className&&i.className.trim().split(/\s+/gi).indexOf(a)>-1)}return t.lib.init.prototype=t.lib,t})})(f)),f.exports}var C=_();const b=E(C);class w{constructor(){this.currentClientId=null,this.currentClientName=null,this.currentClientType=null,this.redirectUris=[],this.grantedScopes=[],this.pkceVerifier=null,this.pkceChallenge=null,this.pendingApiProductId=null,this.pendingApiName=null,this.expandedAccordions=new Set,this.authorizedApps=[],this.authorizedAppsLoaded=!1,this.activeTab="my-apps"}init(){this.setupEventListeners(),this.setupTabNavigation(),this.loadApplications()}setupEventListeners(){document.getElementById("createAppBtn")?.addEventListener("click",()=>{this.showCreateModal()}),document.getElementById("createAppFromEmpty")?.addEventListener("click",()=>{this.showCreateModal()}),document.getElementById("retryBtn")?.addEventListener("click",()=>{this.loadApplications()}),document.getElementById("oauthAppForm")?.addEventListener("submit",e=>{this.handleCreateApp(e)}),document.getElementById("cancelBtn")?.addEventListener("click",()=>{this.hideCreateModal()}),document.getElementById("modalCloseBtn")?.addEventListener("click",()=>{this.hideCreateModal()}),document.getElementById("detailsModalCloseBtn")?.addEventListener("click",()=>{this.hideDetailsModal()}),document.querySelector("#appModal .modal__overlay")?.addEventListener("click",()=>{this.hideCreateModal()}),document.querySelector("#appDetailsModal .modal__overlay")?.addEventListener("click",()=>{this.hideDetailsModal()}),document.getElementById("deleteApplicationBtn")?.addEventListener("click",()=>{this.showDeleteConfirmModal()}),document.getElementById("deleteConfirmCloseBtn")?.addEventListener("click",()=>{this.hideDeleteConfirmModal()}),document.getElementById("cancelDeleteBtn")?.addEventListener("click",()=>{this.hideDeleteConfirmModal()}),document.querySelector("#deleteConfirmModal .modal__overlay")?.addEventListener("click",()=>{this.hideDeleteConfirmModal()}),document.getElementById("deleteConfirmForm")?.addEventListener("submit",e=>{this.handleDeleteConfirm(e)}),document.getElementById("clientSecretCloseBtn")?.addEventListener("click",()=>{this.hideClientSecretModal()}),document.getElementById("clientSecretContinueBtn")?.addEventListener("click",()=>{this.handleClientSecretContinue()}),document.querySelector("#clientSecretModal .modal__overlay")?.addEventListener("click",()=>{this.hideClientSecretModal()}),document.getElementById("copyClientSecretBtn")?.addEventListener("click",()=>{document.getElementById("newClientSecret").textContent,this.copyToClipboard("newClientSecret")}),document.getElementById("ssoUrlCloseBtn")?.addEventListener("click",()=>{this.hideSsoUrlModal()}),document.querySelector("#ssoUrlModal .modal__overlay")?.addEventListener("click",()=>{this.hideSsoUrlModal()}),document.getElementById("copySsoUrlBtn")?.addEventListener("click",()=>{this.copyToClipboard("ssoUrlDisplay")}),document.getElementById("regeneratePkceBtn")?.addEventListener("click",()=>{this.generatePkcePair()}),document.getElementById("copyPkceVerifierBtn")?.addEventListener("click",()=>{this.copyToClipboard("pkceVerifierDisplay")}),document.getElementById("copyPkceChallengeBtn")?.addEventListener("click",()=>{this.copyToClipboard("pkceChallengeDisplay")}),document.getElementById("enableApiCloseBtn")?.addEventListener("click",()=>{this.hideEnableApiModal()}),document.getElementById("cancelEnableApiBtn")?.addEventListener("click",()=>{this.hideEnableApiModal()}),document.querySelector("#enableApiModal .modal__overlay")?.addEventListener("click",()=>{this.hideEnableApiModal()}),document.getElementById("confirmEnableApiBtn")?.addEventListener("click",()=>{this.confirmEnableApi()}),document.getElementById("disableApiCloseBtn")?.addEventListener("click",()=>{this.hideDisableApiModal()}),document.getElementById("cancelDisableApiBtn")?.addEventListener("click",()=>{this.hideDisableApiModal()}),document.querySelector("#disableApiModal .modal__overlay")?.addEventListener("click",()=>{this.hideDisableApiModal()}),document.getElementById("confirmDisableApiBtn")?.addEventListener("click",()=>{this.confirmDisableApi()}),this.setupEventDelegation()}setupEventDelegation(){const e=document.getElementById("appDetailsModal");if(!e)return;e.addEventListener("click",n=>{const s=n.target.closest("[data-action]");if(!s)return;const i=s.dataset.action,a=parseInt(s.dataset.id,10),r=s.dataset.name;switch(i){case"delete-redirect-uri":this.deleteRedirectUri(a);break;case"delete-origin":this.deleteAuthorizedOrigin(a);break;case"enable-api":this.enableApi(a,r);break;case"disable-api":this.disableApi(a,r);break;case"toggle-accordion":this.toggleAccordion(s,a);break;case"add-redirect-uri":this.addRedirectUriInput();break;case"add-origin":this.addOriginInput();break;case"remove-input":s.closest(".add-uri-form")?.remove();break;case"copy-to-clipboard":this.copyToClipboard(s.dataset.target);break;case"show-sso-url-modal":this.showSsoUrlModal();break;case"hide-sso-url-modal":this.hideSsoUrlModal();break;case"save-all-redirect-uris":this.saveAllRedirectUris();break;case"save-all-origins":this.saveAllOrigins();break}}),e.addEventListener("change",n=>{const s=n.target;if(s.classList.contains("scope-checkbox")&&!s.disabled){const i=parseInt(s.dataset.scopeId,10),a=s.dataset.scopeName;this.toggleScope(i,a,s.checked)}});const t=document.getElementById("ssoRedirectUriSelect");t&&t.addEventListener("change",()=>{this.updateSsoUrl()});const o=document.getElementById("ssoUrlModal");o&&o.addEventListener("click",n=>{const s=n.target.closest("[data-action]");if(!s)return;const i=s.dataset.action;i==="hide-sso-url-modal"?this.hideSsoUrlModal():i==="copy-to-clipboard"&&this.copyToClipboard(s.dataset.target)})}setupTabNavigation(){const e=document.getElementById("myAppsTab"),t=document.getElementById("authorizedAppsTab");e?.addEventListener("click",()=>{this.switchTab("my-apps")}),t?.addEventListener("click",()=>{this.switchTab("authorized-apps")}),document.getElementById("authorizedRetryBtn")?.addEventListener("click",()=>{this.loadAuthorizedApps()})}switchTab(e){this.activeTab=e;const t=document.getElementById("myAppsTab"),o=document.getElementById("authorizedAppsTab");e==="my-apps"?(t?.classList.add("oauth-tabs__tab--active"),o?.classList.remove("oauth-tabs__tab--active")):(t?.classList.remove("oauth-tabs__tab--active"),o?.classList.add("oauth-tabs__tab--active"));const n=document.getElementById("myAppsContent"),s=document.getElementById("authorizedAppsContent");e==="my-apps"?(this.showElement(n),n.classList.add("oauth-tab-content--active"),this.hideElement(s),s.classList.remove("oauth-tab-content--active")):(this.hideElement(n),n.classList.remove("oauth-tab-content--active"),this.showElement(s),s.classList.add("oauth-tab-content--active"),this.authorizedAppsLoaded||this.loadAuthorizedApps())}getCsrfToken(){const e=document.querySelector('meta[name="csrf-token"]');return e?e.getAttribute("content"):""}showElement(e){e&&e.classList.remove("hidden")}hideElement(e){e&&e.classList.add("hidden")}showSuccess(e){b({text:e,duration:3e3,gravity:"top",position:"right",style:{background:"var(--color-success, #10b981)"}}).showToast()}showError(e){b({text:e,duration:4e3,gravity:"top",position:"right",style:{background:"var(--color-error, #ef4444)"}}).showToast()}async loadApplications(){const e=document.getElementById("loadingState"),t=document.getElementById("emptyState"),o=document.getElementById("errorState"),n=document.getElementById("appsListContainer");this.showElement(e),this.hideElement(t),this.hideElement(o),this.hideElement(n);try{const s=await fetch("/api/v1/oauth/clients",{credentials:"include",headers:{"X-CSRF-Token":this.getCsrfToken()}});if(s.status===401||s.status===403){this.hideElement(e),this.showElement(t);return}if(!s.ok)throw new Error("Failed to load applications");const a=(await s.json()).clients||[];this.hideElement(e),a.length===0?this.showElement(t):n&&(n.innerHTML=a.map(r=>this.renderAppCard(r)).join(""),this.showElement(n),a.forEach(r=>{document.getElementById(`app-card-${r.id}`)?.addEventListener("click",()=>{this.showAppDetails(r.client_id,r.id,r.client_name)})}))}catch(s){if(console.error("Error loading applications:",s),this.hideElement(e),o){this.showElement(o);const i=o.querySelector(".error-state__message");i&&(i.textContent=s.message||"An unexpected error occurred")}}}renderAppCard(e){return`
            <div class="app-card" id="app-card-${e.id}">
                <div class="app-card__header">
                    <div>
                        <h3 class="app-card__title">${this.escapeHtml(e.client_name)}</h3>
                        ${e.description?`<p class="app-card__desc">${this.escapeHtml(e.description)}</p>`:""}
                    </div>
                    <span class="app-card__type">${e.client_type==="confidential"?"Confidential":"Public"}</span>
                </div>
                <div class="app-card__client-id">Client ID: ${this.escapeHtml(e.client_id)}</div>
            </div>
        `}showCreateModal(){const e=document.getElementById("appModal");document.getElementById("modalTitle").textContent="Create OAuth Application",document.getElementById("saveOAuthAppBtn").querySelector(".btn__text").textContent="Create Application",document.getElementById("oauthAppForm").reset(),e.setAttribute("aria-hidden","false")}hideCreateModal(){document.getElementById("appModal").setAttribute("aria-hidden","true")}async handleCreateApp(e){e.preventDefault();const t=new FormData(e.target),o={client_name:t.get("client_name"),description:t.get("description")||null,client_type:t.get("client_type"),homepage_url:t.get("homepage_url")||null,privacy_policy_url:t.get("privacy_policy_url")||null,terms_of_service_url:t.get("terms_of_service_url")||null},n=document.getElementById("saveOAuthAppBtn");n.disabled=!0,n.querySelector(".btn__text").textContent="Creating...";try{const s=await fetch("/api/v1/oauth/clients",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":this.getCsrfToken()},body:JSON.stringify(o),credentials:"include"}),i=await s.json();if(!s.ok)throw new Error(i.error||i.message||"Failed to create application");this.showSuccess("OAuth application created successfully!"),this.hideCreateModal(),await this.loadApplications(),i.client_secret?this.showClientSecretModal(i.client_secret,i.client_id,i.id,o.client_name):i.client_id&&i.id&&this.showAppDetails(i.client_id,i.id,o.client_name)}catch(s){console.error("Error creating OAuth application:",s),this.showError(`Failed to create application: ${s.message}`)}finally{n.disabled=!1,n.querySelector(".btn__text").textContent="Create Application"}}async showAppDetails(e,t,o){this.currentClientId=e,this.currentClientName=o,document.getElementById("appDetailsModal").setAttribute("aria-hidden","false"),document.getElementById("detailsModalTitle").textContent=o||"Application Details",await Promise.all([this.loadCredentials(e),this.loadRedirectUris(e),this.loadAuthorizedOrigins(e),this.loadEnabledApis(e)])}hideDetailsModal(){document.getElementById("appDetailsModal").setAttribute("aria-hidden","true"),this.currentClientId=null,this.currentClientName=null,this.currentClientType=null}showClientSecretModal(e,t,o,n){const s=document.getElementById("clientSecretModal");document.getElementById("newClientSecret").textContent=e,s.dataset.clientId=t,s.dataset.clientDbId=o,s.dataset.clientName=n,s.setAttribute("aria-hidden","false")}hideClientSecretModal(){const e=document.getElementById("clientSecretModal");e.setAttribute("aria-hidden","true"),delete e.dataset.clientId,delete e.dataset.clientDbId,delete e.dataset.clientName}handleClientSecretContinue(){const e=document.getElementById("clientSecretModal"),t=e.dataset.clientId,o=e.dataset.clientDbId,n=e.dataset.clientName;this.hideClientSecretModal(),t&&o&&this.showAppDetails(t,o,n)}async loadCredentials(e){try{const t=await fetch(`/api/v1/oauth/clients/${e}`,{credentials:"include"});if(!t.ok)throw new Error("Failed to load credentials");const o=await t.json();document.getElementById("detailClientId").textContent=o.client_id,this.currentClientType=o.client_type||null,o.secrets&&o.secrets.length>0?(this.showElement(document.getElementById("clientSecretSection")),document.getElementById("detailClientSecret").textContent=o.secrets[0].secret_value||"(already hashed - not shown)"):this.hideElement(document.getElementById("clientSecretSection"))}catch(t){console.error("Error loading credentials:",t)}}async loadRedirectUris(e){const t=document.getElementById("redirectUrisList");try{const o=await fetch(`/api/v1/oauth/clients/${e}/redirect-uris`,{credentials:"include"});if(!o.ok)throw new Error("Failed to load redirect URIs");const s=(await o.json()).redirect_uris||[];s.length===0?t.innerHTML='<p class="oauth-text oauth-text--muted">No redirect URIs configured yet.</p>':t.innerHTML=s.map(i=>`
                    <div class="uri-item">
                        <code>${this.escapeHtml(i.redirect_uri)}</code>
                        <button type="button" class="btn-delete" data-action="delete-redirect-uri" data-id="${i.id}">Delete</button>
                    </div>
                `).join("")}catch(o){console.error("Error loading redirect URIs:",o),t.innerHTML='<p class="oauth-text oauth-text--danger">Failed to load redirect URIs.</p>'}}async loadAuthorizedOrigins(e){const t=document.getElementById("authorizedOriginsList");try{const o=await fetch(`/api/v1/oauth/clients/${e}/authorized-domains`,{credentials:"include"});if(!o.ok)throw new Error("Failed to load authorized origins");const s=(await o.json()).authorized_domains||[];s.length===0?t.innerHTML='<p class="oauth-text oauth-text--muted">No authorized origins configured yet.</p>':t.innerHTML=s.map(i=>`
                    <div class="origin-item">
                        <code>${this.escapeHtml(i.domain)}</code>
                        <button type="button" class="btn-delete" data-action="delete-origin" data-id="${i.id}">Delete</button>
                    </div>
                `).join("")}catch(o){console.error("Error loading authorized origins:",o),t.innerHTML='<p class="oauth-text oauth-text--danger">Failed to load authorized origins.</p>'}}async loadEnabledApis(e){const t=document.getElementById("enabledApisList");try{const o=await fetch(`/api/v1/oauth/clients/${e}/api-products`,{credentials:"include"});if(!o.ok)throw new Error("Failed to load API products");const s=(await o.json()).api_products||[],i=await fetch(`/api/v1/oauth/clients/${e}/enabled-apis`,{credentials:"include"});if(!i.ok)throw new Error("Failed to load enabled APIs");const a=await i.json(),r=(a.enabled_apis||[]).map(d=>parseInt(d.id,10)),l=new Set;(a.enabled_apis||[]).forEach(d=>{(d.scopes||[]).forEach(c=>{l.add(parseInt(c.id,10))})}),console.log("Enabled API IDs:",r),console.log("Granted scope IDs:",[...l]),console.log("All APIs:",s.map(d=>({id:d.id,name:d.product_name}))),s.length===0?t.innerHTML='<p class="oauth-text oauth-text--muted">No APIs available yet.</p>':(t.innerHTML=s.map(d=>{const c=parseInt(d.id,10),h=r.includes(c);return console.log(`API ${d.product_name} (id: ${c}): isEnabled=${h}`),this.renderApiCard(d,h,l)}).join(""),this.restoreAccordionState())}catch(o){console.error("Error loading APIs:",o),t.innerHTML='<p class="oauth-text oauth-text--danger">Failed to load APIs.</p>'}}restoreAccordionState(){this.expandedAccordions.forEach(e=>{const t=document.querySelector(`.api-card__accordion[data-api-id="${e}"]`);if(t){const o=t.querySelector(".api-card__accordion-header"),n=t.querySelector(".api-card__accordion-content"),s=o.querySelector(".api-card__accordion-icon");o&&n&&s&&(o.setAttribute("aria-expanded","true"),n.setAttribute("aria-hidden","false"),n.style.maxHeight=n.scrollHeight+"px",s.textContent="‚ñº")}})}renderApiCard(e,t,o){const n=e.scopes||[],s=n.filter(i=>o.has(parseInt(i.id,10))||i.scope_name==="galleries.read").length;return`
            <div class="api-card ${t?"api-card--enabled":""}">
                <div class="api-card__header">
                    <div>
                        <div class="api-card__title-row">
                            <h4 class="api-card__title">${this.escapeHtml(e.product_name||e.name)}</h4>
                            ${t?'<span class="api-card__status api-card__status--enabled">API Enabled</span>':""}
                        </div>
                        <p class="api-card__desc">${this.escapeHtml(e.product_description||e.description||"No description available")}</p>
                    </div>
                    <button
                        type="button"
                        class="btn btn--${t?"danger":"primary"} btn--small"
                        data-action="${t?"disable-api":"enable-api"}"
                        data-id="${e.id}"
                        data-name="${this.escapeHtml(e.product_name||e.name)}"
                    >
                        ${t?"Disable API":"Enable API"}
                    </button>
                </div>
                ${t&&n.length>0?`
                    <div class="api-card__accordion" data-api-id="${e.id}">
                        <button
                            type="button"
                            class="api-card__accordion-header"
                            data-action="toggle-accordion"
                            data-id="${e.id}"
                            aria-expanded="false"
                        >
                            <span class="api-card__accordion-title">
                                <span class="api-card__accordion-icon">‚ñ∂</span>
                                Scope Permissions
                                <span class="api-card__accordion-badge">${s}/${n.length} enabled</span>
                            </span>
                        </button>
                        <div class="api-card__accordion-content" aria-hidden="true">
                            <p class="api-card__scopes-subtitle">Select which operations this OAuth client can perform on galleries.</p>
                            ${n.map(i=>{const a=parseInt(i.id,10),r=o.has(a),l=i.scope_name==="galleries.read",d=this.getScopeLabel(i.scope_name),c=this.getScopeIcon(i.scope_name);return`
                                    <label class="scope-checkbox ${l?"scope-checkbox--required":""} ${r?"scope-checkbox--granted":""}">
                                        <input
                                            type="checkbox"
                                            class="scope-checkbox"
                                            data-scope-id="${i.id}"
                                            data-scope-name="${this.escapeHtml(i.scope_name)}"
                                            ${r||l?"checked":""}
                                            ${l?"disabled":""}
                                        />
                                        <span class="scope-checkbox__label">
                                            <span class="scope-icon">${c}</span>
                                            <span class="scope-info">
                                                <strong>${d}</strong>
                                                <span class="scope-desc">${this.escapeHtml(i.scope_description||"")}</span>
                                                ${l?'<span class="scope-required-badge">Required</span>':""}
                                                ${i.sensitive?'<span class="scope-sensitive-badge">üîí Sensitive</span>':""}
                                            </span>
                                        </span>
                                    </label>
                                `}).join("")}
                            <p class="api-card__scopes-note">
                                <strong>Note:</strong> Write, Edit, and Delete operations only apply to galleries owned by the user who authorized this application.
                            </p>
                        </div>
                    </div>
                `:""}
            </div>
        `}toggleAccordion(e,t){const o=e.getAttribute("aria-expanded")==="true",n=e.nextElementSibling,s=e.querySelector(".api-card__accordion-icon");e.setAttribute("aria-expanded",!o),n.setAttribute("aria-hidden",o),o?(n.style.maxHeight="0",s.textContent="‚ñ∂",this.expandedAccordions.delete(t)):(n.style.maxHeight=n.scrollHeight+"px",s.textContent="‚ñº",this.expandedAccordions.add(t))}getScopeLabel(e){return{"galleries.read":"Read Galleries","galleries.write":"Create Galleries","galleries.edit":"Edit Galleries","galleries.delete":"Delete Galleries"}[e]||e}getScopeIcon(e){return{"galleries.read":"üëÅÔ∏è","galleries.write":"‚úèÔ∏è","galleries.edit":"üìù","galleries.delete":"üóëÔ∏è"}[e]||"üîë"}enableApi(e,t){this.showEnableApiModal(e,t)}showEnableApiModal(e,t){this.pendingApiProductId=e,this.pendingApiName=t,document.getElementById("enableApiNameDisplay").textContent=t,document.getElementById("enableApiModal").setAttribute("aria-hidden","false")}hideEnableApiModal(){document.getElementById("enableApiModal").setAttribute("aria-hidden","true"),this.pendingApiProductId=null,this.pendingApiName=null}async confirmEnableApi(){const e=this.pendingApiProductId,t=this.pendingApiName;if(!e){this.hideEnableApiModal();return}const o=document.getElementById("confirmEnableApiBtn");o.disabled=!0,o.querySelector(".btn__text").textContent="Enabling...";try{const n=await fetch(`/api/v1/oauth/clients/${this.currentClientId}/enable-api`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":this.getCsrfToken()},body:JSON.stringify({api_product_id:e}),credentials:"include"});if(!n.ok){const s=await n.json();throw new Error(s.message||"Failed to enable API")}this.hideEnableApiModal(),this.showSuccess(`${t} enabled successfully!`),await this.loadEnabledApis(this.currentClientId)}catch(n){console.error("Error enabling API:",n),this.showError(`Failed to enable API: ${n.message}`)}finally{o.disabled=!1,o.querySelector(".btn__text").textContent="Enable API"}}disableApi(e,t){this.showDisableApiModal(e,t)}showDisableApiModal(e,t){this.pendingApiProductId=e,this.pendingApiName=t,document.getElementById("disableApiNameDisplay").textContent=t,document.getElementById("disableApiModal").setAttribute("aria-hidden","false")}hideDisableApiModal(){document.getElementById("disableApiModal").setAttribute("aria-hidden","true"),this.pendingApiProductId=null,this.pendingApiName=null}async confirmDisableApi(){const e=this.pendingApiProductId,t=this.pendingApiName;if(!e){this.hideDisableApiModal();return}const o=document.getElementById("confirmDisableApiBtn");o.disabled=!0,o.querySelector(".btn__text").textContent="Disabling...";try{const n=await fetch(`/api/v1/oauth/clients/${this.currentClientId}/enabled-apis/${e}`,{method:"DELETE",headers:{"X-CSRF-Token":this.getCsrfToken()},credentials:"include"});if(!n.ok){const s=await n.json();throw new Error(s.message||"Failed to disable API")}this.hideDisableApiModal(),this.showSuccess(`${t} disabled successfully!`),await this.loadEnabledApis(this.currentClientId)}catch(n){console.error("Error disabling API:",n),this.showError(`Failed to disable API: ${n.message}`)}finally{o.disabled=!1,o.querySelector(".btn__text").textContent="Disable API"}}async toggleScope(e,t,o){try{if(o){const n=await fetch(`/api/v1/oauth/clients/${this.currentClientId}/scopes`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":this.getCsrfToken()},body:JSON.stringify({scope_id:e}),credentials:"include"});if(!n.ok){const s=await n.json();throw new Error(s.message||"Failed to grant scope")}this.showSuccess(`Scope '${t}' granted successfully!`)}else{const n=await fetch(`/api/v1/oauth/clients/${this.currentClientId}/scopes/${e}`,{method:"DELETE",headers:{"X-CSRF-Token":this.getCsrfToken()},credentials:"include"});if(!n.ok){const s=await n.json();throw new Error(s.message||"Failed to revoke scope")}this.showSuccess(`Scope '${t}' revoked successfully!`)}await this.updateScopeUI(e,o)}catch(n){console.error("Error toggling scope:",n),this.showError(`Failed to ${o?"grant":"revoke"} scope: ${n.message}`);const s=document.querySelector(`[data-scope-id="${e}"]`);s&&(s.checked=!o)}}updateScopeUI(e,t){t?this.grantedScopes.includes(e)||this.grantedScopes.push(e):this.grantedScopes=this.grantedScopes.filter(n=>n!==e);const o=document.querySelector(".api-card__accordion");if(o){const s=o.querySelector(".api-card__accordion-header")?.querySelector(".api-card__accordion-badge");if(s){const i=o.querySelectorAll("input.scope-checkbox:not(:disabled)"),a=Array.from(i).filter(l=>l.checked).length,r=i.length+1;s.textContent=`${a+1}/${r} enabled`}}}addRedirectUriInput(){const e=document.getElementById("redirectUriInputs"),t=document.createElement("div");t.className="add-uri-form",t.innerHTML=`
            <input type="text" placeholder="https://example.com/callback" class="form__input form__input--full redirect-uri-input" />
            <button type="button" class="btn-remove-uri" title="Remove this input" data-action="remove-input">-</button>
        `,e.appendChild(t)}async saveAllRedirectUris(){const e=document.querySelectorAll(".redirect-uri-input"),t=[];if(e.forEach(i=>{const a=i.value.trim();a&&t.push(a)}),t.length===0){this.showError("Please enter at least one redirect URI");return}let o=0,n=0;for(const i of t)try{(await fetch(`/api/v1/oauth/clients/${this.currentClientId}/redirect-uris`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":this.getCsrfToken()},body:JSON.stringify({redirect_uri:i}),credentials:"include"})).ok?o++:n++}catch(a){console.error("Error adding redirect URI:",a),n++}const s=document.getElementById("redirectUriInputs");s.innerHTML=`
            <div class="add-uri-form">
                <input type="text" placeholder="https://example.com/callback" class="form__input form__input--full redirect-uri-input" />
                <button type="button" class="btn-add-uri" title="Add Another Redirect URI" data-action="add-redirect-uri">+</button>
            </div>
        `,o>0&&this.showSuccess(`${o} redirect URI(s) added successfully!`),n>0&&this.showError(`Failed to add ${n} redirect URI(s)`),await this.loadRedirectUris(this.currentClientId)}async deleteRedirectUri(e){if(confirm("Delete this redirect URI?"))try{const t=await fetch(`/api/v1/oauth/clients/${this.currentClientId}/redirect-uris/${e}`,{method:"DELETE",headers:{"X-CSRF-Token":this.getCsrfToken()},credentials:"include"});if(!t.ok){const o=await t.json();throw new Error(o.message||"Failed to delete redirect URI")}this.showSuccess("Redirect URI deleted successfully!"),await this.loadRedirectUris(this.currentClientId)}catch(t){console.error("Error deleting redirect URI:",t),this.showError(`Failed to delete redirect URI: ${t.message}`)}}addOriginInput(){const e=document.getElementById("authorizedOriginInputs"),t=document.createElement("div");t.className="add-uri-form",t.innerHTML=`
            <input type="text" placeholder="https://example.com" class="form__input form__input--full origin-input" />
            <button type="button" class="btn-remove-uri" title="Remove this input" data-action="remove-input">-</button>
        `,e.appendChild(t)}async saveAllOrigins(){const e=document.querySelectorAll(".origin-input"),t=[];if(e.forEach(i=>{const a=i.value.trim();a&&t.push(a)}),t.length===0){this.showError("Please enter at least one authorized origin");return}let o=0,n=0;for(const i of t)try{(await fetch(`/api/v1/oauth/clients/${this.currentClientId}/authorized-domains`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":this.getCsrfToken()},body:JSON.stringify({domain:i}),credentials:"include"})).ok?o++:n++}catch(a){console.error("Error adding authorized origin:",a),n++}const s=document.getElementById("authorizedOriginInputs");s.innerHTML=`
            <div class="add-uri-form">
                <input type="text" placeholder="https://example.com" class="form__input form__input--full origin-input" />
                <button type="button" class="btn-add-uri" title="Add Another Origin" data-action="add-origin">+</button>
            </div>
        `,o>0&&this.showSuccess(`${o} authorized origin(s) added successfully!`),n>0&&this.showError(`Failed to add ${n} authorized origin(s)`),await this.loadAuthorizedOrigins(this.currentClientId)}async deleteAuthorizedOrigin(e){if(confirm("Delete this authorized origin?"))try{const t=await fetch(`/api/v1/oauth/clients/${this.currentClientId}/authorized-domains/${e}`,{method:"DELETE",headers:{"X-CSRF-Token":this.getCsrfToken()},credentials:"include"});if(!t.ok){const o=await t.json();throw new Error(o.message||"Failed to delete authorized origin")}this.showSuccess("Authorized origin deleted successfully!"),await this.loadAuthorizedOrigins(this.currentClientId)}catch(t){console.error("Error deleting authorized origin:",t),this.showError(`Failed to delete authorized origin: ${t.message}`)}}showDeleteConfirmModal(){if(!this.currentClientId||!this.currentClientName){this.showError("No application selected");return}document.getElementById("deleteAppNameDisplay").textContent=this.currentClientName,document.getElementById("deleteConfirmInput").value="",document.getElementById("deleteConfirmError").textContent="",document.getElementById("deleteConfirmModal").setAttribute("aria-hidden","false")}hideDeleteConfirmModal(){document.getElementById("deleteConfirmModal").setAttribute("aria-hidden","true"),document.getElementById("deleteConfirmInput").value="",document.getElementById("deleteConfirmError").textContent=""}async handleDeleteConfirm(e){e.preventDefault();const t=document.getElementById("deleteConfirmInput"),o=document.getElementById("deleteConfirmError"),n=document.getElementById("confirmDeleteBtn"),s=t.value.trim();if(o.textContent="",s!==this.currentClientName){o.textContent="Application name does not match. Please type the exact name.",t.focus();return}n.disabled=!0,n.querySelector(".btn__text").textContent="Deleting...";try{const i=await fetch(`/api/v1/oauth/clients/${this.currentClientId}`,{method:"DELETE",headers:{"X-CSRF-Token":this.getCsrfToken()},credentials:"include"});if(!i.ok){const a=await i.json();throw new Error(a.message||"Failed to delete application")}this.showSuccess(`Application "${this.currentClientName}" deleted successfully!`),this.hideDeleteConfirmModal(),this.hideDetailsModal(),await this.loadApplications()}catch(i){console.error("Error deleting application:",i),o.textContent=i.message,this.showError(`Failed to delete application: ${i.message}`)}finally{n.disabled=!1,n.querySelector(".btn__text").textContent="Delete Application"}}async showSsoUrlModal(){if(!this.currentClientId){this.showError("No application selected");return}await this.generatePkcePair(),await this.loadRedirectUrisForModal(this.currentClientId),await this.loadGrantedScopesForModal(this.currentClientId),document.getElementById("ssoUrlModal").setAttribute("aria-hidden","false"),this.updatePkceRequirementNote(),document.getElementById("ssoUrlDisplay").textContent="Select a redirect URI to generate the URL",document.getElementById("copySsoUrlBtn").disabled=!0}hideSsoUrlModal(){document.getElementById("ssoUrlModal").setAttribute("aria-hidden","true");const t=document.getElementById("ssoRedirectUriSelect");t.innerHTML='<option value="">-- Select a redirect URI --</option>',this.pkceVerifier=null,this.pkceChallenge=null,this.updatePkceDisplay()}async loadRedirectUrisForModal(e){const t=document.getElementById("ssoRedirectUriSelect");try{const o=await fetch(`/api/v1/oauth/clients/${e}/redirect-uris`,{credentials:"include"});if(!o.ok)throw new Error("Failed to load redirect URIs");const n=await o.json();this.redirectUris=n.redirect_uris||[],t.innerHTML='<option value="">-- Select a redirect URI --</option>',this.redirectUris.forEach(s=>{const i=document.createElement("option");i.value=s.redirect_uri,i.textContent=s.redirect_uri,t.appendChild(i)}),this.redirectUris.length===0&&(t.innerHTML='<option value="">No redirect URIs configured</option>')}catch(o){console.error("Error loading redirect URIs:",o),t.innerHTML='<option value="">Failed to load redirect URIs</option>'}}async loadGrantedScopesForModal(e){try{const t=await fetch(`/api/v1/oauth/clients/${e}/enabled-apis`,{credentials:"include"});if(!t.ok)throw new Error("Failed to load granted scopes");const n=(await t.json()).enabled_apis||[];this.grantedScopes=[],n.forEach(s=>{(s.scopes||[]).forEach(i=>{this.grantedScopes.push(i.scope_name)})})}catch(t){console.error("Error loading granted scopes:",t),this.grantedScopes=[]}}async updateSsoUrl(){const t=document.getElementById("ssoRedirectUriSelect").value,o=document.getElementById("ssoUrlDisplay"),n=document.getElementById("copySsoUrlBtn");if(!t){o.textContent="Select a redirect URI to generate the URL",n.disabled=!0;return}(!this.pkceVerifier||!this.pkceChallenge)&&await this.generatePkcePair();const s=window.location.origin,i=new URL("/oauth/authorize",s);i.searchParams.set("client_id",this.currentClientId),i.searchParams.set("redirect_uri",t),i.searchParams.set("response_type","code"),this.grantedScopes.length>0&&i.searchParams.set("scope",this.grantedScopes.join(" ")),i.searchParams.set("state","YOUR_STATE_TOKEN_HERE"),this.pkceChallenge&&(i.searchParams.set("code_challenge",this.pkceChallenge),i.searchParams.set("code_challenge_method","S256")),o.textContent=i.toString(),n.disabled=!1}updatePkceRequirementNote(){const e=document.getElementById("pkceRequirementNote");e&&(e.textContent="PKCE is required for all clients. Use the verifier below when exchanging the code.")}updatePkceDisplay(){const e=document.getElementById("pkceVerifierDisplay"),t=document.getElementById("pkceChallengeDisplay"),o=document.getElementById("copyPkceVerifierBtn"),n=document.getElementById("copyPkceChallengeBtn");e&&(e.textContent=this.pkceVerifier||"Generate a PKCE verifier to continue"),t&&(t.textContent=this.pkceChallenge||"Generate a PKCE challenge to continue"),o&&(o.disabled=!this.pkceVerifier),n&&(n.disabled=!this.pkceChallenge)}base64UrlEncode(e){let t="";return e.forEach(o=>{t+=String.fromCharCode(o)}),btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}async generatePkcePair(){const e=new Uint8Array(32);crypto.getRandomValues(e),this.pkceVerifier=this.base64UrlEncode(e);const t=new TextEncoder().encode(this.pkceVerifier),o=await crypto.subtle.digest("SHA-256",t);this.pkceChallenge=this.base64UrlEncode(new Uint8Array(o)),this.updatePkceDisplay(),await this.updateSsoUrl()}async copyToClipboard(e){const t=document.getElementById(e);if(!t)return;const o=t.textContent;try{await navigator.clipboard.writeText(o),this.showSuccess("Copied to clipboard!")}catch(n){console.error("Failed to copy:",n);const s=document.createElement("textarea");s.value=o,s.style.position="fixed",s.style.left="-9999px",document.body.appendChild(s),s.select();try{document.execCommand("copy"),this.showSuccess("Copied to clipboard!")}catch{this.showError("Failed to copy to clipboard")}document.body.removeChild(s)}}async loadAuthorizedApps(){const e=document.getElementById("authorizedLoadingState"),t=document.getElementById("authorizedEmptyState"),o=document.getElementById("authorizedErrorState"),n=document.getElementById("authorizedAppsListContainer"),s=document.getElementById("authorizedAppsBadge");this.showElement(e),this.hideElement(t),this.hideElement(o),this.hideElement(n);try{const i=await fetch("/oauth/authorized-apps",{credentials:"include",headers:{"X-CSRF-Token":this.getCsrfToken()}});if(i.status===401||i.status===403){this.hideElement(e),this.showElement(t);return}if(!i.ok)throw new Error("Failed to load authorized apps");const a=await i.json();this.authorizedApps=a.apps||[],this.authorizedAppsLoaded=!0,s&&(this.authorizedApps.length>0?(s.textContent=this.authorizedApps.length,s.classList.remove("hidden")):s.classList.add("hidden")),this.hideElement(e),this.authorizedApps.length===0?this.showElement(t):n&&(n.innerHTML=this.authorizedApps.map(r=>this.renderAuthorizedAppCard(r)).join(""),this.showElement(n),this.authorizedApps.forEach(r=>{document.getElementById(`revoke-btn-${r.consent_id}`)?.addEventListener("click",l=>{l.stopPropagation(),this.revokeAuthorization(r.client_db_id,r.client_name)})}))}catch(i){if(console.error("Error loading authorized apps:",i),this.hideElement(e),o){this.showElement(o);const a=o.querySelector(".error-state__message");a&&(a.textContent=i.message||"An unexpected error occurred")}}}renderAuthorizedAppCard(e){const t=new Date(e.authorized_at).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),o=new Date(e.last_used_at).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),n=(e.granted_scopes||[]).map(s=>({"galleries.read":"Read Galleries","galleries.write":"Create Galleries","galleries.edit":"Edit Galleries","galleries.delete":"Delete Galleries"})[s]||s);return`
            <div class="authorized-app-card" id="authorized-app-${e.consent_id}">
                <div class="authorized-app-card__header">
                    <div class="authorized-app-card__info">
                        ${e.logo_url?`
                            <img src="${this.escapeHtml(e.logo_url)}" alt="${this.escapeHtml(e.client_name)} logo" class="authorized-app-card__logo">
                        `:`
                            <div class="authorized-app-card__logo authorized-app-card__logo--placeholder">
                                ${this.escapeHtml(e.client_name.charAt(0).toUpperCase())}
                            </div>
                        `}
                        <div>
                            <h3 class="authorized-app-card__title">${this.escapeHtml(e.client_name)}</h3>
                            ${e.client_description?`<p class="authorized-app-card__desc">${this.escapeHtml(e.client_description)}</p>`:""}
                        </div>
                    </div>
                    <button
                        type="button"
                        class="btn btn--danger btn--small"
                        id="revoke-btn-${e.consent_id}"
                        title="Revoke access"
                    >
                        Revoke Access
                    </button>
                </div>

                <div class="authorized-app-card__meta">
                    <div class="authorized-app-card__meta-item">
                        <span class="authorized-app-card__meta-label">Authorized:</span>
                        <span class="authorized-app-card__meta-value">${t}</span>
                    </div>
                    <div class="authorized-app-card__meta-item">
                        <span class="authorized-app-card__meta-label">Last used:</span>
                        <span class="authorized-app-card__meta-value">${o}</span>
                    </div>
                </div>

                ${n.length>0?`
                    <div class="authorized-app-card__scopes">
                        <span class="authorized-app-card__scopes-label">Permissions:</span>
                        <div class="authorized-app-card__scopes-list">
                            ${n.map(s=>`<span class="scope-badge">${this.escapeHtml(s)}</span>`).join("")}
                        </div>
                    </div>
                `:""}

                ${e.homepage_url||e.privacy_policy_url?`
                    <div class="authorized-app-card__links">
                        ${e.homepage_url?`<a href="${this.escapeHtml(e.homepage_url)}" target="_blank" rel="noopener noreferrer" class="authorized-app-card__link">üåê Website</a>`:""}
                        ${e.privacy_policy_url?`<a href="${this.escapeHtml(e.privacy_policy_url)}" target="_blank" rel="noopener noreferrer" class="authorized-app-card__link">üîí Privacy Policy</a>`:""}
                    </div>
                `:""}
            </div>
        `}async revokeAuthorization(e,t){if(confirm(`Are you sure you want to revoke access for "${t}"?

This app will no longer be able to access your data.`))try{const o=await fetch("/oauth/authorized-apps/revoke",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":this.getCsrfToken()},body:JSON.stringify({client_db_id:e}),credentials:"include"});if(!o.ok){const n=await o.json();throw new Error(n.message||"Failed to revoke authorization")}this.showSuccess(`Access revoked for "${t}"`),this.authorizedAppsLoaded=!1,await this.loadAuthorizedApps()}catch(o){console.error("Error revoking authorization:",o),this.showError(`Failed to revoke access: ${o.message}`)}}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}}document.addEventListener("DOMContentLoaded",()=>{new w().init()})})();
