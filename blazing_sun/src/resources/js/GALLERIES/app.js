(function(){"use strict";class b{constructor(e){this.baseUrl=e.baseUrl,this.galleriesGrid=e.galleriesGrid,this.loadingState=e.loadingState,this.errorState=e.errorState,this.emptyState=e.emptyState,this.showToast=e.showToast,this.galleries=[],this.currentGallery=null,this.currentGalleryForPictures=null,this.selectedFiles=[],this.fileMetadata=[],this.currentLightboxIndex=0,this.init()}init(){this.setupEventListeners(),this.loadGalleries()}setupEventListeners(){const e=document.getElementById("createGalleryBtn");e&&e.addEventListener("click",()=>this.showGalleryModal()),document.querySelectorAll(".create-gallery-trigger").forEach(d=>{d.addEventListener("click",()=>this.showGalleryModal())});const i=document.getElementById("retryBtn");i&&i.addEventListener("click",()=>this.loadGalleries());const o=document.getElementById("galleryForm");o&&o.addEventListener("submit",d=>{d.preventDefault(),this.handleGallerySubmit()}),this.setupModalCloseListeners();const l=document.getElementById("confirmDeleteBtn");l&&l.addEventListener("click",()=>this.handleDelete());const s=document.getElementById("addPictureBtn");s&&s.addEventListener("click",()=>this.handleAddPictures());const r=document.getElementById("browseFilesBtn");r&&r.addEventListener("click",()=>this.triggerFileInput());const n=document.getElementById("pictureFileInput");n&&n.addEventListener("change",d=>this.handleFileSelect(d));const a=document.getElementById("uploadDropZone");a&&(a.addEventListener("dragover",d=>this.handleDragOver(d)),a.addEventListener("dragleave",d=>this.handleDragLeave(d)),a.addEventListener("drop",d=>this.handleDrop(d)));const u=document.getElementById("uploadFilesBtn");u&&u.addEventListener("click",()=>this.uploadAndAddPictures());const c=document.getElementById("cancelUploadBtn");c&&c.addEventListener("click",()=>this.cancelUpload());const h=document.querySelector(".image-lightbox__close");h&&h.addEventListener("click",()=>this.closeLightbox());const p=document.getElementById("lightboxPrevBtn");p&&p.addEventListener("click",()=>this.navigateLightbox(-1));const y=document.getElementById("lightboxNextBtn");y&&y.addEventListener("click",()=>this.navigateLightbox(1));const v=document.getElementById("lightboxForm");v&&v.addEventListener("submit",d=>{d.preventDefault(),this.saveLightboxMetadata()})}setupModalCloseListeners(){document.querySelectorAll(".modal__close, .modal__overlay").forEach(t=>{t.addEventListener("click",i=>{const o=i.target.closest(".modal");o&&this.closeModal(o)})})}async loadGalleries(){this.showLoadingState();try{const e=await fetch(`${this.baseUrl}/api/v1/galleries`,{method:"GET",credentials:"include",headers:{Accept:"application/json"}});if(!e.ok)throw new Error(`Failed to load galleries: ${e.statusText}`);const t=await e.json();this.galleries=t.galleries||[],this.galleries.length===0?this.showEmptyState():(this.renderGalleries(),this.showContentState())}catch(e){console.error("Failed to load galleries:",e),this.showErrorState(e.message)}}renderGalleries(){this.galleriesGrid.innerHTML="",this.galleries.forEach(e=>{const t=this.createGalleryCard(e);this.galleriesGrid.appendChild(t)})}createGalleryCard(e){const t=document.createElement("div");t.className="gallery-card",t.dataset.galleryId=e.id;const i=e.cover_image_url||"/assets/img/gallery-placeholder.svg",o=e.picture_count||0,l=e.is_public?"Public":"Private";t.innerHTML=`
      <div class="gallery-card__cover">
        <img src="${i}" alt="${this.escapeHtml(e.name)}" class="gallery-card__image">
        <div class="gallery-card__overlay">
          <button class="gallery-card__action" data-action="view-pictures" aria-label="View pictures">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
          </button>
        </div>
      </div>
      <div class="gallery-card__content">
        <h3 class="gallery-card__title">${this.escapeHtml(e.name)}</h3>
        ${e.description?`<p class="gallery-card__description">${this.escapeHtml(e.description)}</p>`:""}
        <div class="gallery-card__meta">
          <span class="gallery-card__count">${o} ${o===1?"picture":"pictures"}</span>
          <span class="gallery-card__visibility">${l}</span>
        </div>
      </div>
      <div class="gallery-card__actions">
        <button class="btn btn--icon" data-action="edit" aria-label="Edit gallery">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
        </button>
        <button class="btn btn--icon btn--danger" data-action="delete" aria-label="Delete gallery">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
        </button>
      </div>
    `;const s=t.querySelector('[data-action="view-pictures"]');s&&s.addEventListener("click",()=>this.showPicturesModal(e));const r=t.querySelector('[data-action="edit"]');r&&r.addEventListener("click",()=>this.showGalleryModal(e));const n=t.querySelector('[data-action="delete"]');return n&&n.addEventListener("click",()=>this.showDeleteModal(e)),t}showGalleryModal(e=null){const t=document.getElementById("galleryModal"),i=document.getElementById("galleryModalTitle"),o=document.getElementById("galleryForm"),l=document.getElementById("saveGalleryBtn");!t||!o||(this.currentGallery=e,e?(i.textContent="Edit Gallery",l.querySelector(".btn__text").textContent="Update Gallery",document.getElementById("galleryName").value=e.name||"",document.getElementById("galleryDescription").value=e.description||"",document.getElementById("galleryIsPublic").checked=e.is_public||!1,document.getElementById("galleryId").value=e.id):(i.textContent="Create Gallery",l.querySelector(".btn__text").textContent="Create Gallery",o.reset(),document.getElementById("galleryId").value=""),this.clearFormErrors(),this.openModal(t))}async handleGallerySubmit(){const e=document.getElementById("galleryForm"),t=new FormData(e),i=document.getElementById("galleryId").value,o={name:t.get("name"),description:t.get("description")||null,is_public:t.get("is_public")==="on"};if(this.clearFormErrors(),!o.name||o.name.trim().length===0){this.showFieldError("nameError","Gallery name is required");return}const l=document.getElementById("saveGalleryBtn");l.disabled=!0;try{i?await this.updateGallery(i,o):await this.createGallery(o);const s=document.getElementById("galleryModal");this.closeModal(s),await this.loadGalleries()}catch(s){console.error("Failed to save gallery:",s),this.showToast(s.message,"error")}finally{l.disabled=!1}}async createGallery(e){const t=await fetch(`${this.baseUrl}/api/v1/galleries`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e)});if(!t.ok){const i=await t.json();throw new Error(i.error||"Failed to create gallery")}return this.showToast("Gallery created successfully","success"),t.json()}async updateGallery(e,t){const i=await fetch(`${this.baseUrl}/api/v1/galleries/${e}`,{method:"PUT",credentials:"include",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(t)});if(!i.ok){const o=await i.json();throw new Error(o.error||"Failed to update gallery")}return this.showToast("Gallery updated successfully","success"),i.json()}showDeleteModal(e){this.currentGallery=e;const t=document.getElementById("deleteModal"),i=document.getElementById("deleteMessage");!t||!i||(i.textContent=`Are you sure you want to delete "${e.name}"? This will also delete all pictures in this gallery. This action cannot be undone.`,this.openModal(t))}async handleDelete(){if(!this.currentGallery)return;const e=document.getElementById("confirmDeleteBtn");e.disabled=!0;try{await this.deleteGallery(this.currentGallery.id);const t=document.getElementById("deleteModal");this.closeModal(t),this.currentGallery=null,await this.loadGalleries()}catch(t){console.error("Failed to delete gallery:",t),this.showToast(t.message,"error")}finally{e.disabled=!1}}async deleteGallery(e){const t=await fetch(`${this.baseUrl}/api/v1/galleries/${e}`,{method:"DELETE",credentials:"include",headers:{Accept:"application/json"}});if(!t.ok){const i=await t.json();throw new Error(i.error||"Failed to delete gallery")}this.showToast("Gallery deleted successfully","success")}showPicturesModal(e){this.currentGalleryForPictures=e;const t=document.getElementById("picturesModal"),i=document.getElementById("picturesModalTitle");!t||!i||(i.textContent=`${e.name} - Pictures`,this.openModal(t),this.loadGalleryPictures(e.id))}async loadGalleryPictures(e){const t=document.getElementById("picturesGrid"),i=document.getElementById("picturesEmpty");if(!(!t||!i)){t.innerHTML='<div class="loading-state"><div class="spinner"></div><p>Loading pictures...</p></div>',i.style.display="none";try{const o=await fetch(`${this.baseUrl}/api/v1/galleries/${e}/pictures`,{method:"GET",credentials:"include",headers:{Accept:"application/json"}});if(!o.ok)throw new Error("Failed to load pictures");const s=(await o.json()).pictures||[];s.length===0?(t.innerHTML="",i.style.display="block"):this.renderPictures(s)}catch(o){console.error("Failed to load pictures:",o),t.innerHTML=`<div class="error-state"><p>${o.message}</p></div>`}}}renderPictures(e){const t=document.getElementById("picturesGrid");t&&(t.innerHTML="",e.forEach(i=>{const o=document.createElement("div");o.className="picture-card",o.dataset.pictureId=i.id,o.innerHTML=`
        <div class="picture-card__image-wrapper" data-action="view-picture">
          <img src="${i.urls.medium}" alt="${this.escapeHtml(i.title||"Picture")}" class="picture-card__image">
        </div>
        <div class="picture-card__content">
          <h4 class="picture-card__title">${this.escapeHtml(i.title||"Untitled")}</h4>
          ${i.description?`<p class="picture-card__description">${this.escapeHtml(i.description)}</p>`:""}
        </div>
        <div class="picture-card__actions">
          <button class="btn btn--icon" data-action="edit-picture" aria-label="Edit metadata">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
          </button>
          <button class="btn btn--icon btn--danger" data-action="remove-picture" aria-label="Remove from gallery">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      `;const l=o.querySelector('[data-action="view-picture"]');l&&(l.style.cursor="pointer",l.addEventListener("click",()=>this.openPictureLightbox(e,e.indexOf(i))));const s=o.querySelector('[data-action="edit-picture"]');s&&s.addEventListener("click",n=>{n.stopPropagation(),this.openPictureLightbox(e,e.indexOf(i),!0)});const r=o.querySelector('[data-action="remove-picture"]');r&&r.addEventListener("click",n=>{n.stopPropagation(),this.removePictureFromGallery(i.id)}),t.appendChild(o)}))}async removePictureFromGallery(e){if(confirm("Remove this picture from the gallery?"))try{if(!(await fetch(`${this.baseUrl}/api/v1/galleries/${this.currentGalleryForPictures.id}/pictures/${e}`,{method:"DELETE",credentials:"include",headers:{Accept:"application/json"}})).ok)throw new Error("Failed to remove picture");this.showToast("Picture removed successfully","success"),this.currentGalleryForPictures&&this.loadGalleryPictures(this.currentGalleryForPictures.id)}catch(t){console.error("Failed to remove picture:",t),this.showToast(t.message,"error")}}openPictureLightbox(e,t,i=!1){console.log("Opening picture lightbox",{picturesCount:e.length,index:t,editMode:i}),this.currentPictures=e,this.currentPictureIndex=t;const o=e[t];let l=document.getElementById("pictureLightbox");if(!l){console.log("Creating new lightbox"),l=document.createElement("div"),l.id="pictureLightbox",l.className="image-lightbox",l.innerHTML=`
        <div class="image-lightbox__container">
          <div class="image-lightbox__image-section">
            <img class="image-lightbox__image" src="" alt="">
            ${e.length>1?`
              <button class="image-lightbox__nav image-lightbox__nav--prev" aria-label="Previous">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
              </button>
              <button class="image-lightbox__nav image-lightbox__nav--next" aria-label="Next">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            `:""}
          </div>
          <div class="image-lightbox__meta-section">
            <div class="image-lightbox__header">
              <h3 class="image-lightbox__title">Picture Details</h3>
              <button class="image-lightbox__close" aria-label="Close">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
            <div class="image-lightbox__body">
              <div class="lightbox-form" id="lightboxMetaView">
                <div class="form__group">
                  <h4 class="lightbox__meta-title" style="margin: 0 0 0.5rem 0; color: var(--text-primary);"></h4>
                  <p class="lightbox__meta-description" style="margin: 0; color: var(--text-secondary);"></p>
                  ${e.length>1?'<p class="lightbox__counter" style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-tertiary);"></p>':""}
                </div>
              </div>
              <div class="lightbox-form" id="lightboxMetaEdit" style="display: none;">
                <div class="form__group">
                  <label class="form__label">Title</label>
                  <input type="text" class="form__input lightbox__title-input" placeholder="Enter title">
                </div>
                <div class="form__group">
                  <label class="form__label">Description</label>
                  <textarea class="form__textarea lightbox__description-input" placeholder="Enter description (optional)" rows="4"></textarea>
                </div>
              </div>
            </div>
            <div class="image-lightbox__footer" id="lightboxFooterView">
              <button class="btn btn--primary lightbox__edit-btn">Edit Metadata</button>
            </div>
            <div class="image-lightbox__footer" id="lightboxFooterEdit" style="display: none; gap: 0.5rem;">
              <button class="btn btn--secondary lightbox__cancel-edit">Cancel</button>
              <button class="btn btn--primary lightbox__save-edit">Save</button>
            </div>
          </div>
        </div>
      `,document.body.appendChild(l),l.querySelector(".image-lightbox__close").addEventListener("click",()=>{console.log("Close button clicked"),this.closePictureLightbox()});const r=l.querySelector(".image-lightbox__image-section");if(r.addEventListener("click",c=>{c.target===r&&(console.log("Backdrop clicked"),this.closePictureLightbox())}),e.length>1){const c=l.querySelector(".image-lightbox__nav--prev"),h=l.querySelector(".image-lightbox__nav--next");c.addEventListener("click",()=>{console.log("Previous button clicked"),this.navigatePictureLightbox(-1)}),h.addEventListener("click",()=>{console.log("Next button clicked"),this.navigatePictureLightbox(1)})}const n=l.querySelector(".lightbox__edit-btn"),a=l.querySelector(".lightbox__cancel-edit"),u=l.querySelector(".lightbox__save-edit");n.addEventListener("click",()=>{console.log("Edit button clicked"),this.togglePictureEditMode(!0)}),a.addEventListener("click",()=>{console.log("Cancel edit clicked"),this.togglePictureEditMode(!1)}),u.addEventListener("click",()=>{console.log("Save button clicked"),this.savePictureMetadata()}),this.pictureLightboxKeyHandler=c=>{c.key==="Escape"?(console.log("Escape key pressed"),this.closePictureLightbox()):c.key==="ArrowLeft"&&e.length>1?(console.log("Left arrow key pressed"),this.navigatePictureLightbox(-1)):c.key==="ArrowRight"&&e.length>1&&(console.log("Right arrow key pressed"),this.navigatePictureLightbox(1))},document.addEventListener("keydown",this.pictureLightboxKeyHandler)}this.updatePictureLightbox(o,i),l.classList.add("image-lightbox--open"),document.body.style.overflow="hidden",console.log("Lightbox opened")}updatePictureLightbox(e,t=!1){const i=document.getElementById("pictureLightbox");if(!i)return;const o=i.querySelector(".image-lightbox__image"),l=i.querySelector(".lightbox__meta-title"),s=i.querySelector(".lightbox__meta-description"),r=i.querySelector(".lightbox__counter"),n=i.querySelector(".lightbox__title-input"),a=i.querySelector(".lightbox__description-input");o.src=e.urls.large,o.alt=e.title||"Picture",l.textContent=e.title||"Untitled",s.textContent=e.description||"",s.style.display=e.description?"block":"none",r&&this.currentPictures.length>1&&(r.textContent=`${this.currentPictureIndex+1} / ${this.currentPictures.length}`),n.value=e.title||"",a.value=e.description||"",t&&this.togglePictureEditMode(!0)}togglePictureEditMode(e){const t=document.getElementById("pictureLightbox");if(!t)return;const i=document.getElementById("lightboxMetaView"),o=document.getElementById("lightboxMetaEdit"),l=document.getElementById("lightboxFooterView"),s=document.getElementById("lightboxFooterEdit");if(e)i.style.display="none",o.style.display="block",l.style.display="none",s.style.display="flex";else{i.style.display="block",o.style.display="none",l.style.display="flex",s.style.display="none";const r=this.currentPictures[this.currentPictureIndex],n=t.querySelector(".lightbox__title-input"),a=t.querySelector(".lightbox__description-input");n.value=r.title||"",a.value=r.description||""}}async savePictureMetadata(){const e=document.getElementById("pictureLightbox");if(!e)return;const t=e.querySelector(".lightbox__title-input"),i=e.querySelector(".lightbox__description-input"),o=this.currentPictures[this.currentPictureIndex],l=t.value.trim()||"Untitled",s=i.value.trim()||null;try{const r=await fetch(`${this.baseUrl}/api/v1/galleries/${this.currentGalleryForPictures.id}/pictures/${o.id}`,{method:"PUT",credentials:"include",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({title:l,description:s})});if(!r.ok){const n=await r.json();throw new Error(n.error||"Failed to update picture")}o.title=l,o.description=s,this.showToast("Picture updated successfully","success"),this.togglePictureEditMode(!1),this.updatePictureLightbox(o,!1),this.currentGalleryForPictures&&this.loadGalleryPictures(this.currentGalleryForPictures.id)}catch(r){console.error("Failed to update picture:",r),this.showToast(r.message,"error")}}navigatePictureLightbox(e){const t=this.currentPictureIndex+e;if(t>=0&&t<this.currentPictures.length){this.currentPictureIndex=t;const i=this.currentPictures[t];this.updatePictureLightbox(i,!1)}}closePictureLightbox(){console.log("Closing picture lightbox");const e=document.getElementById("pictureLightbox");e&&(e.classList.remove("image-lightbox--open"),document.body.style.overflow="",this.pictureLightboxKeyHandler&&(document.removeEventListener("keydown",this.pictureLightboxKeyHandler),this.pictureLightboxKeyHandler=null),this.currentPictures=null,this.currentPictureIndex=-1)}handleAddPictures(){if(!this.currentGalleryForPictures){this.showToast("No gallery selected","error");return}const e=document.getElementById("uploadSection"),t=document.getElementById("picturesGrid"),i=document.getElementById("picturesEmpty"),o=document.getElementById("addPictureBtn");e&&(e.style.display="block"),t&&(t.style.display="none"),i&&(i.style.display="none"),o&&(o.style.display="none")}triggerFileInput(){const e=document.getElementById("pictureFileInput");e&&e.click()}handleFileSelect(e){const t=Array.from(e.target.files);this.processFiles(t)}handleDragOver(e){e.preventDefault(),e.stopPropagation(),e.currentTarget.classList.add("upload-drop-zone--active")}handleDragLeave(e){e.preventDefault(),e.stopPropagation(),e.currentTarget.classList.remove("upload-drop-zone--active")}handleDrop(e){e.preventDefault(),e.stopPropagation(),e.currentTarget.classList.remove("upload-drop-zone--active");const t=Array.from(e.dataTransfer.files);this.processFiles(t)}processFiles(e){const t=e.filter(l=>l.type.startsWith("image/"));if(t.length===0){this.showToast("Please select valid image files","error");return}const i=10*1024*1024,o=t.filter(l=>l.size>i?(this.showToast(`${l.name} exceeds 10MB limit`,"error"),!1):!0);o.length!==0&&(this.selectedFiles=o,this.fileMetadata=o.map(l=>({title:l.name.replace(/\.[^/.]+$/,""),description:""})),this.showFilePreview())}showFilePreview(){const e=document.getElementById("uploadDropZone"),t=document.getElementById("uploadPreview"),i=document.querySelector(".upload-actions"),o=document.getElementById("uploadFilesBtn");e&&(e.style.display="none"),t&&(t.style.display="grid",t.innerHTML="",this.selectedFiles.forEach((l,s)=>{const r=new FileReader;r.onload=n=>{const a=document.createElement("div");a.className="upload-preview__item",a.dataset.index=s,a.innerHTML=`
            <img src="${n.target.result}" alt="${this.escapeHtml(l.name)}" class="upload-preview__image">
            <div class="upload-preview__info">
              <span class="upload-preview__name">${this.escapeHtml(l.name)}</span>
              <span class="upload-preview__size">${this.formatFileSize(l.size)}</span>
            </div>
            <button type="button" class="upload-preview__edit" data-index="${s}" aria-label="Edit details">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
            </button>
            <button type="button" class="upload-preview__remove" data-index="${s}" aria-label="Remove file">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          `;const u=a.querySelector(".upload-preview__image");u&&u.addEventListener("click",()=>this.openLightbox(s));const c=a.querySelector(".upload-preview__edit");c&&c.addEventListener("click",p=>{p.stopPropagation(),this.openLightbox(s)});const h=a.querySelector(".upload-preview__remove");h&&h.addEventListener("click",p=>{p.stopPropagation(),this.removeFile(s)}),t.appendChild(a)},r.readAsDataURL(l)})),i&&(i.style.display="flex"),o&&(o.disabled=!1)}removeFile(e){this.selectedFiles.splice(e,1),this.selectedFiles.length===0?this.cancelUpload():this.showFilePreview()}formatFileSize(e){if(e===0)return"0 Bytes";const t=1024,i=["Bytes","KB","MB"],o=Math.floor(Math.log(e)/Math.log(t));return Math.round(e/Math.pow(t,o)*100)/100+" "+i[o]}cancelUpload(){this.selectedFiles=[],this.fileMetadata=[];const e=document.getElementById("uploadSection"),t=document.getElementById("uploadDropZone"),i=document.getElementById("uploadPreview"),o=document.querySelector(".upload-actions"),l=document.getElementById("picturesGrid");document.getElementById("picturesEmpty");const s=document.getElementById("addPictureBtn"),r=document.getElementById("pictureFileInput");e&&(e.style.display="none"),t&&(t.style.display="block"),i&&(i.style.display="none",i.innerHTML=""),o&&(o.style.display="none"),l&&(l.style.display="grid"),s&&(s.style.display="inline-flex"),r&&(r.value=""),this.currentGalleryForPictures&&this.loadGalleryPictures(this.currentGalleryForPictures.id)}async uploadAndAddPictures(){if(!this.currentGalleryForPictures||this.selectedFiles.length===0)return;const e=document.getElementById("uploadFilesBtn");e&&(e.disabled=!0,e.querySelector(".btn__text").textContent="Uploading...");try{for(let t=0;t<this.selectedFiles.length;t++){const i=this.selectedFiles[t],o=this.fileMetadata[t],l=await this.uploadFile(i);await this.addPictureToGallery(l,o.title,o.description)}this.showToast(`${this.selectedFiles.length} picture(s) added successfully`,"success"),this.cancelUpload(),await this.loadGalleryPictures(this.currentGalleryForPictures.id),await this.loadGalleries()}catch(t){console.error("Failed to upload pictures:",t),this.showToast(t.message,"error"),e&&(e.disabled=!1,e.querySelector(".btn__text").textContent="Upload & Add to Gallery")}}async uploadFile(e){const t=new FormData;t.append("file",e);const i=await fetch(`${this.baseUrl}/api/v1/upload/public`,{method:"POST",credentials:"include",body:t});if(!i.ok){const l=await i.json();throw new Error(l.error||"Failed to upload file")}return(await i.json()).id}async addPictureToGallery(e,t,i){const o=await fetch(`${this.baseUrl}/api/v1/galleries/${this.currentGalleryForPictures.id}/pictures`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({upload_id:e,title:t||"Untitled",description:i||null})});if(!o.ok){const l=await o.json();throw new Error(l.error||"Failed to add picture to gallery")}return o.json()}openModal(e){e.classList.add("modal--open"),e.setAttribute("aria-hidden","false")}closeModal(e){e.classList.remove("modal--open"),e.setAttribute("aria-hidden","true"),e&&e.id==="picturesModal"&&this.loadGalleries()}showLoadingState(){this.loadingState.style.display="block",this.errorState.style.display="none",this.emptyState.style.display="none",this.galleriesGrid.style.display="none"}showErrorState(e){this.loadingState.style.display="none",this.errorState.style.display="block",this.emptyState.style.display="none",this.galleriesGrid.style.display="none";const t=this.errorState.querySelector(".error-state__message");t&&(t.textContent=e)}showEmptyState(){this.loadingState.style.display="none",this.errorState.style.display="none",this.emptyState.style.display="block",this.galleriesGrid.style.display="none"}showContentState(){this.loadingState.style.display="none",this.errorState.style.display="none",this.emptyState.style.display="none",this.galleriesGrid.style.display="grid"}clearFormErrors(){document.querySelectorAll(".form__error").forEach(t=>{t.textContent=""})}showFieldError(e,t){const i=document.getElementById(e);i&&(i.textContent=t)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}openLightbox(e){if(e<0||e>=this.selectedFiles.length)return;this.currentLightboxIndex=e;const t=this.selectedFiles[e],i=this.fileMetadata[e],o=document.getElementById("lightboxImage");if(o){const a=new FileReader;a.onload=u=>{o.src=u.target.result,o.alt=t.name},a.readAsDataURL(t)}const l=document.getElementById("lightboxTitle"),s=document.getElementById("lightboxDescription"),r=document.getElementById("lightboxFileIndex");l&&(l.value=i.title),s&&(s.value=i.description||""),r&&(r.value=e),this.updateLightboxNav();const n=document.getElementById("imageLightbox");n&&(n.classList.add("image-lightbox--open"),n.setAttribute("aria-hidden","false"))}closeLightbox(){const e=document.getElementById("imageLightbox");e&&(e.classList.remove("image-lightbox--open"),e.setAttribute("aria-hidden","true"));const t=document.getElementById("lightboxTitle"),i=document.getElementById("lightboxDescription");t&&(t.value=""),i&&(i.value=""),this.currentLightboxIndex=0}navigateLightbox(e){const t=this.currentLightboxIndex+e;if(t>=0&&t<this.selectedFiles.length){const i=document.getElementById("lightboxTitle"),o=document.getElementById("lightboxDescription");i&&this.currentLightboxIndex>=0&&this.currentLightboxIndex<this.fileMetadata.length&&(this.fileMetadata[this.currentLightboxIndex]={title:i.value.trim()||this.fileMetadata[this.currentLightboxIndex].title,description:o?o.value.trim():""}),this.openLightbox(t)}}updateLightboxNav(){const e=document.getElementById("lightboxPrevBtn"),t=document.getElementById("lightboxNextBtn");e&&(e.disabled=this.currentLightboxIndex===0),t&&(t.disabled=this.currentLightboxIndex===this.selectedFiles.length-1)}saveLightboxMetadata(e=!0){const t=document.getElementById("lightboxTitle"),i=document.getElementById("lightboxDescription"),o=document.getElementById("lightboxFileIndex");if(!t||!o)return;const l=parseInt(o.value,10);if(isNaN(l)||l<0||l>=this.selectedFiles.length)return;const s=t.value.trim();if(!s){this.showFieldError("lightboxTitleError","Title is required");return}this.clearFieldErrors(),this.fileMetadata[l]={title:s,description:i?i.value.trim():""};const r=document.querySelector(`.upload-preview__item[data-index="${l}"]`);if(r){const n=r.querySelector(".upload-preview__name");n&&(n.textContent=s)}e&&(this.showToast("Image details saved","success"),this.closeLightbox())}}function m(){const g=document.getElementById("galleriesGrid"),e=document.getElementById("loadingState"),t=document.getElementById("errorState"),i=document.getElementById("emptyState");if(!g||!e||!t||!i){console.error("GalleriesPage: Required DOM elements not found");return}const o=window.BASE_URL||"",l=f(),s=new b({baseUrl:o,galleriesGrid:g,loadingState:e,errorState:t,emptyState:i,showToast:l});typeof window<"u"&&(window.galleriesController=s)}function f(){const g={success:"linear-gradient(to right, #00b09b, #96c93d)",error:"linear-gradient(to right, #ff5f6d, #ffc371)",info:"linear-gradient(to right, #667eea, #764ba2)"};return function(t,i="success"){typeof Toastify<"u"?Toastify({text:t,duration:4e3,gravity:"top",position:"right",style:{background:g[i]||g.info}}).showToast():console.log(`[${i.toUpperCase()}] ${t}`)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",m):m()})();
