{% extends "base.html" %}

{% block title %}Profile - Blazing Sun{% endblock %}

{% block extra_styles_links %}
<link rel="stylesheet" href="/assets/css/PROFILE/style.css?v={{ assets_version }}">
{% endblock %}

{% block content %}
<main class="profile">
    <div class="profile__container">
        <header class="profile__header">
            <h1 class="profile__title">My Profile</h1>
        </header>

        <div class="profile__grid">
            <!-- Left Column: Avatar Section -->
            <aside>
                <div class="profile-card avatar-section">
                    <div class="avatar" id="avatarContainer">
                        {% if user and user.avatar_url %}
                        <img
                            id="avatarImage"
                            class="avatar__image"
                            src="{{ user.avatar_url | safe }}"
                            alt="Profile picture"
                        >
                        <div id="avatarPlaceholder" class="avatar__placeholder hidden">
                        {% else %}
                        <img
                            id="avatarImage"
                            class="avatar__image hidden"
                            src=""
                            alt="Profile picture"
                        >
                        <div id="avatarPlaceholder" class="avatar__placeholder">
                        {% endif %}
                            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm-2.625 6c-.54 0-.828.419-.936.634a1.96 1.96 0 00-.189.866c0 .298.059.605.189.866.108.215.395.634.936.634.54 0 .828-.419.936-.634.13-.26.189-.568.189-.866 0-.298-.059-.605-.189-.866-.108-.215-.395-.634-.936-.634zm4.314.634c.108-.215.395-.634.936-.634.54 0 .828.419.936.634.13.26.189.568.189.866 0 .298-.059.605-.189.866-.108.215-.395.634-.936.634-.54 0-.828-.419-.936-.634a1.96 1.96 0 01-.189-.866c0-.298.059-.605.189-.866zm2.023 6.828a.75.75 0 10-1.06-1.06 3.75 3.75 0 01-5.304 0 .75.75 0 00-1.06 1.06 5.25 5.25 0 007.424 0z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="avatar__overlay" title="Change profile picture">
                            <svg class="avatar__overlay-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                        <input
                            type="file"
                            id="avatarInput"
                            class="avatar__input"
                            accept="image/jpeg,image/png,image/gif,image/webp"
                        >
                    </div>
                    {% if user %}
                    <h2 class="avatar__name" id="displayName">{{ user.first_name }} {{ user.last_name }}</h2>
                    <p class="avatar__email" id="displayEmail">{{ user.email }}</p>
                    {% else %}
                    <h2 class="avatar__name" id="displayName">Loading...</h2>
                    <p class="avatar__email" id="displayEmail">Loading...</p>
                    {% endif %}
                </div>
            </aside>

            <!-- Right Column: Profile Details -->
            <section>
                <!-- Personal Information -->
                <article class="profile-card">
                    <h2 class="profile-card__title">Personal Information</h2>
                    <form id="profileForm" aria-label="Edit profile form" novalidate>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-group__label" for="first_name">First Name</label>
                                <div class="input-wrapper">
                                    <input
                                        type="text"
                                        id="first_name"
                                        name="first_name"
                                        class="form-group__input"
                                        autocomplete="given-name"
                                        aria-required="true"
                                        aria-describedby="firstNameFeedback"
                                        value="{% if user %}{{ user.first_name }}{% endif %}"
                                        placeholder="Enter your first name"
                                    >
                                </div>
                                <div id="firstNameFeedback" class="validation-feedback" aria-live="polite"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label" for="last_name">Last Name</label>
                                <div class="input-wrapper">
                                    <input
                                        type="text"
                                        id="last_name"
                                        name="last_name"
                                        class="form-group__input"
                                        autocomplete="family-name"
                                        aria-required="true"
                                        aria-describedby="lastNameFeedback"
                                        value="{% if user %}{{ user.last_name }}{% endif %}"
                                        placeholder="Enter your last name"
                                    >
                                </div>
                                <div id="lastNameFeedback" class="validation-feedback" aria-live="polite"></div>
                            </div>
                        </div>
                        <button type="submit" id="saveProfileBtn" class="btn btn--primary btn--full mt4" disabled>
                            Save Changes
                        </button>
                    </form>
                </article>

                <!-- Change Password -->
                <article class="profile-card mt4">
                    <h2 class="profile-card__title">Change Password</h2>
                    <form id="passwordForm" aria-label="Change password form" novalidate>
                        <div class="form-group">
                            <label class="form-group__label" for="current_password">Current Password</label>
                            <div class="input-wrapper input-wrapper--password">
                                <input
                                    type="password"
                                    id="current_password"
                                    name="current_password"
                                    class="form-group__input"
                                    autocomplete="current-password"
                                    aria-required="true"
                                    aria-describedby="currentPasswordFeedback"
                                    placeholder="Enter your current password"
                                >
                                <button type="button" class="password-toggle" id="currentPasswordToggle" aria-label="Show password">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                </button>
                            </div>
                            <div id="currentPasswordFeedback" class="validation-feedback" aria-live="polite"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-group__label" for="new_password">New Password</label>
                            <div class="input-wrapper input-wrapper--password">
                                <input
                                    type="password"
                                    id="new_password"
                                    name="new_password"
                                    class="form-group__input"
                                    autocomplete="new-password"
                                    aria-required="true"
                                    aria-describedby="newPasswordFeedback"
                                    placeholder="Enter your new password"
                                >
                                <button type="button" class="password-toggle" id="newPasswordToggle" aria-label="Show password">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                </button>
                            </div>
                            <div id="newPasswordFeedback" class="validation-feedback" aria-live="polite"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-group__label" for="confirm_password">Confirm New Password</label>
                            <div class="input-wrapper input-wrapper--password">
                                <input
                                    type="password"
                                    id="confirm_password"
                                    name="confirm_password"
                                    class="form-group__input"
                                    autocomplete="new-password"
                                    aria-required="true"
                                    aria-describedby="confirmPasswordFeedback"
                                    placeholder="Confirm your new password"
                                >
                                <button type="button" class="password-toggle" id="confirmPasswordToggle" aria-label="Show password">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                </button>
                            </div>
                            <div id="confirmPasswordFeedback" class="validation-feedback" aria-live="polite"></div>
                        </div>
                        <button type="submit" id="changePasswordBtn" class="btn btn--primary btn--full mt4">
                            Change Password
                        </button>
                    </form>
                </article>

                <!-- Change Email -->
                <article class="profile-card mt4">
                    <h2 class="profile-card__title">Change Email</h2>

                    <!-- Step Indicators -->
                    <div class="email-steps">
                        <div class="email-step email-step--active" data-step="1">
                            <span class="email-step__number">1</span>
                            <span class="email-step__label">New Email</span>
                        </div>
                        <div class="email-step__connector"></div>
                        <div class="email-step" data-step="2">
                            <span class="email-step__number">2</span>
                            <span class="email-step__label">Verify Old</span>
                        </div>
                        <div class="email-step__connector"></div>
                        <div class="email-step" data-step="3">
                            <span class="email-step__number">3</span>
                            <span class="email-step__label">Verify New</span>
                        </div>
                        <div class="email-step__connector"></div>
                        <div class="email-step" data-step="4">
                            <span class="email-step__number">4</span>
                            <span class="email-step__label">Done</span>
                        </div>
                    </div>

                    <!-- Step 1: Enter New Email -->
                    <div id="emailStep1">
                        <form id="newEmailForm" aria-label="Request email change" novalidate>
                            <div class="form-group">
                                <label class="form-group__label" for="new_email">New Email Address</label>
                                <div class="input-wrapper">
                                    <input
                                        type="email"
                                        id="new_email"
                                        name="new_email"
                                        class="form-group__input"
                                        autocomplete="email"
                                        aria-required="true"
                                        aria-describedby="newEmailFeedback"
                                        placeholder="Enter your new email"
                                    >
                                </div>
                                <div id="newEmailFeedback" class="validation-feedback" aria-live="polite"></div>
                                <small class="form-group__hint">We'll send a verification code to your current email first</small>
                            </div>
                            <button type="submit" id="sendEmailCodeBtn" class="btn btn--primary btn--full mt3">
                                Request Email Change
                            </button>
                        </form>
                    </div>

                    <!-- Step 2: Verify Old Email -->
                    <div id="emailStep2" class="hidden">
                        <div class="message-box message-box--info">
                            <p><strong>Step 1 of 2:</strong> A verification code has been sent to your current email address (<span id="currentEmailDisplay"></span>). Please check your inbox and enter the code below.</p>
                        </div>
                        <form id="verifyOldEmailForm" aria-label="Verify old email">
                            <div class="form-group">
                                <label class="form-group__label" for="old_email_code">Verification Code (Old Email)</label>
                                <input
                                    type="text"
                                    id="old_email_code"
                                    name="old_email_code"
                                    class="form-group__input tc"
                                    required
                                    maxlength="32"
                                    placeholder="Enter code from old email"
                                    autocomplete="one-time-code"
                                    aria-required="true"
                                >
                            </div>
                            <button type="submit" id="verifyOldEmailBtn" class="btn btn--primary btn--full mt3">
                                Verify Old Email
                            </button>
                            <button type="button" class="btn btn--secondary btn--full mt2" data-action="cancel">
                                Cancel
                            </button>
                        </form>
                    </div>

                    <!-- Step 3: Verify New Email -->
                    <div id="emailStep3" class="hidden">
                        <div class="message-box message-box--info">
                            <p><strong>Step 2 of 2:</strong> A verification code has been sent to your new email address (<span id="newEmailDisplay"></span>). Please check your inbox and enter the code below.</p>
                        </div>
                        <form id="verifyNewEmailForm" aria-label="Verify new email">
                            <div class="form-group">
                                <label class="form-group__label" for="new_email_code">Verification Code (New Email)</label>
                                <input
                                    type="text"
                                    id="new_email_code"
                                    name="new_email_code"
                                    class="form-group__input tc"
                                    required
                                    maxlength="32"
                                    placeholder="Enter code from new email"
                                    autocomplete="one-time-code"
                                    aria-required="true"
                                >
                            </div>
                            <button type="submit" id="verifyNewEmailBtn" class="btn btn--primary btn--full mt3">
                                Complete Email Change
                            </button>
                            <button type="button" class="btn btn--secondary btn--full mt2" data-action="cancel">
                                Cancel
                            </button>
                        </form>
                    </div>

                    <!-- Step 4: Success -->
                    <div id="emailStep4" class="hidden">
                        <div class="message-box message-box--success tc">
                            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 1rem; display: block;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <h3 class="fw600 mb2">Email Changed Successfully!</h3>
                            <p>Your email has been updated. You've been signed out for security. Please sign in with your new email address.</p>
                            <p class="mt2"><small>Redirecting to sign in page in <span id="redirectCountdown">5</span> seconds...</small></p>
                        </div>
                    </div>
                </article>

                <!-- Developer Console -->
                <article class="profile-card mt4">
                    <div class="profile-card__header">
                        <h2 class="profile-card__title">Developer Console</h2>
                    </div>
                    <p class="profile-card__description">Manage OAuth 2.0 applications that integrate with your account. Create API clients and manage their access to your data.</p>
                    <a href="{{ route(name='oauth.applications', lang=language) | default(value='/oauth/applications') }}" class="btn btn--primary mt3">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                        </svg>
                        Manage OAuth Applications
                    </a>
                </article>
            </section>
        </div>
    </div>
</main>

<!-- Avatar Preview Modal -->
<div id="avatarPreviewModal" class="avatar-preview hidden" role="dialog" aria-modal="true" aria-labelledby="previewTitle">
    <div class="avatar-preview__container">
        <h3 id="previewTitle" class="tc mb4">Preview Profile Picture</h3>
        <img id="previewImage" class="avatar-preview__image" src="" alt="Avatar preview">
        <div class="avatar-preview__actions">
            <button type="button" id="cancelAvatarBtn" class="btn btn--secondary">Cancel</button>
            <button type="button" id="confirmAvatarBtn" class="btn btn--primary">Save</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Set base URL for API requests
    window.BASE_URL = '{{ base_url | safe }}';
    // SSR user data - no need to fetch from API
    {% if user %}
    window.USER_DATA = {
        id: {{ user.id }},
        email: "{{ user.email }}",
        first_name: "{{ user.first_name }}",
        last_name: "{{ user.last_name }}",
        avatar_url: {% if user.avatar_url %}"{{ user.avatar_url }}"{% else %}null{% endif %}
    };
    {% else %}
    window.USER_DATA = null;
    {% endif %}
</script>
<script src="/assets/js/PROFILE/app.js?v={{ assets_version }}" defer></script>
{% endblock %}
