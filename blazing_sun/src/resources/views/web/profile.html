{% extends "base.html" %}

{% block title %}Profile - Blazing Sun{% endblock %}

{% block extra_styles_links %}
<link rel="stylesheet" href="/assets/css/PROFILE/style.css?v={{ assets_version }}">
{% endblock %}

{% block content %}
<main class="profile">
    <div class="profile__container">
        <header class="profile__header">
            <h1 class="profile__title">My Profile</h1>
        </header>

        <div class="profile__grid">
            <!-- Left Column: Avatar Section -->
            <aside>
                <div class="profile-card avatar-section">
                    <div class="avatar" id="avatarContainer">
                        {% if user and user.avatar_url %}
                        <img
                            id="avatarImage"
                            class="avatar__image"
                            src="{{ user.avatar_url }}"
                            alt="Profile picture"
                        >
                        <div id="avatarPlaceholder" class="avatar__placeholder hidden">
                        {% else %}
                        <img
                            id="avatarImage"
                            class="avatar__image hidden"
                            src=""
                            alt="Profile picture"
                        >
                        <div id="avatarPlaceholder" class="avatar__placeholder">
                        {% endif %}
                            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm-2.625 6c-.54 0-.828.419-.936.634a1.96 1.96 0 00-.189.866c0 .298.059.605.189.866.108.215.395.634.936.634.54 0 .828-.419.936-.634.13-.26.189-.568.189-.866 0-.298-.059-.605-.189-.866-.108-.215-.395-.634-.936-.634zm4.314.634c.108-.215.395-.634.936-.634.54 0 .828.419.936.634.13.26.189.568.189.866 0 .298-.059.605-.189.866-.108.215-.395.634-.936.634-.54 0-.828-.419-.936-.634a1.96 1.96 0 01-.189-.866c0-.298.059-.605.189-.866zm2.023 6.828a.75.75 0 10-1.06-1.06 3.75 3.75 0 01-5.304 0 .75.75 0 00-1.06 1.06 5.25 5.25 0 007.424 0z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="avatar__overlay" title="Change profile picture">
                            <svg class="avatar__overlay-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                        <input
                            type="file"
                            id="avatarInput"
                            class="avatar__input"
                            accept="image/jpeg,image/png,image/gif,image/webp"
                        >
                    </div>
                    {% if user %}
                    <h2 class="avatar__name" id="displayName">{{ user.first_name }} {{ user.last_name }}</h2>
                    <p class="avatar__email" id="displayEmail">{{ user.email }}</p>
                    {% else %}
                    <h2 class="avatar__name" id="displayName">Loading...</h2>
                    <p class="avatar__email" id="displayEmail">Loading...</p>
                    {% endif %}
                </div>
            </aside>

            <!-- Right Column: Profile Details -->
            <section>
                <!-- Personal Information -->
                <article class="profile-card">
                    <h2 class="profile-card__title">Personal Information</h2>
                    <form id="profileForm" aria-label="Edit profile form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-group__label" for="first_name">First Name</label>
                                <input
                                    type="text"
                                    id="first_name"
                                    name="first_name"
                                    class="form-group__input"
                                    required
                                    autocomplete="given-name"
                                    aria-required="true"
                                    value="{% if user %}{{ user.first_name }}{% endif %}"
                                >
                            </div>
                            <div class="form-group">
                                <label class="form-group__label" for="last_name">Last Name</label>
                                <input
                                    type="text"
                                    id="last_name"
                                    name="last_name"
                                    class="form-group__input"
                                    required
                                    autocomplete="family-name"
                                    aria-required="true"
                                    value="{% if user %}{{ user.last_name }}{% endif %}"
                                >
                            </div>
                        </div>
                        <button type="submit" id="saveProfileBtn" class="btn btn--primary btn--full mt4" disabled>
                            Save Changes
                        </button>
                    </form>
                </article>

                <!-- Change Password -->
                <article class="profile-card mt4">
                    <h2 class="profile-card__title">Change Password</h2>
                    <form id="passwordForm" aria-label="Change password form">
                        <div class="form-group">
                            <label class="form-group__label" for="current_password">Current Password</label>
                            <input
                                type="password"
                                id="current_password"
                                name="current_password"
                                class="form-group__input"
                                required
                                autocomplete="current-password"
                                aria-required="true"
                            >
                        </div>
                        <div class="form-group">
                            <label class="form-group__label" for="new_password">New Password</label>
                            <input
                                type="password"
                                id="new_password"
                                name="new_password"
                                class="form-group__input"
                                required
                                minlength="8"
                                autocomplete="new-password"
                                aria-required="true"
                                aria-describedby="password-strength-hint"
                            >
                            <div class="password-strength">
                                <div class="password-strength__track">
                                    <div class="password-strength__bar"></div>
                                </div>
                            </div>
                            <small id="password-strength-hint" class="password-strength-text"></small>
                        </div>
                        <div class="form-group">
                            <label class="form-group__label" for="confirm_password">Confirm New Password</label>
                            <input
                                type="password"
                                id="confirm_password"
                                name="confirm_password"
                                class="form-group__input"
                                required
                                autocomplete="new-password"
                                aria-required="true"
                            >
                        </div>
                        <button type="submit" id="changePasswordBtn" class="btn btn--primary btn--full mt4">
                            Change Password
                        </button>
                    </form>
                </article>

                <!-- Change Email -->
                <article class="profile-card mt4">
                    <h2 class="profile-card__title">Change Email</h2>

                    <!-- Step Indicators -->
                    <div class="email-steps">
                        <div class="email-step email-step--active">
                            <span class="email-step__number">1</span>
                            <span class="email-step__label">New Email</span>
                        </div>
                        <div class="email-step__connector"></div>
                        <div class="email-step">
                            <span class="email-step__number">2</span>
                            <span class="email-step__label">Verify</span>
                        </div>
                        <div class="email-step__connector"></div>
                        <div class="email-step">
                            <span class="email-step__number">3</span>
                            <span class="email-step__label">Done</span>
                        </div>
                    </div>

                    <!-- Step 1: Enter New Email -->
                    <div id="emailStep1">
                        <form id="newEmailForm" aria-label="Request email change">
                            <div class="form-group">
                                <label class="form-group__label" for="new_email">New Email Address</label>
                                <input
                                    type="email"
                                    id="new_email"
                                    name="new_email"
                                    class="form-group__input"
                                    required
                                    autocomplete="email"
                                    aria-required="true"
                                    placeholder="Enter your new email"
                                >
                                <small class="form-group__hint">We'll send a verification code to this email</small>
                            </div>
                            <button type="submit" id="sendEmailCodeBtn" class="btn btn--primary btn--full mt3">
                                Send Verification Code
                            </button>
                        </form>
                    </div>

                    <!-- Step 2: Verify Code -->
                    <div id="emailStep2" class="hidden">
                        <div class="message-box message-box--info">
                            <p>A verification code has been sent to your new email address. Please check your inbox and enter the code below.</p>
                        </div>
                        <form id="verifyEmailForm" aria-label="Verify email change">
                            <div class="form-group">
                                <label class="form-group__label" for="email_code">Verification Code</label>
                                <input
                                    type="text"
                                    id="email_code"
                                    name="email_code"
                                    class="form-group__input tc"
                                    required
                                    maxlength="20"
                                    placeholder="Enter 20 character code"
                                    autocomplete="one-time-code"
                                    aria-required="true"
                                >
                            </div>
                            <button type="submit" id="verifyEmailBtn" class="btn btn--primary btn--full mt3">
                                Verify & Change Email
                            </button>
                        </form>
                    </div>

                    <!-- Step 3: Success -->
                    <div id="emailStep3" class="hidden">
                        <div class="message-box message-box--success tc">
                            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 1rem; display: block;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <h3 class="fw600 mb2">Email Changed Successfully!</h3>
                            <p>Your email has been updated. You will now receive notifications at your new email address.</p>
                        </div>
                        <button type="button" class="btn btn--secondary btn--full mt3" data-action="start-over">
                            Change Email Again
                        </button>
                    </div>
                </article>
            </section>
        </div>
    </div>
</main>

<!-- Avatar Preview Modal -->
<div id="avatarPreviewModal" class="avatar-preview hidden" role="dialog" aria-modal="true" aria-labelledby="previewTitle">
    <div class="avatar-preview__container">
        <h3 id="previewTitle" class="tc mb4">Preview Profile Picture</h3>
        <img id="previewImage" class="avatar-preview__image" src="" alt="Avatar preview">
        <div class="avatar-preview__actions">
            <button type="button" id="cancelAvatarBtn" class="btn btn--secondary">Cancel</button>
            <button type="button" id="confirmAvatarBtn" class="btn btn--primary">Save</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Set base URL for API requests
    window.BASE_URL = '{{ base_url | safe }}';
    // SSR user data - no need to fetch from API
    {% if user %}
    window.USER_DATA = {
        id: {{ user.id }},
        email: "{{ user.email }}",
        first_name: "{{ user.first_name }}",
        last_name: "{{ user.last_name }}",
        avatar_url: {% if user.avatar_url %}"{{ user.avatar_url }}"{% else %}null{% endif %}
    };
    {% else %}
    window.USER_DATA = null;
    {% endif %}
</script>
<script src="/assets/js/PROFILE/app.js?v={{ assets_version }}" defer></script>
{% endblock %}
