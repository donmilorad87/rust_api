class m{constructor(t){this.baseUrl=t.baseUrl||"",this.profileForm=t.profileForm,this.firstNameInput=t.firstNameInput,this.lastNameInput=t.lastNameInput,this.displayName=t.displayName,this.displayEmail=t.displayEmail,this.saveBtn=t.saveBtn,this.showToast=t.showToast||this.defaultToast.bind(this),this.isSubmitting=!1,this.userData=null,this.authToken=null,this.init()}init(){if(this.authToken=this.getTokenFromCookie(),!this.authToken){this.showToast("Please sign in to view your profile","error"),setTimeout(()=>{window.location.href="/sign-in"},1500);return}this.loadUserData(),this.profileForm&&this.profileForm.addEventListener("submit",t=>this.handleSubmit(t)),this.firstNameInput&&this.firstNameInput.addEventListener("input",()=>this.checkForChanges()),this.lastNameInput&&this.lastNameInput.addEventListener("input",()=>this.checkForChanges())}getTokenFromCookie(){const t=document.cookie.split(";");for(const e of t){const[s,a]=e.trim().split("=");if(s==="auth_token")return decodeURIComponent(a)}return null}getAuthToken(){return this.authToken}async loadUserData(){var t;try{const e=await fetch(`${this.baseUrl}/api/v1/user`,{method:"GET",headers:{Authorization:`Bearer ${this.authToken}`}});if(!e.ok){if(e.status===401){this.showToast("Session expired. Please sign in again.","error"),setTimeout(()=>{window.location.href="/sign-in"},1500);return}throw new Error("Failed to load user data")}const s=await e.json();this.userData=((t=s.data)==null?void 0:t.user)||s.user||s.data||s,this.populateForm()}catch(e){console.error("Failed to load user data:",e),this.showToast("Failed to load profile data","error")}}populateForm(){if(this.userData){if(this.firstNameInput&&(this.firstNameInput.value=this.userData.first_name||""),this.lastNameInput&&(this.lastNameInput.value=this.userData.last_name||""),this.displayName){const t=`${this.userData.first_name||""} ${this.userData.last_name||""}`.trim();this.displayName.textContent=t||"User"}this.displayEmail&&(this.displayEmail.textContent=this.userData.email||""),this.saveBtn&&(this.saveBtn.disabled=!0)}}checkForChanges(){var i,n;if(!this.userData||!this.saveBtn)return;const t=((i=this.firstNameInput)==null?void 0:i.value)||"",e=((n=this.lastNameInput)==null?void 0:n.value)||"",s=this.userData.first_name||"",a=this.userData.last_name||"",r=t!==s||e!==a;this.saveBtn.disabled=!r}async handleSubmit(t){var a,r;if(t.preventDefault(),this.isSubmitting)return;const e=((a=this.firstNameInput)==null?void 0:a.value.trim())||"",s=((r=this.lastNameInput)==null?void 0:r.value.trim())||"";if(!e){this.showToast("First name is required","error");return}if(!s){this.showToast("Last name is required","error");return}this.isSubmitting=!0,this.setButtonLoading(!0);try{const i=await fetch(`${this.baseUrl}/api/v1/user`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.authToken}`},body:JSON.stringify({first_name:e,last_name:s})}),n=await i.json();i.ok?(this.userData.first_name=e,this.userData.last_name=s,this.displayName&&(this.displayName.textContent=`${e} ${s}`),this.showToast("Profile updated successfully!","success"),this.saveBtn.disabled=!0):this.handleApiError(n)}catch(i){console.error("Profile update failed:",i),this.showToast("Network error. Please try again.","error")}finally{this.isSubmitting=!1,this.setButtonLoading(!1)}}updateEmail(t){this.userData&&(this.userData.email=t),this.displayEmail&&(this.displayEmail.textContent=t)}getUserInitials(){var s,a;if(!this.userData)return"?";const t=((s=this.userData.first_name)==null?void 0:s[0])||"",e=((a=this.userData.last_name)==null?void 0:a[0])||"";return(t+e).toUpperCase()||"?"}getUserData(){return this.userData}setButtonLoading(t){this.saveBtn&&(this.saveBtn.disabled=t,this.saveBtn.textContent=t?"Saving...":"Save Changes",t?this.saveBtn.classList.add("btn--loading"):this.saveBtn.classList.remove("btn--loading"))}handleApiError(t){const e=t.message||"An error occurred. Please try again.";if(this.showToast(e,"error"),t.errors)for(const[s,a]of Object.entries(t.errors))Array.isArray(a)&&a.forEach(r=>this.showToast(`${s}: ${r}`,"error"))}defaultToast(t,e="info"){console.log(`[${e.toUpperCase()}] ${t}`),alert(t)}}class f{constructor(t){this.baseUrl=t.baseUrl||"",this.avatarContainer=t.avatarContainer,this.avatarImage=t.avatarImage,this.avatarPlaceholder=t.avatarPlaceholder,this.fileInput=t.fileInput,this.previewModal=t.previewModal,this.previewImage=t.previewImage,this.confirmBtn=t.confirmBtn,this.cancelBtn=t.cancelBtn,this.showToast=t.showToast||this.defaultToast.bind(this),this.getAuthToken=t.getAuthToken||(()=>null),this.onUploadSuccess=t.onUploadSuccess||(()=>{}),this.selectedFile=null,this.isUploading=!1,this.maxFileSize=5*1024*1024,this.allowedTypes=["image/jpeg","image/png","image/gif","image/webp"],this.init()}init(){if(!this.fileInput||!this.avatarContainer){console.error("AvatarUpload: Required elements not found");return}const t=this.avatarContainer.querySelector(".avatar__overlay");t&&t.addEventListener("click",()=>this.fileInput.click()),this.fileInput.addEventListener("change",e=>this.handleFileSelect(e)),this.confirmBtn&&this.confirmBtn.addEventListener("click",()=>this.uploadAvatar()),this.cancelBtn&&this.cancelBtn.addEventListener("click",()=>this.closePreview()),this.previewModal&&this.previewModal.addEventListener("click",e=>{e.target===this.previewModal&&this.closePreview()})}handleFileSelect(t){const e=t.target.files[0];if(e){if(!this.allowedTypes.includes(e.type)){this.showToast("Please select a valid image file (JPEG, PNG, GIF, or WebP)","error"),this.fileInput.value="";return}if(e.size>this.maxFileSize){this.showToast("Image must be smaller than 5MB","error"),this.fileInput.value="";return}this.selectedFile=e,this.showPreview(e)}}showPreview(t){if(!this.previewModal||!this.previewImage)return;const e=new FileReader;e.onload=s=>{this.previewImage.src=s.target.result,this.previewModal.classList.remove("hidden")},e.readAsDataURL(t)}closePreview(){this.previewModal&&this.previewModal.classList.add("hidden"),this.selectedFile=null,this.fileInput.value=""}async uploadAvatar(){if(!this.selectedFile||this.isUploading)return;if(!this.getAuthToken()){this.showToast("Please sign in to upload avatar","error");return}this.isUploading=!0,this.setButtonLoading(!0);const e=new FormData;e.append("file",this.selectedFile);try{const s=await fetch(`${this.baseUrl}/api/v1/upload/avatar`,{method:"POST",body:e}),a=await s.json();if(s.ok&&a.status==="success"){const r=a.upload,i=r.url;this.updateAvatarDisplay(i),this.showToast("Profile picture updated!","success"),this.closePreview(),this.onUploadSuccess(r)}else this.showToast(a.message||"Failed to upload profile picture","error")}catch(s){console.error("Avatar upload failed:",s),this.showToast("Network error. Please try again.","error")}finally{this.isUploading=!1,this.setButtonLoading(!1)}}updateAvatarDisplay(t){this.avatarImage&&(this.avatarImage.src=t,this.avatarImage.classList.remove("hidden")),this.avatarPlaceholder&&this.avatarPlaceholder.classList.add("hidden")}setAvatar(t){t?this.updateAvatarDisplay(t):(this.avatarImage&&this.avatarImage.classList.add("hidden"),this.avatarPlaceholder&&this.avatarPlaceholder.classList.remove("hidden"))}setButtonLoading(t){this.confirmBtn&&(this.confirmBtn.disabled=t,this.confirmBtn.textContent=t?"Uploading...":"Save",t?this.confirmBtn.classList.add("btn--loading"):this.confirmBtn.classList.remove("btn--loading"))}defaultToast(t,e="info"){console.log(`[${e.toUpperCase()}] ${t}`),alert(t)}}class p{constructor(t){this.baseUrl=t.baseUrl||"",this.form=t.form,this.currentPasswordInput=t.currentPasswordInput,this.newPasswordInput=t.newPasswordInput,this.confirmPasswordInput=t.confirmPasswordInput,this.strengthBar=t.strengthBar,this.strengthText=t.strengthText,this.submitBtn=t.submitBtn,this.showToast=t.showToast||this.defaultToast.bind(this),this.getAuthToken=t.getAuthToken||(()=>null),this.isSubmitting=!1,this.init()}init(){if(!this.form){console.error("PasswordChange: Form element not found");return}this.form.addEventListener("submit",t=>this.handleSubmit(t)),this.newPasswordInput&&this.newPasswordInput.addEventListener("input",t=>{this.updatePasswordStrength(t.target.value)})}async handleSubmit(t){var i,n,l;if(t.preventDefault(),this.isSubmitting)return;const e=((i=this.currentPasswordInput)==null?void 0:i.value)||"",s=((n=this.newPasswordInput)==null?void 0:n.value)||"",a=((l=this.confirmPasswordInput)==null?void 0:l.value)||"";if(!this.validatePasswords(e,s,a))return;const r=this.getAuthToken();if(!r){this.showToast("Please sign in to change password","error");return}this.isSubmitting=!0,this.setButtonLoading(!0);try{const h=await fetch(`${this.baseUrl}/api/v1/password/change-password`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({current_password:e,new_password:s,confirm_password:a})}),c=await h.json();h.ok?(this.showToast("Password changed successfully!","success"),this.form.reset(),this.updatePasswordStrength("")):this.handleApiError(c)}catch(h){console.error("Password change failed:",h),this.showToast("Network error. Please try again.","error")}finally{this.isSubmitting=!1,this.setButtonLoading(!1)}}validatePasswords(t,e,s){return t?e?e.length<8?(this.showToast("Password must be at least 8 characters","error"),!1):/[A-Z]/.test(e)?/[a-z]/.test(e)?/[0-9]/.test(e)?/[^\p{L}\p{N}]/u.test(e)?e!==s?(this.showToast("Passwords do not match","error"),!1):t===e?(this.showToast("New password must be different from current password","error"),!1):!0:(this.showToast("Password must contain at least one special character","error"),!1):(this.showToast("Password must contain at least one digit","error"),!1):(this.showToast("Password must contain at least one lowercase letter","error"),!1):(this.showToast("Password must contain at least one uppercase letter","error"),!1):(this.showToast("New password is required","error"),!1):(this.showToast("Current password is required","error"),!1)}updatePasswordStrength(t){if(!this.strengthBar||!this.strengthText)return;const e=this.calculatePasswordStrength(t);if(this.strengthBar.classList.remove("password-strength__bar--weak","password-strength__bar--fair","password-strength__bar--good","password-strength__bar--strong"),t.length===0){this.strengthBar.style.width="0",this.strengthText.textContent="";return}e<2?(this.strengthBar.classList.add("password-strength__bar--weak"),this.strengthText.textContent="Weak"):e<3?(this.strengthBar.classList.add("password-strength__bar--fair"),this.strengthText.textContent="Fair"):e<4?(this.strengthBar.classList.add("password-strength__bar--good"),this.strengthText.textContent="Good"):(this.strengthBar.classList.add("password-strength__bar--strong"),this.strengthText.textContent="Strong")}calculatePasswordStrength(t){let e=0;return t.length>=8&&e++,t.length>=12&&e++,/[A-Z]/.test(t)&&e++,/[a-z]/.test(t)&&e++,/[0-9]/.test(t)&&e++,/[!@#$%^&*(),.?":{}|<>]/.test(t)&&e++,Math.min(e,5)}setButtonLoading(t){this.submitBtn&&(this.submitBtn.disabled=t,this.submitBtn.textContent=t?"Changing...":"Change Password",t?this.submitBtn.classList.add("btn--loading"):this.submitBtn.classList.remove("btn--loading"))}handleApiError(t){const e=t.message||"An error occurred. Please try again.";if(this.showToast(e,"error"),t.errors)for(const[s,a]of Object.entries(t.errors))Array.isArray(a)&&a.forEach(r=>this.showToast(`${s}: ${r}`,"error"))}defaultToast(t,e="info"){console.log(`[${e.toUpperCase()}] ${t}`),alert(t)}}class g{constructor(t){this.baseUrl=t.baseUrl||"",this.step1Card=t.step1Card,this.step2Card=t.step2Card,this.step3Card=t.step3Card,this.emailForm=t.emailForm,this.verifyForm=t.verifyForm,this.newEmailInput=t.newEmailInput,this.codeInput=t.codeInput,this.emailBtn=t.emailBtn,this.verifyBtn=t.verifyBtn,this.stepIndicators=t.stepIndicators||[],this.showToast=t.showToast||this.defaultToast.bind(this),this.getAuthToken=t.getAuthToken||(()=>null),this.onEmailChanged=t.onEmailChanged||(()=>{}),this.currentStep=1,this.isSubmitting=!1,this.newEmail="",this.verificationCode="",this.init()}init(){var e;this.emailForm&&this.emailForm.addEventListener("submit",s=>this.handleEmailSubmit(s)),this.verifyForm&&this.verifyForm.addEventListener("submit",s=>this.handleVerifySubmit(s)),this.codeInput&&this.codeInput.addEventListener("input",s=>this.formatCodeInput(s));const t=(e=this.step3Card)==null?void 0:e.querySelector('[data-action="start-over"]');t&&t.addEventListener("click",()=>this.goToStep(1))}async handleEmailSubmit(t){var a,r;if(t.preventDefault(),this.isSubmitting)return;const e=((a=this.newEmailInput)==null?void 0:a.value.trim())||"";if(!this.validateEmail(e))return;const s=this.getAuthToken();if(!s){this.showToast("Please sign in to change email","error");return}this.isSubmitting=!0,this.setButtonLoading(this.emailBtn,!0,"Checking...");try{const i=await fetch(`${this.baseUrl}/api/v1/email/check-availability`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({email:e})}),n=await i.json();if(!i.ok){(r=n.message)!=null&&r.toLowerCase().includes("already")?this.showToast("This email is already in use","error"):this.showToast(n.message||"Could not verify email availability","error"),this.setButtonLoading(this.emailBtn,!1,"Send Verification Code"),this.isSubmitting=!1;return}const l=await fetch(`${this.baseUrl}/api/v1/email/request-change`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({new_email:e})}),h=await l.json();l.ok?(this.newEmail=e,this.showToast("Verification code sent to your new email!","success"),this.goToStep(2)):(this.showToast(h.message||"Failed to send verification code","error"),this.setButtonLoading(this.emailBtn,!1,"Send Verification Code"))}catch(i){console.error("Email check failed:",i),this.showToast("Network error. Please try again.","error"),this.setButtonLoading(this.emailBtn,!1,"Send Verification Code")}finally{this.isSubmitting=!1}}async handleVerifySubmit(t){var a;if(t.preventDefault(),this.isSubmitting)return;const e=((a=this.codeInput)==null?void 0:a.value.trim())||"";if(!e||e.length<20){this.showToast("Please enter the 20 character verification code","error");return}const s=this.getAuthToken();if(!s){this.showToast("Please sign in to change email","error");return}this.isSubmitting=!0,this.setButtonLoading(this.verifyBtn,!0,"Verifying...");try{const r=await fetch(`${this.baseUrl}/api/v1/email/verify-change`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({code:e,new_email:this.newEmail})}),i=await r.json();r.ok?(this.showToast("Email changed successfully!","success"),this.goToStep(3),this.onEmailChanged(this.newEmail)):(this.showToast(i.message||"Invalid verification code","error"),this.setButtonLoading(this.verifyBtn,!1,"Verify & Change Email"))}catch(r){console.error("Email verification failed:",r),this.showToast("Network error. Please try again.","error"),this.setButtonLoading(this.verifyBtn,!1,"Verify & Change Email")}finally{this.isSubmitting=!1}}goToStep(t){var s,a,r,i,n;this.currentStep=t,(s=this.step1Card)==null||s.classList.add("hidden"),(a=this.step2Card)==null||a.classList.add("hidden"),(r=this.step3Card)==null||r.classList.add("hidden");const e=this.getCardForStep(t);if(e){e.classList.remove("hidden");const l=e.querySelector('input:not([type="hidden"])');l&&setTimeout(()=>l.focus(),100)}this.updateStepIndicators(t),this.setButtonLoading(this.emailBtn,!1,"Send Verification Code"),this.setButtonLoading(this.verifyBtn,!1,"Verify & Change Email"),t===1&&((i=this.emailForm)==null||i.reset(),(n=this.verifyForm)==null||n.reset(),this.newEmail="",this.verificationCode="")}getCardForStep(t){switch(t){case 1:return this.step1Card;case 2:return this.step2Card;case 3:return this.step3Card;default:return null}}updateStepIndicators(t){this.stepIndicators.forEach((e,s)=>{const a=s+1;e.classList.remove("email-step--active","email-step--completed"),a<t?e.classList.add("email-step--completed"):a===t&&e.classList.add("email-step--active")})}validateEmail(t){return t?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)?!0:(this.showToast("Please enter a valid email address","error"),!1):(this.showToast("Email is required","error"),!1)}formatCodeInput(t){const e=t.target;e.value=e.value.replace(/[^a-zA-Z0-9]/g,"").slice(0,20)}setButtonLoading(t,e,s){t&&(t.disabled=e,t.textContent=s,e?t.classList.add("btn--loading"):t.classList.remove("btn--loading"))}defaultToast(t,e="info"){console.log(`[${e.toUpperCase()}] ${t}`),alert(t)}}function d(o,t="info"){const e={success:"linear-gradient(135deg, #10b981 0%, #059669 100%)",error:"linear-gradient(135deg, #ef4444 0%, #dc2626 100%)",warning:"linear-gradient(135deg, #f59e0b 0%, #d97706 100%)",info:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"};typeof Toastify=="function"?Toastify({text:o,duration:4e3,gravity:"top",position:"right",stopOnFocus:!0,style:{background:e[t]||e.info,borderRadius:"8px",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)"}}).showToast():console.log(`[${t.toUpperCase()}] ${o}`)}function u(){const o=window.BASE_URL||"",t=new m({baseUrl:o,profileForm:document.getElementById("profileForm"),firstNameInput:document.getElementById("first_name"),lastNameInput:document.getElementById("last_name"),displayName:document.getElementById("displayName"),displayEmail:document.getElementById("displayEmail"),saveBtn:document.getElementById("saveProfileBtn"),showToast:d}),e=new f({baseUrl:o,avatarContainer:document.getElementById("avatarContainer"),avatarImage:document.getElementById("avatarImage"),avatarPlaceholder:document.getElementById("avatarPlaceholder"),fileInput:document.getElementById("avatarInput"),previewModal:document.getElementById("avatarPreviewModal"),previewImage:document.getElementById("previewImage"),confirmBtn:document.getElementById("confirmAvatarBtn"),cancelBtn:document.getElementById("cancelAvatarBtn"),showToast:d,getAuthToken:()=>t.getAuthToken(),onUploadSuccess:i=>{console.log("Avatar uploaded:",i)}}),s=new p({baseUrl:o,form:document.getElementById("passwordForm"),currentPasswordInput:document.getElementById("current_password"),newPasswordInput:document.getElementById("new_password"),confirmPasswordInput:document.getElementById("confirm_password"),strengthBar:document.querySelector(".password-strength__bar"),strengthText:document.querySelector(".password-strength-text"),submitBtn:document.getElementById("changePasswordBtn"),showToast:d,getAuthToken:()=>t.getAuthToken()}),a=new g({baseUrl:o,step1Card:document.getElementById("emailStep1"),step2Card:document.getElementById("emailStep2"),step3Card:document.getElementById("emailStep3"),emailForm:document.getElementById("newEmailForm"),verifyForm:document.getElementById("verifyEmailForm"),newEmailInput:document.getElementById("new_email"),codeInput:document.getElementById("email_code"),emailBtn:document.getElementById("sendEmailCodeBtn"),verifyBtn:document.getElementById("verifyEmailBtn"),stepIndicators:Array.from(document.querySelectorAll(".email-step")),showToast:d,getAuthToken:()=>t.getAuthToken(),onEmailChanged:i=>{t.updateEmail(i)}}),r=()=>{const i=t.getUserData();if(i){const n=i.avatar_uuid?`/api/v1/avatar/${i.avatar_uuid}`:null;e.setAvatar(n)}else setTimeout(r,100)};setTimeout(r,100),window.profilePage=t,window.avatarUpload=e,window.passwordChange=s,window.emailChange=a}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u):u();
