class f{constructor(e){this.baseUrl=e.baseUrl||"",this.requestCard=e.requestCard,this.verifyCard=e.verifyCard,this.resetCard=e.resetCard,this.requestForm=e.requestForm,this.verifyForm=e.verifyForm,this.resetForm=e.resetForm,this.requestBtn=e.requestBtn,this.verifyBtn=e.verifyBtn,this.resetBtn=e.resetBtn,this.showToast=e.showToast||this.defaultToast.bind(this),this.currentStep=1,this.isSubmitting=!1,this.userEmail="",this.verifiedCode="",this.init()}init(){if(!this.requestForm||!this.verifyForm||!this.resetForm){console.error("ForgotPassword: Required form elements not found");return}this.requestForm.addEventListener("submit",s=>this.handleRequestCode(s)),this.verifyForm.addEventListener("submit",s=>this.handleVerifyCode(s)),this.resetForm.addEventListener("submit",s=>this.handleResetPassword(s));const e=document.getElementById("reset_code");e&&e.addEventListener("input",s=>this.formatCodeInput(s));const t=document.getElementById("new_password");t&&t.addEventListener("input",s=>this.updatePasswordStrength(s.target.value))}async handleRequestCode(e){var r;if(e.preventDefault(),this.isSubmitting)return;const t=((r=this.requestForm.querySelector("#email"))==null?void 0:r.value.trim())||"";if(!this.validateEmail(t))return;this.setButtonLoading(this.requestBtn,!0,"Sending..."),this.isSubmitting=!0;const s=await this.apiRequest("/api/v1/account/forgot-password","POST",{email:t});if(this.isSubmitting=!1,s.ok){this.userEmail=t,this.showToast("Reset code sent! Please check your email.","success");const i=document.getElementById("verify_email"),o=document.getElementById("reset_email");i&&(i.value=t),o&&(o.value=t),this.goToStep(2)}else this.setButtonLoading(this.requestBtn,!1,"Send Reset Code"),this.handleApiError(s)}async handleVerifyCode(e){var i,o;if(e.preventDefault(),this.isSubmitting)return;const t=((i=this.verifyForm.querySelector("#reset_code"))==null?void 0:i.value.trim())||"",s=this.userEmail||((o=document.getElementById("verify_email"))==null?void 0:o.value)||"";if(!t||t.length<20){this.showToast("Please enter the 20 character code","error");return}this.setButtonLoading(this.verifyBtn,!0,"Verifying..."),this.isSubmitting=!0;const r=await this.apiRequest("/api/v1/account/verify-hash","POST",{email:s,code:t});this.isSubmitting=!1,r.ok?(this.showToast("Code verified! Please enter your new password.","success"),this.verifiedCode=t,this.goToStep(3)):(this.setButtonLoading(this.verifyBtn,!1,"Verify Code"),this.handleApiError(r))}async handleResetPassword(e){var o,a,d;if(e.preventDefault(),this.isSubmitting)return;const t=((o=this.resetForm.querySelector("#new_password"))==null?void 0:o.value)||"",s=((a=this.resetForm.querySelector("#confirm_password"))==null?void 0:a.value)||"";this.userEmail||(d=document.getElementById("reset_email"))!=null&&d.value;const r=this.verifiedCode;if(!r){this.showToast("Verification code is missing. Please start over.","error"),this.goToStep(1);return}if(!this.validatePasswords(t,s))return;this.setButtonLoading(this.resetBtn,!0,"Resetting..."),this.isSubmitting=!0;const i=await this.apiRequest("/api/v1/account/reset-password","POST",{code:r,password:t,confirm_password:s});this.isSubmitting=!1,i.ok?(this.showToast("Password reset successful! Redirecting to sign in...","success"),this.setButtonLoading(this.resetBtn,!1,"Redirecting..."),setTimeout(()=>{window.location.href="/sign-in"},2e3)):(this.setButtonLoading(this.resetBtn,!1,"Reset Password"),this.handleApiError(i))}goToStep(e){var s,r,i;this.currentStep=e,(s=this.requestCard)==null||s.classList.add("hidden"),(r=this.verifyCard)==null||r.classList.add("hidden"),(i=this.resetCard)==null||i.classList.add("hidden");const t=this.getCardForStep(e);if(t){t.classList.remove("hidden");const o=t.querySelector('input:not([type="hidden"])');o&&setTimeout(()=>o.focus(),100)}this.setButtonLoading(this.requestBtn,!1,"Send Reset Code"),this.setButtonLoading(this.verifyBtn,!1,"Verify Code"),this.setButtonLoading(this.resetBtn,!1,"Reset Password")}getCardForStep(e){switch(e){case 1:return this.requestCard;case 2:return this.verifyCard;case 3:return this.resetCard;default:return null}}validateEmail(e){return e?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?!0:(this.showToast("Please enter a valid email address","error"),!1):(this.showToast("Email is required","error"),!1)}validatePasswords(e,t){return e?e.length<8?(this.showToast("Password must be at least 8 characters","error"),!1):/[A-Z]/.test(e)?/[a-z]/.test(e)?/[0-9]/.test(e)?/[^\p{L}\p{N}]/u.test(e)?e!==t?(this.showToast("Passwords do not match","error"),!1):!0:(this.showToast("Password must contain at least one special character","error"),!1):(this.showToast("Password must contain at least one digit","error"),!1):(this.showToast("Password must contain at least one lowercase letter","error"),!1):(this.showToast("Password must contain at least one uppercase letter","error"),!1):(this.showToast("Password is required","error"),!1)}formatCodeInput(e){const t=e.target;t.value=t.value.replace(/[^a-zA-Z0-9]/g,"").slice(0,20)}updatePasswordStrength(e){const t=document.querySelector(".password-strength__bar"),s=document.querySelector(".password-strength-text");if(!t||!s)return;const r=this.calculatePasswordStrength(e);if(t.classList.remove("password-strength__bar--weak","password-strength__bar--fair","password-strength__bar--good","password-strength__bar--strong"),e.length===0){t.style.width="0",s.textContent="";return}r<2?(t.classList.add("password-strength__bar--weak"),s.textContent="Weak"):r<3?(t.classList.add("password-strength__bar--fair"),s.textContent="Fair"):r<4?(t.classList.add("password-strength__bar--good"),s.textContent="Good"):(t.classList.add("password-strength__bar--strong"),s.textContent="Strong")}calculatePasswordStrength(e){let t=0;return e.length>=8&&t++,e.length>=12&&t++,/[A-Z]/.test(e)&&t++,/[a-z]/.test(e)&&t++,/[0-9]/.test(e)&&t++,/[!@#$%^&*(),.?":{}|<>]/.test(e)&&t++,Math.min(t,5)}setButtonLoading(e,t,s){e&&(e.disabled=t,e.textContent=s,t?e.classList.add("btn--loading"):e.classList.remove("btn--loading"))}handleApiError(e){var s,r;const t=((s=e.data)==null?void 0:s.message)||"An error occurred. Please try again.";if(this.showToast(t,"error"),(r=e.data)!=null&&r.errors)for(const[i,o]of Object.entries(e.data.errors))Array.isArray(o)&&o.forEach(a=>this.showToast(`${i}: ${a}`,"error"))}async apiRequest(e,t="GET",s=null){const r={method:t,headers:{"Content-Type":"application/json"}};s&&(r.body=JSON.stringify(s));try{const i=await fetch(`${this.baseUrl}${e}`,r),o=await i.json();return{ok:i.ok,data:o}}catch(i){return console.error("API request failed:",i),{ok:!1,data:{message:"Network error. Please try again."}}}}defaultToast(e,t="info"){console.log(`[${t.toUpperCase()}] ${e}`),alert(e)}}function u(){const n=document.getElementById("requestCard"),e=document.getElementById("verifyCard"),t=document.getElementById("resetCard"),s=document.getElementById("requestForm"),r=document.getElementById("verifyForm"),i=document.getElementById("resetForm"),o=document.getElementById("requestBtn"),a=document.getElementById("verifyBtn"),d=document.getElementById("resetBtn");if(!n||!e||!t){console.error("ForgotPassword page: Required card elements not found");return}if(!s||!r||!i){console.error("ForgotPassword page: Required form elements not found");return}const l=window.BASE_URL||"",h=m(),c=new f({baseUrl:l,requestCard:n,verifyCard:e,resetCard:t,requestForm:s,verifyForm:r,resetForm:i,requestBtn:o,verifyBtn:a,resetBtn:d,showToast:h});typeof window<"u"&&(window.forgotPasswordController=c)}function m(){const n={success:"linear-gradient(to right, #00b09b, #96c93d)",error:"linear-gradient(to right, #ff5f6d, #ffc371)",info:"linear-gradient(to right, #667eea, #764ba2)"};return function(t,s="success"){typeof Toastify<"u"?Toastify({text:t,duration:4e3,gravity:"top",position:"right",style:{background:n[s]||n.info}}).showToast():console.log(`[${s.toUpperCase()}] ${t}`)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u):u();
