{% extends "base.html" %}

{% block title %}Forgot Password - MoneyFlow{% endblock %}

{% block content %}
<div class="container">
    <!-- Request Reset Form -->
    <div class="card" id="requestCard">
        <h1>Forgot Password</h1>
        <p class="text-center" style="color: #666; margin-bottom: 1.5rem;">
            Enter your email address and we'll send you a code to reset your password.
        </p>
        <form id="requestForm">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required>
            </div>
            <button type="submit" class="btn" id="requestBtn">Send Reset Code</button>
        </form>
        <p class="text-center mt-1">
            Remember your password? <a href="/sign-in" class="link">Sign In</a>
        </p>
    </div>

    <!-- Verify Hash Form (hidden initially) -->
    <div class="card hidden" id="verifyCard">
        <h1>Verify Code</h1>
        <p class="text-center" style="color: #666; margin-bottom: 1.5rem;">
            We've sent a reset code to your email. Please enter it below to continue.
        </p>
        <form id="verifyForm">
            <div class="form-group">
                <label for="reset_code">Reset Code</label>
                <input type="text" id="reset_code" name="reset_code" required maxlength="6" placeholder="Enter 6-digit code">
            </div>
            <input type="hidden" id="verify_email" name="email">
            <button type="submit" class="btn" id="verifyBtn">Verify Code</button>
        </form>
    </div>

    <!-- Reset Password Form (hidden initially) -->
    <div class="card hidden" id="resetCard">
        <h1>Reset Password</h1>
        <p class="text-center" style="color: #666; margin-bottom: 1.5rem;">
            Code verified! Please enter your new password.
        </p>
        <form id="resetForm">
            <div class="form-group">
                <label for="new_password">New Password</label>
                <input type="password" id="new_password" name="password" required minlength="8">
            </div>
            <div class="form-group">
                <label for="confirm_password">Confirm Password</label>
                <input type="password" id="confirm_password" name="password_confirmation" required>
            </div>
            <input type="hidden" id="reset_token" name="token">
            <input type="hidden" id="reset_email" name="email">
            <button type="submit" class="btn" id="resetBtn">Reset Password</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const requestCard = document.getElementById('requestCard');
    const verifyCard = document.getElementById('verifyCard');
    const resetCard = document.getElementById('resetCard');

    const requestForm = document.getElementById('requestForm');
    const verifyForm = document.getElementById('verifyForm');
    const resetForm = document.getElementById('resetForm');

    // Step 1: Request password reset
    requestForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('requestBtn');
        btn.disabled = true;
        btn.textContent = 'Sending...';

        const email = document.getElementById('email').value;
        const data = { email };

        const result = await apiRequest('/api/v1/account/forgot-password', 'POST', data);

        if (result.ok) {
            showToast('Reset code sent! Please check your email.', 'success');
            document.getElementById('verify_email').value = email;
            document.getElementById('reset_email').value = email;
            requestCard.classList.add('hidden');
            verifyCard.classList.remove('hidden');
        } else {
            const message = result.data.message || 'Failed to send reset code. Please try again.';
            showToast(message, 'error');
        }

        btn.disabled = false;
        btn.textContent = 'Send Reset Code';
    });

    // Step 2: Verify hash code
    verifyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('verifyBtn');
        btn.disabled = true;
        btn.textContent = 'Verifying...';

        const data = {
            email: document.getElementById('verify_email').value,
            hash: document.getElementById('reset_code').value
        };

        const result = await apiRequest('/api/v1/account/verify-hash', 'POST', data);

        if (result.ok) {
            showToast('Code verified! Please enter your new password.', 'success');
            // Store the token for the reset request
            if (result.data.token) {
                document.getElementById('reset_token').value = result.data.token;
            }
            verifyCard.classList.add('hidden');
            resetCard.classList.remove('hidden');
        } else {
            const message = result.data.message || 'Invalid or expired code. Please try again.';
            showToast(message, 'error');
        }

        btn.disabled = false;
        btn.textContent = 'Verify Code';
    });

    // Step 3: Reset password
    resetForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('resetBtn');
        btn.disabled = true;
        btn.textContent = 'Resetting...';

        const password = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;

        if (password !== confirmPassword) {
            showToast('Passwords do not match', 'error');
            btn.disabled = false;
            btn.textContent = 'Reset Password';
            return;
        }

        const data = {
            email: document.getElementById('reset_email').value,
            token: document.getElementById('reset_token').value,
            password: password,
            password_confirmation: confirmPassword
        };

        const result = await apiRequest('/api/v1/account/reset-password', 'POST', data);

        if (result.ok) {
            showToast('Password reset successful! Redirecting to sign in...', 'success');
            setTimeout(() => {
                window.location.href = '/sign-in';
            }, 2000);
        } else {
            const message = result.data.message || 'Failed to reset password. Please try again.';
            showToast(message, 'error');

            if (result.data.errors) {
                for (const [field, errors] of Object.entries(result.data.errors)) {
                    errors.forEach(err => showToast(`${field}: ${err}`, 'error'));
                }
            }
        }

        btn.disabled = false;
        btn.textContent = 'Reset Password';
    });
</script>
{% endblock %}
